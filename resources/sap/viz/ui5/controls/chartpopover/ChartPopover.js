/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','./ContentPanel','./HeaderBar','./SubActionItemsPage','sap/ui/core/Control','sap/viz/ui5/format/ChartFormatter'],function(q,C,H,S,a,b){var c=a.extend('sap.viz.ui5.controls.chartpopover.ChartPopover',{metadata:{properties:{'customDataControl':{type:'any'},'actionItems':{type:'object[]'},'formatString':{type:'any'},'chartType':{type:'string'}}}});c.prototype.init=function(){this._listItemHeight=3;this._isActionItemsChanged=true;this._options=null;this._oContentPanel=new C(this._createId('vizContentPanel'),{});this._oSelectedLabel=new sap.m.Label(this._createId('vizSelectedLabel'),{});this._oSelectedBar=new sap.m.Bar(this._createId('vizSelectedBar'),{contentMiddle:[this._oSelectedLabel]}).addStyleClass('viz-controls-chartPopover-vizSelectedBar').addStyleClass('viz-controls-chartPopover-vizSelectedBarBorder');this._oCustomHeader=new H(this._createId('vizHeaderBar'),{title:sap.viz.extapi.env.Language.getResourceString("IDS_CURRENT_SELECTION"),showNavButton:false,closeButtonPress:q.proxy(this.close,this),navButtonPress:q.proxy(this._navigateBack,this)});this._oPopover=new sap.m.ResponsivePopover(this._createId('vizChartPopover'),{horizontalScrolling:false,placement:sap.m.PlacementType.HorizontalPreferedRight,contentWidth:"18rem",customHeader:this._oCustomHeader,content:[this._oContentPanel]});var p=this._oPopover.getAggregation("_popup");this._popoverOrigGetOffsetX=p._getOffsetX;this._popoverOrigGetOffsetY=p._getOffsetY;this._popoverOrigCalcHorizontal=p._calcHorizontal;this._popoverOrigCalcVertical=p._calcVertical;this._oPopover.addStyleClass('viz-controls-chartPopover');this._oPopover.attachAfterClose(this._afterClose,this);this._oPopover.attachAfterOpen(this._afterOpen,this);this._infoDiv=null;this._chartType=null;};c.prototype._afterOpen=function(){this._oCustomHeader._oCloseButton.focus();};c.prototype._afterClose=function(){this._navigateBack();if(this._options&&this._options.selectedValues<1){this._oPopover.removeContent(this._oSelectedBar);}if(this._infoDiv){this._infoDiv.focus();}};c.prototype.isOpen=function(){return this._oPopover.isOpen();};function h(n,d){if(!n||!n.getAttribute){return false;}var e=n.getAttribute('class')||"";return(' '+e+' ').indexOf(' '+d+' ')>=0;}c.prototype.openBy=function(d,s){if(d){this._oCustomHeader.setTitle(sap.viz.extapi.env.Language.getResourceString('IDS_CURRENT_SELECTION'));this._updateContent();this._updateActionItems();var t=this._updatePopoverSettings(d);var e=this._oPopover.getContent();if(e.length>0){this._oPopover.setInitialFocus(e[0].getId());}setTimeout((function(){this._oPopover.openBy(t,s);}).bind(this),0);}return this;};c.prototype.close=function(){this._oPopover.close();return this;};c.prototype.exit=function(){if(this._oContentPanel){this._oContentPanel.destroy();this._oContentPanel=null;}if(this._oSelectedLabel){this._oSelectedLabel.destroy();this._oSelectedLabel=null;}if(this._oCustomHeader){this._oCustomHeader.destroy();this._oCustomHeader=null;}if(this._oCustomPanel){this._oCustomPanel.destroy();this._oCustomPanel=null;}if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}if(this._targetElement){this._targetElement.remove();this._targetElement=null;}this._options=null;this._infoDiv=null;this._chartType=null;};c.prototype.setOptions=function(d){var e=this._formatData(d);if(!this._infoDiv||this.getChartType()!=this._chartType){var n=d.target;while((n=n.parentNode)&&!h(n,"v-info")){}this._infoDiv=n;this._chartType=this.getChartType();}if(this._infoDiv){var _=this._infoDiv.querySelector(".v-m-screenreader-container");if(_){var l=_.querySelector("li");if(l&&d.selectedValues){var t=d.selectedValues===1?" "+sap.viz.extapi.env.Language.getResourceString("IDS_VALUE_SELECTED"):" "+sap.viz.extapi.env.Language.getResourceString("IDS_VALUES_SELECTED");l.innerText=d.selectedValues+t;}}}this._options=d;this._oContentPanel.setContentData(e);if(!e.val||d.selectedValues>1){this._oSelectedLabel.setText(d.selectedValues+" "+(d.selectedValues===1?sap.viz.extapi.env.Language.getResourceString("IDS_VALUE_SELECTED"):sap.viz.extapi.env.Language.getResourceString("IDS_VALUES_SELECTED")));this._oPopover.insertContent(this._oSelectedBar,1);if(e.val===undefined){this._oSelectedBar.removeStyleClass('viz-controls-chartPopover-vizSelectedBarBorder');}}else{this._oPopover.removeContent(this._oSelectedBar);}return this;};c.prototype.setActionItems=function(i){this._actionItems=[];this._actionItems=q.extend(true,this._actionItems,i);this._isActionItemsChanged=true;};c.prototype.getActionItems=function(i){return this._actionItems;};c.prototype._updateContent=function(){var d=this.getCustomDataControl();if(d){if(this._oCustomPanel){this._oPopover.removeContent(this._oCustomPanel);}this._oCustomPanel=d(this._options);this._oPopover.removeContent(this._oContentPanel);this._oPopover.insertContent(this._oCustomPanel,0);this._oSelectedBar.addStyleClass('viz-controls-chartPopover-vizSelectedBarBorder');}else{this._oCustomPanel=null;if(this._oContentPanel.isMultiSelected()){this._oPopover.removeContent(this._oContentPanel);}else if(this._oPopover.indexOfContent(this._oContentPanel)===-1){this._oPopover.insertContent(this._oContentPanel,0);this._oSelectedBar.addStyleClass('viz-controls-chartPopover-vizSelectedBarBorder');}}return this;};c.prototype._updateActionItems=function(){if(this._isActionItemsChanged){var d=this._actionItems;if(!this._oActionList){d=this.getActionItems();if(d&&d.length>0){this._actionItems=q.extend(true,this._actionItems,d);this._oActionList=new sap.m.List({}).addStyleClass('viz-controls-chartPopover-actionList');this._oPopover.addContent(this._oActionList);}}if(d&&d.length>0){this._oActionList.removeAllItems();var e;for(var i=0,l=d.length;i<l;i++){e=d[i];if(e.type==='action'){this._oActionList.addItem(new sap.m.ActionListItem({text:e.text,press:e.press?e.press:function(){}}));}else if(e.type==='navigation'){this._oActionList.addItem(new sap.m.StandardListItem({title:e.text,type:'Navigation',press:q.proxy(function(f){var g=this._oActionList.indexOfItem(f.getSource());var s=this._actionItems[g].children;if(s&&s.length>0){this._oSubActionItemsPage=new S();this._oPopover.insertContent(this._oSubActionItemsPage);this._oSubActionItemsPage.setItems(s);this._oCustomHeader.setTitle(this._actionItems[g].text);this._navigateTo();}},this)}));}}}else{if(this._oActionList){this._oActionList.destroy();this._oActionList=null;}}this._isActionItemsChanged=false;}};c.prototype._navigateBack=function(){this._oPopover.removeContent(this._oSubActionItemsPage);this._oCustomHeader.setShowNavButton(false).setTitle(sap.viz.extapi.env.Language.getResourceString("IDS_CURRENT_SELECTION"));};c.prototype._navigateTo=function(p){this._oCustomHeader.setShowNavButton(true);};c.prototype._createId=function(i){return this.getId()+"-"+i;};c.prototype._formatData=function(d){if(!(d.data&&d.data.val)){return d.data;}var e=d.data,f=sap.viz.api.env.Format.format,g=q.extend(true,{},e),t=g.val.hasOwnProperty("timeMeasure")?g.val.timeMeasure:-1,j=g.val.hasOwnProperty("timeDimensions")?g.val.timeDimensions:[],k=this.getFormatString(),l=null,m={},p;if(typeof k==="string"){l=k;}else if(k instanceof Object){m=k;}if(t!==-1){var n=g.val.filter(function(i){return(i.type)&&(i.type.toLowerCase()==="measure");})[t];n.value=new Date(n.value);}if(d.timeTooltipData&&this.getChartType().indexOf('time')>-1){var r=false;if(k){j.forEach(function(i){if(g.val[i]&&g.val[i].id&&m[g.val[i].id]){r=true;}});}if(r){g.val.forEach(function(i,s){if(j.indexOf(s)>-1){i.type="measure";i.value=new Date(i.value);}});}else{g.val=d.timeTooltipData;g.isTimeSeries=true;}}g.val.forEach(function(v){if(v.type&&v.type.toLowerCase()==="measure"){p=m[v.id]||l||v.formatString;if(p){v.value=f(v.value,p);}else{v.value=f(v.value);}}});return g;};c.prototype._updatePopoverSettings=function(t){var d=this._options.data.val;var e=t.getBoundingClientRect(),m;var p=function(r){return parseInt(r,10);};var f=t.__data__;if(d!==undefined){for(var i=0,l=d.length;i<l;i++){if(d[i].type&&(d[i].type.toLowerCase()==="measure")){m=d[i].value;break;}}}else if(f&&f.measureNames){m=f[f.measureNames];}var g=this._options.data.type;var j=g&&g==="line";var k;var O,n,P;this._restorePopoverMethod();switch(this.getChartType()){case'info/bar':case'info/dual_bar':if(m<0){P=sap.m.PlacementType.HorizontalPreferedLeft;n=-p(t.getBoundingClientRect().width);}else{P=sap.m.PlacementType.HorizontalPreferedRight;n=p(t.getBoundingClientRect().width);}this._oPopover.setPlacement(P);O=0;o(this._oPopover,P,O,n);k=t.firstChild;break;case'info/column':case'info/dual_column':case'info/timeseries_column':if(m<0){P=sap.m.PlacementType.VerticalPreferedBottom;n=p(t.getBoundingClientRect().height);}else{P=sap.m.PlacementType.VerticalPreferedTop;n=-p(t.getBoundingClientRect().height);}this._oPopover.setPlacement(P);O=0;o(this._oPopover,P,O,n);k=t.firstChild;break;case'info/pie':case'info/donut':P=sap.m.PlacementType.HorizontalPreferedRight;this._oPopover.setPlacement(P);O=-p(t.getBoundingClientRect().width/2);n=p(t.getBoundingClientRect().width/2);o(this._oPopover,P,O,n);k=t.firstChild;break;case'info/bullet':P=sap.m.PlacementType.HorizontalPreferedRight;this._oPopover.setPlacement(P);O=0;n=p(t.getBoundingClientRect().width);o(this._oPopover,P,O,n);k=t;break;case'info/vertical_bullet':P=sap.m.PlacementType.VerticalPreferedTop;this._oPopover.setPlacement(P);O=0;n=-p(t.getBoundingClientRect().height);o(this._oPopover,P,O,n);k=t;break;case'info/line':case'info/timeseries_line':case'info/timeseries_scatter':case'info/timeseries_bubble':case'info/dual_line':case'info/bubble':case'info/time_bubble':case'info/scatter':case'info/stacked_bar':case'info/dual_stacked_bar':case'info/100_stacked_bar':case'info/100_dual_stacked_bar':case'info/waterfall':this._oPopover.setPlacement(sap.m.PlacementType.VerticalPreferedTop);k=this._createOpenByElement(e);break;case'info/stacked_column':case'info/dual_stacked_column':case'info/100_stacked_column':case'info/100_dual_stacked_column':case'info/horizontal_waterfall':case'info/heatmap':this._oPopover.setPlacement(sap.m.PlacementType.HorizontalPreferedRight);k=this._createOpenByElement(e);break;case'info/combination':if(j){this._oPopover.setPlacement(sap.m.PlacementType.VerticalPreferedTop);k=this._createOpenByElement(e);}else{if(m<0){P=sap.m.PlacementType.VerticalPreferedBottom;n=p(t.getBoundingClientRect().height);}else{P=sap.m.PlacementType.VerticalPreferedTop;n=-p(t.getBoundingClientRect().height);}this._oPopover.setPlacement(P);O=0;o(this._oPopover,P,O,n);k=t.firstChild;}break;case'info/stacked_combination':case'info/dual_stacked_combination':if(j){this._oPopover.setPlacement(sap.m.PlacementType.VerticalPreferedTop);}else{this._oPopover.setPlacement(sap.m.PlacementType.HorizontalPreferedRight);}k=this._createOpenByElement(e);break;case'info/horizontal_stacked_combination':case'info/dual_horizontal_stacked_combination':if(j){this._oPopover.setPlacement(sap.m.PlacementType.HorizontalPreferedRight);}else{this._oPopover.setPlacement(sap.m.PlacementType.VerticalPreferedTop);}k=this._createOpenByElement(e);break;}return k;};c.prototype._createOpenByElement=function(d){if(!this._targetElement){this._targetElement=q('<div></div>').attr('class','viz-controls-chartPopover-dpMarker').attr('style','position: fixed;').css('visibility','hidden');q('body').append(this._targetElement);}this._targetElement.css('width',d.width+'px').css('height',d.height+'px').css('left',d.left).css('top',d.top);return this._targetElement[0];};c.prototype._restorePopoverMethod=function(){var p=this._oPopover.getAggregation("_popup");p._getOffsetX=this._popoverOrigGetOffsetY.bind(p);p._getOffsetY=this._popoverOrigGetOffsetY.bind(p);p._calcHorizontal=this._popoverOrigCalcHorizontal.bind(p);p._calcVertical=this._popoverOrigCalcVertical.bind(p);};function o(p,P,O,i){var d=p.getAggregation("_popup");var s,f;switch(P){case sap.m.PlacementType.HorizontalPreferedRight:s="X";f="Left";break;case sap.m.PlacementType.HorizontalPreferedLeft:s="X";f="Right";break;case sap.m.PlacementType.VerticalPreferedTop:s="Y";f="Bottom";break;case sap.m.PlacementType.VerticalPreferedBottom:s="Y";f="Top";break;}d["_getOffset"+s]=function(){var r=sap.ui.getCore().getConfiguration().getRTL();var F=this._oCalcedPos===f?i:O;return(this["getOffset"+s]()*(r?-1:1)+F);}.bind(d);d._calcHorizontal=function(){var $=q(this._getOpenByDomRef());var e=$[0]!==undefined;var g=this.getPlacement()===sap.m.PlacementType.HorizontalPreferedLeft||this.getPlacement()===sap.m.PlacementType.HorizontalPreferredLeft;var j=this.getPlacement()===sap.m.PlacementType.HorizontalPreferedRight||this.getPlacement()===sap.m.PlacementType.HorizontalPreferredRight;var k=e?$[0].getBoundingClientRect().left:0;var l=e?$[0].getBoundingClientRect().width:0;var m=this.getOffsetX();var L=k-this._marginLeft+m;var n=k+l;var r=this._$window.width()-n-this._marginRight-m;var t=this.$().outerWidth();if(f==="Left"){L+=Math.abs(i);}else if(f==="Right"){r+=Math.abs(i);}var R=sap.ui.getCore().getConfiguration().getRTL();if(g&&L>t+this._arrowOffset){this._oCalcedPos=R?sap.m.PlacementType.Right:sap.m.PlacementType.Left;}else if(j&&r>t+this._arrowOffset){this._oCalcedPos=R?sap.m.PlacementType.Left:sap.m.PlacementType.Right;}else if(L>r){this._oCalcedPos=R?sap.m.PlacementType.Right:sap.m.PlacementType.Left;}else{this._oCalcedPos=R?sap.m.PlacementType.Left:sap.m.PlacementType.Right;}}.bind(d);d._calcVertical=function(){var $=q(this._getOpenByDomRef());var e=$[0]!==undefined;var g=this.getPlacement()===sap.m.PlacementType.VerticalPreferedTop||this.getPlacement()===sap.m.PlacementType.VerticalPreferredTop;var j=this.getPlacement()===sap.m.PlacementType.VerticalPreferedBottom||this.getPlacement()===sap.m.PlacementType.VerticalPreferredBottom;var k=e?$[0].getBoundingClientRect().top:0;var l=e?$[0].getBoundingClientRect().height:0;var m=this.getOffsetY();var t=k-this._marginTop+m;var n=k+l;var B=this._$window.height()-n-this._marginBottom-m;var r=this.$().outerHeight();if(f==="Top"){t+=Math.abs(i);}else if(f==="Bottom"){B+=Math.abs(i);}if(g&&t>r+this._arrowOffset){this._oCalcedPos=sap.m.PlacementType.Top;}else if(j&&B>r+this._arrowOffset){this._oCalcedPos=sap.m.PlacementType.Bottom;}else if(t>B){this._oCalcedPos=sap.m.PlacementType.Top;}else{this._oCalcedPos=sap.m.PlacementType.Bottom;}}.bind(d);}return c;});
