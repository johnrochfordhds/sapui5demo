/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare('sap.apf.utils.startFilter');
sap.apf.utils.StartFilter=function(a,c,b){'use strict';var d;var e;var r=new sap.apf.core.utils.Filter(a.instance.messageHandler);var f;var g;var h=0;var j=0;var k=jQuery.extend(true,[],b);var p;if(c.preselectionDefaults&&c.preselectionDefaults.length>0){p=jQuery.extend(true,[],c.preselectionDefaults);}else if(jQuery.isFunction(c.preselectionFunction)){p=jQuery.extend(true,[],c.preselectionFunction());}var v=false;if(c.valueHelpRequest||(jQuery.isArray(c.valueList)&&c.valueList.length>0)){v=true;}var l=false;var m={};var n={};z=z.bind(this);A=A.bind(this);w=w.bind(this);u=u.bind(this);s=s.bind(this);this.setContext=function(i){if(c.notConfigured===true){b=i;}else{a.instance.messageHandler.putMessage(a.instance.messageHandler.createMessageObject({code:'5100',aParameters:['Context of configured Startfilter cannot be changed']}));}};this.getPropertyName=function(){return c.property;};this.getLabel=function(){return c.label;};this.getAliasNameIfExistsElsePropertyName=function(){return c.alias||c.property;};this.isMultiSelection=function(){if(c.multiSelection==='true'||c.multiSelection===true){return true;}return false;};this.isVisible=function(){if(b&&b.type==='internalFilter'&&!c.filterResolutionRequest){return false;}return!c.invisible;};this.setRestriction=function(i){r=i.copy();if(!g){g=jQuery.Deferred();}if(!f){f=jQuery.Deferred();}o(++h);q(++j);};this.setSelectedValues=function(i){if(!g){g=jQuery.Deferred();}if(!d){d=jQuery.Deferred();u().done(function(B){if(d){d.resolve(B);}});}if(i.type==='internalFilter'){e=i;}else{e=jQuery.extend(true,[],i);}q(++j);};this.getSelectedValues=function(){var i;if(!g){g=jQuery.Deferred();i=g;q(++j);}else if(g.state()==='pending'){i=g;if(d){d.done(function(){q(++j);});}else{q(++j);}}return i.promise();};this.getValues=function(){var i;if(!f){f=jQuery.Deferred();i=f;o(++h);}else if(f.state()==='pending'){i=f;o(++h);}return i.promise();};this.getMetadata=function(){if(c.valueHelpRequest){return y().then(function(i){return i.metadata.getPropertyMetadata(this.getAliasNameIfExistsElsePropertyName());}.bind(this));}else if(c.filterResolutionRequest){return w().then(function(i){return i.metadata.getPropertyMetadata(this.getAliasNameIfExistsElsePropertyName());}.bind(this));}return jQuery.Deferred().resolve({});};this.serialize=function(){var i=jQuery.Deferred();var B={propertyName:this.getPropertyName()};u().done(function(C){if(C&&C.type==='internalFilter'){C=C.mapToSapUI5FilterExpression();}B.selectedValues=C;i.resolve(B);});return i;};this.deserialize=function(i){if(i.selectedValues&&(i.selectedValues.filters||i.selectedValues.path)){i.selectedValues=sap.apf.core.utils.Filter.transformUI5FilterToInternal(a.instance.messageHandler,i.selectedValues);}e=null;d=null;if(jQuery.isArray(i.selectedValues)){k=jQuery.extend(true,[],i.selectedValues);b=jQuery.extend(true,[],i.selectedValues);}else{k=i.selectedValues;b=i.selectedValues;}l=false;};this.reset=function(){if(d){d.done(function(i){e=i;});}};function o(i){s(i,h).done(function(B){if(i===h){var C=f;f=jQuery.Deferred();C.resolve(B,f.promise());}});}function q(i){u(i).done(function(B){if(i===j){var C=g;g=jQuery.Deferred();C.resolve(B,g.promise());}});}function s(B,C){var D=jQuery.Deferred();var E=[];t=t.bind(this);G=G.bind(this);if(v&&jQuery.isArray(b)){x(B,C).then(function(i){var E=i.data;var F=t(k,E);D.resolve(F);});}else if(b&&b.type==='internalFilter'&&v&&c.filterResolutionRequest){jQuery.when(x(B,C),w(B,C)).then(function(i,H){var E=i.data;G(H.data,E);D.resolve(E);});}else if(v&&((c.preselectionDefaults&&c.preselectionDefaults.length>0)||jQuery.isFunction(c.preselectionFunction))){x(B,C).then(function(i){var E=i.data;var F=t(p,E);D.resolve(F);});}else if(v){x(B,C).then(function(i){D.resolve(i.data);});}else if(b&&b.type==='internalFilter'&&c.filterResolutionRequest){w(B,C).then(function(i){D.resolve(i.data);});}else if(jQuery.isArray(b)&&c.filterResolutionRequest&&!v){w(B,C).then(function(i){D.resolve(i.data);});}else if(jQuery.isArray(b)){E=t(k,E);D.resolve(E);}else if(((c.preselectionDefaults&&c.preselectionDefaults.length>0)||jQuery.isFunction(c.preselectionFunction))&&!v&&!c.filterResolutionRequest&&!b){if(this.isMultiSelection()){var F=t(p,E);}else if(p.length>0){var F=t([p[0]],E);}D.resolve(F);}else if(((c.preselectionDefaults&&c.preselectionDefaults.length>0)||jQuery.isFunction(c.preselectionFunction))&&c.filterResolutionRequest&&!b){if(this.isMultiSelection()){var F=t(p,E);}else if(p.length>0){var F=t([p[0]],E);}D.resolve(F);}else if(b&&b.type==='internalFilter'||!b){D.resolve(null);}return D.promise();function G(H,I){var J=A(I);for(var i=H.length-1;i>=0;i--){if(!J[H[i][this.getAliasNameIfExistsElsePropertyName()]]){I.unshift(H[i]);}}}}function t(B,C){var D=jQuery.extend(true,[],C);var E=A(C);var F;for(var i=B.length-1;i>=0;i--){if(!E[B[i]]){F={};F[this.getAliasNameIfExistsElsePropertyName()]=B[i];D.unshift(F);}else if(!l){B.splice(i,1);}}l=true;return D;}function u(i){var B=jQuery.Deferred();var C;var D;var E;var F=this;if(e){if(!c.invisible){H(jQuery.extend(true,[],e),i);}else{C=e;G();}}else if(jQuery.isFunction(c.preselectionFunction)&&!v){C=c.preselectionFunction();G();}else if(b&&b.type==='internalFilter'&&!c.filterResolutionRequest){B.resolve(b);}else if(c.filterResolutionRequest&&!b&&!v&&!(c.preselectionDefaults&&c.preselectionDefaults.length>0)){B.resolve(null);}else if(b&&b.type==='internalFilter'&&c.filterResolutionRequest){w(i,j).then(function(I){var J=z(I);H(jQuery.extend(true,[],J),i);});}else if(v&&!jQuery.isArray(b)&&!(c.preselectionDefaults&&c.preselectionDefaults.length>0)&&!c.preselectionFunction){x(i,j).then(function(I){var J=z(I);if(this.isMultiSelection()){C=J;}else{C=[J[0]];}G();}.bind(this));}else if(v&&!jQuery.isArray(b)&&((c.preselectionDefaults&&c.preselectionDefaults.length>0)||c.preselectionFunction)){if(jQuery.isFunction(c.preselectionFunction)){D=c.preselectionFunction();}else{D=c.preselectionDefaults;}H(jQuery.extend(true,[],D),i);}else if(jQuery.isArray(b)){H(b,i);}else if(c.preselectionDefaults&&c.preselectionDefaults.length>0){C=c.preselectionDefaults;H(C,i);}else{B.resolve(null);}return B.promise();function G(){if(C&&C.type==='internalFilter'){B.resolve(C);}else{B.resolve(jQuery.extend(true,[],C));}}function H(I,i){s(i,j).done(function(J){if(J!==null){C=[];E=A(J);I.forEach(function(K){if(E[K]){C.push(K);}});if(C.length===0){C=z({data:J});}if(!F.isMultiSelection()){C=[C[0]];}if(e!==null){e=C;}}else{C=null;}G();});}}function w(i,B){var C;var D=jQuery.Deferred();if(i&&i!==B){return D.promise();}var E;if(jQuery.isArray(b)){E=new sap.apf.core.utils.Filter(a.instance.messageHandler);b.forEach(function(G){E.addOr(this.getAliasNameIfExistsElsePropertyName(),'eq',G);}.bind(this));}else if(b instanceof sap.apf.core.utils.Filter){E=b;}else{E=new sap.apf.core.utils.Filter(a.instance.messageHandler);}if(!r.isEmpty()){C=new sap.apf.core.utils.Filter(a.instance.messageHandler);C.addAnd(r).addAnd(E);}else{C=E;}if(m.lastMergedFilter&&m.lastMergedFilter.isEqual(C)){m.lastFilterResolutionPromise.done(function(G){D.resolve(G);});}else{m.lastMergedFilter=C.copy();m.lastFilterResolutionPromise=D;a.functions.createRequest(c.filterResolutionRequest).sendGetInBatch(C,F,undefined);}return D.promise();function F(G){D.resolve(G);}}function x(i,B){var C;if(c.valueHelpRequest){return y(i,B);}else if(c.valueList){C={data:t(c.valueList,[])};return jQuery.Deferred().resolve(C);}}function y(i,B){var C=jQuery.Deferred();if(i&&B!==i){return C.promise();}if(n.lastRestriction&&n.lastRestriction.isEqual(r)){n.lastValueHelpPromise.done(function(E){C.resolve(E);});}else{n.lastRestriction=r.copy();n.lastValueHelpPromise=C;a.functions.createRequest(c.valueHelpRequest).sendGetInBatch(r,D,undefined);}return C.promise();function D(E){C.resolve(E);}}function z(i){var B=[];i.data.forEach(function(C){B.push(C[this.getAliasNameIfExistsElsePropertyName()]);}.bind(this));return B;}function A(i){var B={};i.forEach(function(C){B[C[this.getAliasNameIfExistsElsePropertyName()]]=true;}.bind(this));return B;}};
