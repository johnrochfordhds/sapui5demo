/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare('sap.apf.utils.startFilterHandler');jQuery.sap.require('sap.apf.utils.filter');jQuery.sap.require('sap.apf.core.utils.filter');
sap.apf.utils.StartFilterHandler=function(a){'use strict';var s=[{isLevel:true}];var S=(a&&a.constructor&&a.constructor.StartFilter)||sap.apf.utils.StartFilter;var r={};var b={};var c={};var d={};var m=a.instance.messageHandler;var e=jQuery.Deferred();var f=jQuery.Deferred();var g=false;var p=jQuery.Deferred();this.getStartFilters=function(){h().done(function(){e.resolve(n());});return e.promise();};this.setRestrictionByProperty=function(i){var w=i.getInternalFilter();var x=w.getProperties()[0];r[x]=i;h().done(function(){var y=true;o().forEach(function(z){if(z.getPropertyName()===x){if(w.isDisjunctionOverEqualities()){z.setSelectedValues(k(w));}else{z.setContext(w);}y=false;}});if(y){s.unshift(new S(a,{multiSelection:true,property:x,invisible:true,notConfigured:true},w));}if(p.state()==='resolved'){p=jQuery.Deferred();}if(a.functions.getFacetFilterConfigurations().length===0){p.resolve(u(q()));}b[x]=i;delete r[x];if(!c[x]){c[x]=i.serialize();}v();});};this.getRestrictionByProperty=function(i){if(b[i]){return b[i];}else if(r[i]){return r[i];}return new sap.apf.utils.Filter(m);};this.getCumulativeFilter=function(){var i=jQuery.Deferred();var w=new sap.apf.core.utils.Filter(m);var x;h().done(function(){x=o().length;if(x===0){i.resolve(new sap.apf.core.utils.Filter(m));}p.done(function(y,z,A){var B;B=new sap.apf.core.utils.Filter(m);if(y&&y.type==='internalFilter'){B=y;}if(jQuery.isArray(y)){y.forEach(function(C){B.addOr(new sap.apf.core.utils.Filter(m,A,'eq',C));});}if(z){w.addAnd(z).addAnd(B);}else{w=B;}i.resolve(w);});});return i.promise();};this.serialize=function(){var i=jQuery.Deferred();var w;var x;var y={};y.startFilters=[];y.restrictionsSetByApplication={};for(x in b){y.restrictionsSetByApplication[x]=b[x].serialize();}w=o().length;if(o().length>0){o().forEach(function(z){z.serialize().done(function(A){y.startFilters.push(A);w--;if(w===0){i.resolve(y);}});});}else{i.resolve(y);}return i.promise();};this.deserialize=function(w){var s=o();var x;var y;b={};w.startFilters.forEach(function(z){for(var i=0,A=s.length;i<A;i++){if(z.propertyName===s[i].getPropertyName()){s[i].deserialize(z);}}});for(x in w.restrictionsSetByApplication){y=new sap.apf.utils.Filter(m);y.deserialize(w.restrictionsSetByApplication[x]);b[x]=y;}v();};this.resetAll=function(){var i;o().forEach(function(w){w.reset();});b={};for(i in c){b[i]=new sap.apf.utils.Filter(m).deserialize(c[i]);}v();};this.resetVisibleStartFilters=function(){n().forEach(function(y){y.reset();});var w=0;var x=s.length;for(var i=0;i<x;i++){if(s[i].isLevel){w=i+1;break;}}if(s[w]){s[w].setRestriction(d[s[w].getPropertyName()]);}};function h(){if(!g){g=true;a.functions.getCombinedContext().done(function(w){var x=a.functions.getFacetFilterConfigurations();var y=w.getProperties();var z=y.length;var A=null;x.forEach(function(B){for(var i=0;i<z;i++){if(B.property===y[i]){A=y[i];break;}}if(A){s.push(new S(a,B,l(w,A)));y.splice(y.indexOf(A),1);A=null;}else{s.push(new S(a,B));}});y.forEach(function(i){s.unshift(new S(a,{property:i,invisible:true,multiSelection:true},l(w,i)));});t().done(function(){j();f.resolve();});});}return f;}function j(){var s=o();s.forEach(function(w){w.getSelectedValues().done(x);function x(y,z){var A;var B=new sap.apf.core.utils.Filter(m);var C;z.done(x);for(var i=0;i<s.length;i++){if(s[i]===w){A=i;break;}}if(A===s.length-1){if(p.state()==='resolved'){p=jQuery.Deferred();}p.resolve(y,d[w.getPropertyName()],w.getPropertyName());return;}else if(p.state()==='resolved'){p=jQuery.Deferred();}if(y&&y.type==='internalFilter'){B=y;}else if(jQuery.isArray(y)){y.forEach(function(D){B.addOr(w.getPropertyName(),'eq',D);});}if(d[w.getPropertyName()]){if(d[w.getPropertyName()].isOr()){C=new sap.apf.core.utils.Filter(m);C.addAnd(d[w.getPropertyName()]).addAnd(B);}else{C=d[w.getPropertyName()].copy().addAnd(B);}}else{C=B;}d[s[A+1].getPropertyName()]=C;s[A+1].setRestriction(C);}});}function k(i){var w=[];i.getFilterTerms().forEach(function(x){w.push(x.getValue());});return w;}function l(w,x){var y=[];var z=w.getFilterTermsForProperty(x);var A=w.reduceToProperty(x);if(A.toUrlParam().indexOf('%20and%20')>-1){return A;}for(var i=0,B=z.length;i<B;i++){if(z[i].getOp()!=='EQ'){return A;}y.push(z[i].getValue());}return y;}function n(){var i=[];o().forEach(function(w){if(w.isVisible()){i.push(w);}});return i;}function o(){var i=[];s.forEach(function(w){if(!w.isLevel){i.push(w);}});return i;}function q(){var w=[];for(var i=0,x=s.length;i<x;i++){if(!s[i].isLevel){w.push(s[i]);}else{break;}}return w;}function t(){var w=jQuery.Deferred();x(u(q()));return w;function x(y){var i;var z=s.length;var A=y;var B=0;for(i=0;i<z;i++){if(s[i].isLevel){B=i+1;break;}}if(s[B]){s[B].setRestriction(A);d[s[B].getPropertyName()]=A.copy();C(B);}else{w.resolve();}function C(D){if(s[D+1]){s[D].getSelectedValues().done(function(E){var F=new sap.apf.core.utils.Filter(m);if(E&&E.type==='internalFilter'){F.addOr(E);}else if(jQuery.isArray(E)){E.forEach(function(G){F.addOr(s[D].getPropertyName(),'eq',G);});}if(!F.isEmpty()){A.addAnd(F);}s[D+1].setRestriction(A);d[s[D+1].getPropertyName()]=A.copy();C(D+1);});}else{w.resolve();}}}}function u(i){var w=new sap.apf.core.utils.Filter(m);i.forEach(function(x){var y=new sap.apf.core.utils.Filter(m);x.getSelectedValues().done(function(z){if(z.type==='internalFilter'){y.addOr(z);}else{z.forEach(function(A){y.addOr(x.getPropertyName(),'eq',A);});}});w.addAnd(y);});return w;}function v(){var w=0;var x=s.length;for(var i=0;i<x;i++){if(s[i].isLevel){w=i+1;break;}}if(s[w]){var y=u(q());d[s[w].getPropertyName()]=y;s[w].setRestriction(y);}}};
