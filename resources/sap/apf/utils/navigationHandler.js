/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
(function(){'use strict';jQuery.sap.declare("sap.apf.utils.navigationHandler");jQuery.sap.require("sap.apf.core.utils.filterSimplify");jQuery.sap.require("sap.ui.core.routing.HashChanger");sap.apf.utils.NavigationHandler=function(I){var c;var e;var m=I.instances.messageHandler;var n=this;this.getNavigationTargets=function(){var d;var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var s=[];if(e){d=jQuery.Deferred();d.resolve(b(e));return d.promise();}if(!c){a();}c.forEach(function(j){if(jQuery.inArray(j.semanticObject,s)===-1){s.push(j.semanticObject);}});e=jQuery.extend(true,[],c);e.forEach(function(j){j.text="";});d=jQuery.Deferred();i(0).done(function(){d.resolve(b(e));}).fail(function(){d.resolve(b(e));});return d.promise();function h(j,k,t){e.forEach(function(l){if(j===l.semanticObject&&k===l.action){l.text=t;}});}function i(j){var d=jQuery.Deferred();var k=[];if(j===s.length){d=jQuery.Deferred();e.forEach(function(o){if(o.text!==""){k.push(o);}});e=k;d.resolve(e);return d.promise();}var l=s[j];f.getSemanticObjectLinks(l,undefined,false,I.instances.component,undefined).done(function(o){o.forEach(function(p){var q=p.intent.split("-");var r=q[1].split("?");r=r[0].split("~");h(l,r[0],p.text);});i(j+1).done(function(){d.resolve(e);});}).fail(function(){return i(j+1);});return d.promise();}};this.navigateToApp=function(d){if(!c){a();}var N=g(d);if(!N){return;}var h=sap.ui.core.routing.HashChanger&&sap.ui.core.routing.HashChanger.getInstance();I.functions.getCumulativeFilterUpToActiveStep().done(function(C){var f;if(I.functions.isFilterReductionActive&&I.functions.isFilterReductionActive()){f=new sap.apf.core.utils.FilterReduction();C=f.filterReduction(m,C);}if(!N.filterMapping||!N.filterMapping.requestForMappedFilter){i(null,null);}else{var M=I.functions.createRequest(N.filterMapping.requestForMappedFilter);sap.apf.utils.executeFilterMapping(C,M,N.filterMapping.target,i,m);}function i(F,o){var j;if(o){return;}if(F){C=C.addAnd(F);}var k=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(k){var s={sapApfState:I.functions.serializePath()};I.instances.startFilterHandler.serialize().done(function(l){n.generateSelectionVariant(C).done(function(p){s.sapApfState.filterIdHandler=I.functions.serializeFilterIds();s.sapApfState.startFilterHandler=l;s.sapApfCumulativeFilter=C.mapToSapUI5FilterExpression();s.sapApfState.dirtyState=I.functions.isDirty();s.sapApfState.pathName=I.functions.getPathName();s.selectionVariant=p;j=k.createEmptyAppState(I.instances.component);j.setData(s);j.save();if(h){h.replaceHash("sap-iapp-state="+j.getKey());}k.toExternal({target:{semanticObject:N.semanticObject,action:N.action},appStateKey:j.getKey()});});});}}});};this.checkMode=function(){var d=jQuery.Deferred();var h=sap.ui.core.routing.HashChanger&&sap.ui.core.routing.HashChanger.getInstance&&sap.ui.core.routing.HashChanger.getInstance();var i=/(?:sap-iapp-state=)([^&=]+)/;var f,j,k,l;if(h){k=i.exec(h.getHash());if(k){f=k[1];}}j=I.functions.getXappStateId();if(f){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(I.instances.component,f).done(function(o){l=o.getData();if(l.sapApfState){I.functions.deserializeFilterIds(l.sapApfState.filterIdHandler);I.functions.deserializePath(l.sapApfState);I.functions.setDirtyState(l.sapApfState.dirtyState);I.functions.setPathName(l.sapApfState.pathName);I.instances.startFilterHandler.getStartFilters().done(function(){I.instances.startFilterHandler.deserialize(l.sapApfState.startFilterHandler);d.resolve({navigationMode:"backward"});});}});}else if(j){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(I.instances.component,j).done(function(o){l=o.getData();if(l&&l.sapApfCumulativeFilter){d.resolve({navigationMode:"forward",sapApfCumulativeFilter:l.sapApfCumulativeFilter});}else{d.resolve({navigationMode:"forward"});}});}else{d.resolve({navigationMode:"forward"});}if(h){h.replaceHash("");}return d.promise();};this.generateSelectionVariant=function(f){var d=jQuery.Deferred();if(I.functions.isFilterReductionActive&&I.functions.isFilterReductionActive()){var s=f.mapToSelectOptions(I.functions.getAllParameterEntitySetKeyProperties);s.done(function(h){h.SelectionVariantID=jQuery.sap.uid();d.resolve(h);});}else{var h={};h={SelectionVariantID:jQuery.sap.uid(),Text:'selectionVariant is only available if filterReduction in APF is active'};d.resolve(h);}return d.promise();};function a(){c=I.functions.getNavigationTargets();}function g(d){for(var i=0,l=c.length;i<l;i++){if(c[i].id===d){return c[i];}}}function b(t){var d=jQuery.extend(true,[],t);var r={global:[],stepSpecific:[]};d.forEach(function(f){if(f.isStepSpecific&&i(f.id)){delete f.isStepSpecific;r.stepSpecific.push(f);}else if(!f.isStepSpecific){delete f.isStepSpecific;r.global.push(f);}});return r;function i(f){var h=false;var j;var k=I.functions.getActiveStep();if(k&&k.getAssignedNavigationTargets){j=k.getAssignedNavigationTargets();if(j&&jQuery.isArray(j)){j.forEach(function(l){if(f===l.id){h=true;}});}}return h;}}};}());
