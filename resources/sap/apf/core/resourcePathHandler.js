/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
(function(){'use strict';jQuery.sap.declare("sap.apf.core.resourcePathHandler");jQuery.sap.require("sap.apf.core.utils.checkForTimeout");jQuery.sap.require("sap.apf.core.utils.filter");jQuery.sap.require("sap.apf.utils.hashtable");jQuery.sap.require("sap.apf.core.messageHandler");jQuery.sap.require("sap.apf.core.messageDefinition");jQuery.sap.require("sap.apf.core.odataProxy");jQuery.sap.require("sap.apf.core.layeredRepositoryProxy");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require("sap.apf.utils.startParameter");sap.apf.core.ResourcePathHandler=function(i){var t=this;var c=i.coreApi;var m=i.messageHandler;var h=new sap.apf.utils.Hashtable(m);var C;var p;var s=null;var a="";var b=false;var I=false;var P=sap.apf.core.OdataProxy;o();this.getApplicationConfigurationURL=function(){return a;};this.loadConfigFromFilePath=function(F){if(b){return;}if(c.getStartParameterFacade().getAnalyticalConfigurationId()){I=true;}var U=F;a=F;jQuery.ajax({url:U,dataType:"json",success:r,error:function(J,S,E){var M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorLoadingRessource,rawText:"Error "+E+" when loading the configuration of the resource location: "+U});m.putMessage(M);},async:false});f();if(I){l();}else{e();}b=true;function r(D,S,J){var M=sap.apf.core.utils.checkForTimeout(J);if(M){m.putMessage(m.createMessageObject({code:sap.apf.core.constants.message.code.errorStartUp,rawText:"Timeout when loading application configuration from "+F+"."}));}if(!D||!D.applicationConfiguration){m.putMessage(m.createMessageObject({code:sap.apf.core.constants.message.code.errorStartUp,rawText:"The application configuration from "+F+" has no valid format."}));return;}if(D.applicationConfiguration.textResourceLocations===undefined){m.putMessage(m.createMessageObject({code:sap.apf.core.constants.message.code.errorStartUp,rawText:"The textResourceLocations is missing in the application configuration from "+F+"."}));return;}q(D);}};function u(){return c.getStartParameterFacade().isLrepActive();}function l(){var r=c.getStartParameterFacade().getAnalyticalConfigurationId();var v=r.applicationId;var w=r.configurationId;if(u()&&!v){m.putMessage(m.createMessageObject({code:"5024"}));}var x=new P({serviceRoot:p.path.service,entityTypes:{configuration:sap.apf.core.constants.entitySets.configuration,texts:sap.apf.core.constants.entitySets.texts}},{instance:{coreApi:c,messageHandler:m}});x.readEntity("configuration",function(y,z,A){if(A){m.putMessage(m.createMessageObject({code:"5022",aParameters:[w]}));}else{var B=JSON.parse(y.SerializedAnalyticalConfiguration);c.loadAnalyticalConfiguration(JSON.parse(y.SerializedAnalyticalConfiguration));v=v||y.Application;d(v,x);if(B.applicationTitle){C.appName=B.applicationTitle.key;C.appTitle=B.applicationTitle.key;}}},[{name:"AnalyticalConfiguration",value:w}],undefined,false,v,{layer:'ALL'});}function d(r,v){var w=new sap.apf.core.utils.Filter(m,'Application','eq',r);var x=new sap.apf.core.utils.Filter(m,'Language','eq',sap.apf.core.constants.developmentLanguage);x.addAnd(w);var y=["TextElement","TextElementDescription"];v.readCollection('texts',function(z,A,B){if(B){m.putMessage(m.createMessageObject({code:"5023",aParameters:[sap.apf.utils.uriParameter.getConfigurationId()]}));}else{c.loadTextElements(z);}},undefined,y,x,false,{layer:'ALL'});}function e(){var U=t.getResourceLocation(sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation);var M;if(U!==""){jQuery.ajax({url:U,dataType:"json",success:function(D,S,J){if(D){c.loadAnalyticalConfiguration(D);if(D.applicationTitle){C.appName=D.applicationTitle.key;C.appTitle=D.applicationTitle.key;}}else{M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorLoadingAnalyticalConfig,rawText:"No data received when loading analytical configuration file"+U});m.putMessage(M);}},error:function(J,S,E){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorLoadingAnalyticalConfig,rawText:"Error "+E+" when loading analytical configuration file"+U});m.putMessage(M);},async:false});}else{M=m.createMessageObject({code:sap.apf.core.constants.message.code.missingAnalyticalConfig,rawText:"No analytical configuration defined in the application configuration"});m.putMessage(M);}}function f(){c.loadMessageConfiguration(sap.apf.core.messageDefinition,true);g(sap.apf.core.constants.resourceLocation.applicationMessageDefinitionLocation,false);}function g(r,R){var U=t.getResourceLocation(r);if(U!==""){jQuery.ajax({url:U,dataType:"json",success:v,error:function(J,S,E){var M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorLoadingAnalyticalConfig,rawText:"Error "+E+" when loading message configuration file"+U});m.putMessage(M);},async:false});}function v(D,S,J){var M;var w=sap.apf.core.utils.checkForTimeout(J);if(!w){if(D.messageConfiguration){c.loadMessageConfiguration(D.messageConfiguration.definitions,R);}}else{M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorLoadingAnalyticalConfig,rawText:"Timeout error when loading message configuration file"+U});m.putMessage(M);}}}function j(r){var M;if(!r||!r.path){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"persistence path configuration is missing in the application configuration"});m.putMessage(M);}if(!r.path.service){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"service in persistence path configuration is missing"});m.putMessage(M);}if(!r.logicalSystem){M=m.createMessageObject({code:sap.apf.core.constants.message.code.warningAnalyticalConfig,rawText:"logical system configuration is missing in the application configuration"});m.putMessage(M);}else if(!r.logicalSystem.service&&r.logicalSystem.service!==null){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"service is missing in logical system configuration  in the application configuration"});m.putMessage(M);}if(r.analyticalConfiguration){if(!r.analyticalConfiguration.service){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"service or entity set are missing in analytical configuration in the application configuration"});m.putMessage(M);}}}function k(r){var M;if(r.evaluations&&!r.evaluations.service){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"service in Smart Business service root configuration is missing"});m.putMessage(M);}if(r.evaluations&&(!r.evaluations.type||r.evaluations.type!=="smartBusinessRequest")){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"type in Smart Business configuration is not smartBusinessRequest"});m.putMessage(M);}if(r.evaluations&&!r.evaluations.entityType){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"entityType in Smart Business service root configuration is missing"});m.putMessage(M);}}this.getResourceLocation=function(r){return h.getItem(r);};this.getPersistenceConfiguration=function(){m.check(b,"RessourcePathHandler: configuration must be loaded before access to ressources");return p;};this.getConfigurationProperties=function(){m.check(b,"RessourcePathHandler: configuration must be loaded before access to ressources");return C;};function n(){var r=sap.apf.core.utils.uriGenerator;var v,w,x;var y=i.manifests.manifest;var z=i.manifests.baseManifest;if(b){return;}if(c.getStartParameterFacade().getAnalyticalConfigurationId()){I=true;}var A=r.getBaseURLOfComponent(i.manifests.baseManifest.name);var B=r.getBaseURLOfComponent(i.manifests.manifest.name);a=y["sap.app"].id;if(y["sap.app"].dataSources&&y["sap.app"].dataSources.PathPersistenceServiceRoot){x=y["sap.app"].dataSources.PathPersistenceServiceRoot.uri;}var D=z["sap.app"].i18n;D=r.addRelativeToAbsoluteURL(A,D);var E=y["sap.app"].i18n;E=r.addRelativeToAbsoluteURL(B,E);var F=y["sap.app"].title;F=F.replace(/[{}]/g,"");var G="";if(y["sap.app"].dataSources&&y["sap.app"].dataSources.AnalyticalConfigurationLocation){G=y["sap.app"].dataSources.AnalyticalConfigurationLocation.uri;G=r.addRelativeToAbsoluteURL(B,G);}var H={"appName":F,"appTitle":F,"analyticalConfigurationLocation":G,"textResourceLocations":{"apfUiTextBundle":D,"applicationUiTextBundle":E},"persistence":{"path":{"service":x}}};if(y["sap.apf"]&&y["sap.apf"].appSpecificParameters){for(v in y["sap.apf"].appSpecificParameters){H[v]=y["sap.apf"].appSpecificParameters[v];}}if(u()){P=sap.apf.core.LayeredRepositoryProxy;}if(y["sap.app"].dataSources&&y["sap.app"].dataSources.SmartBusiness){w=y["sap.app"].dataSources.SmartBusiness.uri;H.smartBusiness={runtime:{service:w}};}if(y["sap.app"].dataSources&&y["sap.app"].dataSources.LogicalSystem){H.persistence.logicalSystem={service:y["sap.app"].dataSources.LogicalSystem.uri};}q({applicationConfiguration:H});f();if(I){l();}else{e();}b=true;}function o(){var A=c.getUriGenerator().getApfLocation();h.setItem(sap.apf.core.constants.resourceLocation.apfUiTextBundle,A+"resources/i18n/apfUi.properties");h.setItem(sap.apf.core.constants.resourceLocation.applicationMessageDefinitionLocation,"");h.setItem(sap.apf.core.constants.resourceLocation.applicationMessageTextBundle,"");h.setItem(sap.apf.core.constants.resourceLocation.applicationUiTextBundle,"");h.setItem(sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation,"");}function q(r){function v(A){C=jQuery.extend(true,{},A);delete C.type;delete C.analyticalConfigurationLocation;delete C.applicationMessageDefinitionLocation;delete C.textResourceLocations;delete C.persistence;}var A=r.applicationConfiguration;v(A);var T=r.applicationConfiguration.textResourceLocations;p=r.applicationConfiguration.persistence;j(p);if(!p.path.entitySet){p.path.entitySet=sap.apf.core.constants.entitySets.analysisPath;}if(r.applicationConfiguration.smartBusiness){s=r.applicationConfiguration.smartBusiness;k(s);}var M;var U;var w;for(w in sap.apf.core.constants.resourceLocation){if(!sap.apf.core.constants.resourceLocation.hasOwnProperty(w)){continue;}if(A[w]!==undefined){U=A[w];}else if(T[w]!==undefined){U=T[w];}else{continue;}if(i.fileExists.check(U)){h.setItem(w,U);}else if(!I){M=m.createMessageObject({code:sap.apf.core.constants.message.code.wrongRessourcePath,rawText:"The path "+U+" for resource location "+w+"is not valid."});m.putMessage(M);}}}if(i.manifests&&i.manifests.manifest){n();}};}());
