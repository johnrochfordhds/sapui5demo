/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.metadata");jQuery.sap.require("sap.apf.utils.utils");jQuery.sap.require("sap.apf.core.utils.fileExists");(function(){'use strict';sap.apf.core.Metadata=function(I,a){this.type="metadata";var t=this;var c=I.coreApi;var A=[];var H=I.hashtable;var h=new H(I.messageHandler);var o=new H(I.messageHandler);var b=new H(I.messageHandler);var d=new H(I.messageHandler);var e=new H(I.messageHandler);var f=new H(I.messageHandler);var g=new H(I.messageHandler);var j=new H(I.messageHandler);var k=new H(I.messageHandler);var l=new H(I.messageHandler);var m=new H(I.messageHandler);var O=I.ODataModel||sap.ui.model.odata.ODataModel;var D=false;if(I.deactivateFatalError){D=true;}var M;var E;var s;function n(){return A;}function p(i){var L;function N(Q){if(!L.dataType){L.dataType={};}L.dataType[Q]=L[Q];delete L[Q];}function P(Q,R){if(jQuery.isArray(L[R])===true){(L[R]).forEach(function(S){L[S.name]=S.value;});delete L[R];}else if(R!=="dataType"&&typeof(L[R])==="object"){if(Object.keys(L[R]).length===0){L[Q]="true";}jQuery.each(L[R],function(S,T){L[Q]=T;});delete L[R];}else{L[Q]=L[R];}}if(i===null){return{};}L=jQuery.extend(true,{},i);jQuery.each(L,function(Q){switch(Q){case'type':N(Q);break;case'maxLength':N(Q);break;case'precision':N(Q);break;default:var R=Q.split(".").pop();if(R.search("ISO")===0){P(R,Q);}else{P(R.replace(/^./,R[0].toLowerCase()),Q);}break;}});r(L);return L;}function r(L){for(var i in L){if(/^sap:/.test(i)){delete L[i];}}}function q(i,L){if(d.hasItem(i)!==true){var N;var P={};var R={allParameters:[],keyParameters:[]};if(z(i)){N=J(i);if(N.key&&N.key.propertyRef){N.key.propertyRef.forEach(function(Q){P[Q.name]=null;});}N.property.forEach(function(Q){var S=p(Q);S.isKey=P.hasOwnProperty(S.name);R.allParameters.push(S);if(S.isKey){R.keyParameters.push(S);}});}d.setItem(i,R);}if(!L){return d.getItem(i).allParameters;}return d.getItem(i).keyParameters;}function u(i){var P=[];var L;if(z(i)){i=G(i);}L=J(i);L.property.forEach(function(N){P.push(N.name);});return P;}function v(L){var i;if(b.hasItem(L)===true){return b.getItem(L);}var N;var P=[];var Q=[];var R=G(L);if(R&&B(R)){var S=J(R);S.property.forEach(function(U){P.push(U.name);});}var T=q(L,false);for(i=0;i<T.length;i++){Q.push(T[i].name);}N=P.concat(Q);b.setItem(L,N);return N;}function w(i){return f.getItem(i);}function x(i){var L;if(J(i)){L=i;}else{L=w(i);L=L||w(i+"Results");}return L;}function y(i){if(o.hasItem(i)===false){var R=[];if(B(i)){var L=J(i);L.property.forEach(function(N){if(!(N["sap:filterable"]==="false"||N.filterable&&N.filterable==="true")){R.push(N.name);}});}o.setItem(i,R);}return o.getItem(i);}function z(i){return C(i)==="parameters";}function B(i){return C(i)==="aggregate";}function C(i){if(!g.hasItem(i)){var L=J(i);var N=L&&L["sap:semantics"]||"undefined";g.setItem(i,N);}return g.getItem(i);}function F(i,P){if(h.hasItem(i+P)===false){var L=z(i);var N=J(i);var Q=M.getODataProperty(N,P);if(!Q&&L){var R=G(i);N=J(R);Q=M.getODataProperty(N,P);}h.setItem(i+P,p(Q));}return h.getItem(i+P);}function G(i){var R=k.getItem(i);if(R){return w(R.toAggregateEntitySet);}return i;}function J(i){if(!i){return undefined;}if(!m.hasItem(i)){var L=M.getODataEntityType(E+i);if(!L){return L;}m.setItem(i,L);}return m.getItem(i);}function K(){var i=S();var L;if(!i.getServiceMetadata()){L="5018";if(D){L="11013";}I.messageHandler.putMessage(I.messageHandler.createMessageObject({code:L,aParameters:[a],oCallingObject:t}));t.failed=true;return;}M=i.getMetaModel();N();P();Q(i);R();function N(){var T={};M.getODataEntityContainer().entitySet.forEach(function(U){var V=U.entityType.split(/[. ]+/).pop();f.setItem(U.name,V);if(!T.hasOwnProperty(V)){T[V]=true;A.push(V);}});}function P(){var T=M.getODataEntityContainer().entitySet[0].entityType.split(".");T.pop();E=T.join(".")+".";}function Q(T){var U=T.getServiceAnnotations();if(U&&U.aliasDefinitions&&U.aliasDefinitions.Capabilities){s=U.aliasDefinitions.Capabilities+".";}}function R(){var T=M.getODataEntityContainer();if(!T.associationSet){return;}T.associationSet.forEach(function(U){var V=U.end[0].entitySet,W=U.end[1].entitySet,X,Y;if(z(w(V))){X=V;}else if(B(w(V))){Y=V;}if(z(w(W))){X=W;}else if(B(w(W))){Y=W;}if(!X||!Y){return;}var Z;var $=J(w(X));var _;$.navigationProperty.forEach(function(b1){if(_){return;}if(b1.relationship===U.association){Z=b1.name;_=true;}});if(!Z){return;}var a1={navigationProperty:Z,fromParameterEntitySet:X,toAggregateEntitySet:Y,fromIsUnique:undefined,toIsUnique:undefined};if(j.hasItem(X)){a1.fromIsUnique=false;j.getItem(X).fromIsUnique=false;}else{a1.fromIsUnique=true;j.setItem(X,a1);k.setItem(w(X),a1);}if(l.hasItem(Y)){l.getItem(Y).toIsUnique=false;}else{a1.toIsUnique=true;l.setItem(Y,a1);}});}function S(){var T;var U=c.getUriGenerator().getODataPath(a)+"annotation.xml";var V=I.fileExists.check(U);if(V){T={loadMetadataAsync:false,annotationURI:U,json:true};}else{T={loadMetadataAsync:false,json:true};}return new O(a,T);}}this.getPropertyMetadata=function(i,P){I.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getPropertyMetadata incorrect EntityType name or type");I.messageHandler.check(P!==undefined&&typeof P==="string","sap.apf.core.Metadata:getPropertyMetadata incorrect sPropertyName name or type");var L=x(i);if(!L){return{};}return F(L,P);};this.getUriComponents=function(i){if(!w(i)){if(w(i+"Results")){return{entitySet:i+"Results",navigationProperty:""};}return null;}var R;switch(C(w(i))){case"undefined":return{entitySet:i,navigationProperty:""};case"parameters":R=j.getItem(i);if(!R||R.fromIsUnique===false){return{entitySet:i,navigationProperty:undefined};}return{entitySet:i,navigationProperty:R.navigationProperty};case"aggregate":R=l.getItem(i);if(!R){return{entitySet:i,navigationProperty:""};}if(R.toIsUnique===false){return{entitySet:undefined,navigationProperty:undefined};}return{entitySet:R.fromParameterEntitySet,navigationProperty:R.navigationProperty};default:I.messageHandler.check(false,"metadata : getUriComponents - not handled return value for sap semantics");}};this.getFilterableProperties=function(i){I.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getFilterableProperties incorrect EntityType name or type");var L=x(i);if(!L){return[];}L=G(L);return y(L);};this.getAllPropertiesOfEntitySet=function(i){I.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getAllPropertiesOfEntitySet incorrect EntitySet name or type");var L=x(i);return u(L);};this.getAllProperties=function(){var i=[];var L;n().forEach(function(N){L=v(N);if(L.length===0){L=u(N);}i=i.concat(L);});i=sap.apf.utils.eliminateDuplicatesInArray(I.messageHandler,i);return i;};this.getParameterEntitySetKeyPropertiesForService=function(){var i=[];n().forEach(function(L){q(L,true).forEach(function(N){i.push(N.name);});});i=sap.apf.utils.eliminateDuplicatesInArray(I.messageHandler,i);return i;};this.getAllKeys=function(){var i=[];var L=[];n().forEach(function(N){if(!z(N)&&!B(N)){return;}var P=J(N);L=[];if(P.key&&P.key.propertyRef){P.key.propertyRef.forEach(function(Q){L.push(Q.name);});}i=i.concat(L);});i=sap.apf.utils.eliminateDuplicatesInArray(I.messageHandler,i);return i;};this.getAttributes=function(P){var i=false;var L;n().forEach(function(N){if(i){return;}L=F(N,P);if(L.name){i=true;}});return L;};this.getParameterEntitySetKeyProperties=function(i){I.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getParameterEntitySetKeyProperties incorrect EntityType name or type");var L=x(i);if(!L){return[];}return q(L,true);};this.getEntityTypeAnnotations=function(i){var L=x(i);I.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getEntityTypeAnnotations incorrect EntityType name or type");if(e.hasItem(L)===true){return e.getItem(L);}var N={};Q(L,N);var P=G(L);if(P!==L){Q(P,N);}e.setItem(L,N);return e.getItem(L);function Q(L,R){var S;var T;var U;var V=J(L);for(S in V){if(S.indexOf(s)!==0){continue;}T=S.split(".").pop();T=T.replace(/^./,T[0].toLowerCase());for(U in V[S]){R[T]=V[S][U];}}}};this.getEntitySets=function(){var i={};var L=[];var N=M.getODataEntityContainer();if(N.associationSet){N.associationSet.forEach(function(P){var Q,R,S;Q=x(P.end[0].entitySet);if(!z(Q)){return;}S=P.end[1].entitySet;R=x(S);if(!z(R)){i[S]=true;}});}if(N.entitySet){N.entitySet.forEach(function(P){if(!i[P.name]){L.push(P.name);}});}return L;};K();};}());
