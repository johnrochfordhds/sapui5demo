jQuery.sap.declare("sap.apf.core.layeredRepositoryProxy");jQuery.sap.require('sap.apf.utils.utils');jQuery.sap.require("sap.ui.thirdparty.datajs");jQuery.sap.require('sap.apf.core.constants');jQuery.sap.require('sap.apf.utils.hashtable');jQuery.sap.require('sap.ui.fl.LrepConnector');jQuery.sap.require('sap.apf.utils.parseTextPropertyFile');(function(){'use strict';sap.apf.core.LayeredRepositoryProxy=function(s,a){var c=a.instance.coreApi;var b;var m=a.instance.messageHandler;var n='sap/apf/dt';var t='text.properties';var d=new sap.apf.utils.Hashtable(a.instance.messageHandler);var e=new sap.apf.utils.Hashtable(a.instance.messageHandler);this.getConnector=function(){return b;};this.readEntity=function(L,M,N,O,P,Q,R){var S=N[0].value;var T=r(Q);var U=[];var V=false;var W=1;var X=0;var Y;var Z;var $;var i;var _;var a1;var b1;var c1;var d1=o(R);a.instance.messageHandler.check(L==='configuration',"layered repository proxy - only read entity of configuration supported");if(P!==undefined&&P===false){return K(M,S,Q,O,R);}if(O===undefined||O.indexOf("SerializedAnalyticalConfiguration")>=0){V=true;var e1=b.getStaticResource(T,S,'apfconfiguration');U.push(e1);}else{W=0;}Y=k(Q,S);if(Y===undefined){var f1=b.getFileAttributes(T,S,'apfconfiguration',d1);U.push(f1);}Z=Promise.all(U);Z.then(function(g1){Y=k(Q,S);if(Y===undefined){Y=g1[W].response;}l(Q,S,Y);$=E(Q,Y);if(V){c1=g1[X].response;if(c1 instanceof String){$.SerializedAnalyticalConfiguration=c1;}else{$.SerializedAnalyticalConfiguration=JSON.stringify(c1);}}$.AnalyticalConfiguration=S;if(O&&O.length!==0){_=O.length;a1={};for(i=0;i<_;i++){b1=O[i];a1[b1]=$[b1];}$=a1;}M($,q());},function(g1){M(undefined,q(),p('5201'));});};this.doChangeOperationsInBatch=function(L,M,N){function O(R,S){M(S);}var i,P;function Q(){}w(N).then(function(){for(i=0;i<L.length;i++){P=L[i];P.application=N;if(P.method==='DELETE'&&P.entitySetName==='texts'){u(P,Q);}else if(P.method==='POST'&&sap.apf.utils.isValidPseudoGuid(P.data.TextElement)){x(P.data,Q);}else{x(P.data,Q);}}y(N,O,true);}).fail(function(R){M(R);});};this.readCollectionsInBatch=function(L,M,N){var O=L.length;var P=[];var Q=0;function R(T){function U(V,W,X){if(X){M(undefined,X);}else{Q++;P[T]=V;if(Q===O){M(P);}}}return U;}for(var i=0;i<O;i++){var S=L[i];this.readCollection(S.entitySetName,R(i),S.inputParameters,S.selectList,S.filter,N);}};this.readCollection=function(i,L,M,N,O,P,Q){var R=this;var T,S,U;var V;var W;if(Q&&Q.layer){W=Q.layer;}else{W="CUSTOMER";}var X=function(U){var Z=new sap.apf.utils.Hashtable(a.instance.messageHandler);var $=[];var _=(U&&U.response)||(U&&U.responseText)||"";var a1=sap.apf.utils.parseTextPropertyFile(_,{instance:{messageHandler:m}});Z=new sap.apf.utils.Hashtable(a.instance.messageHandler);a1.TextElements.forEach(function(b1){Z.setItem(b1.TextElement,b1);$.push(b1);});d.setItem(S,Z);L($,q());};if(i==='application'){m.check(!M&&!N&&!O,"unsupported parameters when calling readCollection for application");m.check(P===undefined||P===true,'no async readCollection of application supported');J(L,W);}else if(i==='texts'){T=O.getFilterTermsForProperty('Application');S=T[0].getValue();if(P!==undefined&&P===false){v(S,X,true,Q);}else{V=v(S,undefined,false,Q);V.then(function(U){X(U);},function(Z){var $=I(Error);L(undefined,q(),$);});}}else if(i==='configuration'){T=O.getFilterTermsForProperty('Application');S=T[0].getValue();U=[];var Y=function(Z,$){function _(a1,b1,$){U.push(a1);if(U.length===Z.length){L(U,q(),$);}}if(Z.length===0){L(U,q(),$);}Z.forEach(function(a1){R.readEntity('configuration',_,[{value:a1}],N,P,S);});};z(S,Y);}};this.remove=function(i,L,M,N,O,P){if(!P){P="CUSTOMER";}if(i==='application'){H(L,M,P);}else if(i==='configuration'){D(L,M,O,P);}else{m.check(false,'the remove operation on entity set '+i+' is currently not supported by the lrep proxy');}};this.create=function(i,L,M,N,O){if(i==='application'){m.check(N===undefined||N===true,'no async creation of application supported');F(L,M,O);}else if(i==='configuration'){m.check(N===undefined||N===true,'no async creation of configuration supported');C(L,M,O);}else if(i==='texts'&&N===false){x(L,M,false);}else{m.check(false,'the create operation on entity set '+i+' is currently not supported by the lrep proxy');}};this.update=function(i,L,M,N){if(i==='configuration'){B(L,M);}else if(i==='application'){G(L,M);}else{m.check(false,'the update operation on entity set '+i+' is currently not supported by the lrep proxy');}};function f(i){var O={async:true,contentType:'application/json'};var P=[];P.push({name:"layer",value:i});P.push({name:"deep-read",value:true});P.push({name:"metadata",value:true});var R="/sap/bc/lrep/content/"+n+"/";R+=b._buildParams(P);return b.send(R,'GET',{},O);}function g(i){var n=i.ns.split('/');return n[n.length-2];}function h(i,L){var M;i.metadata.forEach(function(N){if(N.name===L){M=N.value;}});return M;}this.readAllConfigurationsFromVendorLayer=function(){var i=jQuery.Deferred();var L=[];f('VENDOR').then(function(M){var N={};M.response.forEach(function(O){if(O.fileType&&O.fileType==='apfapplication'){N[g(O)]=h(O,'apfdt-applname');}});M.response.forEach(function(O){var P;var Q;var R;if(O.fileType&&O.fileType==="apfconfiguration"){P=g(O);Q=O.name;if(!(sap.apf.utils.isValidPseudoGuid(P)&&sap.apf.utils.isValidPseudoGuid(Q))){return;}R=h(O,'apfdt-configname');L.push({configurationText:R,applicationText:N[P],value:P+'.'+Q});}});i.resolve(L);},function(){i.reject(m.createMessageObject({code:'5201'}));});return i.promise();};j();function j(){if(a.constructor&&a.constructor.LrepConnector){b=a.constructor.LrepConnector.createConnector();}else{b=sap.ui.fl.LrepConnector.createConnector();}if(!b._sClient){b._sClient=c.getStartParameterFacade().getSapClient();}}function k(i,L){var M=e.getItem(i);if(M===undefined){return;}L=M.getItem(L);return L;}function l(i,L,M){var N=e.getItem(i);if(N===undefined){N=new sap.apf.utils.Hashtable(a.instance.messageHandler);}N.setItem(L,M);e.setItem(i,N);}function o(i){var L=(i&&i.layer)||"CUSTOMER";if(L==="ALL"){return undefined;}return L;}function p(i,L){return m.createMessageObject({code:i,aParameters:L});}function q(){return{};}function r(i){return n+'/'+i;}function u(i,L){var M=i.application;var N=i.inputParameters[0].value;var O;w(M).done(function(){O=d.getItem(M);O.removeItem(N);L(i,q());}).fail(function(){L(undefined,q(),p('5201'));});}function v(i,L,M,N){var O;var P=[];var R="/sap/bc/lrep/content/";var Q=o(N);R+=n+"/"+i+'/'+t;if(Q){P.push({name:"layer",value:Q});}O={contentType:'text/plain'};if(M){O.complete=L;O.async=false;}R+=b._buildParams(P);return b.send(R,'GET',undefined,O);}function w(i,L){var M=jQuery.Deferred();var N;var O=d.getItem(i);var P=function(Q){var R=(Q&&Q.response)||(Q&&Q.responseText)||"";var S=sap.apf.utils.parseTextPropertyFile(R,{instance:{messageHandler:m}});O=new sap.apf.utils.Hashtable(a.instance.messageHandler);S.TextElements.forEach(function(T){O.setItem(T.TextElement,T);});d.setItem(i,O);M.resolve({});};if(O===undefined){if(L!==undefined&&L===false){v(i,P,true);}else{N=v(i,undefined,false);N.then(function(Q){P(Q);},function(Q){M.reject(p('5201'));});}}else{M.resolve({});}return M.promise();}function x(i,L,M){var N=i.Application;if(i.TextElement===undefined||!sap.apf.utils.isValidGuid(i.TextElement)){i.TextElement=sap.apf.utils.createPseudoGuid();}w(N,M).done(function(){var O=d.getItem(N);O.setItem(i.TextElement,i);L(i,q());}).fail(function(){L(undefined,q(),p('5201'));});}function y(i,L,M){var N=r(i);var O;function P(){var R=sap.apf.utils.renderHeaderOfTextPropertyFile(i,m);R=R+sap.apf.utils.renderTextEntries(O,m);var S=b.upsert(N,'text','properties',"CUSTOMER",R,'text/plain');S.then(function(T){L(q());},function(T){L(q(),p('5201'));});}O=d.getItem(i);if(!O){L(q());return;}if(M){P();}else{var Q=v(i,undefined,false);Q.then(function(R){var S=(R&&R.response)||"";var T=sap.apf.utils.parseTextPropertyFile(S,{instance:{messageHandler:m}});T.TextElements.forEach(function(U){O.setItem(U.TextElement,U);});P();},function(R){L(q(),p('5201'));});}}function z(L,M){var i,N;var O=r(L);var P=b.listContent(O,'CUSTOMER');P.then(function(Q){var R=Q.response;N=[];for(i=0;i<R.length;i++){if(R[i].fileType==="apfconfiguration"){N.push(R[i].name);}}M(N);},function(Q){M([]);});}function A(i,L,M,N){var O=N||'CUSTOMER';var P=r(i);var Q=b.getFileAttributes(P,L,'apfconfiguration',O);Q.then(function(R){var S=R.response;if(O==='CUSTOMER'){l(i,L,S);y(i,M);}else{M(q());}},function(R){M(q(),p('5201'));});}function B(i,L,M){if(!M){M="CUSTOMER";}var N=i.Application;var O=i.AnalyticalConfiguration;var P=JSON.parse(i.SerializedAnalyticalConfiguration);var Q=r(N);var R=b.getStaticResource(Q,"metadata","apfapplication");R.then(function(S){var T={Application:N,ApplicationName:S.response.ApplicationName,SemanticObject:S.response.SemanticObject,AnalyticalConfiguration:O,AnalyticalConfigurationName:i.AnalyticalConfigurationName,CreationUTCDateTime:i.CreationUTCDateTime,LastChangeUTCDateTime:i.LastChangeUTCDateTime};P=jQuery.extend(true,P,{configHeader:T});P=JSON.stringify(P);var U=b.upsert(Q,O,'apfconfiguration',M,P,'application/json');return U;},function(S){L(q(),p('5201'));}).then(function(S){A(N,O,L,M);},function(S){L(q(),p('5201'));});}function C(i,L,M){var N=o(M);var O=i.Application;var P=i.AnalyticalConfiguration;if(P===undefined||!sap.apf.utils.isValidGuid(P)){P=sap.apf.utils.createPseudoGuid(32);}var Q=JSON.parse(i.SerializedAnalyticalConfiguration);var R=r(O);var S=b.getStaticResource(R,"metadata","apfapplication");S.then(function(U){var V={Application:O,ApplicationName:U.response.ApplicationName,SemanticObject:U.response.SemanticObject,AnalyticalConfiguration:P,AnalyticalConfigurationName:Q.analyticalConfigurationName,CreationUTCDateTime:i.CreationUTCDateTime,LastChangeUTCDateTime:i.LastChangeUTCDateTime};Q=jQuery.extend(true,Q,{configHeader:V});Q=JSON.stringify(Q);T(O,P,i.AnalyticalConfigurationName,Q,L);},function(U){L(undefined,q(),p('5201'));});function T(O,P,U,Q,L){var R=r(O);var V=b.upsert(R,P,'apfconfiguration',N,Q,'application/json');V.then(function(W){A(O,P,function(X,Y,Z){if(!Z){L({AnalyticalConfiguration:P,AnalyticalConfigurationName:i.AnalyticalConfigurationName},q());}else{L(undefined,q(),p('5201'));}},N);},function(W){L(undefined,q(),p('5201'));});}}function D(i,L,M,N){var O=i[0].value;m.check(O!==undefined,"configuration may not be undefined");m.check(M!==undefined,"application of configuration not found");var P=r(M);var Q=b.deleteFile(P,O,'apfconfiguration',N);Q.then(function(R){L(q());},function(R){L(q(),p('5201'));});}function E(L,M){var i=0;var N={Application:L};var O,P;for(i=0;i<M.length;i++){O=M[i].name;P=M[i].value;if(O==="apfdt-applname"){O="ApplicationName";}else if(O==='createdAt'){O="CreationUTCDateTime";}else if(O==='createdBy'){O="CreatedByUser";}else if(O==='lastChangedAt'){O="LastChangeUTCDateTime";}else if(O==='lastChangedBy'){O="LastChangedByUser";}else if(O==="apfdt-configname"){O='AnalyticalConfigurationName';}else if(O==='size'||O==='layer'){continue;}N[O]=P;}return N;}function F(i,L,M){m.check(i.ApplicationName!==undefined&&i.ApplicationName!=="","Valid application name is required");var N=i.Application;if(N===undefined||!sap.apf.utils.isValidGuid(N)){N=sap.apf.utils.createPseudoGuid(32);}var O=JSON.stringify({ApplicationName:i.ApplicationName,SemanticObject:i.SemanticObject,Application:N});var P=sap.apf.utils.renderHeaderOfTextPropertyFile(N,m);var Q=o(M);function R(){L(undefined,q(),p('5201'));}var S=r(N);var T=b.upsert(S,'metadata','apfapplication',Q,O,'application/json');T.then(function(U){var V=b.upsert(S,'text','properties',Q,P,'text/plain');V.then(function(W){d.setItem(N,new sap.apf.utils.Hashtable(a.instance.messageHandler));L({Application:N,ApplicationName:i.ApplicationName,SemanticObject:i.SemanticObject},q());},R);},R);}function G(i,L){m.check(i.ApplicationName!==undefined&&i.ApplicationName!=="","Valid application name is required");var M=i.Application;var N=JSON.stringify({ApplicationName:i.ApplicationName,SemanticObject:i.SemanticObject,Application:M});function O(){L(undefined,p('5201'));}var P=r(M);var Q=b.upsert(P,'metadata','apfapplication','CUSTOMER',N,'application/json');Q.then(function(R){L({Application:M,ApplicationName:i.ApplicationName,SemanticObject:i.SemanticObject});},O);}function H(i,L,M){var N=i[0].value;function O(R){var S=I(R);L(q(),S);}var P=r(N);var Q=b.listContent(P,M);Q.then(function(R){var S=R.response;var T=[];S.forEach(function(V){T.push(b.deleteFile(P,V.name,V.fileType,V.layer));});var U=Promise.all(T);return U;},O).then(function(R){L(q());},O);}function I(i){var L;if(i.messageObject&&i.messageObject.getCode){L=i.messageObject;}else if(i.response&&i.response.statusCode&&i.response.statusCode>=400){L=m.createMessageObject({code:'11005',aParameters:[i.response.statusCode.toString(),i.response.statusText]});}else{L=m.createMessageObject({code:'5201'});}m.putMessage(L);return L;}function J(i,L){var M=[];f(L).then(function(O){var P=O.response;P.forEach(function(P){var Q;var R;if(P.fileType&&P.fileType==="apfapplication"){Q=g(P);if(!sap.apf.utils.isValidPseudoGuid(Q)){return;}R="";var S="";R=h(P,'apfdt-applname');M.push({Application:Q,ApplicationName:R,SemanticObject:S});}});i(M,q());},N);function N(O){i(undefined,q(),m.createMessageObject({code:'5201'}));}}function K(i,L,M,N,O){var P=o(O);var Q={async:false,complete:function(U){var V={};V.SerializedAnalyticalConfiguration=U.responseText;i(V,q());}};var R=[];var S;var T="/sap/bc/lrep/content/";a.instance.messageHandler.check(N===undefined||N.indexOf("SerializedAnalyticalConfiguration")>=0,"layered repository proxy - read configuration async without analytical configuration - not supported call");T+=n+"/"+M+'/'+L+'.apfconfiguration';if(P){R.push({name:"layer",value:P});}T+=b._buildParams(R);S=b.send(T,'GET',{},Q);S.then(function(U){},function(U){i(undefined,q(),p('5201'));});}};}());
