/*
 * Created by d025375 on 24.05.2015.
 * Copyright(c) 2015 SAP SE
 */
jQuery.sap.declare('sap.apf.core.utils.filterSimplify');jQuery.sap.require('sap.apf.core.utils.filter');jQuery.sap.require('sap.apf.core.utils.filterTerm');jQuery.sap.require('sap.apf.core.constants');jQuery.sap.require('sap.apf.core.messageHandler');(function(){'use strict';sap.apf.core.utils.CollectPropertiesAndValuesVisitor=function(){var t=this;var p=[];var v=[];var a=true;var b=true;var n=0;var c=0;var d=0;var e=0;function f(g){var i,l=p.length;for(i=0;i<l;i++){if(p[i]===g){return;}}p.push(g);}this.getProperties=function(){return p.slice(0);};this.getValues=function(){return v.slice(0);};this.isWellFormed=function(){return a&&b&&p.length<=1;};this.isEmptyFilter=function(){return n===0&&c===0&&d>0&&e===0;};this.processEmptyFilter=function(){d++;};this.processAnd=function(g,F){n++;b=false;this.process(g);this.processAndArray(F);};this.processAndArray=function(F){F.forEach(function(g){t.process(g);});};this.processOr=function(g,F){c++;this.process(g);this.processOrArray(F);};this.processOrArray=function(F){F.forEach(function(g){t.process(g);});};this.processTerm=function(g){e++;var h=g.getProperty();f(h);switch(g.getOp()){case sap.apf.core.constants.FilterOperators.EQ:v.push(g.getValue());return;default:a=false;return;}};this.process=function(g){if(g instanceof sap.apf.core.utils.FilterTerm){this.processTerm(g);}else{g.traverse(this);}};};sap.apf.core.utils.CollectChildrenOfAndNodeVisitor=function(){this.processEmptyFilter=function(){return null;};this.processTerm=function(t){return[t];};this.processAnd=function(f,F){var r=[];r.push(f);F.forEach(function(a){r.push(a);});return r;};this.processOr=function(){return null;};this.process=function(f){if(f instanceof sap.apf.core.utils.FilterTerm){this.processTerm(f);}else{return f.traverse(this);}};};sap.apf.core.utils.FilterReduction=function(){var t=this;this.transformFilter=function(f){var T=[];var p;var c;if(f){f.forEach(function(a){if(a instanceof sap.apf.core.utils.FilterTerm){T.push({property:a.getProperty(),values:[a.getValue()]});}else if(a instanceof sap.apf.core.utils.Filter){p=a.getProperties();c=new sap.apf.core.utils.CollectPropertiesAndValuesVisitor();c.process(a);T.push({property:p[0],values:c.getValues()});}});}return T;};this.intersection=function(a,b){var r={};var l=a.values;var c=b.values;var d=[];var e={};var i,f=l.length;var j,g=c.length;for(i=0;i<f;i++){e[l[i]]=l[i];}for(j=0;j<g;j++){if(e[c[j]]!==undefined&&d.indexOf(c[j])<0){d.push(c[j]);}}r.property=a.property;r.values=d;return r;};function F(m){this.reducers=[];this.disjunctions=[];this.processTerm=function(a){var w=new sap.apf.core.utils.Filter(m,a);if(a.getOp()===sap.apf.core.constants.FilterOperators.EQ){this.disjunctions.push(w);}else{this.reducers.push(w);}};this.processOr=function(l,f,o){var i=new sap.apf.core.utils.CollectPropertiesAndValuesVisitor();i.process(o);if(i.isWellFormed()){this.disjunctions.push(o);}else{this.reducers.push(o);}};this.processAnd=function(l,f,a){var s=t.filterSeparation(a,m);this.disjunctions=this.disjunctions.concat(s.disjunctions);this.reducers=this.reducers.concat(s.reducers);};this.processEmptyFilter=function(){};this.process=function(a){a.traverse(this);};}this.filterSeparation=function(f,m){var c=new sap.apf.core.utils.CollectChildrenOfAndNodeVisitor();var a=c.process(f);var v;if(!a){return{reducers:[],disjunctions:[]};}v=new F(m);a.forEach(function(e){e.traverse(v);});return{reducers:v.reducers,disjunctions:v.disjunctions};};this.simplifyTransforms=function(T){var s=[];var r;var p=[];var l=T.length;var n;T.forEach(function(a,i){var j;n=a.property;if(p.indexOf(n)===-1){p.push(n);r=a;for(j=i+1;j<l;++j){if(n===T[j].property){r=t.intersection(r,T[j]);}}s.push(r);}});return s;};this.applyStartFilter=function(s,T){var r=[];var p=s.getProperties();T.forEach(function(a){var R=[];var j;var l=a.values.length;var v;if(p.indexOf(a.property)>-1){for(j=0;j<l;j++){v=a.values[j];if(s.isConsistentWithFilter(a.property,v)){R.push(v);}}r.push({property:a.property,values:R});}else{r.push(a);}});return r;};this.simplifyInStartFilter=function(s,T){var r=s;T.forEach(function(a){if(r){r=r.removeTermsByProperty(a.property);}});return r;};this.containsContradiction=function(m,T){var i=false;T.forEach(function(a){if(a.values.length===0){i=true;}});if(i){return i;}return i;};this.rebuildDisjunction=function(m,a){var r=new sap.apf.core.utils.Filter(m);var p=a.property;var v=a.values;v.forEach(function(b){var f=new sap.apf.core.utils.FilterTerm(m,p,sap.apf.core.constants.FilterOperators.EQ,b);r.addOr(f);});return r;};this.filterReduction=function(m,f){var c=this;function a(R){var g=[];R.forEach(function(h){g.push(t.rebuildDisjunction(m,h));});return g;}function b(g,h){h.forEach(function(i){g.addAnd(i);});}function d(g,h){var i;var R=h;var j=[];var k;for(i=0;i<g.length;++i){R=c.applyStartFilter(g[i],h);if(c.containsContradiction(m,R)){return{contradiction:f};}k=c.simplifyInStartFilter(g[i],h);if(k){j.push(k);}}return{reducedTransforms:R,simplifiedReducers:j};}var s;var D;var T;var S;var r;var e;if(f.isFilterTerm()||f.isOr()||f.isEmpty()){return f;}s=this.filterSeparation(f,m);D=s.disjunctions;T=this.transformFilter(D);S=this.simplifyTransforms(T);if(this.containsContradiction(m,S)){return f;}e=d(s.reducers,S);if(e.contradiction){return e.contradiction;}r=new sap.apf.core.utils.Filter(m);b(r,e.simplifiedReducers);b(r,a(e.reducedTransforms));return r;};};}());
