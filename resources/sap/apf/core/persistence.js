/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.persistence");jQuery.sap.require("sap.apf.core.constants");(function(){'use strict';sap.apf.core.Persistence=function(I){var t=this;var l;this.createPath=function(n,C,E){var R;var S=I.coreApi.serializePath();if(E){S.filterIdHandler=E.filterIdHandler;S.startFilterHandler=E.startFilterHandler;}var o=d(S);h().then(function(l){R={data:{AnalysisPath:"",AnalysisPathName:n,LogicalSystem:l,ApplicationConfigurationURL:I.coreApi.getApplicationConfigurationURL(),SerializedAnalysisPath:JSON.stringify(S),StructuredAnalysisPath:JSON.stringify(o)},method:"POST"};if(I.coreApi.getStartParameterFacade().getAnalyticalConfigurationId()){R.data.AnalyticalConfiguration=I.coreApi.getStartParameterFacade().getAnalyticalConfigurationId().configurationId;}s(R,i.bind(t));},function(m){C({oResponse:undefined,status:"failed"},{},m);});function i(j,k,m){if(m){C({oResponse:j,status:"failed"},k,m);}else{I.messageHandler.check(j&&j.data&&j.statusCode===201&&j.statusText==="Created","Persistence create Path - proper response");C({AnalysisPath:j.data.AnalysisPath,status:"successful"},k,m);}}};this.readPaths=function(C){var R={method:"GET"};s(R,j.bind(this));function j(o,E,m){if(!m&&o&&o.data&&o.data.results){for(var i in o.data.results){o.data.results[i].StructuredAnalysisPath=JSON.parse(o.data.results[i].StructuredAnalysisPath);}}else if(!m||o.statusCode!==200||o.statusText!=="OK"){m=I.messageHandler.createMessageObject({code:'5211'});}if(m){C({oResponse:o,status:"failed"},E,m);}else{C({paths:o.data.results,status:"successful"},E,m);}}};this.deletePath=function(A,C){var R={method:"DELETE"};s(R,i.bind(this),A);function i(o,E,m){if((o.statusCode!==204||o.statusText!=="No Content")&&(!m)){m=I.messageHandler.createMessageObject({code:5201});m.setPrevious(I.messageHandler.createMessageObject({code:5200,aParameters:[o.statusCode,o.statusText]}));}if(m){C({oResponse:o,status:"failed"},E,m);}else{C({status:"successful"},E,m);}}};this.modifyPath=function(A,n,C,E){var S=I.coreApi.serializePath();if(E){S.filterIdHandler=E.filterIdHandler;S.startFilterHandler=E.startFilterHandler;}var o=d(S);h().then(function(l){var i={data:{AnalysisPathName:n,LogicalSystem:l,ApplicationConfigurationURL:I.coreApi.getApplicationConfigurationURL(),SerializedAnalysisPath:JSON.stringify(S),StructuredAnalysisPath:JSON.stringify(o)},method:"PUT"};s(i,R.bind(this),A);},function(m){C({oResponse:undefined,status:"failed"},{},m);});function R(i,j,m){if((i.statusCode!==204||i.statusText!=="No Content")&&(!m)){m=I.messageHandler.createMessageObject({code:5201});m.setPrevious(I.messageHandler.createMessageObject({code:5200,aParameters:[i.statusCode,i.statusText]}));}if(m){C({oResponse:i,status:"failed"},j,m);}else{C({AnalysisPath:A,status:"successful"},j,m);}}};this.openPath=function(A,C,n){var R={method:"GET"};s(R,i.bind(this),A);function i(o,E,m){var M;if(!m&&o&&o.statusCode===200&&o.data&&o.data.SerializedAnalysisPath){o.data.SerializedAnalysisPath=JSON.parse(o.data.SerializedAnalysisPath);m=a(o.data,n);}if(m){M=I.messageHandler.createMessageObject({code:'5210'});M.setPrevious(m);I.messageHandler.putMessage(M);}if(M){C({oResponse:o,status:"failed"},E,M);}else{C({path:o.data,status:"successful"},E,M);}}};function s(R,L,A){var S=function(D,o){L(o,e(),undefined);};var E=function(o){var m;if(o.messageObject&&o.messageObject.getCode&&o.messageObject.getCode()===5021){L(o,e(),o.messageObject);return;}var i=c(o.response.body);if(i!==undefined){m=I.messageHandler.createMessageObject({code:i});}if(o.response.body.match("274")){m=I.messageHandler.createMessageObject({code:'5207'});}if(o.response.statusCode===400){m=I.messageHandler.createMessageObject({code:'5203'});}if(o.response.statusCode===403){m=I.messageHandler.createMessageObject({code:'5206'});}if(o.response.statusCode===405){m=I.messageHandler.createMessageObject({code:'5202'});}if(o.response.statusCode===404){m=I.messageHandler.createMessageObject({code:'5208'});}if(!m&&o.response.statusCode===500){m=I.messageHandler.createMessageObject({code:'5200',aParameters:[o.response.statusCode,o.response.statusText]});}if(!m){m=I.messageHandler.createMessageObject({code:'5201'});}I.messageHandler.putMessage(m);L(o,e(),m);};var u=I.coreApi.getPersistenceConfiguration().path.service+"/"+I.coreApi.getPersistenceConfiguration().path.entitySet;R.headers={"x-csrf-token":I.coreApi.getXsrfToken(I.coreApi.getPersistenceConfiguration().path.service)};switch(R.method){case"GET":if(!R.data&&A){R.requestUri=u+"('"+A+"')";I.coreApi.odataRequest(R,S,E);}else if(!R.data&&!A){g().then(function(i){R.requestUri=u+i;I.coreApi.odataRequest(R,S,E);},function(m){L({},e(),m);});}break;case"POST":if(R.data&&!A){R.requestUri=u;}I.coreApi.odataRequest(R,S,E);break;case"DELETE":if(!R.data&&A){R.requestUri=u+"('"+A+"')";}I.coreApi.odataRequest(R,S,E);break;case"PUT":if(R.data&&A){R.requestUri=u+"('"+A+"')";}I.coreApi.odataRequest(R,S,E);break;default:I.coreApi.odataRequest(R,S,E);break;}}function g(){var i=jQuery.Deferred();h().then(function(l){var j="";if(I.coreApi.getStartParameterFacade().getAnalyticalConfigurationId()){j="AnalyticalConfiguration%20eq%20'"+I.coreApi.getStartParameterFacade().getAnalyticalConfigurationId().configurationId+"'%20and%20";}var u="?$select=AnalysisPath,AnalysisPathName,StructuredAnalysisPath,CreationUTCDateTime,LastChangeUTCDateTime&$filter=("+j+"LogicalSystem%20eq%20'"+l+"'%20and%20"+"ApplicationConfigurationURL%20eq%20'"+I.coreApi.getApplicationConfigurationURL()+"')"+"&$orderby=LastChangeUTCDateTime%20desc";i.resolve(u);},function(m){i.fail(m);});return i.promise();}function c(E){var i=E.match("52[0-9]{2}");if(i){return i[0];}return undefined;}function a(R,n){var p;var m;function i(){I.messageHandler.putMessage=p;}function j(){p=I.messageHandler.putMessage;I.messageHandler.putMessage=function(m){var k=I.messageHandler.getConfigurationByCode(m.getCode());if(k&&k.severity&&k.severity==="warning"){return;}throw m;};}if(n!==undefined){R.SerializedAnalysisPath.path.indicesOfActiveSteps[0]=n;}I.coreApi.resetPath(true);j();try{I.coreApi.deserializePath(R.SerializedAnalysisPath);}catch(E){I.coreApi.restoreOriginalPath();m=b(E);}finally{i();}return m;}function b(E){var m;if(E.type&&E.type==="messageObject"){m=E;}else{m=new sap.apf.core.MessageObject({code:sap.apf.core.constants.message.code.errorUnknown});m.setSeverity(sap.apf.core.constants.message.severity.error);m.setMessage("Unknown exception caught "+E.message);}return m;}function d(S){var j=[];var k=S.path.steps;var m;for(var i in k){j.push({stepId:k[i].stepId,selectedRepresentationId:k[i].binding.selectedRepresentationId});}m={steps:j,indexOfActiveStep:S.path.indicesOfActiveSteps[0]};return m;}function e(){var C=I.coreApi.getPersistenceConfiguration();var E=I.coreApi.getEntityTypeMetadata(C.path.service,C.path.entitySet);return E;}function f(C){var T=C&&C.getFilterTermsForProperty('SAPClient');if(T===undefined||T.length!==1){return undefined;}return T[0].getValue();}function r(i,j){var m=I.messageHandler;var k=I.coreApi.getPersistenceConfiguration().logicalSystem;if(!k){l=j;i.resolve(j);return i.promise();}var S=k.service;var E=k.entitySet||k.entityType;if(S===null){l=j;i.resolve(j);return i.promise();}if(E===undefined){E=sap.apf.core.constants.entitySets.logicalSystem;}var F=new sap.apf.core.utils.Filter(m,"SAPClient",'eq',j);var u=I.coreApi.getUriGenerator().getAbsolutePath(S);u=u+I.coreApi.getUriGenerator().buildUri(m,E,['LogicalSystem'],F,undefined,undefined,undefined,undefined,undefined,'Results');var R={requestUri:u,method:"GET",headers:{"x-csrf-token":I.coreApi.getXsrfToken(S)}};var o=function(D){var p;if(D&&D.results&&D.results instanceof Array&&D.results.length===1&&D.results[0].LogicalSystem){l=D.results[0].LogicalSystem;i.resolve(l);}else{p=m.createMessageObject({code:"5026",aParameters:[j]});i.fail(p);}};var n=function(p){var q=m.createMessageObject({code:"5026",aParameters:[j]});if(p.messageObject!==undefined&&p.messageObject.type==="messageObject"){q.setPrevious(p.messageObject);}i.fail(q);};I.coreApi.odataRequest(R,o,n);}function h(){var i=jQuery.Deferred();if(l){i.resolve(l);return i.promise();}var j=I.coreApi.getStartParameterFacade().getSapClient();if(j){r(i,j);return i.promise();}I.coreApi.getCumulativeFilter().done(function(C){j=f(C);if(!j){i.resolve('');}else{r(i,j);}});return i.promise();}};}());
