/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.messageHandler");jQuery.sap.require("sap.apf.core.messageObject");jQuery.sap.require("sap.apf.utils.hashtable");jQuery.sap.require("sap.apf.core.constants");(function(){'use strict';sap.apf.core.MessageHandler=function(l){var t=this;var T;var L=[];var n=0;var a;var m;var A=function(){};var o=false;var d=false;var D=false;var h=false;var u="";var b={code:sap.apf.core.constants.message.code.errorUnknown,severity:sap.apf.core.constants.message.severity.error,rawText:"Unknown Error occurred"};this.createMessageObject=function(C){if(l){var M=new sap.apf.core.MessageObject(C);if(M.getCode()===undefined){M.setCode(sap.apf.core.constants.message.code.errorUnknown);}p.bind(this)(M);q(M,1);}return new sap.apf.core.MessageObject(C);};this.activateOnErrorHandling=function(O){o=O;if(o===true){jQuery(window).on("error",v);}else{jQuery(window).off("error");}};this.setTextResourceHandler=function(i){T=i;};this.loadConfig=function(M,R){if(a===undefined||R){a=new sap.apf.utils.Hashtable(t);}for(var i=0;i<M.length;i++){r(M[i]);}};this.setMessageCallback=function(C){if(C!==undefined&&typeof C==="function"){m=C;}else{m=undefined;}};this.setApplicationMessageCallback=function(C){if(C!==undefined&&typeof C==="function"){A=C;}else{A=function(){};this.putMessage(this.createMessageObject({code:"5031"}));}};this.putMessage=function(M){var P;var i=0;var x;if(M.getCode()===undefined){M.setCode(sap.apf.core.constants.message.code.errorUnknown);}p.bind(this)(M);if(M.getSeverity()===sap.apf.core.constants.message.severity.fatal){x=t.createMessageObject({code:sap.apf.core.constants.message.code.errorExitTriggered});p.bind(this)(x);x.setSeverity(sap.apf.core.constants.message.severity.fatal);if(x.getMessage()===""){x.setMessage("You must log out of the application due to a critical error");}}P=M.getPrevious();while(P!==undefined&&P.type&&P.type==="messageObject"&&i<10){if(P.getCode()===undefined){P.setCode(sap.apf.core.constants.message.code.errorUnknown);}p.bind(this)(P);P=P.getPrevious();i++;}if(x!==undefined){x.setPrevious(M);M=x;}if(!l){q(M,10);}if(d){return;}if(m!==undefined){d=true;m(M,A);d=false;}if(M.getSeverity()===sap.apf.core.constants.message.severity.fatal){if(sap.ui.Device.browser.firefox){h=true;}throw new Error(u);}};this.check=function(i,M,C){var E=C||sap.apf.core.constants.message.code.errorCheck;if(!i){var x=this.createMessageObject({code:E,aParameters:[M]});t.putMessage(x);}};this.getConfigurationByCode=function(E){if(a===undefined){return undefined;}return a.getItem(E);};this.getLogMessages=function(){return jQuery.extend(true,[],L);};this.reset=function(){a=undefined;m=undefined;A=undefined;L=[];};function c(E){if(sap.ui.Device.browser.firefox){return h;}return(E.originalEvent&&E.originalEvent.message&&E.originalEvent.message.search(u)>-1);}function e(E){return(E.originalEvent&&E.originalEvent.message&&E.originalEvent.message.search(u)===-1&&E.originalEvent.message.search(sap.apf.core.constants.message.code.suppressFurtherException)>-1);}function g(){var i=new Date();var x=Math.random()*i.getTime();return sap.apf.core.constants.message.code.suppressFurtherException+x;}function f(C){var N=parseInt(C,10);if(N==sap.apf.core.constants.message.code.errorExitTriggered){return true;}else if(N>=sap.apf.core.constants.message.code.errorUnknown&&N<=sap.apf.core.constants.message.code.warningAnalyticalConfig){return true;}return false;}function j(C){var N=parseInt(C,10);if(N>sap.apf.core.constants.message.code.errorUnknown&&N<=sap.apf.core.constants.message.code.errorInAnalyticalConfig){return true;}return false;}function k(C){var N=parseInt(C,10);if(N===sap.apf.core.constants.message.code.warningAnalyticalConfig){return true;}return false;}function p(M){var C=M.getCode();var i=t.getConfigurationByCode(C);if(i===undefined){i=jQuery.extend(true,{},b);if(f(C)){if(M.hasRawText()){i.rawText=M.getRawText();}i.rawText+=' '+M.getParameters();if(j(C)){i.severity=sap.apf.core.constants.message.severity.fatal;}else if(k(C)){i.severity=sap.apf.core.constants.message.severity.warning;}}else{i.rawText="Message "+C+"  "+M.getParameters()+" (Message Code has no Configuration)";}if(!f(C)){M.setCode(i.code);}}if(i.severity!==undefined){M.setSeverity(i.severity);}else{M.setSeverity(sap.apf.core.constants.message.severity.technError);}if(i.rawText){M.setMessage(i.rawText);}else{var P=M.getParameters();if(M.getSeverity()===sap.apf.core.constants.message.severity.technError){var x=t.getConfigurationByCode(i.code).text;if(!x){x=t.getConfigurationByCode(i.code).description;}var y=0;while(x.indexOf("{"+y+"}")>-1){if(typeof P[y]==="string"){x=x.replace("{"+y+"}",P[y]);}else{x=x.replace("{"+y+"}","undefined");}y++;}M.setMessage(x);}else{try{if(T){M.setMessage(T.getMessageText(i.key,M.getParameters()));}else{M.setMessage("Message Code: "+C+" "+P.toString());}}catch(E){M.setMessage("Message Code: "+C+" "+P.toString());}}}}function q(M,i){var x="APF message ";var P="";var y=i-1;if(i===0){return;}var z=M.getPrevious();if(z!==undefined){q(z,y);P=" - (see previous message for more information)";}n++;var B=x+'('+n+'): '+M.getCode()+" - "+M.getMessage()+P;if(D){alert("Fatal Error during Log Writing "+B);return;}D=true;if(M.getSeverity()===sap.apf.core.constants.message.severity.fatal){if(L.length<2){L.unshift(B);}}switch(M.getSeverity()){case sap.apf.core.constants.message.severity.warning:jQuery.sap.log.warning(B);break;case sap.apf.core.constants.message.severity.error:jQuery.sap.log.error(B);break;case sap.apf.core.constants.message.severity.fatal:jQuery.sap.log.error(B);break;case sap.apf.core.constants.message.severity.technError:jQuery.sap.log.error(B);break;default:jQuery.sap.log.info(B);}D=false;}function s(i){t.check(i!==undefined&&i.hasOwnProperty("code")!==false,"MessageHandler setItem: oItem is undefined or property 'code' is missing",sap.apf.core.constants.message.code.errorStartUp);var x=a.setItem(i.code,i);t.check((x===undefined),"MessageHandler setItem: Configuration includes duplicated codes",sap.apf.core.constants.message.code.errorStartUp);}function r(M){if(M.type===undefined){M.type="message";}s(M);}function v(E){var M;var i="";var x="";var U="";var y="";var B=true;if(sap.ui.Device.browser.firefox){B=false;}if(B&&E&&E.originalEvent){i=E.originalEvent.message;U=E.originalEvent.filename;x=E.originalEvent.lineno;}if(c(E)){E.stopImmediatePropagation();E.preventDefault();}else if(e(E)){return;}else if(d){M=new sap.apf.core.MessageObject({code:sap.apf.core.constants.message.code.errorStopProcessing});M.setSeverity(sap.apf.core.constants.message.severity.error);y="Unknown exception happened during processing of error by callback function ";if(B){y=y+i+" (source: "+U+":"+x+")";}M.setMessage(y);q(M,1);}else{M=new sap.apf.core.MessageObject({code:sap.apf.core.constants.message.code.errorUnknown});M.setSeverity(sap.apf.core.constants.message.severity.error);y="Unknown exception ";if(B){y=y+i+" (source: "+U+":"+x+")";}M.setMessage(y);q(M,1);}}function w(){u=g();}w();};}());
