/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.binding");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require("sap.apf.core.utils.filter");jQuery.sap.require("sap.apf.core.utils.filterTerm");(function(){'use strict';sap.apf.core.Binding=function(I,b,f,r){var t=this;this.type="binding";var n=0;var R=[];var a=[];var c=[];var C;var s;this.oTitle=b.oTitle;this.oLongTitle=b.oLongTitle;var d=b.requiredFilters;this.destroy=function(){R.forEach(function(o){if(o&&o.destroy){o.destroy();}});R=[];a=[];c=[];C=undefined;s=undefined;};this.getFilter=function(){var S=this.getSelectedRepresentation();var m=sap.apf.core.constants.filterMethodTypes;var i=[];if(S.getFilterMethodType()===m.filter){var F=S.getFilter().getInternalFilter();if(s){return s.getInternalFilter().overwriteWith(F);}return F;}if(S.getSelectionAsArray){i=S.getSelectionAsArray();}else{return new sap.apf.core.utils.Filter(I.messageHandler);}if(i===undefined){return sap.apf.core.utils.Filter.createEmptyFilter(I.messageHandler,d);}if(i.length===c.length||i.length===0){return new sap.apf.core.utils.Filter(I.messageHandler);}return sap.apf.core.utils.Filter.createFromArray(I.messageHandler,d,c,i);};this.getRequestOptions=function(){if(jQuery.isFunction(this.getSelectedRepresentation().getRequestOptions)){return this.getSelectedRepresentation().getRequestOptions();}return{};};function e(o){return o.getFilterMethodType()===sap.apf.core.constants.filterMethodTypes.startFilter;}this.setFilter=function(F){var o=this.getSelectedRepresentation();s=F;if(e(o)){o.setFilter(s);}};this.setData=function(D){I.messageHandler.check(D!==undefined,"aDataResponse is undefined (binding function setData)");c=D.data;C=D.metadata;this.getSelectedRepresentation().setData(D.data,D.metadata);};this.getRepresentationInfo=function(){var k=jQuery.extend(true,[],a);for(var i=0;i<k.length;i++){delete k[i].id;delete k[i].type;delete k[i].constructor;}return k;};this.getSelectedRepresentationInfo=function(){I.messageHandler.check(n>=0&&n<a.length,"index in array boundaries");var o=jQuery.extend(true,{},a[n]);delete o.id;delete o.type;delete o.constructor;return o;};this.getSelectedRepresentation=function(){I.messageHandler.check(n>=0&&n<R.length,"selectedRepresentation in array boundaries");return R[n];};this.setSelectedRepresentation=function(r){I.messageHandler.check(typeof r==="string","setSelectedRepresentation() - sRepresentationId missing");var t=this;var o=this.getSelectedRepresentation();var S=k(r,b.representations);var N=l(S);n=S.index;if(c!==undefined&&C!==undefined){N.setData(c,C);}if(N.adoptSelection){N.adoptSelection(o);}function k(r,m){for(var i=0;i<m.length;i++){if(r===m[i].id){return{config:m[i],constructor:f.getConfigurationById(m[i].representationTypeId).constructor,index:i};}}I.messageHandler.check(false,"Representation config not found");}function l(i){var m;if(R[i.index]===undefined){if(i.config.parameter&&i.config.parameter.alternateRepresentationTypeId){i.config.parameter.alternateRepresentationType=f.getConfigurationById(i.config.parameter.alternateRepresentationTypeId);}i.config.parameter.requiredFilters=b.requiredFilters;m=t.convertSortToOrderBy(i.config.parameter);R[i.index]=I.coreApi.createRepresentation(i.constructor,m);return R[i.index];}return R[i.index];}};this.serialize=function(){return{selectedRepresentation:t.getSelectedRepresentation().serialize(),selectedRepresentationId:t.getSelectedRepresentationInfo().representationId};};this.deserialize=function(S){t.setSelectedRepresentation(S.selectedRepresentationId);t.getSelectedRepresentation().deserialize(S.selectedRepresentation);return t;};this.convertSortToOrderBy=function(p){var i;if(p.sort&&!p.orderby){i=jQuery.extend(true,{},p);if(p.alternateRepresentationType){i.alternateRepresentationType=p.alternateRepresentationType;}i.orderby=[{property:p.sort.sortField,ascending:!p.sort.descending}];delete i.sort;return i;}i=p;return i;};R[0]=undefined;var g,h=false;for(g in b.representations){var j=b.representations[g].representationTypeId;a[g]=jQuery.extend(true,{},f.getConfigurationById(j));a[g].representationId=b.representations[g].id;if(r===a[g].representationId){h=true;}a[g].representationLabel=b.representations[g].label;a[g].thumbnail=b.representations[g].thumbnail;a[g].parameter=jQuery.extend(true,{},b.representations[g].parameter);}if(h){this.setSelectedRepresentation(r);}else if(a.length>0){this.setSelectedRepresentation(a[0].representationId);}if(!h&&r){I.messageHandler.putMessage(I.messageHandler.createMessageObject({code:'5037',aParameters:[r]}));}};}());
