/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
(function(){'use strict';jQuery.sap.declare("sap.apf.core.configurationFactory");jQuery.sap.require("sap.apf.core.step");jQuery.sap.require("sap.apf.core.request");jQuery.sap.require("sap.apf.utils.hashtable");jQuery.sap.require("sap.apf.core.binding");jQuery.sap.require("sap.apf.core.representationTypes");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require('sap.apf.utils.utils');sap.apf.core.ConfigurationFactory=function(i){var t=this;var a=new sap.apf.utils.Hashtable(i.messageHandler);var s=function(I){i.messageHandler.check(I!==undefined&&I.hasOwnProperty("id")!==false,"oItem is undefined or property 'id' is missing",sap.apf.core.constants.message.code.errorCheckConfiguration);if(!a){a=new sap.apf.utils.Hashtable(i.messageHandler);}var v=a.setItem(I.id,I);i.messageHandler.check((v===undefined),"Configuration includes duplicated identifiers (IDs): "+I.id+"",sap.apf.core.constants.message.code.errorCheckConfigurationWarning);};var g=function(v){var R=[];if(a.getNumberOfItems()!==0){a.each(function(w,x){if(x.type===v){R.push(x);}});return R;}i.messageHandler.putMessage(i.messageHandler.createMessageObject({code:"5020"}));return R;};function l(v){if(v.type===undefined){v.type="step";}s(v);}function b(v){i.messageHandler.check(v!==undefined&&v instanceof Array!==false,"aSteps is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);v.forEach(function(w){l(w);});}function c(R){if(R.type===undefined){R.type="request";}if(R.entitySet){R.entityType=R.entitySet;delete R.entitySet;}s(R);}function d(v){if(v.type===undefined){v.type="navigationTarget";}s(v);}function e(R){i.messageHandler.check(R!==undefined&&R instanceof Array!==false,"aRequests is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);R.forEach(function(v){c(v);});}function f(B){function v(){var w=new sap.apf.utils.Hashtable(i.messageHandler);B.representations.forEach(function(x){if(!(x.id&&typeof x.id==="string")){i.messageHandler.putMessage(i.messageHandler.createMessageObject({code:"5028",aParameters:[B.id]}));}if(w.setItem(x.id,x.id)){i.messageHandler.putMessage(i.messageHandler.createMessageObject({code:"5029",aParameters:[B.id]}));}});}if(B.type===undefined){B.type="binding";}i.messageHandler.check(B.id!==undefined,"binding has no id");i.messageHandler.check(B.representations!==undefined&&B.representations instanceof Array!==false,"representations for binding "+B.id+" not defined",sap.apf.core.constants.message.code.errorCheckConfiguration);v();s(B);}function h(B){i.messageHandler.check(B!==undefined&&B instanceof Array!==false,"aBindings is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);B.forEach(function(v){f(v);});}function j(v){i.messageHandler.check(v!==undefined&&v instanceof Array!==false,"navigationTarget is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);v.forEach(function(w){d(w);});}function k(v){if(v.type===undefined){v.type="category";}s(v);}function m(v){i.messageHandler.check(v!==undefined&&v instanceof Array!==false,"aCategories is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);v.forEach(function(w){var x=w.steps;i.messageHandler.check(x!==undefined&&x instanceof Array!==false,"steps for category "+w.id+" are missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);x.forEach(function(y){i.messageHandler.check(y.type&&y.type==="step"&&y.id,"step with wrong format assigned to category '"+w.id+"'");i.messageHandler.check(t.existsConfiguration(y.id),"step with id '"+y.id+"' which is assigned to category '"+w.id+"' does not exist");});k(w);});}function n(v){var w=false;var R=sap.apf.core.representationTypes();R.forEach(function(x){if(v===x.id){w=true;}});return w;}function o(R){var v;if(R.type===undefined){R.type="representationType";}if(!n(R.id)){v=sap.apf.utils.extractFunctionFromModulePathString(R.constructor);if(!jQuery.isFunction(v)){i.messageHandler.putMessage(i.messageHandler.createMessageObject({code:'5030',parameters:[R.id]}));}}s(R);}function p(R){i.messageHandler.check(R!==undefined&&R instanceof Array!==false,"aRepresentationInfo is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);R.forEach(function(v){o(v);});}function q(F){if(F.type===undefined){F.type="facetFilter";}t.addObject(F);}function r(F){i.messageHandler.check(F!==undefined&&F instanceof Array!==false,"Facet filter configuration is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);F.forEach(function(v){q.call(t,v);});}var u=function(R){p(R);};function S(v,F){function w(v,z){var A=z.getConfigurationById(v.binding).representations;if(A){return A;}i.messageHandler.check(false,'Binding of step with ID "'+v.id+'" does not contain any representations.',sap.apf.core.constants.message.code.errorCheckConfigurationWarning);}function x(v,z){var A;var B=[];if(v.binding){A=w(v,z);A.forEach(function(D){var E=jQuery.extend(true,{},z.getConfigurationById(D.representationTypeId));E.representationId=D.id;E.representationLabel=D.label;E.parameter=jQuery.extend(true,{},D.parameter);B.push(E);});return B;}i.messageHandler.check(false,'Step with ID "'+v.id+'" does not contain any binding references.',sap.apf.core.constants.message.code.errorCheckConfigurationWarning);}var y=jQuery.extend(true,{},v);var R=x(v,F);delete y.request;delete y.binding;delete y.thumbnail;delete y.longTitle;y.type="stepTemplate";y.getRepresentationInfo=function(){var z=jQuery.extend(true,[],R);z.forEach(function(A){delete A.id;delete A.type;delete A.constructor;});return z;};return y;}var C=function(v,w){var t=this;this.type=v.type;this.id=v.id;this.label=v.label;this.stepTemplates=[];v.steps.forEach(function(x){var y=w.getConfigurationById(x.id);t.stepTemplates.push(new S(y,w));});return this;};var T=function(v,F){this.type="thumbnail";if(v===undefined){return this;}this.leftUpper=F.createLabel(v.leftUpper);this.rightUpper=F.createLabel(v.rightUpper);this.leftLower=F.createLabel(v.leftLower);this.rightLower=F.createLabel(v.rightLower);this.altTitle=F.createLabel(v.altTitle);return this;};this.createThumbnail=function(v){return new T(v,this);};function L(v){this.type="label";this.kind=v.kind;if(this.kind==="text"){this.file=v.file;this.key=v.key;}else if(this.kind==="property"){this.property=v.property;}else if(this.kind==="sapLabel"){this.labelOf=v.labelOf;}}this.createLabel=function(v){return new L(v,this);};this.loadConfig=function(v){a=new sap.apf.utils.Hashtable(i.messageHandler);if(v.applicationTitle){a.setItem('applicationTitle',v.applicationTitle);}var w={constructor:{hashtable:sap.apf.utils.Hashtable},instance:{messageHandler:i.messageHandler}};sap.apf.utils.migrateConfigToCategoryStepAssignment(v,w);var R=sap.apf.core.representationTypes();u(R);b(v.steps);m(v.categories);e(v.requests);h(v.bindings);if(v.representationTypes){p(v.representationTypes);}if(v.facetFilters){r.call(this,v.facetFilters);}if(v.navigationTargets){j(v.navigationTargets);}};this.addObject=function(v){if(!sap.apf.core.constants.configurationObjectTypes.hasOwnProperty(v.type)){i.messageHandler.putMessage(i.messageHandler.createMessageObject({code:"5033",aParams:[v.type]}));}if(!(v.property)){i.messageHandler.putMessage(i.messageHandler.createMessageObject({code:"5034"}));}a.setItem(v.id,v);};this.getConfigurationById=function(I){return a.getItem(I);};this.existsConfiguration=function(I){return a.hasItem(I);};this.getServiceDocuments=function(){var R=g("request");var v=[];R.forEach(function(w){v.push(w.service);});return sap.apf.utils.eliminateDuplicatesInArray(i.messageHandler,v);};this.getNavigationTargets=function(){var v=g("navigationTarget");return jQuery.extend(true,[],v);};this.getStepTemplates=function(){var I=g("step");var v=[];I.forEach(function(w,x){v[x]=new S(w,t);});return v;};this.getFacetFilterConfigurations=function(){var v=g("facetFilter");var w;v=jQuery.extend(true,[],v);v.forEach(function(x){if(x.preselectionFunction){w=sap.apf.utils.extractFunctionFromModulePathString(x.preselectionFunction);if(!jQuery.isFunction(w)){i.messageHandler.putMessage(i.messageHandler.createMessageObject({code:'5035',parameters:[x.id]}));x.preselectionFunction=undefined;}else{x.preselectionFunction=w;}}});return v;};this.getCategories=function(){var I=g("category");var v=[];I.forEach(function(w,x){v[x]=new C(w,t);});return v;};this.createStep=function(v,R){var w=this.getConfigurationById(v);i.messageHandler.check((w!==undefined&&w.type==="step"),"Error - referenced object is undefined or has not type step",sap.apf.core.constants.message.code.errorCheckConfiguration);i.messageHandler.check(sap.apf.core.Step!==undefined,"Step must be defined ",sap.apf.core.constants.message.code.errorCheckConfiguration);i.messageHandler.check(typeof sap.apf.core.Step==="function","Step must be Ctor function");return new sap.apf.core.Step(i.messageHandler,w,this,R);};this.createBinding=function(B,v,w,R){var x=this.getConfigurationById(B);i.messageHandler.check((x!==undefined&&x.type==="binding"),"Error - oBindingConfig is undefined or has not type binding",sap.apf.core.constants.message.code.errorCheckConfiguration);x.oTitle=v;x.oLongTitle=w;return new sap.apf.core.Binding(i,x,this,R);};this.createRequest=function(v){if(v.entitySet){v.entityType=v.entitySet;delete v.entitySet;}var M;var R;function w(){var x=new Date();return Math.random()*x.getTime();}if(typeof v==="string"){R=t.getConfigurationById(v);if(!(R!==undefined&&R.type==="request")){M=i.messageHandler.createMessageObject({code:"5004",aParameters:[v]});i.messageHandler.putMessage(M);return undefined;}}else{R=v;i.messageHandler.check(R.type&&R.type==="request"&&R.service&&R.entityType,'Wrong request configuration when creating a new request');if(!R.id){R.id=w();s(R);}}return new sap.apf.core.Request(i,R);};if(i.constructor.registryProbe){this.getRegistry=function(){var P=i.constructor.registryProbe;return new P(a);};}};}());
