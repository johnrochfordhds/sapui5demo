/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare('sap.apf.core.request');jQuery.sap.require('sap.apf.utils.utils');jQuery.sap.require('sap.apf.core.utils.filter');jQuery.sap.require('sap.apf.core.utils.filterTerm');jQuery.sap.require('sap.ui.thirdparty.datajs');jQuery.sap.require("sap.apf.core.utils.filterSimplify");(function(){'use strict';sap.apf.core.Request=function(I,c){var m=I.messageHandler;var C=I.coreApi;var s=c.service;var a=c.selectProperties;var u=C.getUriGenerator();var M;if(s===undefined){M=m.createMessageObject({code:'5015',aParameters:[c.id]});m.putMessage(M);}var o=C.getMetadata(s);var U=o.getUriComponents(c.entityType);var e,b;if(U){e=U.entitySet;b=U.navigationProperty;}m.check(e!==undefined,'Invalid request configuration: An entityset does not exist under the service '+c.entityType);m.check(b!==undefined,'Invalid request configuration: A usable navigation does not exist for the service '+c.entityType);this.type=c.type;this.sendGetInBatch=function(F,h,R){var p=r(F);var i;var j;g(F);if(F&&F.getProperties){i=F.reduceToProperty(o.getFilterableProperties(e));if(C.getStartParameterFacade().isFilterReductionActive()){j=new sap.apf.core.utils.FilterReduction();i=j.filterReduction(m,i);}}d(R);var P=R&&R.paging;var S=R&&R.orderby;var k=u.buildUri(m,e,a,i,p,S,P,undefined,f,b);var l={method:'POST',headers:{'x-csrf-token':C.getXsrfToken(s)},requestUri:u.getAbsolutePath(s)+'$batch',data:{__batchRequests:[{requestUri:k,method:'GET',headers:{'Accept-Language':sap.ui.getCore().getConfiguration().getLanguage(),'x-csrf-token':C.getXsrfToken(s)}}]}};var n=function(q,t){var v={};var w='';if(q&&q.__batchResponses&&q.__batchResponses[0].data){v.data=q.__batchResponses[0].data.results;v.metadata=C.getEntityTypeMetadata(c.service,c.entityType);if(q.__batchResponses[0].data.__count){v.count=parseInt(q.__batchResponses[0].data.__count,10);}}else if(q&&q.__batchResponses[0]&&q.__batchResponses[0].response&&q.__batchResponses[0].message){w=t.requestUri;var x=q.__batchResponses[0].message;var y=q.__batchResponses[0].response.body;var H=q.__batchResponses[0].response.statusCode;v=m.createMessageObject({code:'5001',aParameters:[H,x,y,w]});}else{w=t.requestUri||k;v=m.createMessageObject({code:'5001',aParameters:['unknown','unknown error','unknown error',w]});}h(v,false);};var E=function(q){var t='unknown error';var v='unknown error';var w=k;if(q.message!==undefined){t=q.message;}var H='unknown';if(q.response&&q.response.statusCode){H=q.response.statusCode;v=q.response.statusText||'';w=q.response.requestUri||k;}if(q.messageObject&&q.messageObject.type==='messageObject'){h(q.messageObject);}else{h(m.createMessageObject({code:'5001',aParameters:[H,t,v,w]}));}};C.odataRequest(l,n,E,OData.batchHandler);};function f(p,v){var h="'";var E=o.getPropertyMetadata(e,p);if(E&&E.dataType){return sap.apf.utils.formatValue(v,E.dataType.type);}if(typeof v==='number'){return v;}return h+sap.apf.utils.escapeOdata(v)+h;}function d(R){var p,i;if(!R){return;}p=Object.getOwnPropertyNames(R);for(i=0;i<p.length;i++){if(p[i]!=='orderby'&&p[i]!=='paging'){m.putMessage(m.createMessageObject({code:'5032',aParameters:[e,p[i]]}));}}}function g(F){var h=o.getFilterableProperties(e);var R='';var E=o.getEntityTypeAnnotations(e);var i;if(E.requiresFilter!==undefined&&E.requiresFilter==='true'){if(E.requiredProperties!==undefined){R=E.requiredProperties;}}if(R===''){return;}if(jQuery.inArray(R,h)===-1){i=m.createMessageObject({code:'5006',aParameters:[e,R]});m.putMessage(i);}var p=F.getProperties();if(jQuery.inArray(R,p)===-1){i=m.createMessageObject({code:'5005',aParameters:[e,R]});m.putMessage(i);}}function r(F){var p={};var P;var n;var t;var i;var h;P=o.getParameterEntitySetKeyProperties(e);if(P!==undefined){n=P.length;}else{n=0;}if(n>0){for(i=0;i<n;i++){if(F&&F instanceof sap.apf.core.utils.Filter){t=F.getFilterTermsForProperty(P[i].name);h=t[t.length-1];}if(h instanceof sap.apf.core.utils.FilterTerm){j(i,h.getValue());}else if(P[i].defaultValue){j(i,P[i].defaultValue);}else{m.putMessage(m.createMessageObject({code:'5016',aParameters:[P[i].name]}));}}}return p;function j(k,v){var l;if(P[k].dataType.type==='Edm.String'){p[P[k].name]=(jQuery.sap.encodeURL("'"+sap.apf.utils.escapeOdata(v)+"'"));}else if(P[k].dataType.type){l=sap.apf.utils.formatValue(v,P[k].dataType.type);if(typeof l==='string'){p[P[k].name]=jQuery.sap.encodeURL(l);}else{p[P[k].name]=l;}}else if(typeof v==='string'){p[P[k].name]=jQuery.sap.encodeURL(sap.apf.utils.escapeOdata(v));}else{p[P[k].name]=v;}}}};}());
