/* SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.apf.ui.representations.table");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require('sap.apf.ui.utils.formatter');jQuery.sap.require("sap.apf.ui.representations.BaseUI5ChartRepresentation");(function(){'use strict';function _(S){T.removeSelections();S.forEach(function(i){T.setSelectedItem(i);});}function a(i){i.UI5ChartHelper.filterValues=[];i.setFilter(i.oApi.createFilter());}function b(i){var r=i.getFilter().getInternalFilter().getProperties()[0];var q=i.getFilter().getInternalFilter().getFilterTermsForProperty(r);var u=q.map(function(v){return v.getValue();});return u;}function c(E){var i=[],r;var C=E.getParameters("listItems").listItems;if(this.UI5ChartHelper){var I=this.getFilter().getInternalFilter().getProperties();i=I.length>0?b(this):[];r=I[0];F=i;}var q=this.oParameter.requiredFilters.length>0?"MultiSelect":"None";T.setMode(q);if(E.getId()==="selectionChange"){var u=true;var v=[];r=I[0]||this.parameter.requiredFilters[0];var w=C[0].getBindingContext().getProperty(this.parameter.requiredFilters[0]);if(C[0].isSelected()){v.push(w);}else{var x=i.indexOf(w);if(x!==-1){i.splice(x,1);}}i=i.concat(v.filter(function(y){return i.indexOf(y)<0;}));F=i;if(u){a(this);this.filter=this.UI5ChartHelper.getFilterFromSelection(i);this.oApi.getActiveStep().getSelectedRepresentation().UI5ChartHelper.filterValues=this.UI5ChartHelper.filterValues;this.oApi.selectionChanged();}else{u=true;}}var A=E.getSource().getItems().filter(function(y){var z=y.getBindingContext().getProperty(r);return i.indexOf(z)!==-1;});_(A);}function d(i){var q=b(i);var r=i.getFilter().getInternalFilter().getProperties()[0];var S=p.getItems().filter(function(v){var w=v.getBindingContext().getProperty(r);return q.indexOf(w)!==-1;});var u=i.oParameter.requiredFilters.length>0?"MultiSelect":"None";p.setMode(u);return S;}var f,F,t,e,g,T,o,p,h=[];var j,s,k,l,m;var n=new sap.ui.model.json.JSONModel();n.setSizeLimit(10000);sap.apf.ui.representations.table=function(A,P){this.oParameter=P;sap.apf.ui.representations.BaseUI5ChartRepresentation.apply(this,[A,P]);g=P.isAlternateRepresentation;this.alternateRepresentation=P.defaultListConfigurationTypeID;this.type=sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION;m=false;j=0;s=0;k=0;l=10;F=[];this.aDataResponse=[];};sap.apf.ui.representations.table.prototype=Object.create(sap.apf.ui.representations.BaseUI5ChartRepresentation.prototype);sap.apf.ui.representations.table.prototype.constructor=sap.apf.ui.representations.table;sap.apf.ui.representations.table.prototype.setData=function(D,i){var q=this;if(s===0){if(m){D.map(function(r){q.aDataResponse.push(r);});s++;}else{k=0;l=100;h=[];q.aDataResponse=D;}}h=q.aDataResponse||[];if(!i){this.oMessageObject=this.oApi.createMessageObject({code:"6004",aParameters:[this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(this.oMessageObject);}else{this.metadata=i;f=new sap.apf.ui.utils.formatter({getEventCallback:this.oApi.getEventCallback.bind(this.oApi),getTextNotHtmlEncoded:this.oApi.getTextNotHtmlEncoded},i,D);this.UI5ChartHelper.metadata=i;}};sap.apf.ui.representations.table.prototype.createDataset=function(){t=[];e={name:[],value:[]};t=this.oParameter.dimensions.concat(this.oParameter.measures).length?this.oParameter.dimensions.concat(this.oParameter.measures):this.oParameter.properties;h=this.getData();if(h.length!==0){for(var i=0;i<t.length;i++){e.value[i]=t[i].fieldName;var q="";var r=this.metadata.getPropertyMetadata(t[i].fieldName).label||this.metadata.getPropertyMetadata(t[i].fieldName).name;var u="";if(this.metadata!==undefined&&this.metadata.getPropertyMetadata(t[i].fieldName).unit!==undefined){var U=this.metadata.getPropertyMetadata(t[i].fieldName).unit;u=this.getData()[0][U];q=t[i].fieldDesc===undefined||!this.oApi.getTextNotHtmlEncoded(t[i].fieldDesc).length?r+" ("+u+")":this.oApi.getTextNotHtmlEncoded(t[i].fieldDesc)+" ("+u+")";e.name[i]=q;}else{e.name[i]=t[i].fieldDesc===undefined||!this.oApi.getTextNotHtmlEncoded(t[i].fieldDesc).length?r:this.oApi.getTextNotHtmlEncoded(t[i].fieldDesc);}}}};sap.apf.ui.representations.table.prototype.getSelectionFromChart=function(){var S=T.getSelectedItems();return S;};sap.apf.ui.representations.table.prototype.getSelections=function(){var S=[];if(F){F.forEach(function(i){S.push({id:i,text:i});});}return S;};sap.apf.ui.representations.table.prototype.getRequestOptions=function(){if(!m){l=100;k=0;s=0;}var r={paging:{top:l,skip:k,inlineCount:true}};var i;if(this.sortProperty!==undefined){i=[{property:this.sortProperty,descending:this.sortOrderIsDescending}];r.orderby=i;}else{if(this.getParameter().orderby&&this.getParameter().orderby.length){var O=this.getParameter().orderby.map(function(q){return{property:q.property,descending:!q.ascending};});r.orderby=O;}}return r;};sap.apf.ui.representations.table.prototype.getMainContent=function(S,i,w){var q=this;this.createDataset();var M;if(!S){M=this.oApi.createMessageObject({code:"6002",aParameters:["title",this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(M);}if(t.length===0){M=this.oApi.createMessageObject({code:"6002",aParameters:["dimensions",S]});this.oApi.putMessage(M);}if(!h||h.length===0){M=this.oApi.createMessageObject({code:"6000",aParameters:[S]});this.oApi.putMessage(M);}var r=(w||1000)+"px";var u=[];var v;var C=function(U){return function(V){if(q.metadata===undefined){return V;}else{var W;if(e.value[U]&&V){W=f.getFormattedValue(e.value[U],V);}if(W!==undefined){return W;}else{return V;}}};};var x;for(v=0;v<e.name.length;v++){x=new sap.m.Text().bindText(e.value[v],C(v),sap.ui.model.BindingMode.OneWay);u.push(x);}var y=[],z=[];var A,B;var D;for(D=0;D<e.name.length;D++){A=new sap.m.Column({header:new sap.m.Text({text:e.name[D]})});y.push(A);B=new sap.m.Column();z.push(B);}o=new sap.m.Table({headerText:S,showNoData:false,columns:y}).addStyleClass("tableWithHeaders");T=new sap.m.Table({columns:z,items:{path:"/tableData",template:new sap.m.ColumnListItem({cells:u})},selectionChange:c.bind(q)});n.setData({tableData:h});o.setModel(n);T.setModel(n);T.attachUpdateFinished(c.bind(q));var E=function(U){var V=U.getParameters();T.setBusy(true);s=0;q.sortProperty=V.sortItem.getKey();q.orderby=q.sortOrderIsDescending=V.sortDescending;l=100;k=0;var J=[];if(V.sortItem){if(g){var K=T.getBinding("items");J.push(new sap.ui.model.Sorter(q.sortProperty,q.sortOrderIsDescending));K.sort(J);T.setBusy(false);return;}q.oApi.updatePath(function(W,X){if(W===q.oApi.getActiveStep()){n.setData({tableData:h});T.rerender();T.setBusy(false);}});}};this.viewSettingsDialog=new sap.m.ViewSettingsDialog({confirm:E});var G;for(G=0;G<o.getColumns().length;G++){var I=new sap.m.ViewSettingsItem({text:e.name[G],key:e.value[G]});this.viewSettingsDialog.addSortItem(I);}var H;if(this.sortProperty===undefined&&this.sortOrderIsDescending===undefined){if(this.getParameter().orderby&&this.getParameter().orderby.length){for(H=0;H<this.viewSettingsDialog.getSortItems().length;H++){if(this.getParameter().orderby[0].property===this.viewSettingsDialog.getSortItems()[H].getKey()){this.viewSettingsDialog.setSelectedSortItem(this.viewSettingsDialog.getSortItems()[H]);this.viewSettingsDialog.setSortDescending(!this.getParameter().orderby[0].ascending);}}}else{this.viewSettingsDialog.setSelectedSortItem(this.viewSettingsDialog.getSortItems()[0]);this.viewSettingsDialog.setSortDescending(false);}}else{for(H=0;H<this.viewSettingsDialog.getSortItems().length;H++){if(this.sortProperty===this.viewSettingsDialog.getSortItems()[H].getKey()){this.viewSettingsDialog.setSelectedSortItem(this.viewSettingsDialog.getSortItems()[H]);}}this.viewSettingsDialog.setSortDescending(this.sortOrderIsDescending);var J=[];if(g){var K=T.getBinding("items");J.push(new sap.ui.model.Sorter(this.sortProperty,this.sortOrderIsDescending));K.sort(J);}}var L;if(this.metadata!==undefined){for(L=0;L<e.name.length;L++){var N=this.metadata.getPropertyMetadata(e.value[L]);if(N.unit){var O=T.getColumns()[L];O.setHAlign(sap.ui.core.TextAlign.Right);}}}var P=new sap.m.ScrollContainer({content:T,height:"480px",horizontal:false,vertical:true}).addStyleClass("tableWithoutHeaders");var Q=new sap.m.Link({text:"More"}).addStyleClass("loadMoreLink");var R=new sap.m.ScrollContainer({content:[o,P],width:r,horizontal:true,vertical:false}).addStyleClass("scrollContainer");n.setSizeLimit(10000);o.addEventDelegate({onAfterRendering:function(){jQuery(".scrollContainer > div:first-child").css({"display":"table","width":"inherit"});var U;if(this.offsetTop===undefined){this.offsetTop=jQuery(".tableWithoutHeaders").offset().top;}if(jQuery(".tableWithoutHeaders").offset().top!==this.offsetTop){U=((window.innerHeight-jQuery('.tableWithoutHeaders').offset().top))+"px";}else{U=((window.innerHeight-jQuery('.tableWithoutHeaders').offset().top)-(jQuery(".applicationFooter").height())-20)+"px";}document.querySelector('.tableWithoutHeaders').style.cssText+="height : "+U;var V=sap.ui.getCore().getRenderManager().getHTML(Q);sap.ui.Device.orientation.attachHandler(function(){R.rerender();});var W=q.oApi.getActiveStep();if(W.getSelectedRepresentation().bIsAlternateView===undefined||W.getSelectedRepresentation().bIsAlternateView===false){if(sap.ui.Device.browser.mobile){if(h.length>0){jQuery(jQuery(".tableWithoutHeaders > div:first-child")).append(V);}Q.attachPress(function(){if(!jQuery(".openToggleImage").length&&(h.length>0)){if(j===0){X();s=0;j++;jQuery(".loadMoreLink").remove();jQuery(jQuery(".tableWithoutHeaders > div:first-child")).append(V);}}else{jQuery(".loadMoreLink").remove();}});}else{jQuery('.tableWithoutHeaders').on("scroll",function(){var q=jQuery(this);var Y=q.prop("scrollTop");var Z=q.prop("scrollHeight");var $=q.prop("offsetHeight");var a1=Z-$-5;if((a1<=Y)&&!jQuery(".openToggleImage").length&&(h.length>0)){if(j===0){X();s=0;j++;}}});}}var X=function(){T.setBusy(true);sap.ui.getCore().applyChanges();var Y=n.getData();k=Y.tableData.length;l=10;m=true;q.oApi.updatePath(function(Z,$){if(Z===q.oApi.getActiveStep()){n.setData(Y);T.rerender();T.setBusy(false);j=0;}});};}});return new sap.ui.layout.VerticalLayout({content:[R]});};sap.apf.ui.representations.table.prototype.getThumbnailContent=function(){var i;if(this.aDataResponse!==undefined&&this.aDataResponse.length!==0){var q=new sap.ui.core.Icon({src:"sap-icon://table-chart",size:"70px"}).addStyleClass('thumbnailTableImage');i=q;}else{var r=new sap.m.Text({text:this.oApi.getTextNotHtmlEncoded("noDataText")}).addStyleClass('noDataText');i=new sap.ui.layout.VerticalLayout({content:r});}return i;};sap.apf.ui.representations.table.prototype.removeAllSelection=function(){a(this);F=[];T.removeSelections();this.oApi.getActiveStep().getSelectedRepresentation().UI5ChartHelper.filterValues=[];this.oApi.selectionChanged();};sap.apf.ui.representations.table.prototype.getPrintContent=function(S){var q=this;this.createDataset();var P=new sap.ui.model.json.JSONModel();P.setData({tableData:h});var i;var r=[];for(i=0;i<e.name.length;i++){this.columnName=new sap.m.Column({width:"75px",header:new sap.m.Label({text:e.name[i]})});r.push(this.columnName);}var u=[];var C=function(y){return function(z){if(q.metadata===undefined){return z;}else{var M=q.metadata.getPropertyMetadata(e.value[y]);if(M.dataType.type==="Edm.DateTime"){if(z===null){return"-";}var A=new Date(parseInt(z.slice(6,z.length-2),10));A=A.toLocaleDateString();if(A==="Invalid Date"){return"-";}return A;}if(M.unit){if(z===null){return"-";}var B=q.metadata.getPropertyMetadata(M.unit);if(B.semantics==="currency-code"){var D=h[0][M.scale];z=parseFloat(z,10).toFixed(D).toString();var E=z.split(".");var G=parseFloat(E[0]).toLocaleString();var H=0.1;H=H.toLocaleString();if(G.split(H.substring(1,2)).length>1){G=G.split(H.substring(1,2))[0];}G=G.concat(H.substring(1,2),E[1]);return G;}}else{return z;}}};};var v;for(i=0;i<e.name.length;i++){v=new sap.m.Text().bindText(e.value[i],C(i),sap.ui.model.BindingMode.OneWay);u.push(v);}p=new sap.m.Table({headerText:S,headerDesign:sap.m.ListHeaderDesign.Standard,columns:r,items:{path:"/tableData",template:new sap.m.ColumnListItem({cells:u})}});if(this.metadata!==undefined){for(i=0;i<e.name.length;i++){var M=this.metadata.getPropertyMetadata(e.value[i]);if(M.unit){var w=p.getColumns()[i];w.setHAlign(sap.ui.core.TextAlign.Right);}}}p.setModel(P);var x=d(this);return{oTableForPrint:new sap.ui.layout.VerticalLayout({content:[p]}),aSelectedListItems:x};};}());
