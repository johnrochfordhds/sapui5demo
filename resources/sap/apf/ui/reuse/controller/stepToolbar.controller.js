/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.require('sap.apf.ui.utils.helper');sap.ui.controller("sap.apf.ui.reuse.controller.stepToolbar",{chartIconInserted:false,alternateRepresentationIcon:false,alternateRepresentationBool:false,selectedRepresentation:null,alternateRepresentationBtn:{},selectedNumber:null,selectedNumberLink:null,isSwitchRepresentation:false,viewSettingsIcon:null,onInit:function(){this.oCoreApi=this.getView().getViewData().oCoreApi;this.oUiApi=this.getView().getViewData().uiApi;if(sap.ui.Device.system.desktop){this.getView().addStyleClass("sapUiSizeCompact");}},addCompactStyleClassForDialog:function(d){if(sap.ui.Device.system.desktop){d.addStyleClass("sapUiSizeCompact");}},drawAlternateRepresentation:function(){var t=this;this.alternateRepresentationBtn=new sap.m.Button({icon:this.oCoreApi.getActiveStep().getSelectedRepresentation().getAlternateRepresentation().picture,tooltip:this.oCoreApi.getTextNotHtmlEncoded("TableRepresentation"),press:function(){var s=t.oCoreApi.getActiveStep();var c=s.getSelectedRepresentation();var a=t.oCoreApi.getSteps().indexOf(s);t.selectedRepresentation="table";c.bIsAlternateView=true;if(c.toggleInstance===undefined){c.toggleInstance=t.oUiApi.getStepContainer().getController().createAlternateRepresentation(a);}else{var d=c.getData(),m=c.getMetaData();if(d!==undefined&&m!==undefined){c.toggleInstance.setData(d,m);}c.toggleInstance.adoptSelection(c);}t.oUiApi.getAnalysisPath().getController().refresh(-1);t.oUiApi.getStepContainer().getController().drawStepContent();t.oUiApi.getAnalysisPath().getCarousel().getStepView(a).getController().drawThumbnailContent(true);}}).addStyleClass("alternateButton");this.insertViewSettingsIcon();this.getView().chartToolbar.getToolBar().insertContentRight(this.alternateRepresentationBtn);},insertViewSettingsIcon:function(){var t=this;var v;this.sortButton=new sap.m.Button({icon:"sap-icon://drop-down-list",tooltip:this.oCoreApi.getTextNotHtmlEncoded("view-Settings"),press:function(){if(t.oCoreApi.getActiveStep().getSelectedRepresentation().type!==sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){v=t.oCoreApi.getActiveStep().getSelectedRepresentation().toggleInstance.viewSettingsDialog;t.addCompactStyleClassForDialog(v);v.open();}else{v=t.oCoreApi.getActiveStep().getSelectedRepresentation().viewSettingsDialog;t.addCompactStyleClassForDialog(v);v.open();}}}).addStyleClass("sortButton");this.getView().chartToolbar.getToolBar().insertContentRight(this.sortButton);},showSelectionCount:function(){var a=this.oCoreApi.getActiveStep();var s=a.getSelectedRepresentation();var b=s.getSelections().length||s.getSelectionCount();var r=s.getParameter().requiredFilters!==undefined&&s.getParameter().requiredFilters.length!==0;var m=s.getMetaData!==undefined&&s.getMetaData()!==undefined&&s.getMetaData().hasOwnProperty("getPropertyMetadata");var c=r&&m?s.getMetaData().getPropertyMetadata(s.getParameter().requiredFilters[0]).label:null;if(c===null||b===0){jQuery(".showSelection").hide();jQuery(".resetSelection").hide();}else if(b>0){this.selectedNumber.setText("("+this.oCoreApi.getTextNotHtmlEncoded("selected-objects",[c]));this.selectedNumberLink.setText(b);this.selectedNumberEndText.setText(')');jQuery(".showSelection").show();jQuery(".resetSelection").show();}},insertContentLeft:function(){var t=this;this.currentStepText=new sap.m.Label({wrapping:true,text:this.oCoreApi.getTextNotHtmlEncoded("currentStep")}).addStyleClass("currentStep");this.selectedNumber=new sap.m.Label({wrapping:true}).addStyleClass("showSelection");this.selectedNumberEndText=new sap.m.Label({wrapping:true}).addStyleClass("showSelection");this.selectedNumberEndText.addStyleClass("selectedNumberEndText");this.selectedNumberLink=new sap.m.Link({press:function(){if(t.selectionDisplayDialog){t.selectionDisplayDialog.destroy();}t.selectionDisplayDialog=new sap.ui.jsfragment("sap.apf.ui.reuse.fragment.selectionDisplay",t);t.addCompactStyleClassForDialog(t.selectionDisplayDialog);t.selectionDisplayDialog.open();}}).addStyleClass("showSelection");this.selectedNumberLink.addStyleClass("selectedNumberLink");this.resetSelection=new sap.m.Link({text:this.oCoreApi.getTextNotHtmlEncoded("resetSelection")}).attachPress(function(){jQuery(".showSelection").hide();jQuery(".resetSelection").hide();if(t.oCoreApi.getActiveStep().getSelectedRepresentation().bIsAlternateView){t.oCoreApi.getActiveStep().getSelectedRepresentation().toggleInstance.removeAllSelection();}t.oCoreApi.getActiveStep().getSelectedRepresentation().removeAllSelection();}).addStyleClass("resetSelection");this.getView().chartToolbar.getToolBar().insertContentRight(this.resetSelection);this.getView().chartToolbar.getToolBar().insertContentLeft(this.selectedNumberEndText);this.getView().chartToolbar.getToolBar().insertContentLeft(this.selectedNumberLink);this.getView().chartToolbar.getToolBar().insertContentLeft(this.selectedNumber);this.getView().chartToolbar.getToolBar().insertContentLeft(this.currentStepText);},drawSingleRepresentation:function(){var t=this;var a=this.oCoreApi.getActiveStep();a.selectedRepresentaionType=a.getSelectedRepresentationInfo();if(a.selectedRepresentaionType.parameter&&a.selectedRepresentaionType.parameter.orderby){var r=new sap.apf.ui.utils.Helper(t.oCoreApi).getRepresentationSortInfo(a.selectedRepresentaionType);a.selectedRepresentaionType.sortDescription=r;}var s=new sap.m.Button({icon:a.selectedRepresentaionType.picture,tooltip:this.oCoreApi.getTextNotHtmlEncoded(a.selectedRepresentaionType.label)+"\n"+((a.selectedRepresentaionType.sortDescription!==undefined)?this.oCoreApi.getTextNotHtmlEncoded("sortBy")+": "+a.selectedRepresentaionType.sortDescription:""),press:function(){var S=t.oCoreApi.getActiveStep();var c=S.getSelectedRepresentation();c.bIsAlternateView=false;t.oUiApi.getStepContainer().getController().drawStepContent();var b=t.oCoreApi.getSteps().indexOf(S);t.oUiApi.getAnalysisPath().getCarousel().getStepView(b).getController().drawThumbnailContent(true);}});this.getView().chartToolbar.getToolBar().insertContentRight(s,0);this.insertContentLeft();},drawMultipleRepresentation:function(){var t=this;var a=this.oCoreApi.getActiveStep();a.representationtypes=a.getRepresentationInfo();a.representationtypes.forEach(function(R){if(R.parameter&&R.parameter.orderby){var r=new sap.apf.ui.utils.Helper(t.oCoreApi).getRepresentationSortInfo(R);R.sortDescription=r;}});a.selectedRepresentaionType=a.getSelectedRepresentationInfo();if(a.selectedRepresentaionType.parameter&&a.selectedRepresentaionType.parameter.orderby){var r=new sap.apf.ui.utils.Helper(this.oCoreApi).getRepresentationSortInfo(a.selectedRepresentaionType);a.selectedRepresentaionType.sortDescription=r;}var b=a.representationtypes.length;var s;var d=function(f){var a=t.oCoreApi.getSteps()[f.nActiveStepIndex];a.getSelectedRepresentation().bIsAlternateView=false;a.setSelectedRepresentation(f.oRepresentationType.representationId);t.oUiApi.getAnalysisPath().getController().refresh(f.nActiveStepIndex);t.oCoreApi.updatePath(t.oUiApi.getAnalysisPath().getController().callBackForUpdatePath.bind(t.oUiApi.getAnalysisPath().getController()));};this.openList=function(E){var f=E.getParameter("listItem").getCustomData()[0].getValue();d(f);s.setIcon(f.icon);s.setTooltip(t.oCoreApi.getTextNotHtmlEncoded(f.oRepresentationType.label)+"\n"+(f.oRepresentationType.sortDescription!==undefined?t.oCoreApi.getTextNotHtmlEncoded("sortBy")+": "+f.oRepresentationType.sortDescription:""));};var A=new sap.m.List({mode:sap.m.ListMode.SingleSelectMaster,showSeparators:sap.m.ListSeparators.None,includeItemInSelection:true,select:jQuery.proxy(function(E){this.openList(E);},this)});var c=sap.ui.Device.system.desktop?false:true;for(var j=0;j<b;j++){var i=new sap.m.StandardListItem({description:a.representationtypes[j].sortDescription&&this.oCoreApi.getTextNotHtmlEncoded("sortBy")+": "+a.representationtypes[j].sortDescription,icon:a.representationtypes[j].picture,title:t.oCoreApi.getTextNotHtmlEncoded(a.representationtypes[j].label),adaptTitleSize:c,customData:[new sap.ui.core.CustomData({key:'data',value:{oRepresentationType:a.representationtypes[j],nActiveStepIndex:t.oCoreApi.getSteps().indexOf(t.oCoreApi.getActiveStep()),icon:a.representationtypes[j].picture}})]});if(sap.ui.Device.system.desktop){i.addStyleClass("repItem");}A.addItem(i);}var S=new sap.m.Popover({placement:sap.m.PlacementType.Bottom,showHeader:false,content:[A]}).addStyleClass("sapCaUiChartToolBarShowAllChartListPopover");function p(E){var f=E.getSource().getCustomData()[0].getValue();d(f);}for(var k=0;k<b;k++){var e=new sap.m.Button({tooltip:t.oCoreApi.getTextNotHtmlEncoded(a.representationtypes[k].label)+"\n"+((a.representationtypes[k].sortDescription!==undefined)?this.oCoreApi.getTextNotHtmlEncoded("sortBy")+": "+a.representationtypes[k].sortDescription:""),icon:a.representationtypes[k].picture,customData:[new sap.ui.core.CustomData({key:'data',value:{oRepresentationType:a.representationtypes[k],nActiveStepIndex:t.oCoreApi.getSteps().indexOf(t.oCoreApi.getActiveStep()),icon:a.representationtypes[k].picture}})],press:p});e.addStyleClass("iconLeft");this.getView().chartToolbar.getToolBar().insertContentRight(e);}s=new sap.m.Button({icon:a.selectedRepresentaionType.picture,tooltip:this.oCoreApi.getTextNotHtmlEncoded(a.selectedRepresentaionType.label)+"\n"+((a.selectedRepresentaionType.sortDescription!==undefined)?this.oCoreApi.getTextNotHtmlEncoded("sortBy")+": "+a.selectedRepresentaionType.sortDescription:""),press:function(){S.openBy(this);}}).addStyleClass("iconList");this.getView().chartToolbar.getToolBar().insertContentRight(s,0);this.insertContentLeft();},drawToolBar:function(){var t=this;this.showAndHideIcons=function(){var t=this;t.isSwitchRepresentation=false;if(t.getView().chartToolbar.getFullScreen()===true){jQuery(".iconList").hide();jQuery(".iconLeft").show();}else{jQuery(".iconList").show();jQuery(".iconLeft").hide();}if((t.oCoreApi.getActiveStep().getSelectedRepresentation().bIsAlternateView&&t.oCoreApi.getActiveStep().getSelectedRepresentation().getAlternateRepresentation().id===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION)||t.oCoreApi.getActiveStep().getSelectedRepresentation().type===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){jQuery(".sortButton").show();}else{jQuery(".sortButton").hide();}if(t.oCoreApi.getSteps().length>=1){t.showSelectionCount();}var a=t.getView().chartToolbar.getId();if(t.oCoreApi.getActiveStep().getSelectedRepresentation().getAlternateRepresentation()!==undefined){if((!t.oCoreApi.getActiveStep().getSelectedRepresentation().bIsAlternateView&&t.oCoreApi.getActiveStep().getSelectedRepresentation().getAlternateRepresentation().id!==sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION)||t.oCoreApi.getActiveStep().getSelectedRepresentation().type!==sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){if((window.innerWidth===jQuery("#"+a+" > div:first-child > div:nth-child(2)").width())){jQuery(t.getView().chartToolbar._oShowLegendButton.getDomRef()).show();}}}};this.renderIcons=function(){var t=this;var a=t.oCoreApi.getActiveStep();if(a!==undefined){t.getView().chartToolbar._oFullScreenButton.setTooltip(t.oCoreApi.getTextNotHtmlEncoded("toggle-fullscreen"));t.getView().chartToolbar._oFullScreenExitButton.setTooltip(t.oCoreApi.getTextNotHtmlEncoded("toggle-fullscreen"));if(t.alternateRepresentationIcon===false&&t.oCoreApi.getActiveStep().getSelectedRepresentation().type!==sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){t.drawAlternateRepresentation();t.alternateRepresentationIcon=true;}if(t.oCoreApi.getActiveStep().getSelectedRepresentation().type===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){if(t.viewSettingsIcon===false){t.insertViewSettingsIcon();}t.viewSettingsIcon=true;}if(t.oCoreApi.getActiveStep().getRepresentationInfo().length>1){if(t.chartIconInserted===false){t.drawMultipleRepresentation();}t.chartIconInserted=true;}else if(t.oCoreApi.getActiveStep().getRepresentationInfo().length===1){if(t.chartIconInserted===false){t.drawSingleRepresentation();}t.chartIconInserted=true;}if((t.oCoreApi.getActiveStep().getSelectedRepresentation().bIsAlternateView&&t.oCoreApi.getActiveStep().getSelectedRepresentation().getAlternateRepresentation().id===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION)||t.oCoreApi.getActiveStep().getSelectedRepresentation().type===(sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION||sap.apf.ui.utils.CONSTANTS.representationTypes.GEO_MAP)){t.getView().chartToolbar._oShowLegendButton.setVisible(false);}else{t.getView().chartToolbar._oShowLegendButton.setVisible(true);t.getView().chartToolbar._oShowLegendButton.setTooltip(t.oCoreApi.getTextNotHtmlEncoded("legend"));}if(t.isSwitchRepresentation===true){t.getView().chartToolbar.setShowLegend(true);}}};this.getView().chartToolbar.addEventDelegate({onAfterRendering:function(){if(t.oCoreApi.getSteps().length>0){t.showAndHideIcons();}var s=t.oCoreApi.getActiveStep();if(s){var c=s.getSelectedRepresentation();var f;var a=s.getSelectedRepresentation().chart||{};if(c.bIsLegendVisible===true||c.bIsLegendVisible===undefined){if(a.setVizProperties){a.setVizProperties({legend:{visible:true},sizeLegend:{visible:true}});}else{if(a.setLegend!==undefined){a.setLegend(new sap.viz.ui5.types.legend.Common({visible:true,title:new sap.viz.ui5.types.legend.Common_title({visible:true})}));}if(a.setSizeLegend!==undefined){f=a.getSizeLegend().getFormatString();a.setSizeLegend(new sap.viz.ui5.types.legend.Common({visible:true,title:new sap.viz.ui5.types.legend.Common_title({visible:true})}));if(f!==null){a.getSizeLegend().setFormatString(f);}}}}else{if(a.setVizProperties){a.setVizProperties({legend:{visible:false},sizeLegend:{visible:false}});}else{if(a.setLegend!==undefined){a.setLegend(new sap.viz.ui5.types.legend.Common({visible:false,title:new sap.viz.ui5.types.legend.Common_title({visible:false})}));}if(a.setSizeLegend!==undefined){f=a.getSizeLegend().getFormatString();a.setSizeLegend(new sap.viz.ui5.types.legend.Common({visible:false,title:new sap.viz.ui5.types.legend.Common_title({visible:false})}));if(f!==null){a.getSizeLegend().setFormatString(f);}}}}}},onBeforeRendering:function(){if(t.oCoreApi.getSteps().length>0){t.renderIcons();}}});},drawRepresentation:function(c){var t=this;this.isSwitchRepresentation=true;this.getView().chartToolbar.getToolBar().removeAllContentLeft();this.getView().chartToolbar.getToolBar().removeAllContentRight();this.chartIconInserted=false;this.alternateRepresentationIcon=false;this.viewSettingsIcon=false;this.getView().chartToolbar.removeAllCharts();this.getView().chartToolbar.insertChart(c);if(this.getView().chartToolbar.getFullScreen()===true){this.getView().chartToolbar.rerender();if(this.oCoreApi.getActiveStep().getSelectedRepresentation().bIsAlternateView||this.oCoreApi.getActiveStep().getSelectedRepresentation().type===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){var s=this.oCoreApi.getActiveStep().getSelectedRepresentation().getParameter().requiredFilters.length>0?"MultiSelect":"None";this.getView().chartToolbar.getCharts()[0].getContent()[0].getContent()[1].getContent()[0].setMode(s);this.getView().chartToolbar.getCharts()[0].getContent()[0].getContent()[1].getContent()[0].rerender();}}this.drawToolBar();this.getView().chartToolbar.onAfterRendering=function(){var l=this._oShowLegendButton.getDomRef();var e=sap.ui.Device.browser.mobile?"tap":"click";jQuery(l).on(e,function(){var S=t.oCoreApi.getActiveStep();var a=S.getSelectedRepresentation();if(a.bIsLegendVisible===true||a.bIsLegendVisible===undefined){a.bIsLegendVisible=false;}else{a.bIsLegendVisible=true;}});};}});
