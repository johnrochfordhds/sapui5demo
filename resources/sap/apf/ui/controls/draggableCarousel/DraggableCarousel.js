/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.ui.controls.draggableCarousel.DraggableCarousel");(function(u){"use strict";var a,b;var d=(function(){var i=navigator.maxTouchPoints;var c='ontouchstart'in window?true:false;a=c||i;if('onclick'in window){b=true;}})();sap.apf.ui.controls.draggableCarousel.DraggableCarousel=function(o){var c=o||{};this.eleRefs={blocks:[],containerEle:o.containerEle};this._editState=c.editable===u?true:c.editable;this._dragState=this._editState;this._removeState=this._editState;this.styles={containerHeight:c.containerHeight,containerWidth:c.containerWidth,blockHeight:c.blockHeight,blockWidth:c.blockWidth,blockMargin:c.blockMargin,separatorHeight:c.separatorHeight,removeIconHeight:c.removeIconHeight};this.elems={separator:c.separator,removeIcon:c.removeIcon};this.callbacks={onBeforeDrag:c.onBeforeDrag,onAfterDrop:c.onAfterDrop,onAfterRemove:c.onAfterRemove,onAfterSelect:c.onAfterSelect};this.eleRefs.containerEle=this._drawSkeleton();this._initDimensions();this._isMouseDown=false;};sap.apf.ui.controls.draggableCarousel.DraggableCarousel.prototype={_initDimensions:function(){var m=this.styles.blockMargin;this._blockMargin=parseInt(m.replace("px"),10);var B=this.styles.blockHeight;this._blockHeight=parseInt(B.replace("px"),10);this._blockTotalHeight=this._blockHeight+(2*this._blockMargin);this._separatorHeight=0;if(this.elems.separator!==u){var s=this.styles.separatorHeight;this._separatorHeight=parseInt(s.replace("px"),10);}this._mFactor=this._blockTotalHeight+this._separatorHeight;},_drawSkeleton:function(){var c;if(this.eleRefs.containerEle===u){c=document.createElement('div');}else{c=this.eleRefs.containerEle;}c.style.cssText+=this._getContainerStyles();c.classList.add('DnD-container');var s=this;var t=function(e){s._onMouseUp(e,s);};if(a){document.addEventListener("touchend",t);}if(b){document.addEventListener("mouseup",t);}return c;},_getBlockWrapper:function(c){var f=c.blockElement;var g=this.eleRefs.blocks;var h=c.dragState===u?true:c.dragState;var i=c.dropState===u?true:c.dropState;var r=c.removable===u?true:c.removable;var j=document.createElement('div');j.style.cssText+=this._getBlockStyles();j.setAttribute('class','DnD-block');j.setAttribute('drag-state',h);j.setAttribute('drop-state',i);if(r){var k=this._getRemoveIconEle();j.appendChild(k);}var s=this;var t=function(e){s._onMouseDown(e,s,this);};if(a){j.addEventListener("touchstart",t);}if(b){j.addEventListener("mousedown",t);}var l=function(e){window.clearTimeout(s._TIMEOUTID);};if(a){j.addEventListener("touchmove",l);}if(b){j.addEventListener("mousemove",l);}this._keypress(j,13,function(m,e){var n=g.indexOf(m);s.callbacks.onAfterSelect.apply(m,[n]);});this._keypress(j,32,function(m,e){var n=g.indexOf(m);s.callbacks.onAfterSelect.apply(m,[n]);});this._keypress(j,36,function(m,e){jQuery(g).removeAttr("tabindex");jQuery(g).attr("tabindex",-1);jQuery(g[0]).attr("tabindex",0);jQuery(g[0]).focus();});this._keypress(j,35,function(m,e){jQuery(g).removeAttr("tabindex");jQuery(g).attr("tabindex",-1);jQuery(g[g.length-1]).attr("tabindex",0);jQuery(g[g.length-1]).focus();});if(r===true){this._keypress(j,46,function(m,e){var n=g.indexOf(m);s.removeBlock(n,s.callbacks.onAfterRemove);s._grouping(g);jQuery(g).parent().wrap("<div>").find("[tabindex='0']").focus();});}j.appendChild(f);return j;},_getSeparatorEle:function(){var s=document.createElement('div');s.style.cssText+=this._getSeparatorStyles();s.setAttribute('class','DnD-separator');s.innerHTML=this.elems.separator.outerHTML;return s;},_getRemoveIconEle:function(){var r=this.elems.removeIcon;var c=document.createElement('div');c.style.cssText+=this._getRemoveIconStyles();c.setAttribute('class','DnD-removeIconWrapper');c.innerHTML=r.outerHTML;var s=this;var t=function(e){s._onRemoveBlock(e,s,this);};if(a){c.addEventListener("touchstart",t);}if(b){c.addEventListener("mousedown",t);}return c;},addBlock:function(c){if(c instanceof Array){var i;for(i=0;i<c.length;i++){this.addBlock(c[i]);}return;}var e=this._getBlockWrapper(c);var f=this.eleRefs.blocks.length;var g=this.eleRefs.blocks;var y=f*this._mFactor;e.style.cssText=e.style.cssText+this._getTransformCss(y);this.eleRefs.blocks.push(e);var h=this.eleRefs.containerEle;h.appendChild(e);this._setHorizontalBlockMargin();if(this.elems.separator!==u){var s=this._getSeparatorEle();var j=y+this._blockHeight+2*this._blockMargin;s.style.cssText=s.style.cssText+this._getTransformCss(j);h.appendChild(s);}this._grouping(g);},swapBlocks:function(f,t){var c=this.eleRefs.blocks[f];var e=this.eleRefs.blocks[t];if((c.getAttribute('drag-state')!=="true"&&c.getAttribute('drop-state')!=="true")||(e.getAttribute('drag-state')!=="true"&&e.getAttribute('drop-state')!=="true")){return false;}var g=f*this._mFactor;var h=t*this._mFactor;var i=h;var j=i+this._blockHeight+(2*this._blockMargin);var k=document.getElementsByClassName('scrollContainerEle')[0]?document.getElementsByClassName('scrollContainerEle')[0]:this.eleRefs.containerEle;var s=k.scrollTop;if((f>t)&&i<k.scrollTop){s=i;}if((f<t)&&j-k.offsetHeight>k.scrollTop){s=j-k.offsetHeight;}var p;var l=40;var m=window.setInterval(function(){k.scrollTop+=(s-k.scrollTop)/l;if(k.scrollTop===p){window.clearInterval(m);}p=k.scrollTop;},1000/60);this._setTransformYValue(c,h);this._setTransformYValue(e,g);this._swapArray(this.eleRefs.blocks,f,t);return true;},insertBlock:function(c,e){var f=this.eleRefs.blocks;f.push({});var i;for(i=f.length-1;i>e;i--){f[i]=f[i-1];var g=i*this._mFactor;this._setTransformYValue(f[i],g);}var h=this._getBlockWrapper(c);f[i]=h;var y=e*this._mFactor;h.style.cssText=h.style.cssText+this._getTransformCss(y);var j=this.eleRefs.containerEle;j.appendChild(h);this._setHorizontalBlockMargin();if(this.elems.separator!==u){var s=this._getSeparatorEle();var k=y+this._blockHeight+2*this._blockMargin;s.style.cssText=s.style.cssText+this._getTransformCss(k);j.appendChild(s);}this._grouping(f);},removeBlock:function(c,e){var f=this.eleRefs.blocks;var g=this.eleRefs.containerEle;var i;var r=f[c];g.removeChild(r);for(i=c;i<f.length-1;i++){f[i]=f[i+1];var y=i*this._mFactor;this._setTransformYValue(f[i],y);}f.pop();if(this.elems.separator!==u){var s=g.querySelectorAll('.DnD-separator');var l=s[s.length-1];g.removeChild(l);}e.apply(g,[c]);this._grouping(f);},placeAt:function(i){var e=document.getElementById(i);e.appendChild(this.eleRefs.containerEle);this._setHorizontalBlockMargin();},getEditable:function(){return this._editState;},setEditable:function(e){this._editState=e;this._setDragState(e);this._setRemoveState(e);},_setDragState:function(c){this._dragState=c;},_setRemoveState:function(r){this._removeState=r;var c=this.eleRefs.containerEle.querySelectorAll('.DnD-removeIconWrapper');var e;if(r){e="display : block";}else{e="display : none";}var i;for(i=0;i<c.length;i++){c[i].style.cssText+=e;}},_getContainerStyles:function(){var s=["height : ",this.styles.containerHeight,";width : ",this.styles.containerWidth,"; position : relative"].join("");return s;},_getBlockStyles:function(){if(this.styles.horizontalBlockMargin===u){var c=this.eleRefs.containerEle.clientWidth;var e=this.eleRefs.blocks[0]===u?0:this.eleRefs.blocks[0].clientWidth;this.styles.horizontalBlockMargin=((c-e)/2)+"px";}var s=["height : ",this.styles.blockHeight,";width : ",this.styles.blockWidth,";margin : ",this.styles.blockMargin," ",this.styles.horizontalBlockMargin,";position : absolute"].join("");return s;},_getSeparatorStyles:function(){var s=["height : ",this.styles.separatorHeight,";width : 100%",";position : absolute"].join("");return s;},_getRemoveIconStyles:function(){var s=["height : ",this.styles.removeIconHeight,";width : ",this.styles.removeIconHeight,";float : right",";margin : -10px -13px -10px 0",";z-index : 2",";position : relative",";cursor : pointer"].join("");if(this._removeState){s+=";display : block";}else{s+=";display : none";}return s;},_getTransformCss:function(y){var Y=y+"px";var t=["transform","-webkit-transform","-moz-transform","-ms-transform","-o-transform"];var c="";var i;for(i=0;i<t.length;i++){c+=t[i]+": translate3d(0px,"+Y+", 0px); ";}return c;},_setTransformYValue:function(e,y){var v=[{"WebkitTransform":"-webkit-transform"},{"MozTransform":"-moz-transform"},{"MsTransform":"-ms-transform"},{"OTransform":"-o-transform"}];var t="transform";var i;for(i=0;i<v.length;i++){if(e.style.hasOwnProperty(Object.keys(v[i])[0])){t=v[i][Object.keys(v[i])[0]];}}var Y=y+'px';e.style.cssText=e.style.cssText+" "+t+": translate3d(0px,"+Y+", 0px);";},_setHorizontalBlockMargin:function(){var c=this.eleRefs.blocks;var e=this.eleRefs.containerEle;var f=c[0]===u?0:jQuery(c[0]).width();var g=jQuery(e).width();this.styles.horizontalBlockMargin=((g-f)/2)+"px";var m=this.styles.horizontalBlockMargin;[].forEach.call(c,function(h){h.style.cssText+="margin-right : "+m+";margin-left : "+m;});},_onMouseDown:function(e,c,f){c._isMouseDown=true;c._TIMEOUTID=window.setTimeout(function(){if(c._isMouseDown){c._onDragStart(e,c,f);}},500);},_onMouseUp:function(e,c){c._isMouseDown=false;if(c._dragEle!==u&&c._dragEle.ele!==u){c._onDrop(e,c);}},_onDragStart:function(e,c,f){if(!c._dragState||f.getAttribute('drag-state')!=='true'){return;}c._dragIndex=c.eleRefs.blocks.indexOf(f);var y=c._dragIndex*c._mFactor;var g=document.getElementsByClassName('scrollContainerEle')[0]?document.getElementsByClassName('scrollContainerEle')[0]:c.eleRefs.containerEle;c._containerEleOffsetHeight=g.offsetHeight;c._containerEleScrollHeight=g.scrollHeight;c._blockEleOffsetHeight=f.offsetHeight;c._containerEleScrollTop=g.scrollTop;var h=y+c._blockMargin;var i=h+c._blockHeight;if(h<c._containerEleScrollTop){g.scrollTop=h;c._containerEleScrollTop=Math.max(0,h);}if(i-c._containerEleOffsetHeight>g.scrollTop){g.scrollTop=i-c._containerEleOffsetHeight;c._containerEleScrollTop=Math.min(c._containerEleScrollHeight-c._containerEleOffsetHeight,i-c._containerEleOffsetHeight);}c._diffTop=e.pageY-y+c._containerEleScrollTop;c._dragEle={ele:f,pos:{y:y}};c.callbacks.onBeforeDrag.apply(f,[c._dragIndex]);c._dragEle.ele.className=c._dragEle.ele.className+" "+"DnD-drag";var t=function(e){if(c._dragEle.ele!==u){e.preventDefault();c._onDrag(e,c);e.stopPropagation();}};if(a){document.addEventListener("touchmove",t);}if(b){document.addEventListener("mousemove",t);}},_onDrag:function(e,c){var f=document.getElementsByClassName('scrollContainerEle')[0]?document.getElementsByClassName('scrollContainerEle')[0]:c.eleRefs.containerEle;var y=e.pageY-c._diffTop+c._containerEleScrollTop;var g=y+c._blockMargin;var h=g+c._blockHeight;var j=((e.pageY-c._diffTop)>c._prevPageY);var k=((e.pageY-c._diffTop)<c._prevPageY);c._prevPageY=(e.pageY-c._diffTop);if(k&&(g<c._containerEleScrollTop)){f.scrollTop=g;c._containerEleScrollTop=Math.max(0,g);y=e.pageY-c._diffTop+c._containerEleScrollTop;}if(j&&((h-c._containerEleOffsetHeight)>c._containerEleScrollTop)){f.scrollTop=h-c._containerEleOffsetHeight;c._containerEleScrollTop=Math.min(c._containerEleScrollHeight-c._containerEleOffsetHeight,h-c._containerEleOffsetHeight);y=e.pageY-c._diffTop+c._containerEleScrollTop;}c._setTransformYValue(c._dragEle.ele,y);var l=y;var m=y+c._blockEleOffsetHeight;var n=c._dragEle.pos.y-(c._mFactor-(c._blockHeight/2));var o=(c._dragEle.pos.y+c._blockEleOffsetHeight)+(c._mFactor-(c._blockHeight/2));var p=c._dragEle.pos.y;var q=p/(c._mFactor);var r=c.eleRefs.blocks;var s=-1,t=r.length;var i,v;for(i=q-1;i>=0;i--){v=r[i];if(v.getAttribute('drop-state')==='true'){s=i;break;}}for(i=q+1;i<r.length;i++){v=r[i];if(v.getAttribute('drop-state')==='true'){t=i;break;}}n=c._dragEle.pos.y-((q-s)*c._mFactor-(c._blockHeight/2));o=(c._dragEle.pos.y+c._blockEleOffsetHeight)+((t-q)*c._mFactor-(c._blockHeight/2));var w;var S=false;if(l<n){S=true;w=s;}else if(m>o){S=true;w=t;}if(S&&(w>=0)&&(w<=r.length-1)){c._dragEle.pos.y=w*(c._mFactor);var x=r[w];if(x!==u){c._setTransformYValue(x,p);c._swapArray(r,q,w);}}},_onDrop:function(e,c){c._dragEle.ele.className=c._dragEle.ele.className.replace(" DnD-drag","");var f=c.eleRefs.containerEle.querySelectorAll('.DnD-drag');var i;for(i=0;i<f.length;i++){f[i].className=f[i].className.replace(" DnD-drag","");}var g=c._dragEle.pos.y;c._dropIndex=g/(c._mFactor);c._setTransformYValue(c._dragEle.ele,g);c.callbacks.onAfterDrop.apply(c._dragEle.ele,[c._dragIndex,c._dropIndex]);c._dragEle={};},_onRemoveBlock:function(e,c,r){e.stopPropagation();var f=r.parentElement;var g=c.eleRefs.blocks.indexOf(f);c.removeBlock(g,c.callbacks.onAfterRemove);},_swapArray:function(c,f,t){var e=c[f];c[f]=c[t];c[t]=e;return c;},_grouping:function(c){var f=c;var g=(c.length>2)?c.length-2:0;jQuery(f).removeAttr("tabindex");jQuery(f).attr("tabindex",-1);jQuery(f[g]).attr("tabindex",0);this._keypress(f,38,function(h,e){var i=f.indexOf(h);if(i===0){return;}jQuery(f).removeAttr("tabindex");jQuery(f).attr("tabindex",-1);jQuery(f[i-1]).attr("tabindex",0);jQuery(f[i-1]).focus();});this._keypress(f,40,function(h,e){var i=f.indexOf(h);if(i===f.length-1){return;}jQuery(f).removeAttr("tabindex");jQuery(f).attr("tabindex",-1);jQuery(f[i+1]).attr("tabindex",0);jQuery(f[i+1]).focus();});},_keypress:function(c,k,f){jQuery(c).keydown(function(e){var g=e.keyCode||e.which;if(g===k){f(this,e);return false;}});}};}(undefined));
