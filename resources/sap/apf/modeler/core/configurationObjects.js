/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.apf.modeler.core.configurationObjects");(function(){'use strict';sap.apf.modeler.core.ConfigurationObjects=function(i){var t=this;var H,a,p,m;if(i.constructor.hashtable){H=i.constructor.hashtable;}if(i.instance.textPool){a=i.instance.textPool;}if(i.instance.persistenceProxy){p=i.instance.persistenceProxy;}if(i.instance.messageHandler){m=i.instance.messageHandler;}function c(j,k){var P=[];if(k){P.push(k);}m.putMessage(m.createMessageObject({code:j,aParameters:P}));}function b(l){var r=l&&l.type&&l.type==="label"&&l.kind&&l.kind==="text"&&l.key&&typeof l.key==="string";if(!r){c(11030,l.key);}return r;}this.serializeLabelKey=function(j){return{type:"label",kind:"text",key:a.getPersistentKey(j)};};this.serializeAndAddThumbnail=function(j,k){var l=j.getLeftLowerCornerTextKey();var n=j.getLeftUpperCornerTextKey();var r=j.getRightUpperCornerTextKey();var o=j.getRightLowerCornerTextKey();var q={type:"thumbnail"};if(n){q.leftUpper=this.serializeLabelKey(n);}if(l){q.leftLower=this.serializeLabelKey(l);}if(r){q.rightUpper=this.serializeLabelKey(r);}if(o){q.rightLower=this.serializeLabelKey(o);}if(q.leftLower||q.leftUpper||q.rightLower||q.rightUpper){k.thumbnail=q;}};this.serializeCategory=function(j,k){var T=a.get(j.labelKey);var l=[];if(k){k.forEach(function(o){l.push({type:"step",id:o});});}var n=(T&&T.TextElementDescription)||"";return{type:"category",description:n,id:j.getId(),label:t.serializeLabelKey(j.labelKey),steps:l};};this.validateCategory=function(j){var r=j&&j.type&&j.type==="category"&&j.id&&j.steps&&b(j.label);if(r){j.steps.forEach(function(o){if(!o.type||o.type!=="step"||!o.id){r=false;}});}if(!r){c(11031,j.id);}return r;};this.validateRequest=function(r){var j=r&&r.id&&r.type==="request"&&r.service&&typeof r.service==="string"&&((r.entityType&&typeof r.entityType==="string")||(r.entitySet&&typeof r.entitySet==="string"))&&r.selectProperties&&r.selectProperties&&r.selectProperties instanceof Array&&r.selectProperties.length>=0;if(!j){c(11032,r.id);}return j;};this.validateBinding=function(j){var r=j&&j.id&&j.type==="binding"&&j.requiredFilters&&j.requiredFilters instanceof Array&&j.requiredFilters.length>=0&&j.representations&&j.representations instanceof Array;if(!r){c(11033,j.id);}return r;};this.validateFacetFilter=function(j){var r=j&&j.id&&j.property&&j.type==="facetFilter";if(!r){c(11034,j.id);}return r;};this.validateNavigationTarget=function(n){var r=n&&n.id&&n.semanticObject&&n.action&&n.type==="navigationTarget"&&n.hasOwnProperty("isStepSpecific");if(!r){c(11040,n.id);}return r;};this.validateStep=function(j){var r=j&&j.id&&j.type==="step"&&b(j.title)&&b(j.longTitle)&&j.hasOwnProperty("navigationTargets");if(!r){c(11035,j.id);}return r;};this.validateConfiguration=function(j){var r=j&&j.applicationTitle&&j.applicationTitle.key&&typeof j.applicationTitle.key==='string'&&j.steps&&j.steps instanceof Array&&j.steps.length>=0&&j.requests&&j.requests instanceof Array&&j.requests.length>=0&&j.bindings&&j.bindings instanceof Array&&j.bindings.length>=0&&j.representationTypes&&j.representationTypes instanceof Array&&j.representationTypes.length>=0&&j.facetFilters&&j.facetFilters instanceof Array&&j.facetFilters.length>=0&&j.categories&&j.categories instanceof Array&&j.categories.length>=0;if(!r){c(11036);}return r;};function s(j){var r=[];var k,l;var n,o;var q;var u;var v;var w;var x=j.getRepresentations();x.forEach(function(y){k=[];l=y.getDimensions();l.forEach(function(z){var A={fieldName:z};if(y.getDimensionKind(z)){A.kind=y.getDimensionKind(z);}if(y.getDimensionTextLabelKey(z)){A.fieldDesc={type:'label',kind:'text',key:y.getDimensionTextLabelKey(z)};}if(y.getLabelDisplayOption(z)){A.labelDisplayOption=y.getLabelDisplayOption(z);}k.push(A);});n=[];o=y.getMeasures();o.forEach(function(z){var A={fieldName:z};if(y.getMeasureKind(z)){A.kind=y.getMeasureKind(z);}if(y.getMeasureTextLabelKey(z)){A.fieldDesc={type:'label',kind:'text',key:y.getMeasureTextLabelKey(z)};}n.push(A);});q=[];y.getProperties().forEach(function(z){var A={fieldName:z};if(y.getPropertyKind(z)){A.kind=y.getPropertyKind(z);}if(y.getPropertyTextLabelKey(z)){A.fieldDesc={type:'label',kind:'text',key:y.getPropertyTextLabelKey(z)};}q.push(A);});u=[];y.getOrderbySpecifications().forEach(function(z){u.push({property:z.property,ascending:z.ascending});});v={id:y.getId(),representationTypeId:y.getRepresentationType(),parameter:{dimensions:k,measures:n,properties:q,alternateRepresentationTypeId:y.getAlternateRepresentationType()}};if(y.getWidthProperties()){v.parameter.width=y.getWidthProperties();}if(u.length>0){v.parameter.orderby=u;}w=y.getTopN();if(w&&w>0){v.parameter.top=w;}t.serializeAndAddThumbnail(y,v);r.push(v);});return r;}this.serializeBinding=function(j,k){var l="binding-for-"+j.getId();var T=a.get(j.getTitleId());var n=(T&&T.TextElementDescription)||"";k.bindings.push({type:"binding",id:l,stepDescription:n,requiredFilters:j.getFilterProperties(),representations:s(j)});return l;};this.serializeRequest=function(j,k){var r;var l="request-for-"+j.getId();r={type:"request",id:l,service:j.getService(),entitySet:j.getEntitySet(),selectProperties:j.getSelectProperties()};k.requests.push(r);return l;};this.serializeFilterMappingRequest=function(o,j){var r="request-for-FilterMapping"+o.getId();var k={type:"request",id:r,service:o.getFilterMappingService(),entitySet:o.getFilterMappingEntitySet(),selectProperties:o.getFilterMappingTargetProperties()};j.requests.push(k);return r;};this.serializeStep=function(j,k){var r=t.serializeRequest(j,k);var l=t.serializeBinding(j,k);var T=a.get(j.getTitleId());var n=(T&&T.TextElementDescription)||"";var o=j.getLongTitleId();var q;var u={type:"step",description:n,request:r,binding:l,id:j.getId(),title:t.serializeLabelKey(j.getTitleId()),navigationTargets:[]};if(j.getFilterMappingService()){u.filterMapping={requestForMappedFilter:t.serializeFilterMappingRequest(j,k),target:j.getFilterMappingTargetProperties(),keepSource:j.getFilterMappingKeepSource()?"true":"false"};}q=j.getTopN();if(q){u.topNSettings=q;}if(o!==""&&o!==undefined){u.longTitle=t.serializeLabelKey(j.getLongTitleId());}this.serializeAndAddThumbnail(j,u);j.getNavigationTargets().forEach(function(v){u.navigationTargets.push({type:"navigationTarget",id:v});});return u;};this.serializeFacetFilter=function(j,k){var r,l,v;if(j.getServiceOfFilterResolution()){r=o("FilterResolution",j,k);}if(j.getUseSameRequestForValueHelpAndFilterResolution()){l=r;}else if(j.getServiceOfValueHelp()){l=o("ValueHelp",j,k);}var T=a.get(j.getLabelKey());var n=(T&&T.TextElementDescription)||"";if(j.getValueList().length>0){v=j.getValueList();}return{type:"facetFilter",description:n,id:j.getId(),alias:j.getAlias(),property:j.getProperty(),multiSelection:j.isMultiSelection()+"",preselectionFunction:j.getPreselectionFunction(),preselectionDefaults:j.getPreselectionDefaults(),valueList:v,label:t.serializeLabelKey(j.getLabelKey()),invisible:!j.isVisible(),filterResolutionRequest:r,valueHelpRequest:l,hasAutomaticSelection:j.getAutomaticSelection()+"",useSameRequestForValueHelpAndFilterResolution:j.getUseSameRequestForValueHelpAndFilterResolution()+""};function o(q,j,k){var u;var w;var x;var y;switch(q){case"ValueHelp":w=j.getServiceOfValueHelp();x=j.getEntitySetOfValueHelp();y=j.getSelectPropertiesOfValueHelp();break;case"FilterResolution":w=j.getServiceOfFilterResolution();x=j.getEntitySetOfFilterResolution();y=j.getSelectPropertiesOfFilterResolution();break;}var z=q+"-request-for-"+j.getId();u={type:"request",id:z,service:w,entitySet:x,selectProperties:y};k.requests.push(u);return z;}};this.serializeNavigationTarget=function(n,j){var r={type:"navigationTarget",id:n.getId(),semanticObject:n.getSemanticObject(),action:n.getAction(),isStepSpecific:n.isStepSpecific()};if(n.getFilterMappingService()){r.filterMapping={requestForMappedFilter:t.serializeFilterMappingRequest(n,j),target:n.getFilterMappingTargetProperties()};}return r;};this.serializeConfiguration=function(j){var k={analyticalConfigurationName:j.getConfigurationName(),applicationTitle:t.serializeLabelKey(j.getApplicationTitle()),steps:[],requests:[],bindings:[],representationTypes:[],categories:[],facetFilters:[],navigationTargets:[]};var l={requests:k.requests,bindings:k.bindings};j.getCategories().forEach(function(n){var o=j.getCategoryStepAssignments(n.getId());k.categories.push(t.serializeCategory(n,o));});j.getSteps().forEach(function(n){var o=t.serializeStep(n,l);k.steps.push(o);});j.getFacetFilters().forEach(function(n){var o=t.serializeFacetFilter(n,l);k.facetFilters.push(o);});j.getNavigationTargets().forEach(function(n){var o=t.serializeNavigationTarget(n,l);k.navigationTargets.push(o);});return k;};function d(j,k){var l=j.thumbnail;if(!l){return;}if(l.leftLower){k.setLeftLowerCornerTextKey(l.leftLower.key);}if(l.leftUpper){k.setLeftUpperCornerTextKey(l.leftUpper.key);}if(l.rightLower){k.setRightLowerCornerTextKey(l.rightLower.key);}if(l.rightUpper){k.setRightUpperCornerTextKey(l.rightUpper.key);}}function e(j,r,k){var l=k.createStepWithId(j.id);var n=k.getStep(l);var o=r.getItem(j.request);if(o.entityType){o.entitySet=o.entityType;delete o.entityType;}if(o.service){k.registerService(o.service);}n.setService(o.service);n.setEntitySet(o.entitySet);n.setTitleId(j.title.key);if(j.longTitle&&j.longTitle.key){n.setLongTitleId(j.longTitle.key);}if(j.navigationTargets){j.navigationTargets.forEach(function(u){n.addNavigationTarget(u.id);});}d(j,n);o.selectProperties.forEach(function(u){n.addSelectProperty(u);});var q=r.getItem(j.binding);q.requiredFilters.forEach(function(u){n.addFilterProperty(u);});q.representations.forEach(function(u){var v;var w=n.getRepresentation(n.createRepresentation().getId());w.setRepresentationType(u.representationTypeId);w.setAlternateRepresentationType(u.parameter.alternateRepresentationTypeId);u.parameter.dimensions.forEach(function(x){w.addDimension(x.fieldName);if(x.fieldDesc){w.setDimensionTextLabelKey(x.fieldName,x.fieldDesc.key);}if(x.kind){w.setDimensionKind(x.fieldName,x.kind);}if(x.labelDisplayOption){w.setLabelDisplayOption(x.fieldName,x.labelDisplayOption);}});u.parameter.measures.forEach(function(x){w.addMeasure(x.fieldName);if(x.fieldDesc){w.setMeasureTextLabelKey(x.fieldName,x.fieldDesc.key);}if(x.kind){w.setMeasureKind(x.fieldName,x.kind);}});if(u.parameter.properties){u.parameter.properties.forEach(function(x){w.addProperty(x.fieldName);if(x.fieldDesc){w.setPropertyTextLabelKey(x.fieldName,x.fieldDesc.key);}if(x.kind){w.setPropertyKind(x.fieldName,x.kind);}});}if(u.parameter.width){for(v in u.parameter.width){if(u.parameter.width.hasOwnProperty(v)){w.setWidthProperty(v,u.parameter.width[v]);}}}if(u.parameter.orderby&&!u.parameter.topN){u.parameter.orderby.forEach(function(x){w.addOrderbySpec(x.property,x.ascending);});}d(u,w);});if(j.filterMapping){h(j.filterMapping,n,r);}if(j.topNSettings){n.setTopN(j.topNSettings.top,j.topNSettings.orderby);}}function f(j,r,k){var l=k.createFacetFilterWithId(j.id);var n=k.getFacetFilter(l);n.setLabelKey(j.label.key);n.setAlias(j.alias);n.setProperty(j.property);if(j.preselectionFunction&&j.preselectionFunction!==""){n.setPreselectionFunction(j.preselectionFunction);}else{n.setPreselectionDefaults(j.preselectionDefaults);}if(j.valueList){n.setValueList(j.valueList);}if(j.useSameRequestForValueHelpAndFilterResolution&&j.useSameRequestForValueHelpAndFilterResolution==="true"){n.setUseSameRequestForValueHelpAndFilterResolution(true);}else{n.setUseSameRequestForValueHelpAndFilterResolution(false);}if(j.multiSelection==="true"){n.setMultiSelection(true);}if(j.invisible===true){n.setInvisible();}if(j.hasAutomaticSelection==="true"){n.setAutomaticSelection(true);}else{n.setAutomaticSelection(false);}if(j.valueHelpRequest){var o=r.getItem(j.valueHelpRequest);if(o.entityType){o.entitySet=o.entityType;delete o.entityType;}if(o.service){k.registerService(o.service);n.setServiceOfValueHelp(o.service);}if(o.entitySet){n.setEntitySetOfValueHelp(o.entitySet);}o.selectProperties.forEach(function(u){n.addSelectPropertyOfValueHelp(u);});}if(j.filterResolutionRequest){var q=r.getItem(j.filterResolutionRequest);if(q.entityType){q.entitySet=q.entityType;delete q.entityType;}if(q.service){k.registerService(q.service);n.setServiceOfFilterResolution(q.service);}if(q.entitySet){n.setEntitySetOfFilterResolution(q.entitySet);}q.selectProperties.forEach(function(u){n.addSelectPropertyOfFilterResolution(u);});}}function g(j,r,k){var l=k.createNavigationTargetWithId(j.id);var n=k.getNavigationTarget(l);n.setSemanticObject(j.semanticObject);n.setAction(j.action);if(j.isStepSpecific===true){n.setStepSpecific();}else{n.setGlobal();}if(j.filterMapping){h(j.filterMapping,n,r);}}function h(j,k,r){var l=r.getItem(j.requestForMappedFilter);if(l.entityType){l.entitySet=l.entityType;delete l.entityType;}k.setFilterMappingService(l.service);k.setFilterMappingEntitySet(l.entitySet);j.target.forEach(function(n){k.addFilterMappingTargetProperty(n);});if(j.hasOwnProperty("keepSource")){if(j.keepSource==="true"){k.setFilterMappingKeepSource(true);}else{k.setFilterMappingKeepSource(false);}}}this.mapToDesignTime=function(r,j){j.setApplicationTitle(r.getItem('applicationTitle').key);r.getSteps().forEach(function(k){e(k,r,j);});r.getCategories().forEach(function(k){j.createCategoryWithId({labelKey:k.label.key},k.id);k.steps.forEach(function(l){j.addCategoryStepAssignment(k.id,l.id);});});r.getFacetFilters().forEach(function(k){f(k,r,j);});r.getNavigationTargets().forEach(function(n){g(n,r,j);});};this.loadAllConfigurations=function(j,k){var l=new sap.apf.core.utils.Filter(m,'Application','eq',j);p.readCollection("configuration",function(r,n,o){k(r,n,o);},undefined,undefined,l,true);};this.getTextKeysFromAllConfigurations=function(j,k){this.loadAllConfigurations(j,function(l,n,o){var q=new H(m);if(o){k(undefined,o);return;}l.forEach(function(r){var u=JSON.parse(r.SerializedAnalyticalConfiguration);var v=sap.apf.modeler.core.ConfigurationObjects.getTextKeysFromConfiguration(u);v.forEach(function(w){q.setItem(w,w);});});k(q,undefined);});};};sap.apf.modeler.core.ConfigurationObjects.deepDataCopy=function deepDataCopy(i){var r;if(!i){r=i;}else if(i.copy&&typeof i.copy==="function"){r=i.copy();}else if(i&&typeof i==="object"){if(i instanceof Array){r=[];i.forEach(function(a){r.push(deepDataCopy(a));});}else{r={};for(var a in i){if(!i.hasOwnProperty(a)){continue;}r[a]=deepDataCopy(i[a]);}}}else{r=i;}return r;};sap.apf.modeler.core.ConfigurationObjects.getTextKeysFromConfiguration=function getTextKeysFromConfiguration(c){var r=[];if(!c){return;}if(c.type&&c.type==="label"&&c.kind&&c.kind==="text"&&c.key){return[c.key];}for(var i in c){if(typeof c[i]!=="object"||!c.hasOwnProperty(i)){continue;}Array.prototype.push.apply(r,getTextKeysFromConfiguration(c[i]));}return r;};}());
