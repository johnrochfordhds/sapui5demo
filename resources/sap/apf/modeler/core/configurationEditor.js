/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.apf.modeler.core.configurationEditor");jQuery.sap.require("sap.apf.utils.utils");(function(){'use strict';sap.apf.modeler.core.ConfigurationEditor=function(c,a,b,d){var t=this;var e;var f=a.instance.configurationHandler;var p=a.instance.persistenceProxy;var m=a.instance.messageHandler;var g=a.instance.metadataFactory;var h=true;var s,j,k,n,l,o;var q=new a.constructor.configurationObjects(a);var r=new a.constructor.configurationFactory({messageHandler:m,constructor:{registryProbe:a.constructor.registryProbe}});if(!d){s=new a.constructor.elementContainer("Step",a.constructor.step,a);j=new a.constructor.elementContainer("Category",undefined,a);k=new a.constructor.elementContainer("FacetFilter",a.constructor.facetFilter,a);n=new a.constructor.elementContainer("NavigationTarget",a.constructor.navigationTarget,a);l=new a.constructor.elementContainer("CategoryStepAssignment",a.constructor.elementContainer,a);o=[];}else{s=d.stepContainer;j=d.categoryContainer;k=d.facetFilterContainer;n=d.navigationTargetContainer;l=d.categoryStepAssignmentContainer;o=d.serviceList;e=d.applicationTitle;}this.registerService=function(i){var x=false;if(o.indexOf(i)===-1){if(g.getMetadata(i)){o.push(i);x=true;}}else{x=true;}return x;};this.getAllServices=function(){return o;};this.getAllEntitySetsOfService=function(i){var x=[];if(o.indexOf(i)>-1){x=g.getEntitySets(i);}return x;};this.getAllEntitySetsOfServiceWithGivenProperties=function(x,y){var z=[],A;var B=this.getAllEntitySetsOfService(x);if(!y||y.length===0){return B;}A=g.getMetadata(x);B.forEach(function(C){var D=A.getFilterableProperties(C);var E=true;for(var i=0;i<y.length;i++){if(D.indexOf(y[i])<=-1){E=false;break;}}if(E){z.push(C);}});return z;};this.getAllPropertiesOfEntitySet=function(i,x){var y=[];if(o.indexOf(i)>-1){y=g.getMetadata(i).getAllPropertiesOfEntitySet(x);}return y;};this.getAllKnownProperties=function(){var i=[];var x;o.forEach(function(y){x=g.getMetadata(y);i=i.concat(x.getAllProperties());});i=sap.apf.utils.eliminateDuplicatesInArray(m,i);return i;};this.setApplicationTitle=function(i){h=false;e=i;};this.getApplicationTitle=function(){return e;};this.getConfigurationName=function(){return f.getConfiguration(c.id||c).AnalyticalConfigurationName;};this.getCategoryStepAssignments=function(i){var x=[];if(!this.getCategory(i)){return false;}var y=l.getElement(i);if(y){y.getElements().forEach(function(z){x.push(z.stepId);});}return x;};this.addCategoryStepAssignment=function(i,x){if(!this.getCategory(i)||!this.getStep(x)){return false;}var y=l.getElement(i);if(!y){l.createElementWithProposedId({},i);y=l.getElement(i);}if(!y.getElement(x)){y.createElementWithProposedId({stepId:x},x);return true;}return false;};this.removeCategoryStepAssignment=function(i,x){var y;if(!x){var z=this.getCategoryStepAssignments(i);y=l.removeElement(i);if(y){_(z);}return!!y;}var A=l.getElement(i);if(!A){return false;}y=A.removeElement(x);if(A.getElements().length===0){l.removeElement(i);}if(y){_([x]);}return!!y;};function _(i){if(!i){return;}i.forEach(function(x){if(t.getCategoriesForStep(x).length===0){u(x);}});}this.moveCategoryStepAssignmentBefore=function(i,x,y){var z=l.getElement(i);if(!z){return null;}return z.moveBefore(x,y);};this.moveCategoryStepAssignmentToEnd=function(i,x){var y=l.getElement(i);if(!y){return null;}return y.moveToEnd(x);};this.moveCategoryStepAssignmentUpOrDown=function(i,x,y){var z=l.getElement(i);if(!z){return null;}return z.moveUpOrDown(x,y);};this.getCategory=j.getElement;this.setCategory=function(i,x){h=false;return j.setElement(i,x);};this.createCategoryWithId=function(i,x){h=false;return j.createElementWithProposedId(i,x).getId();};this.removeCategory=function(i){var x=t.getCategoryStepAssignments(i);if(x){x.forEach(function(y){var z=t.getCategoriesForStep(y);if(!z||z.length<2){u(y);}});}j.removeElement(i);};this.getCategories=j.getElements;this.copyCategory=function(i){var x=j.copyElement(i);if(!x){return;}t.getCategoryStepAssignments(i).forEach(function(y){v(y,x);});return x;};this.moveCategoryBefore=function(i,x){return j.moveBefore(i,x);};this.moveCategoryToEnd=function(i){return j.moveToEnd(i);};this.moveCategoryUpOrDown=function(i,x){return j.moveUpOrDown(i,x);};this.serialize=function(){return q.serializeConfiguration(t);};this.isSaved=function(){return h;};this.setIsUnsaved=function(){h=false;};this.save=function(i){function x(A,B,C){if(!C){h=true;f.replaceConfigurationId(c.id||c,A.AnalyticalConfiguration);c=A.AnalyticalConfiguration;}i(c,B,C);}function y(A,B){if(!B){h=true;}i(c.id||c,A,B);}var z={AnalyticalConfiguration:"",AnalyticalConfigurationName:f.getConfiguration(c.id||c).AnalyticalConfigurationName,Application:f.getApplicationId(),SerializedAnalyticalConfiguration:JSON.stringify(this.serialize()),CreatedByUser:"",CreationUTCDateTime:null,LastChangeUTCDateTime:null,LastChangedByUser:""};if(typeof c==='string'){if(c.indexOf("apf1972-")===0){p.create("configuration",z,x);}else{z.AnalyticalConfiguration=c;p.update("configuration",z,y,[{name:"AnalyticalConfiguration",value:c}]);}}else{if(c.id.indexOf("apf1972-")===0){z.AnalyticalConfiguration="";z.CreationUTCDateTime=null;z.LastChangeUTCDateTime=null;}else{z.AnalyticalConfiguration=c.id;z.CreationUTCDateTime=c.creationDate;z.LastChangeUTCDateTime=c.lastChangeDate;}if(c.updateExisting){p.update("configuration",z,y,[{name:"AnalyticalConfiguration",value:c.id}]);}else{p.create("configuration",z,x);}}};this.createFacetFilterWithId=function(i){return k.createElementWithProposedId(undefined,i).getId();};this.createFacetFilter=function(){return k.createElement().getId();};this.removeFacetFilter=k.removeElement;this.getFacetFilter=k.getElement;this.getFacetFilters=k.getElements;this.copyFacetFilter=k.copyElement;this.moveFacetFilterBefore=function(i,x){return k.moveBefore(i,x);};this.moveFacetFilterToEnd=function(i){return k.moveToEnd(i);};this.moveFacetFilterUpOrDown=function(i,x){return k.moveUpOrDown(i,x);};this.createNavigationTargetWithId=function(i){return n.createElementWithProposedId(undefined,i).getId();};this.createNavigationTarget=function(){return n.createElement().getId();};this.removeNavigationTarget=n.removeElement;this.getNavigationTarget=n.getElement;this.getNavigationTargets=n.getElements;this.copyNavigationTarget=n.copyElement;this.moveNavigationTargetBefore=function(i,x){return n.moveBefore(i,x);};this.moveNavigationTargetToEnd=function(i){return n.moveToEnd(i);};this.moveNavigationTargetUpOrDown=function(i,x){return n.moveUpOrDown(i,x);};this.createStepWithId=function(i){return s.createElementWithProposedId(undefined,i).getId();};this.createStep=function(i){if(!this.getCategory(i)){return;}var x=s.createElement().getId();this.addCategoryStepAssignment(i,x);return x;};var u=s.removeElement;this.getStep=s.getElement;this.getSteps=s.getElements;this.getStepsNotAssignedToCategory=function(i){var x=this.getCategoryStepAssignments(i);var y=[];t.getSteps().forEach(function(z){var A=z.getId();if(x.indexOf(A)===-1){y.push(A);}});return y;};this.copyStep=function(i){var x=v(i);var y=this.getCategoriesForStep(i);if(!x){return false;}if(y){y.forEach(function(z){t.addCategoryStepAssignment(z,x);});}return x;};function v(i,x){if(x&&!t.getCategory(x)){return false;}var y=s.copyElement(i);if(!y){return false;}if(x){t.addCategoryStepAssignment(x,y);}return y;}this.getCategoriesForStep=function getCategoriesForStep(i){var x=[];var y=t.getCategories();if(y){y.forEach(function(z){var A=z.getId();var B=t.getCategoryStepAssignments(A);if(B&&B.indexOf(i)>-1){x.push(A);}});}return x;};this.getAssignableStepsForNavigationTarget=function(i){var x=[];t.getSteps().forEach(function(y){var z=false;y.getNavigationTargets().forEach(function(A){if(i===A){z=true;}});if(!z){x.push(y.getId());}});return x;};this.getStepsAssignedToNavigationTarget=function(i){var x=[];t.getSteps().forEach(function(y){var z=false;y.getNavigationTargets().forEach(function(A){if(i===A){z=true;}});if(z){x.push(y.getId());}});return x;};this.copy=function(i){var x={stepContainer:s,categoryContainer:j,facetFilterContainer:k,navigationTargetContainer:n,categoryStepAssignmentContainer:l,applicationTitle:e,serviceList:o};var d=sap.apf.modeler.core.ConfigurationObjects.deepDataCopy(x);return new sap.apf.modeler.core.ConfigurationEditor(i,a,undefined,d);};if(typeof c==='string'){if(c.indexOf("apf1972-")===0){h=false;if(b){b(t,undefined);}}else{if(!d){w(c,p,function(i,x){if(!x){var y=JSON.parse(i.SerializedAnalyticalConfiguration);t.setApplicationTitle(y.applicationTitle);r.loadConfig(y);q.mapToDesignTime(r.getRegistry(),t);h=true;b(t,undefined);}else{b(undefined,x);}});}}}else{r.loadConfig(c.content);q.mapToDesignTime(r.getRegistry(),this);if(b){b(t,undefined);}}function w(i,x,b){x.readEntity("configuration",function(y,z,A){b(y,A);},[{name:"AnalyticalConfiguration",value:i}],undefined,true,f.getApplicationId());}};}());
