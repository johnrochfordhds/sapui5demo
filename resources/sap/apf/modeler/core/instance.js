/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.apf.modeler.core.instance");(function(){'use strict';jQuery.sap.require("sap.ui.thirdparty.datajs");jQuery.sap.require("sap.apf.utils.hashtable");jQuery.sap.require('sap.apf.core.constants');jQuery.sap.require('sap.apf.core.messageHandler');jQuery.sap.require('sap.apf.core.sessionHandler');jQuery.sap.require('sap.apf.core.representationTypes');jQuery.sap.require("sap.apf.core.entityTypeMetadata");jQuery.sap.require("sap.apf.core.configurationFactory");jQuery.sap.require("sap.apf.core.utils.uriGenerator");jQuery.sap.require("sap.apf.core.metadata");jQuery.sap.require("sap.apf.core.metadataFacade");jQuery.sap.require("sap.apf.core.metadataProperty");jQuery.sap.require('sap.apf.core.messageDefinition');jQuery.sap.require("sap.apf.core.metadataFactory");jQuery.sap.require('sap.apf.core.odataProxy');jQuery.sap.require('sap.apf.core.ajax');jQuery.sap.require('sap.apf.core.odataRequest');jQuery.sap.require('sap.apf.modeler.core.messageDefinition');jQuery.sap.require('sap.apf.modeler.core.textHandler');jQuery.sap.require('sap.apf.modeler.core.textPool');jQuery.sap.require('sap.apf.modeler.core.applicationHandler');jQuery.sap.require('sap.apf.modeler.core.configurationHandler');jQuery.sap.require('sap.apf.modeler.core.configurationEditor');jQuery.sap.require("sap.apf.modeler.core.step");jQuery.sap.require("sap.apf.modeler.core.facetFilter");jQuery.sap.require("sap.apf.modeler.core.navigationTarget");jQuery.sap.require("sap.apf.modeler.core.elementContainer");jQuery.sap.require("sap.apf.modeler.core.representation");jQuery.sap.require("sap.apf.modeler.core.configurationObjects");jQuery.sap.require("sap.apf.modeler.core.elementContainer");jQuery.sap.require("sap.apf.utils.parseTextPropertyFile");jQuery.sap.require("sap.apf.modeler.core.lazyLoader");jQuery.sap.require("sap.apf.modeler.core.registryWrapper");jQuery.sap.require("sap.apf.utils.startParameter");jQuery.sap.require("sap.apf.core.utils.fileExists");sap.apf.modeler.core.Instance=function(p,a){var t=this;var A,C,b,c,d,S,F,N,R,E,H,e,M,f,g,h,j,L,k,l,m,s,n,o,q,r,u,v,O,w,x,y,z,B,D,G;A=(a&&a.constructor&&a.constructor.applicationHandler)||sap.apf.modeler.core.ApplicationHandler;C=(a&&a.constructor&&a.constructor.configurationHandler)||sap.apf.modeler.core.ConfigurationHandler;b=(a&&a.constructor&&a.constructor.configurationEditor)||sap.apf.modeler.core.ConfigurationEditor;c=(a&&a.constructor&&a.constructor.configurationObjects)||sap.apf.modeler.core.ConfigurationObjects;d=(a&&a.constructor&&a.constructor.configurationFactory)||sap.apf.core.ConfigurationFactory;E=(a&&a.constructor&&a.constructor.elementContainer)||sap.apf.modeler.core.ElementContainer;S=(a&&a.constructor&&a.constructor.step)||sap.apf.modeler.core.Step;F=(a&&a.constructor&&a.constructor.facetFilter)||sap.apf.modeler.core.FacetFilter;N=(a&&a.constructor&&a.constructor.navigationTarget)||sap.apf.modeler.core.NavigationTarget;R=(a&&a.constructor&&a.constructor.representation)||sap.apf.modeler.core.Representation;H=(a&&a.constructor&&a.constructor.hashtable)||sap.apf.utils.Hashtable;e=(a&&a.constructor&&a.constructor.registryProbe)||sap.apf.modeler.core.RegistryWrapper;L=(a&&a.constructor&&a.constructor.LazyLoader)||sap.apf.modeler.core.LazyLoader;M=(a&&a.constructor&&a.constructor.metadata)||sap.apf.core.Metadata;f=(a&&a.constructor&&a.constructor.entityTypeMetadata)||sap.apf.core.EntityTypeMetadata;g=(a&&a.constructor&&a.constructor.metadataFacade)||sap.apf.core.MetadataFacade;h=(a&&a.constructor&&a.constructor.metadataProperty)||sap.apf.core.MetadataProperty;j=(a&&a.constructor&&a.constructor.metadataFactory)||sap.apf.core.MetadataFactory;k=(a&&a.constructor&&a.constructor.startParameter)||sap.apf.utils.StartParameter;if(a&&a.constructor&&a.constructor.textHandler){l=new a.constructor.textHandler();}else{l=new sap.apf.modeler.core.TextHandler();}if(a&&a.constructor&&a.constructor.messageHandler){m=new a.constructor.messageHandler(true);}else{m=new sap.apf.core.MessageHandler(true);}m.setTextResourceHandler(l);m.loadConfig(sap.apf.core.messageDefinition);m.loadConfig(sap.apf.modeler.core.messageDefinition);m.activateOnErrorHandling(true);if(a&&a.instances&&a.instances.component){G={};G.baseManifest=sap.apf.modeler.Component.prototype.getMetadata().getManifest();G.manifest=jQuery.extend({},true,a.instances.component.getMetadata().getManifest());}n=new k(a&&a.instances&&a.instances.component,G);this.getStartParameterFacade=function(){return n;};r={instance:{messageHandler:m,coreApi:t}};if(a&&a.constructor&&a.constructor.persistenceProxy){o=new a.constructor.persistenceProxy(p,r);}else{o=new sap.apf.core.OdataProxy(p,r);}if(a&&a.constructor&&a.constructor.sessionHandler){s=new a.constructors.sessionHandler(r.instance);}else{s=new sap.apf.core.SessionHandler(r.instance);}u={entityTypeMetadata:sap.apf.core.EntityTypeMetadata,hashtable:H,metadata:sap.apf.core.Metadata,metadataFacade:sap.apf.core.MetadataFacade,metadataProperty:sap.apf.core.MetadataProperty,messageHandler:m,coreApi:t,datajs:OData,configurationFactory:{getServiceDocuments:function(){return[p.serviceRoot];}},deactivateFatalError:true,fileExists:new sap.apf.core.utils.FileExists()};q=new sap.apf.core.MetadataFactory(u);v={constructor:{hashtable:H},instance:{messageHandler:m}};this.getCatalogServiceUri=a&&a.functions&&a.functions.getCatalogServiceUri;O=(a&&a.functions&&a.functions.odataRequestWrapper)||sap.apf.core.odataRequestWrapper;w=(a&&a.functions&&a.functions.ajax)||sap.apf.core.ajax;this.ajax=function(i){return w(i);};this.odataRequest=function(i,K,P,Q){O(m,i,K,P,Q);};this.checkForTimeout=function(i){var K=sap.apf.core.utils.checkForTimeout(i);if(K){m.putMessage(K);}return K;};this.getEntityTypeMetadata=function(i,K){return q.getEntityTypeMetadata(i,K);};this.getXsrfToken=function(i){return s.getXsrfToken(i);};this.getUriGenerator=function(){return sap.apf.core.utils.uriGenerator;};this.getText=function(i,P){return l.getText(i,P);};this.putMessage=function(i){return m.putMessage(i);};this.check=function(i,K,P){return m.check(i,K,P);};this.createMessageObject=function(i){return m.createMessageObject(i);};this.setCallbackForMessageHandling=function(i){m.setMessageCallback(i);};this.importConfigurationFromLrep=function(K,P,Q,T){var U;o.readAllConfigurationsFromVendorLayer().then(function(_){var a1=K+'.'+P;var i;for(i=0;i<_.length;i++){if(_[i].value===a1){U=_[i].applicationText;break;}}t.getApplicationHandler(V);});function V(i,_){if(_){T(undefined,undefined,_);return;}var a1=false;var b1=i.getApplication(K);if(!b1){a1=true;}var c1={ApplicationName:U};i.setAndSave(c1,W,K,a1);}function W(i,_,a1){if(a1){T(P,undefined,a1);return;}X();}function X(){var i=new sap.apf.core.utils.Filter(m,'Language','eq',sap.apf.core.constants.developmentLanguage);var _=new sap.apf.core.utils.Filter(m,'Application','eq',K);_.addAnd(i);o.readCollection("texts",Y,undefined,undefined,_,true,{layer:"VENDOR"});}function Y(i,_,a1){if(a1){T(P,undefined,a1);return;}I(i,K,Z);}function Z(i){if(i){T(P,undefined,i);return;}o.readEntity("configuration",$,[{value:P}],undefined,true,K,{layer:"VENDOR"});}function $(i,_,a1){if(a1){T(undefined,_,a1);return;}var b1=JSON.parse(i.SerializedAnalyticalConfiguration);J(b1,Q,T);}};function I(i,K,P){t.getApplicationHandler(T);function Q(U,V,W){var X;var Y;if(W){P(W);}else{X={instance:{messageHandler:m,persistenceProxy:o},constructor:{hashtable:H}};Y=new sap.apf.modeler.core.TextPool(X,K,U);Y.addTextsAndSave(i,P,K);}}function T(U,V){if(V){P(V);return;}var W;var X=U.getApplication(K);if(!X){W=m.createMessageObject({code:11021});P(W);return;}if(z&&z.getId()===K){z.getInstance().getTextPool().addTextsAndSave(i,P,K);}else{var Y=new sap.apf.core.utils.Filter(m,'Application','eq',K);var Z=new sap.apf.core.utils.Filter(m,'Language','eq',sap.apf.core.constants.developmentLanguage);Z.addAnd(Y);o.readCollection("texts",Q,undefined,undefined,Z,true);}}}this.importTexts=function(K,P){var Q;var T;var i;var U=sap.apf.utils.parseTextPropertyFile(K,{instance:{messageHandler:m}});if(U.Messages.length>0){Q=m.createMessageObject({code:11020});T=U.Messages.length;for(i=0;i<T-1;i++){U.Messages[i+1].setPrevious(U.Messages[i]);}Q.setPrevious(U.Messages[T-1]);P(Q);}else{I(U.TextElements,U.Application,P);}};function J(i,K,P){var Q=i.configHeader;t.getApplicationHandler(T);function T(X,Y){if(Y){P(undefined,undefined,Y);return;}var Z=false;var $=X.getList();$.forEach(function(a1){if(a1.Application===Q.Application){Z=true;}});if(Z){t.getConfigurationHandler(Q.Application,V);}else{var _={ApplicationName:Q.ApplicationName,SemanticObject:Q.SemanticObject};X.setAndSave(_,U,Q.Application,true);}}function U(X,Y,Z){if(Z){P(undefined,undefined,Z);return;}t.getConfigurationHandler(Q.Application,V);}function V(X,Y){if(Y){P(undefined,undefined,Y);return;}var Z=jQuery.extend({},i,true);delete Z.configHeader;var $=false;var _=X.getList();_.forEach(function(d1){if(d1.AnalyticalConfiguration===Q.AnalyticalConfiguration){$=true;}});if($){K(b1,c1);}else{X.setConfiguration({AnalyticalConfigurationName:Q.AnalyticalConfigurationName},Q.AnalyticalConfiguration);var a1={id:Q.AnalyticalConfiguration,creationDate:Q.CreationUTCDateTime,lastChangeDate:Q.LastChangeUTCDateTime,content:Z};X.loadConfiguration(a1,W);}function b1(){X.setConfiguration({AnalyticalConfigurationName:Q.AnalyticalConfigurationName},Q.AnalyticalConfiguration);var a1={updateExisting:true,id:Q.AnalyticalConfiguration,creationDate:Q.CreationUTCDateTime,lastChangeDate:Q.LastChangeUTCDateTime,content:Z};X.loadConfiguration(a1,W);}function c1(){var d1=X.setConfiguration({AnalyticalConfigurationName:Q.AnalyticalConfigurationName});var e1={id:d1,content:Z};X.loadConfiguration(e1,W);}}function W(X,Y){if(Y){P(undefined,undefined,Y);return;}X.save(P);}}this.importConfiguration=function(i,K,P){var Q=JSON.parse(i);if(!T(Q,P)){return;}J(Q,K,P);function T(Q,P){var U=[],V=true,W;if(!sap.apf.utils.isValidGuid(Q.configHeader.Application)){U.push(m.createMessageObject({code:11037,aParameters:[Q.configHeader.Application]}));V=false;}if(!sap.apf.utils.isValidGuid(Q.configHeader.AnalyticalConfiguration)){U.push(m.createMessageObject({code:11038,aParameters:[Q.configHeader.AnalyticalConfiguration]}));V=false;}W=sap.apf.modeler.core.ConfigurationObjects.getTextKeysFromConfiguration(Q);W.forEach(function(X){var Y=new H(m);if(!Y.hasItem(X)){Y.setItem(X,X);if(!sap.apf.utils.isValidGuid(X)){U.push(m.createMessageObject({code:11039,aParameters:[X]}));V=false;}}});if(V){return V;}U.forEach(function(X,Y,U){if(Y){X.setPrevious(U[Y-1]);}});P(i,undefined,U[U.length-1]);return V;}};this.getApplicationHandler=function(i){if(!y){var K=(a&&a.functions&&a.functions.loadApplicationHandler)||P;y=new L(v,K);}y.asyncGetInstance("ApplicationHandlerId",i);function P(Q,T){new A({instance:{messageHandler:m,persistenceProxy:o},constructor:{hashtable:H},functions:{resetConfigurationHandler:V}},U);function U(W,X){T(Q,W,X);}function V(W){if(z&&z.getId()===W){z.getInstance().removeAllConfigurations();z.reset();}}}};this.getConfigurationHandler=function(i,K){if(!z){x=(a&&a.functions&&a.functions.loadConfigurationHandler)||P;z=new L(v,x);}z.asyncGetInstance(i,K);function P(i,Q,T){var U=new sap.apf.core.utils.Filter(m,'Application','eq',i);var V=new sap.apf.core.utils.Filter(m,'Language','eq',sap.apf.core.constants.developmentLanguage);V.addAnd(U);var W=[];var X=["AnalyticalConfiguration","AnalyticalConfigurationName","Application","CreatedByUser","CreationUTCDateTime","LastChangeUTCDateTime","LastChangedByUser"];W.push({entitySetName:"configuration",filter:U,selectList:X});W.push({entitySetName:'texts',filter:V});o.readCollectionsInBatch(W,Y,true);function Y(Z,$){var _,a1;var b1;var c1;var d1=T;if($){Q(i,undefined,$);}else{b1=Z[0];c1=Z[1];a1={instance:{messageHandler:m,persistenceProxy:o},constructor:{hashtable:H}};_=new sap.apf.modeler.core.TextPool(a1,i,c1);if(!d1){d1=new C({instance:{messageHandler:m,persistenceProxy:o,datajs:OData,coreApi:t,metadataFactory:q},constructor:{configurationEditor:b,configurationFactory:d,configurationObjects:c,elementContainer:E,entityTypeMetadata:f,facetFilter:F,navigationTarget:N,hashtable:H,representation:R,registryProbe:e,step:S,lazyLoader:L},functions:{getApplication:y.getInstance().getApplication}});}d1.setApplicationIdAndContext(i,b1,_);Q(i,d1,$);}}}};this.getUnusedTextKeys=function(i,K){var P={instance:{messageHandler:m,persistenceProxy:o},constructor:{hashtable:H}};var Q=new c(P);var T=null,U=null,V=null;Q.getTextKeysFromAllConfigurations(i,function(X,Y){if(U){return;}T=X;U=Y;if(Y||V){W();}});this.getConfigurationHandler(i,function(X,Y){if(U){return;}V=X;U=Y;if(Y||T){W();}});function W(){var X=[];if(U){K(undefined,U);return;}V.getTextPool().getTextKeys().forEach(function(Y){if(!T.hasItem(Y)){X.push(Y);}});K(X,undefined);}};this.resetConfigurationHandler=function(){if(z){z.reset();}};this.getRepresentationTypes=function(){var i=sap.apf.core.representationTypes();var K=[];jQuery.extend(true,K,i);return K;};this.getAllAvailableSemanticObjects=function(i){function K(T,U){D=T.results;i(T.results,undefined);}function P(T){var U;if(T.messageObject){U=T.messageObject;}else{U=m.createMessageObject({code:"11041"});}i([],U);}if(D){i(D,undefined);return;}var Q={requestUri:"/sap/opu/odata/UI2/INTEROP/SemanticObjects?$format=json&$select=id,text",method:"GET",headers:{"x-csrf-token":s.getXsrfToken("/sap/opu/odata/UI2/INTEROP/SemanticObjects")}};t.odataRequest(Q,K,P);};this.getSemanticActions=function(K){var P;var Q=jQuery.Deferred();if(!B){B=new H(m);}P=B.getItem(K);if(P){Q.resolve(P);return Q.promise();}t.getAllAvailableSemanticObjects(T);return Q.promise();function T(U,V){if(V){Q.reject(V);return;}var W=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var X;var i;if(!W){Q.reject(m.createMessageObject({code:"5038"}));return;}for(i=0;i<U.length;i++){if(U[i].id===K){X=U[i];break;}}W.getSemanticObjectLinks(K,undefined,true,a.instances.component,undefined).done(function(Y){var Z=[];Y.forEach(function($){var _=$.intent.split("-");var a1=_[1].split("?");a1=a1[0].split("~");Z.push({id:a1[0],text:$.text});});B.setItem(K,{semanticObject:X,semanticActions:Z});Q.resolve({semanticObject:X,semanticActions:Z});}).fail(function(){Q.reject(m.createMessageObject({code:"11042"}));});}};this.navigateToGenericRuntime=function(i,K,P){var Q=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var T={};if(t.getStartParameterFacade().isLrepActive()){T['sap-apf-configuration-id']=i+'.'+K;}else{T['sap-apf-configuration-id']=K;}var U=Q.hrefForExternal({target:a.functions.getNavigationTargetForGenericRuntime(),params:T});var V=jQuery(location).attr('href');var W=V.split('#')[0];P(W+U);};this.readAllConfigurationsFromVendorLayer=function(){return o.readAllConfigurationsFromVendorLayer();};if(a&&a.probe){new a.probe({constructor:{applicationHandler:A,configurationHandler:C,configurationEditor:b,configurationObjects:c,configurationFactory:d,metadataFactory:j,metadata:M,entityTypeMetadata:f,metadataFacade:g,metadataProperty:h,step:S,facetFilter:F,navigationTarget:N,representation:R,elementContainer:E,hashtable:H,lazyLoader:L,registryProbe:e},textHandler:l,messageHandler:m,sessionHandler:s,persistenceProxy:o,metadataFactory:q,injectForFollowUp:r,injectMetadataFactory:u,fnOdataRequestWrapper:O,ajax:w,odataRequestWrapper:O});}};}());
