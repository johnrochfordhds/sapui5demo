/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");sap.ui.controller("sap.apf.modeler.ui.controller.step",{onInit:function(){this.getView().addStyleClass("sapUiSizeCompact");this.oViewData=this.getView().getViewData();this.getText=this.oViewData.getText;this.params=this.oViewData.oParams;this.oConfigurationHandler=this.oViewData.oConfigurationHandler;this.oConfigurationEditor=this.oViewData.oConfigurationEditor;this.oTextPool=this.oConfigurationHandler.getTextPool();this.getNavigationTargetName=this.oViewData.getNavigationTargetName;var s=this;if(!this.oConfigurationEditor){this.oConfigurationHandler.loadConfiguration(this.params.arguments.configId,function(c){s.oConfigurationEditor=c;});}this.oTextPool=this.oConfigurationHandler.getTextPool();this._setDisplayText();this.setDetailData();var m=[];m.push(this.byId("idstepTitle"));m.push(this.byId("idSourceSelect"));m.push(this.byId("idSelectPropCombo"));m.push(this.byId("idCategorySelect"));m.push(this.byId("idFilterMapEntitySelect"));m.push(this.byId("idFilterMapTargetFilterCombo"));m.push(this.byId("idCustomRecordValue"));this._setMandatoryFields(m);this._attachEvents();if(this.step.getFilterMappingService()===undefined||this.step.getFilterMappingService()===""){this._removeMandatoryFromFilterMap();}if(!this.step.getTopN()){this.byId("idCustomRecordValue").isMandatory=false;}},_setDisplayText:function(){this.byId("idStepBasicData").setTitle(this.getText("stepBasicData"));this.byId("idStepTitleLabel").setText(this.getText("stepTitle"));this.byId("idStepTitleLabel").setRequired(true);this.byId("idstepTitle").setPlaceholder(this.getText("newStep"));this.byId("idStepLongTitleLabel").setText(this.getText("stepLongTitle"));this.byId("idstepLongTitle").setPlaceholder(this.getText("stepLongTitle"));this.byId("idCategoryTitleLabel").setText(this.getText("categoryAssignments"));this.byId("idCategoryTitleLabel").setRequired(true);this.byId("idGlobalLabel").setText(this.getText("globalNavTargets"));this.byId("idStepSpecificLabel").setText(this.getText("stepSpecificNavTargets"));this.byId("idSourceSelectLabel").setText(this.getText("source"));this.byId("idSourceSelectLabel").setRequired(true);this.byId("idEntitySelectLabel").setText(this.getText("entity"));this.byId("idEntitySelectLabel").setRequired(true);this.byId("idSelectPropComboLabel").setText(this.getText("selectProperties"));this.byId("idSelectPropComboLabel").setRequired(true);this.byId("idReqFilterSelectLabel").setText(this.getText("requiredFilters"));this.byId("idDataRequest").setTitle(this.getText("dataRequest"));this.byId("idNavigationTarget").setTitle(this.getText("navigationTargetAssignment"));this.byId("idCornerTextLabel").setTitle(this.getText("cornerTextLabel"));this.byId("idLeftTop").setPlaceholder(this.getText("leftTop"));this.byId("idRightTop").setPlaceholder(this.getText("rightTop"));this.byId("idLeftBottom").setPlaceholder(this.getText("leftBottom"));this.byId("idRightBottom").setPlaceholder(this.getText("rightBottom"));this.byId("idDataReduction").setTitle(this.getText("dataReduction"));this.byId("idDataReductionLabel").setText(this.getText("dataReductionType"));this.byId("idNoDataReduction").setText(this.getText("noDataReduction"));this.byId("idTopN").setText(this.getText("topN"));this.byId("idDataRecordsLabel").setText(this.getText("recordNumber"));},_addAutoCompleteFeatureOnInputs:function(){if(this.oConfigurationHandler){var t=new sap.apf.modeler.ui.utils.TextPoolHelper(this.oTextPool);var s=this.byId("idstepTitle");var T=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_TITLE;var d={oTranslationFormat:T,type:"text"};t.setAutoCompleteOn(s,d);var S=this.byId("idstepLongTitle");var o=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_LONG_TITLE;var D={oTranslationFormat:o,type:"text"};t.setAutoCompleteOn(S,D);var a=this.byId("idLeftTop");var b=this.byId("idRightTop");var c=this.byId("idLeftBottom");var e=this.byId("idRightBottom");var f=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_CORNER_TEXT;var g={oTranslationFormat:f,type:"text"};t.setAutoCompleteOn(a,g);t.setAutoCompleteOn(b,g);t.setAutoCompleteOn(c,g);t.setAutoCompleteOn(e,g);var h={oConfigurationEditor:this.oConfigurationEditor,type:"service"};var i=this.byId("idSourceSelect");t.setAutoCompleteOn(i,h);var j=this.byId("idFilterMapSourceSelect");t.setAutoCompleteOn(j,h);}},_prepareStepSpecificList:function(){var s=this;var m=[];var a=this.oConfigurationEditor.getNavigationTargets();var S=this.step.getNavigationTargets();var A=a.filter(function(n){return n.isStepSpecific();});if(A.length!==0){this.byId("idStepSpecificCombo").setBusy(true);}A.forEach(function(o){var n={};n.navTargetKey=o.getId();s.getNavigationTargetName(o.getId()).then(function(v){n.navTargetName=v;m.push(n);if(m.length===A.length){var b=new sap.ui.model.json.JSONModel();var c={stepSpecific:m};b.setData(c);s.byId("idStepSpecificCombo").setModel(b);s.byId("idStepSpecificCombo").setSelectedKeys(S);s.byId("idStepSpecificCombo").setBusy(false);}});});},_prepareGlobalList:function(){var s=this;var m=[];var a=this.oConfigurationEditor.getNavigationTargets();var g=a.filter(function(n){return n.isGlobal();});if(g.length!==0){this.byId("idGlobalCombo").setBusy(true);}g=g.map(function(G){return G.getId();});g.forEach(function(G){var o={};o.navTargetKey=G;s.getNavigationTargetName(G).then(function(v){o.navTargetName=v;m.push(o);if(m.length===g.length){var b=new sap.ui.model.json.JSONModel();var c={global:m};b.setData(c);s.byId("idGlobalCombo").setModel(b);s.byId("idGlobalCombo").setSelectedKeys(g);s.byId("idGlobalCombo").setBusy(false);}});});},setDetailData:function(){var s=this;if(this.params&&this.params.arguments&&this.params.arguments.stepId){this.step=this.oConfigurationEditor.getStep(this.params.arguments.stepId);}var C=[];this.oTextPool=this.oConfigurationHandler.getTextPool();var a=this.oConfigurationEditor.getCategories();a.forEach(function(L){var N={};N.CategoryId=L.getId();N.CategoryTitle=s.oTextPool.get(L.labelKey)?s.oTextPool.get(L.labelKey).TextElementDescription:L.labelKey;C.push(N);});var d={Categories:C};var m=new sap.ui.model.json.JSONModel();m.setData(d);this.byId("idCategorySelect").setModel(m);var p={propertyKey:this.getText("none"),propertyName:this.getText("none")};var D={Properties:[p]};var M=new sap.ui.model.json.JSONModel();M.setSizeLimit(500);M.setData(D);this.byId("idReqFilterSelect").setModel(M);var S=[];var o=this.byId("idFilterMapTargetFilterCombo")?this.byId("idFilterMapTargetFilterCombo").getSelectedKeys():[];o.forEach(function(L){var p={};p.propertyKey=L;p.propertyName=L;S.push(p);});var b=new sap.ui.model.json.JSONModel();b.setSizeLimit(500);b.setData(S);this.byId("idFilterMapTargetFilterCombo").setModel(b);if(this.step){var n=this.getText("none");var c=[n];if(this.step.getTitleId&&this.step.getTitleId()!==undefined&&this.step.getTitleId()!==null&&s.oTextPool.get(this.step.getTitleId())){this.byId("idstepTitle").setValue(s.oTextPool.get(this.step.getTitleId()).TextElementDescription);}else{this.byId("idstepTitle").setValue(this.params.arguments.stepId);}if(this.step.getLongTitleId&&this.step.getLongTitleId()!==undefined&&this.step.getLongTitleId()!==null&&s.oTextPool.get(this.step.getLongTitleId())){this.byId("idstepLongTitle").setValue(s.oTextPool.get(this.step.getLongTitleId()).TextElementDescription);}else{this.byId("idstepLongTitle").setValue("");}if(this.step.getService&&this.step.getService()!==undefined&&this.step.getService()!==null){this.byId("idSourceSelect").setValue(this.step.getService());var e=this.step.getService();var A=[];var f=[];A=this.oConfigurationEditor.getAllEntitySetsOfService(e);A.forEach(function(L){var N={};N.entityKey=L;N.entityName=L;f.push(N);});var g={Entities:f};var h=new sap.ui.model.json.JSONModel();h.setSizeLimit(500);h.setData(g);this.byId("idEntitySelect").setModel(h);}if(this.step.getEntitySet&&this.step.getEntitySet()!==undefined&&this.step.getEntitySet()!==null){this.byId("idEntitySelect").setSelectedKey(this.step.getEntitySet());var E=this.step.getEntitySet();var i=this.step.getService();var P=[],j=[];if(i&&i!==null&&i!==""){P=this.oConfigurationEditor.getAllPropertiesOfEntitySet(i,E);P.forEach(function(L){var p={};p.propertyKey=L;p.propertyName=L;j.push(p);});var k={Properties:j};var l=new sap.ui.model.json.JSONModel();l.setSizeLimit(500);l.setData(k);this.byId("idSelectPropCombo").setModel(l);}}if(this.step.getSelectProperties&&this.step.getSelectProperties()!==undefined&&this.step.getSelectProperties().length!==0){this.byId("idSelectPropCombo").setSelectedKeys(this.step.getSelectProperties());P=c.concat(this.step.getSelectProperties());j=[];P.forEach(function(L){var p={};p.propertyKey=L;p.propertyName=L;j.push(p);});D={Properties:j};M=new sap.ui.model.json.JSONModel();M.setSizeLimit(500);M.setData(D);this.byId("idReqFilterSelect").setModel(M);}if(this.step.getFilterProperties&&this.step.getFilterProperties()!==undefined&&this.step.getFilterProperties().length!==0){this.byId("idReqFilterSelect").setSelectedKey(this.step.getFilterProperties()[0]);this._showFilterMappingField();}else{this.byId("idReqFilterSelect").setSelectedKey(this.getText("none"));this._hideFilterMapField();this._resetFilterMappingFields();}this._setTopNValue();if(this.step.getFilterMappingService&&this.step.getFilterMappingService()!==undefined&&this.step.getFilterMappingService().length!==0){this.byId("idFilterMapSourceSelect").setValue(this.step.getFilterMappingService());var F=this.step.getFilterMappingService();var q=[];var r=[];var R=this.step.getFilterProperties();q=this.oConfigurationEditor.getAllEntitySetsOfServiceWithGivenProperties(F,R);q.forEach(function(L){var N={};N.entityKey=L;N.entityName=L;r.push(N);});var t={Entities:r};var u=new sap.ui.model.json.JSONModel();u.setSizeLimit(500);u.setData(t);this.byId("idFilterMapEntitySelect").setModel(u);this._addMandatoryfromFilterMap();}else{this._removeMandatoryFromFilterMap();this._resetFilterMappingFields();}if(this.step.getFilterMappingEntitySet&&this.step.getFilterMappingEntitySet()!==undefined&&this.step.getFilterMappingEntitySet().length!==0){this.byId("idFilterMapEntitySelect").setSelectedKey(this.step.getFilterMappingEntitySet());var v=this.step.getFilterMappingEntitySet();var w=this.step.getFilterMappingService();var x=[],y=[];if(w&&w!==null&&w!==""){x=this.oConfigurationEditor.getAllPropertiesOfEntitySet(w,v);x.forEach(function(L){var p={};p.propertyKey=L;p.propertyName=L;y.push(p);});var z={Properties:y};var B=new sap.ui.model.json.JSONModel();B.setSizeLimit(500);B.setData(z);this.byId("idFilterMapTargetFilterCombo").setModel(B);}}if(this.step.getFilterMappingTargetProperties&&this.step.getFilterMappingTargetProperties()!==undefined&&this.step.getFilterMappingTargetProperties().length!==0){this.byId("idFilterMapTargetFilterCombo").setSelectedKeys(this.step.getFilterMappingTargetProperties());}if(this.step.getFilterMappingKeepSource&&this.step.getFilterMappingKeepSource()!==undefined){this.byId("idFilterKeepSourceCheckBox").setSelected(this.step.getFilterMappingKeepSource());}var G=s.oConfigurationEditor.getCategoriesForStep(this.step.getId());if(G&&G.length!==0){this.byId("idCategorySelect").setSelectedKeys(G);}if(this.step.getLeftLowerCornerTextKey()&&s.oTextPool.get(this.step.getLeftLowerCornerTextKey())){this.byId("idLeftBottom").setValue(s.oTextPool.get(this.step.getLeftLowerCornerTextKey()).TextElementDescription);}else{this.byId("idLeftBottom").setValue(this.step.getLeftLowerCornerTextKey());}if(this.step.getLeftUpperCornerTextKey()&&s.oTextPool.get(this.step.getLeftUpperCornerTextKey())){this.byId("idLeftTop").setValue(s.oTextPool.get(this.step.getLeftUpperCornerTextKey()).TextElementDescription);}else{this.byId("idLeftTop").setValue(this.step.getLeftUpperCornerTextKey());}if(this.step.getRightUpperCornerTextKey()&&s.oTextPool.get(this.step.getRightUpperCornerTextKey())){this.byId("idRightTop").setValue(s.oTextPool.get(this.step.getRightUpperCornerTextKey()).TextElementDescription);}else{this.byId("idRightTop").setValue(this.step.getRightUpperCornerTextKey());}if(this.step.getRightLowerCornerTextKey()&&s.oTextPool.get(this.step.getRightLowerCornerTextKey())){this.byId("idRightBottom").setValue(s.oTextPool.get(this.step.getRightLowerCornerTextKey()).TextElementDescription);}else{this.byId("idRightBottom").setValue(this.step.getRightLowerCornerTextKey());}}else{this._changeVisibilityDataReductionField(false);this._changeVisibilityOfTopN(false);this._hideFilterMapField();var H=this.params.arguments.categoryId;var I=s.oConfigurationEditor.createStep(H);this.step=s.oConfigurationEditor.getStep(I);var J=[H];this.byId("idCategorySelect").setSelectedKeys(J);var K={id:I,icon:"sap-icon://BusinessSuiteInAppSymbols/icon-phase"};this.oViewData.updateSelectedNode(K);}this._addAutoCompleteFeatureOnInputs();this._prepareGlobalList();this._prepareStepSpecificList();},_setTopNValue:function(){this._setSortDataForStep();var h;if(this.step.getTopN()){h=true;var n=this.step.getTopN().top;this.byId("idDataReductionRadioGroup").setSelectedButton(this.byId("idDataReductionRadioGroup").getButtons()[1]);this.byId("idCustomRecordValue").setValue(n);}else{this.byId("idDataReductionRadioGroup").setSelectedButton(this.byId("idDataReductionRadioGroup").getButtons()[0]);h=false;}this._changeVisibilityOfTopN(h);},handleChangeDetailValueForTree:function(e){this.oConfigurationEditor.setIsUnsaved();var s=this;var S=this.oConfigurationEditor.getCategoriesForStep(this.step.getId());var t=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_TITLE;var a=this.byId("idstepTitle").getValue().trim();var b=s.oTextPool.setText(a,t);if(a!==""&&a!==null){this.step.setTitleId(b);}var c={};c.name=a;c.id=this.step.getId();if(a!==""&&a!==null){if(S.length>1){this.oViewData.updateTree();}else{this.oViewData.updateSelectedNode(c);}var T=this.getText("step")+": "+a;this.oViewData.updateTitleAndBreadCrumb(T);}},handleChangeForLongTitle:function(){this.oConfigurationEditor.setIsUnsaved();var s=this.byId("idstepLongTitle").getValue().trim();var t=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_LONG_TITLE;var S=this.oTextPool.setText(s,t);this.step.setLongTitleId(S);},handleChangeForStepSpecific:function(){var s=this;this.oConfigurationEditor.setIsUnsaved();var a=this.byId("idStepSpecificCombo").getSelectedKeys();var p=this.step.getNavigationTargets();p.forEach(function(n){if(a.indexOf(n)===-1){s.step.removeNavigationTarget(n);}});a.forEach(function(n){if(p.indexOf(n)===-1){s.step.addNavigationTarget(n);}});},_attachEvents:function(){var c=this;c.byId("idSourceSelect").attachEvent("selectService",c.handleSelectionOfService.bind(c));c.byId("idFilterMapSourceSelect").attachEvent("selectService",c.handleSelectionOfService.bind(c));},handleShowValueHelpRequest:function(e){var c=this;var v={oTextReader:c.getView().getViewData().getText,parentView:c.getView(),parentControl:e.getSource(),getCalatogServiceUri:c.getView().getViewData().getCalatogServiceUri};sap.ui.view({id:c.createId("idCatalogServiceView"),viewName:"sap.apf.modeler.ui.view.catalogService",type:sap.ui.core.mvc.ViewType.XML,viewData:v});},handleSelectionOfService:function(e){var s=e.getParameters()[0];e.getSource().setValue(s);e.getSource().fireEvent("change");},handleChangeForService:function(e){this.oConfigurationEditor.setIsUnsaved();var s,a=[],A=[],p=[],S=[],r;var b=this.byId("idReqFilterSelect").getSelectedKey();if(b!==this.getText("none")){r=[b];}else{r=this.step.getFilterProperties();}var c=e?e.getParameter("id"):"";var i=c.search("FilterMap")!==-1?true:false;var d;if(i){s=this.byId("idFilterMapSourceSelect").getValue().trim();d=this.oConfigurationEditor.registerService(s);if(d){this._addMandatoryfromFilterMap();a=this.oConfigurationEditor.getAllEntitySetsOfServiceWithGivenProperties(s,r);}else{this._removeMandatoryFromFilterMap();}}else{this._resetStepRequestProperties();if(b===this.getText("none")||b===""){this._hideFilterMapField();}else{this._removeMandatoryFromFilterMap();}this._resetFilterMappingFields();s=this.byId("idSourceSelect").getValue().trim();d=this.oConfigurationEditor.registerService(s);a=this.oConfigurationEditor.getAllEntitySetsOfService(s);}a.forEach(function(q){var t={};t.entityKey=q;t.entityName=q;A.push(t);});var E={Entities:A};var o=new sap.ui.model.json.JSONModel();o.setSizeLimit(500);o.setData(E);var f;if(a.length>=1){if(i){if(this.step.getFilterMappingEntitySet()){f=this.step.getFilterMappingEntitySet();p=this.oConfigurationEditor.getAllPropertiesOfEntitySet(s,f);}else{p=this.oConfigurationEditor.getAllPropertiesOfEntitySet(s,a[0]);}this.step.setFilterMappingEntitySet(a[0]);this.byId("idFilterMapEntitySelect").setSelectedKey(a[0]);}else{if(this.step.getEntitySet()){f=this.step.getEntitySet();p=this.oConfigurationEditor.getAllPropertiesOfEntitySet(s,f);}else{p=this.oConfigurationEditor.getAllPropertiesOfEntitySet(s,a[0]);}this.step.setEntitySet(a[0]);this.byId("idEntitySelect").setSelectedKey(a[0]);}p.forEach(function(q){var P={};P.propertyKey=q;P.propertyName=q;S.push(P);});}var g={Properties:S};var h=new sap.ui.model.json.JSONModel();h.setSizeLimit(500);h.setData(g);var j=[],k=[];var l=this.byId("idSelectPropCombo").getSelectedKeys();l.forEach(function(q){var P={};P.propertyKey=q;P.propertyName=q;j.push(P);});var n={propertyKey:this.getText("none"),propertyName:this.getText("none")};var N=[n];N=N.concat(j);var R=new sap.ui.model.json.JSONModel();R.setSizeLimit(500);var D={Properties:N};R.setData(D);var m=this.byId("idFilterMapTargetFilterCombo")?this.byId("idFilterMapTargetFilterCombo").getSelectedKeys():[];m.forEach(function(q){var P={};P.propertyKey=q;P.propertyName=q;k.push(P);});if(i){this.byId("idFilterMapEntitySelect").setModel(o);this.byId("idFilterMapTargetFilterCombo").setModel(h);}else{this.byId("idEntitySelect").setModel(o);this.byId("idSelectPropCombo").setModel(h);this.byId("idReqFilterSelect").setModel(R);}this._checkValidationStateForService("source",c);},_addMandatoryfromFilterMap:function(){this.byId("idFilterMapEntitySelect").isMandatory=true;this.byId("idFilterMapTargetFilterCombo").isMandatory=true;this.byId("idFilterMapEntityLabel").setText(this.getText("entity"));this.byId("idFilterMapEntityLabel").setRequired(true);this.byId("idFilterMapTargetFilterLabel").setText(this.getText("filterMapTarget"));this.byId("idFilterMapTargetFilterLabel").setRequired(true);this.byId("idFilterMapKeepSourceLabel").setText(this.getText("filterMapKeepSource"));this.byId("idFilterMapKeepSourceLabel").setRequired(true);},_removeMandatoryFromFilterMap:function(){this.byId("idFilterMapEntitySelect").isMandatory=false;this.byId("idFilterMapTargetFilterCombo").isMandatory=false;this.byId("idFilterMapEntityLabel").setText(this.getText("entity"));this.byId("idFilterMapEntityLabel").setRequired(false);this.byId("idFilterMapTargetFilterLabel").setText(this.getText("filterMapTarget"));this.byId("idFilterMapTargetFilterLabel").setRequired(false);this.byId("idFilterMapKeepSourceLabel").setText(this.getText("filterMapKeepSource"));this.byId("idFilterMapKeepSourceLabel").setRequired(false);},_resetFilterMappingFields:function(){var s=this;this.step.setFilterMappingService("");this.step.setFilterMappingEntitySet(undefined);this.step.setFilterMappingKeepSource(undefined);var o=this.step.getFilterMappingTargetProperties();o.forEach(function(p){s.step.removeFilterMappingTargetProperty(p);});var e=new sap.ui.model.json.JSONModel();var E={NoData:[]};e.setData(E);this.byId("idFilterMapSourceSelect").setValue("");this.byId("idFilterMapEntitySelect").setModel(e);this.byId("idFilterMapEntitySelect").setSelectedKey();this.byId("idFilterMapTargetFilterCombo").setModel(e);var S=this.byId("idFilterMapTargetFilterCombo").getSelectedKeys();this.byId("idFilterMapTargetFilterCombo").removeSelectedKeys(S);},handleChangeForEntity:function(e){this.oConfigurationEditor.setIsUnsaved();var E,s,p=[],P=[];var a=e.getParameter("id");var i=a.search("FilterMap")!==-1?true:false;if(i){E=this.byId("idFilterMapEntitySelect").getSelectedKey();s=this.byId("idFilterMapSourceSelect").getValue().trim();p=this.oConfigurationEditor.getAllPropertiesOfEntitySet(s,E);}else{E=this.byId("idEntitySelect").getSelectedKey();s=this.byId("idSourceSelect").getValue().trim();p=this.oConfigurationEditor.getAllPropertiesOfEntitySet(s,E);}p.forEach(function(c){var f={};f.propertyKey=c;f.propertyName=c;P.push(f);});var S={Properties:P};var o=new sap.ui.model.json.JSONModel();o.setSizeLimit(500);o.setData(S);var n={propertyKey:this.getText("none"),propertyName:this.getText("none")};var r=[n];r=r.concat(P);var R=new sap.ui.model.json.JSONModel();R.setSizeLimit(500);var d={Properties:r};R.setData(d);var t=new sap.ui.model.json.JSONModel();t.setSizeLimit(500);t.setData(P);if(i){this.byId("idFilterMapTargetFilterCombo").setModel(o);}else{this.byId("idSelectPropCombo").setModel(o);this.byId("idReqFilterSelect").setModel(R);}this._checkValidationStateForService("entitySet",a);var b=this.byId("idReqFilterSelect").getSelectedKey();if(b===this.getText("none")){this._hideFilterMapField();this._resetFilterMappingFields();}},handleChangeForSelectProperty:function(e){var s=this;var h;this.oConfigurationEditor.setIsUnsaved();var S,a=[];var b=e.getParameter("id");var o=this.step.getSelectProperties();o.forEach(function(p){s.step.removeSelectProperty(p);});S=this.byId("idSelectPropCombo").getSelectedKeys();if(S.length>0){S.forEach(function(p){s.step.addSelectProperty(p);var P={};P.propertyKey=p;P.propertyName=p;a.push(P);});var n={propertyKey:this.getText("none"),propertyName:this.getText("none")};var r=[n];r=r.concat(a);var R=new sap.ui.model.json.JSONModel();R.setSizeLimit(500);var d={Properties:r};R.setData(d);var t=new sap.ui.model.json.JSONModel();t.setSizeLimit(500);t.setData(a);this.byId("idReqFilterSelect").setModel(R);this._checkValidationStateForService("selectProperties",b);var c=this.step.getFilterProperties()?this.step.getFilterProperties()[0]:undefined;if(c){var f=this.step.getSelectProperties().indexOf(c)===-1?false:true;if(f){this.byId("idReqFilterSelect").setSelectedKey(c);}else{this.byId("idReqFilterSelect").setSelectedKey(this.getText("none"));}}if(this.byId("idReqFilterSelect").getSelectedKey()===this.getText("none")){this._hideFilterMapField();this._resetFilterMappingFields();}this._setSortDataForStep();h=true;}else{h=false;this._changeVisibilityOfTopN(h);this.byId("idDataReductionRadioGroup").setSelectedButton(this.byId("idDataReductionRadioGroup").getButtons()[0]);this._resetTopNFields();}this._changeVisibilityDataReductionField(h);},_changeVisibilityDataReductionField:function(h){this.byId("idDataReduction").setVisible(h);this.byId("idDataReductionLabel").setVisible(h);this.byId("idDataReductionRadioButton").setVisible(h);this.byId("idDataReductionRadioGroup").setVisible(h);},handleChangeForRequiredFilter:function(e){var s=this;var a=e.getParameter("id");this.oConfigurationEditor.setIsUnsaved();var o=this.step.getFilterProperties();o.forEach(function(p){s.step.removeFilterProperty(p);});var r=this.byId("idReqFilterSelect").getSelectedKey();if(r!==this.getText("none")){this.step.addFilterProperty(r);this._showFilterMappingField();}else{this._hideFilterMapField();this._resetFilterMappingFields();}this._checkValidationStateForService("requiredFilter",a);},_showFilterMappingField:function(){this.byId("idFilterMapping").setVisible(true);this.byId("idFilterMapSourceLabel").setVisible(true);this.byId("idFilterMapSourceSelect").setVisible(true);this.byId("idFilterMapEntityLabel").setVisible(true);this.byId("idFilterMapEntitySelect").setVisible(true);this.byId("idFilterMapTargetFilterLabel").setVisible(true);this.byId("idFilterMapTargetFilterCombo").setVisible(true);this.byId("idFilterMapKeepSourceLabel").setVisible(true);this.byId("idFilterKeepSourceCheckBox").setVisible(true);this.byId("idFilterMapping").setTitle(this.getText("filterMap"));this.byId("idFilterMapSourceLabel").setText(this.getText("source"));this.byId("idFilterMapSourceLabel").setRequired(false);this.byId("idFilterMapEntityLabel").setText(this.getText("entity"));this.byId("idFilterMapEntityLabel").setRequired(false);this.byId("idFilterMapTargetFilterLabel").setText(this.getText("filterMapTarget"));this.byId("idFilterMapTargetFilterLabel").setRequired(false);this.byId("idFilterMapKeepSourceLabel").setText(this.getText("filterMapKeepSource"));this.byId("idFilterMapKeepSourceLabel").setRequired(false);},_hideFilterMapField:function(){this.byId("idFilterMapping").setVisible(false);this.byId("idFilterMapSourceLabel").setVisible(false);this.byId("idFilterMapSourceSelect").setVisible(false);this.byId("idFilterMapEntityLabel").setVisible(false);this.byId("idFilterMapEntitySelect").setVisible(false);this.byId("idFilterMapTargetFilterLabel").setVisible(false);this.byId("idFilterMapTargetFilterCombo").setVisible(false);this.byId("idFilterMapKeepSourceLabel").setVisible(false);this.byId("idFilterKeepSourceCheckBox").setVisible(false);this._removeMandatoryFromFilterMap();},handleChangeForTargetFilter:function(e){var s=this;var a=e.getParameter("id");this.oConfigurationEditor.setIsUnsaved();var t=this.byId("idFilterMapTargetFilterCombo").getSelectedKeys();if(t.length>0){var o=this.step.getFilterMappingTargetProperties();o.forEach(function(p){s.step.removeFilterMappingTargetProperty(p);});t.forEach(function(p){s.step.addFilterMappingTargetProperty(p);});}this._checkValidationStateForService("targetProperties",a);},handleFilterMapKeepSource:function(){var i=this.byId("idFilterKeepSourceCheckBox").getSelected();this.oConfigurationEditor.setIsUnsaved();this.step.setFilterMappingKeepSource(i);},_checkValidationStateForService:function(p,s){var a=this;var v={source:undefined,entitySet:undefined,selectProperty:undefined,requiredFilter:undefined,targetFilter:undefined};var S,r,A=[],b=[];var i=s.search("FilterMap")!==-1?true:false;S=i?this.byId("idFilterMapSourceSelect").getValue().trim():this.byId("idSourceSelect").getValue().trim();var c=this.oConfigurationEditor.registerService(S);if(c){v.source=S;var d=this.byId("idReqFilterSelect").getSelectedKey();if(d!==this.getText("none")){r=[d];}else{r=this.step.getFilterProperties();}A=i?this.oConfigurationEditor.getAllEntitySetsOfServiceWithGivenProperties(S,r):this.oConfigurationEditor.getAllEntitySetsOfService(S);var e;if(p==="entitySet"||p==="selectProperties"||p==="targetProperties"||p==="requiredFilter"){e=i?this.byId("idFilterMapEntitySelect").getSelectedKey():this.byId("idEntitySelect").getSelectedKey();}else{e=i?this.step.getFilterMappingEntitySet():this.step.getEntitySet();}if(e){A.forEach(function(u){if(e===u){v.entitySet=e;if(p==="source"){if(i){a.byId("idFilterMapEntitySelect").setSelectedKey(e);}else{a.byId("idEntitySelect").setSelectedKey(e);}}}});var f,C=[];if(p==="selectProperties"){f=this.byId("idSelectPropCombo").getSelectedKeys();}else{f=this.step.getSelectProperties();}var P=this.oConfigurationEditor.getAllPropertiesOfEntitySet(S,e);var g=[];P.forEach(function(u){var w={};w.propertyKey=u;w.propertyName=u;g.push(w);});var D={Properties:g};var m=new sap.ui.model.json.JSONModel();m.setSizeLimit(500);m.setData(D);if(!i){this.byId("idSelectPropCombo").setModel(m);}else{this.byId("idFilterMapTargetFilterCombo").setModel(m);}P.forEach(function(u){f.forEach(function(w){if(w===u){C.push(w);}});});var h=[];var o=[{propertyKey:this.getText("none"),propertyName:this.getText("none")}];if(this.step.getFilterMappingTargetProperties().length===0){this.byId("idFilterMapTargetFilterCombo").setSelectedKeys([]);}if(C.length>0){v.selectProperty=C;if(p!=="selectProperties"&&!i){this.byId("idSelectPropCombo").setSelectedKeys(C);}C.forEach(function(u){var w={};w.propertyKey=u;w.propertyName=u;h.push(w);});}else{var j;if(!i){j=this.byId("idSelectPropCombo").getSelectedKeys();this.byId("idSelectPropCombo").removeSelectedKeys(j);this.byId("idReqFilterSelect").setSelectedKey(this.getText("none"));}}o=o.concat(h);var R={Properties:o};var k=new sap.ui.model.json.JSONModel();k.setData(R);var t=[],l=[];if(p==="targetProperties"){t=this.byId("idFilterMapTargetFilterCombo").getSelectedKeys();}else{t=this.step.getFilterMappingTargetProperties();}if(t.length>0){v.targetFilter=t;this.byId("idFilterMapTargetFilterCombo").setSelectedKeys(t);}if(p==="requiredFilter"){l.push(this.byId("idReqFilterSelect").getSelectedKey());}else{l=this.step.getFilterProperties();}var n=[];l.forEach(function(u){if(u!==a.getText("none")){h.forEach(function(w){if(w.propertyKey===u){n.push(u);}});}});if(n.length!==0){v.requiredFilter=n;}else{if(!i){this.byId("idReqFilterSelect").setSelectedKey(this.getText("none"));}}var T={Properties:h};var q=new sap.ui.model.json.JSONModel();q.setSizeLimit(500);q.setData(T);if(!i){this.byId("idReqFilterSelect").setModel(k);}}if(i){this._validateStepServiceForFilterMapping(v);}else{this._validateStepServiceForDataSource(v);}}else{if(i){this._resetFilterMappingFields();}else{this._resetStepRequestProperties();}}},_resetStepRequestProperties:function(){var s=this;this.step.setEntitySet(undefined);var o=this.step.getSelectProperties();o.forEach(function(p){s.step.removeSelectProperty(p);});var O=this.step.getFilterProperties();O.forEach(function(p){s.step.removeFilterProperty(p);});this.byId("idEntitySelect").setSelectedKey();this.byId("idReqFilterSelect").setSelectedKey();},_validateStepServiceForDataSource:function(v){var s=this;if(v.selectProperty&&v.entitySet&&v.source){this.step.setService(v.source);this.step.setEntitySet(v.entitySet);var o=this.step.getSelectProperties();o.forEach(function(p){s.step.removeSelectProperty(p);});v.selectProperty.forEach(function(p){s.step.addSelectProperty(p);});var O=this.step.getFilterProperties();O.forEach(function(p){s.step.removeFilterProperty(p);});if(v.requiredFilter){v.requiredFilter.forEach(function(p){s.step.addFilterProperty(p);});}}},_validateStepServiceForFilterMapping:function(v){var s=this;if(v.entitySet&&v.source&&v.targetFilter){this.step.setFilterMappingService(v.source);this.step.setFilterMappingEntitySet(v.entitySet);var o=this.step.getFilterMappingTargetProperties();o.forEach(function(p){s.step.removeFilterMappingTargetProperty(p);});v.targetFilter.forEach(function(p){s.step.addFilterMappingTargetProperty(p);});}},handleChangeForCategory:function(){this.oConfigurationEditor.setIsUnsaved();var s=this;var a=s.step.getId();var c=this.params.arguments.categoryId;var p=this.oConfigurationEditor.getCategoriesForStep(this.step.getId());var S=this.byId("idCategorySelect").getSelectedKeys();var b=S.indexOf(c);var d=[];var u=[];var i,j;for(i=0;i<p.length;i++){var m=false;for(j=0;j<S.length;j++){if(p[i]===S[j]){m=true;break;}}if(!m){u.push(p[i]);}}if(S.length!==0){S.forEach(function(e){s.oConfigurationEditor.addCategoryStepAssignment(e,a);var o={oldContext:{name:s.params.name,arguments:{configId:s.params.arguments.configId,categoryId:c,stepId:a}},newContext:{arguments:{configId:s.params.arguments.configId,categoryId:e}}};if(e!==c){d.push(o);}});p.forEach(function(C){if(S.indexOf(C)===-1){s.oConfigurationEditor.removeCategoryStepAssignment(C,s.step.getId());}});if(u.length!==0){var n=jQuery.extend(true,{},s.params);u.forEach(function(e){var o={oldContext:{name:s.params.name,arguments:{configId:s.params.arguments.configId,categoryId:c,stepId:a}},newContext:{arguments:{configId:s.params.arguments.configId,categoryId:e}},removeStep:true};if(b===-1&&e===c){var f={arguments:{appId:s.params.arguments.appId,configId:s.params.arguments.configId,categoryId:S[0],stepId:a}};o.categoryChangeContext=f;o.changeCategory=true;}d.push(o);});}}if(d.length!==0){this.oViewData.updateConfigTree(d);}},handleChangeForLeftTop:function(){this.oConfigurationEditor.setIsUnsaved();var s=this.byId("idLeftTop").getValue().trim();var t=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_CORNER_TEXT;var S=this.oTextPool.setText(s,t);this.step.setLeftUpperCornerTextKey(S);},handleChangeForRightTop:function(){this.oConfigurationEditor.setIsUnsaved();var s=this.byId("idRightTop").getValue().trim();var t=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_CORNER_TEXT;var S=this.oTextPool.setText(s,t);this.step.setRightUpperCornerTextKey(S);},handleChangeForLeftBottom:function(){this.oConfigurationEditor.setIsUnsaved();var s=this.byId("idLeftBottom").getValue().trim();var t=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_CORNER_TEXT;var S=this.oTextPool.setText(s,t);this.step.setLeftLowerCornerTextKey(S);},handleChangeForRightBottom:function(){this.oConfigurationEditor.setIsUnsaved();var s=this.byId("idRightBottom").getValue().trim();var t=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_CORNER_TEXT;var S=this.oTextPool.setText(s,t);this.step.setRightLowerCornerTextKey(S);},_setSortDataForStep:function(){var s=this;var S=this.step.getSelectProperties().map(function(p){return{property:p};});var a;var t=this.step.getTopN();if(t&&t.orderby){var b=t.orderby.map(function(c){var O=c.property;var d=c.ascending!==undefined&&!c.ascending?s.getText("descending"):s.getText("ascending");return{property:O,ascending:d,aAllProperties:S};});a=b;}else{a=[{property:S[0].property,ascending:true,aAllProperties:S}];}var o=new sap.ui.model.json.JSONModel({aSortRows:a});this.byId("idStepSortLayout").setModel(o);this._bindSortLayoutDataForStep();},_bindSortLayoutDataForStep:function(){var s=this;var S=this.byId("idStepSortLayout");var o=new sap.ui.layout.Grid({width:"100%"});var a=new sap.m.Label({width:"100%",textAlign:"End",layoutData:new sap.ui.layout.GridData({span:"L3 M3 S3"}),text:this.getText("sortingField")}).addStyleClass("sortFieldLabel");o.addContent(a);var b=new sap.m.Select({width:"100%",layoutData:new sap.ui.layout.GridData({span:"L2 M3 S3"}),items:{path:"aAllProperties",template:new sap.ui.core.ListItem({key:"{property}",text:"{property}"})},selectedKey:"{property}",change:s._handleChangeForSortData.bind(this)});o.addContent(b);var d=new sap.m.Label({layoutData:new sap.ui.layout.GridData({span:"L2 M2 S2"}),width:"100%",textAlign:"End",text:this.getText("direction")}).addStyleClass("directionLabel");o.addContent(d);var D=new sap.m.Select({width:"100%",layoutData:new sap.ui.layout.GridData({span:"L2 M2 S2"}),items:[{key:this.getText("ascending"),text:this.getText("ascending")},{key:this.getText("descending"),text:this.getText("descending")}],selectedKey:"{ascending}",change:s._handleChangeForSortData.bind(this)});o.addContent(D);var A=new sap.ui.core.Icon({width:"100%",src:"sap-icon://add",tooltip:this.getText("addButton"),visible:true,press:s._handleChangeForAddSortRow.bind(this)}).addStyleClass("addIconRepresentation");var r=new sap.ui.core.Icon({width:"100%",src:"sap-icon://less",tooltip:this.getText("deleteButton"),visible:{path:"/",formatter:function(){var B=this.getBindingContext();var n=parseInt(B.getPath().split("/").pop(),10);return!!n;}},press:s._handleChangeForDeleteSortRow.bind(this)}).addStyleClass("lessIconRepresentation");var i=new sap.m.HBox({layoutData:new sap.ui.layout.GridData({span:"L2 M2 S2"}),items:[A,r]});o.addContent(i);S.bindAggregation("items","/aSortRows",function(I){return o.clone(I);});},_handleChangeForSortData:function(){this._setSortFieldsFromCurrentDataset();this.oConfigurationEditor.setIsUnsaved();},_handleChangeForAddSortRow:function(a){var u=this._getUpdatedSortRow(a);var b=a.getSource().getBindingContext();var c=jQuery.extend(true,{},b.getObject());delete c.property;delete c.ascending;u.aSortRows.splice(u.nCurrentIndex+1,0,c);this._updateModelForSortData();},_handleChangeForDeleteSortRow:function(d){var u=this._getUpdatedSortRow(d);u.aSortRows.splice(u.nCurrentIndex,1);this._updateModelForSortData();},_getUpdatedSortRow:function(s){var b=s.getSource().getBindingContext();var n=parseInt(b.getPath().split("/").pop(),10);var S=this.byId("idStepSortLayout").getModel().getData().aSortRows;return{nCurrentIndex:n,aSortRows:S};},_updateModelForSortData:function(){this.byId("idStepSortLayout").getModel().updateBindings();this._setSortFieldsFromCurrentDataset();this.oConfigurationEditor.setIsUnsaved();},_setSortFieldsFromCurrentDataset:function(){var s=this;var S=[];this.byId("idStepSortLayout").getModel().getData().aSortRows.forEach(function(o){var a={};a.property=o.property||(o.aAllProperties.length&&o.aAllProperties[0].property);a.ascending=!o.ascending||(o.ascending===s.getText("ascending"));S.push(a);});this.step.setTopNSortProperties(S);},handleChangeForDataReduction:function(e){var i;if(e.getSource().getSelectedButton().getText()===this.getText("noDataReduction")){i=false;this._resetTopNFields();}else{this._setSortDataForStep();i=true;}this._changeVisibilityOfTopN(i);},_resetTopNFields:function(){this.step.resetTopN();var s=new sap.ui.model.json.JSONModel({aSortRows:[]});this.byId("idStepSortLayout").setModel(s);this.byId("idCustomRecordValue").setValue();},handleChangeForDataRecordInputValue:function(e){var i;if(e.getSource().getValue().trim().indexOf(".")!==-1||e.getSource().getValue().trim()<=0||e.getSource().getValue().trim()>10000){i="Error";}else{i="None";}e.getSource().setValueState(i);var s=[];this.byId("idStepSortLayout").getModel().getData().aSortRows.forEach(function(a){s.push({property:a.property,ascending:a.ascending});});if(s){this.step.setTopNValue(e.getSource().getValue());this.step.setTopNSortProperties(s);}this.oConfigurationEditor.setIsUnsaved();},_changeVisibilityOfTopN:function(i){this.byId("idCustomRecordValue").isMandatory=i;this.byId("idDataRecordsLabel").setVisible(i);this.byId("idDataRecordsLabel").setRequired(i);this.byId("idCustomRecordValue").setVisible(i);this.byId("idStepSortLayout").setVisible(i);},_setMandatoryFields:function(f){this.mandatoryFields=this.mandatoryFields||[];for(var i=0;i<f.length;i++){f[i].isMandatory=true;this.mandatoryFields.push(f[i]);}},_getMandatoryFields:function(){return this.mandatoryFields;},_setValidationState:function(){var m=this._getMandatoryFields();for(var i=0;i<m.length;i++){if(m[i].isMandatory===true){if(typeof m[i].getSelectedKeys==="function"){this.isValidState=(m[i].getSelectedKeys().length>=1)?true:false;}else if(typeof m[i].getValue==="function"){this.isValidState=(m[i].getValue().trim()!=="")?true:false;}else{this.isValidState=(m[i].getSelectedKey().length>=1)?true:false;}if(this.isValidState===false){break;}}}},getValidationState:function(){this._setValidationState();var i=(this.isValidState!==undefined)?this.isValidState:true;return i;}});
