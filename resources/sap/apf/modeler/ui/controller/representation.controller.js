/*!
* SAP APF Analysis Path Framework
*
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
jQuery.sap.require("sap.apf.ui.utils.constants");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");sap.ui.controller("sap.apf.modeler.ui.controller.representation",{onInit:function(){this.getView().addStyleClass("sapUiSizeCompact");this.oViewData=this.getView().getViewData();this.oConfigurationHandler=this.oViewData.oConfigurationHandler;this.oConfigurationEditor=this.oViewData.oConfigurationEditor;this.oTextPool=this.oConfigurationHandler.getTextPool();this.getText=this.oViewData.getText;this.getEntityTypeMetadata=this.oViewData.getEntityTypeMetadata;this.getRepresentationTypes=this.oViewData.getRepresentationTypes;this.mParam=this.oViewData.oParams;var s=this;if(!this.oConfigurationEditor){this.oConfigurationHandler.loadConfiguration(this.mParam.arguments.configId,function(c){s.oConfigurationEditor=c;});}this._setDisplayText();this.setDetailData();this._oPreviewButton=new sap.m.Button({text:this.getText("preview"),press:s._handlePreviewButtonPress.bind(this)});this._insertPreviewButtonInFooter();},onAfterRendering:function(){this._enableDisableItemsInDisplayOptionOrDisplayOptionBox();},_setDisplayText:function(){this.byId("idVisualization").setTitle(this.getText("visualization"));this.byId("idChartTypeLabel").setText(this.getText("chartType"));this.byId("idChartTypeLabel").setTooltip(this.getText("chartType"));this.byId("idBasicData").setTitle(this.getText("basicData"));this.byId("idSorting").setTitle(this.getText("sorting"));this.byId("idThumbnailTexts").setTitle(this.getText("cornerTextLabel"));this.byId("idLeftUpper").setPlaceholder(this.getText("leftTop"));this.byId("idRightUpper").setPlaceholder(this.getText("rightTop"));this.byId("idLeftLower").setPlaceholder(this.getText("leftBottom"));this.byId("idRightLower").setPlaceholder(this.getText("rightBottom"));},handleChangeForChartType:function(e){var n=e.getParameter("selectedItem").getKey();var p=this.sCurrentChartType;this.sCurrentChartType=n;this._updateAndSetDatasetsByChartType(n);var r=sap.apf.ui.utils.CONSTANTS.representationTypes;var b=r.BAR_CHART;var c=[r.COLUMN_CHART,r.STACKED_COLUMN_CHART,r.PERCENTAGE_STACKED_COLUMN_CHART,r.LINE_CHART];var i=(b===n);this.bIsBarClassType=i;var I=c.indexOf(n)!==-1;var a=(c.indexOf(n)!==-1&&c.indexOf(p)!==-1);if(i||(I&&!a)){this._switchLabelForCharts();}this.oRepresentation.setRepresentationType(n);var A;if(n!==sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){A=sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION;}var s=this._getChartPictureDataset().sSelectedChartPicture;this.oRepresentation.setAlternateRepresentationType(A);var R=this.getText(this.oRepresentation.getRepresentationType());var S=this.oConfigurationEditor.getCategoriesForStep(this.oParentStep.getId());if(S.length===1){this.oViewData.updateSelectedNode({name:R,icon:s});}else{this.oViewData.updateTree();}var t=this.getText("representation")+": "+R;this.oViewData.updateTitleAndBreadCrumb(t);this.oConfigurationEditor.setIsUnsaved();},_switchLabelForCharts:function(){var s=this;var b=this.byId("idBasicDataLayout").getItems();var a,k;b.forEach(function(d){a=d.getContent()[0].getBindingContext().getProperty("sAggregationRole");k=d.getContent()[0].getBindingContext().getProperty("sKind");if(a&&k){var t=s._createDimMeasForCharts(a,k);if(a==="dimension"){t=s.getText("display",[t]);}d.getContent()[0].setText(t);}});},_createDimMeasForCharts:function(a,k){var h=sap.apf.core.constants.representationMetadata.kind.XAXIS;var v=sap.apf.core.constants.representationMetadata.kind.YAXIS;if(a==="dimension"&&k===h){k=h;if(this.bIsBarClassType){k=v;}}else if(a==="measure"&&k===v){k=v;if(this.bIsBarClassType){k=h;}}var u=this.getText(a);var U=this.getText(k);var t=this.getText("dim-measure-label",[u,U]);if(this.bIsDualLineChart&&k===v&&a==="measure"){var s=this.getText("leftVerticalAxis");t=this.getText("dim-measure-label",[u,s]);}return t;},handleChangeForCornerText:function(e){var c=e.getSource();var C=c.getValue();var t=sap.apf.modeler.ui.utils.TranslationFormatMap.REPRESENTATION_CORNER_TEXT;var s=this.oTextPool.setText(C,t);var a=c.getBindingPath('value').replace("/","");var S=["set",a,"CornerTextKey"].join("");this.oRepresentation[S](s);this.oConfigurationEditor.setIsUnsaved();this.mDataset.oCornerTextsDataset[a]=this._getCornerTextsDataset()[a];this.mModel.oCornerTextsModel.updateBindings();},_addAutoCompleteFeatureOnInputs:function(){var s=this;var t=new sap.apf.modeler.ui.utils.TextPoolHelper(this.oTextPool);var d={oTranslationFormat:sap.apf.modeler.ui.utils.TranslationFormatMap.REPRESENTATION_CORNER_TEXT,type:"text"};var c=["idLeftUpper","idRightUpper","idLeftLower","idRightLower"];c.forEach(function(i){var I=s.getView().byId(i);t.setAutoCompleteOn(I,d);});},_bindBasicRepresentationData:function(){var s=this;var n,p,c,l;var b=this.byId("idBasicDataLayout");var P=new sap.ui.layout.Grid({width:"100%"});var a=new sap.m.Label({width:"100%",textAlign:"End",layoutData:new sap.ui.layout.GridData({span:"L2 M2 S2"}),text:{path:"/",formatter:function(){var d=this,e,f;var g=this.getBindingContext().getProperty("sAggregationRole");var k=this.getBindingContext().getProperty("sKind");var C=s.sCurrentChartType;var R=sap.apf.ui.utils.CONSTANTS.representationTypes;var B=[R.BAR_CHART,R.STACKED_BAR_CHART,R.PERCENTAGE_STACKED_BAR_CHART];s.bIsBarClassType=(B.indexOf(C)!==-1);s.bIsDualLineChart=(R.LINE_CHART_WITH_TWO_VERTICAL_AXES.indexOf(C)!==-1);if(g&&k){if(s.bIsBarClassType||s.bIsDualLineChart){e=s._createDimMeasForCharts(g,k);}else{f=s.getText(g);k=s.getText(k);e=s.getText("dim-measure-label",[f,k]);}if(g==="dimension"){e=s.getText("display",[e]);}d.setTooltip(e);return e;}}}});P.addContent(a);var o=new sap.m.Select({width:"100%",layoutData:new sap.ui.layout.GridData(),items:{path:"aAllProperties",template:new sap.ui.core.ListItem({key:"{sName}",text:"{sName}"}),templateShareable:true},selectedKey:"{sSelectedProperty}",change:s._handleChangeForBasicDataSelectProperty.bind(this)});P.addContent(o);var L=new sap.m.Label({textAlign:"End",width:"100%",layoutData:new sap.ui.layout.GridData({span:"L2 M2 S2"}),text:{path:"/",formatter:function(){var t;var d,S;var e=this.getBindingContext().getProperty("sLabel");var f=this;if(this.getParent().getContent()[1].getSelectedItem()){S=this.getParent().getContent()[1].getSelectedItem().getText();}else{S=this.getBindingContext().getProperty("sSelectedProperty");}t=s.getText("label");if(S&&S!==s.getText("none")){var g=s.oEntityMetadata.getPropertyMetadata(S);d=g.label?g.label:g.name;if(!e||(e&&d&&(e===d))){t=s.getText("label")+"("+s.getText("default")+")";}}f.setTooltip(t);return t;}}}).addStyleClass("repFormRightLabel");P.addContent(L);var i=new sap.m.Input({width:"100%",layoutData:new sap.ui.layout.GridData({span:"L3 M2 S2"}),value:{path:"sLabel",formatter:function(){var d,S;if(!this.mEventRegistry.suggest&&this.getShowSuggestion()===false){var t=new sap.apf.modeler.ui.utils.TextPoolHelper(s.oTextPool);var D={oTranslationFormat:sap.apf.modeler.ui.utils.TranslationFormatMap.REPRESENTATION_LABEL,type:"text"};t.setAutoCompleteOn(this,D);}if(this.getParent().getContent()[1].getSelectedItem()){S=this.getParent().getContent()[1].getSelectedItem().getText();}else{S=this.getBindingContext().getProperty("sSelectedProperty");}if(S&&S!==s.getText("none")){var e=s.oEntityMetadata.getPropertyMetadata(S);d=e.label?e.label:e.name;}var f=this.getBindingContext().getProperty("sLabel");if((S&&S!==s.getText("none")&&!f)||(f&&d&&(f===d))){return d;}return f;}},change:s._handleChangeForBasicDataPropertyRowLabelInput.bind(this)});P.addContent(i);var A=new sap.ui.core.Icon({width:"100%",src:"sap-icon://add",tooltip:s.getText("addButton"),visible:{path:"nMax",formatter:function(d){return(d==="*");}},press:s._handlerForBasicDataAddPropertyRow.bind(this)}).addStyleClass("addIconRepresentation");var r=new sap.ui.core.Icon({width:"100%",src:"sap-icon://less",tooltip:s.getText("deleteButton"),visible:{path:"/",formatter:function(){var d=true;var B=this.getBindingContext();var e=parseInt(B.getPath().split("/").pop(),10);if(e){var f=s.mDataset.oPropertyDataset.aPropertyRows;var C=f[e].sKind;var g=f[e].sAggregationRole;var h=e-1;var j=f[h].sKind;var k=f[h].sAggregationRole;d=!(C===j&&g===k);}return!d;}},press:s._handlerForBasicDataDeletePropertyRow.bind(this)}).addStyleClass("lessIconRepresentation");var I=new sap.m.HBox({layoutData:new sap.ui.layout.GridData({span:"L1 M2 S2"}),items:[A,r]});P.addContent(I);b.bindAggregation("items","/aPropertyRows",function(d,m){c=jQuery.extend(true,{},P);p=m.sPath.split("/");n=p[p.indexOf("aPropertyRows")+1];c.getContent()[1].getLayoutData().setSpan("L4 M4 S4");if(s.mModel.oPropertyModel.getData().aPropertyRows[n].sAggregationRole==="dimension"){l=new sap.m.Select({width:"100%",layoutData:new sap.ui.layout.GridData({span:"L2 M2 S2"}),items:{path:"aLabelDisplayOptionTypes",template:new sap.ui.core.ListItem({key:"{key}",text:"{value}"}),templateShareable:true},selectedKey:"{sLabelDisplayOptionProperty}",change:s._handleChangeForLabelDisplayOption.bind(s)});c.insertContent(l,2);c.getContent()[1].getLayoutData().setSpan("L2 M2 S2");}return c.clone(d);});},_handleChangeForBasicDataSelectProperty:function(s){var l;var S=s.getSource().getSelectedKey();var p=s.getSource().getParent().getContent();var L=s.getSource().getBindingContext().getProperty("sAggregationRole")==="dimension"?p[3]:p[2];var o=s.getSource().getBindingContext().getProperty("sAggregationRole")==="dimension"?p[4]:p[3];if(S&&(S!==this.getText("none"))){this._setDefaultLabelForSelectedProperty(S,L);}else{L.setText(this.getText("label"));o.setValue("");}this._setPropertiesFromCurrentDataset();if(s.getSource().getBindingContext().getProperty("sAggregationRole")==="dimension"){this._setDefaultLabelDisplayOption(S);l=s.getSource().getParent().getContent()[2];l.setSelectedKey(this.oRepresentation.getLabelDisplayOption(S));this._enableDisableItemsInDisplayOptionOrDisplayOptionBox();}this.oConfigurationEditor.setIsUnsaved();},_handleChangeForBasicDataPropertyRowLabelInput:function(i){var p=i.getSource().getBindingContext().getProperty("sSelectedProperty");var P=i.getSource().getParent().getContent();var l=i.getSource().getBindingContext().getProperty("sAggregationRole")==="dimension"?P[3]:P[2];if(p&&p!==this.getText("none")){this._updatLabelInPropertyRow(p,i.getSource().getValue(),l);}this._setPropertiesFromCurrentDataset();this.oConfigurationEditor.setIsUnsaved();},_handleChangeForLabelDisplayOption:function(e){var s=e.getSource().getSelectedKey();var p=e.getSource().getBindingContext().getProperty("sSelectedProperty");this.oRepresentation.setLabelDisplayOption(p,s);this.oConfigurationEditor.setIsUnsaved();},_handlerForBasicDataAddPropertyRow:function(a){var b=a.getSource().getBindingContext();var c=jQuery.extend(true,{},b.getObject());delete c.sSelectedProperty;delete c.sLabel;delete c.sLabelDisplayOptionProperty;var n=parseInt(b.getPath().split("/").pop(),10);var p=this.mDataset.oPropertyDataset.aPropertyRows;p.splice(n+1,0,c);this._setPropertiesFromCurrentDataset();this.mModel.oPropertyModel.updateBindings();this._enableDisableItemsInDisplayOptionOrDisplayOptionBox();this.oConfigurationEditor.setIsUnsaved();},_handlerForBasicDataDeletePropertyRow:function(d){var b=d.getSource().getBindingContext();var n=parseInt(b.getPath().split("/").pop(),10);var p=this.mDataset.oPropertyDataset.aPropertyRows;p.splice(n,1);this.mModel.oPropertyModel.updateBindings();this._setPropertiesFromCurrentDataset();this.oConfigurationEditor.setIsUnsaved();},_updatLabelInPropertyRow:function(s,l,L){var p=this.oEntityMetadata.getPropertyMetadata(s);var d=p.label?p.label:p.name;var a,b;if(d!==l&&l.length!==0){a=this.getText("label");b=l;}else{a=this.getText("label")+"("+this.getText("default")+")";b=d;}this.mDataset.oPropertyDataset.aPropertyRows.forEach(function(P){if(P.sSelectedProperty===s){P.sLabel=b;}});this.mModel.oPropertyModel.updateBindings();L.setText(a);},_setDefaultLabelForSelectedProperty:function(s,l){var p=this.oEntityMetadata.getPropertyMetadata(s);var d=p.label?p.label:p.name;var L=this.getText("label")+"("+this.getText("default")+")";this.mDataset.oPropertyDataset.aPropertyRows.forEach(function(P){if(P.sSelectedProperty===s){P.sLabel=d;}});this.mModel.oPropertyModel.updateBindings();l.setText(L);},_bindSortLayoutData:function(){var s=this;var S=this.byId("idSortLayout");var o=new sap.ui.layout.Grid({width:"100%"});var a=new sap.m.Label({width:"100%",textAlign:"End",layoutData:new sap.ui.layout.GridData({span:"L2 M2 S2"}),text:this.getText("sortingField"),tooltip:this.getText("sortingField")});o.addContent(a);var b=new sap.m.Select({width:"100%",layoutData:new sap.ui.layout.GridData({span:"L4 M4 S4"}),items:{path:"aAllProperties",template:new sap.ui.core.ListItem({key:"{sName}",text:"{sName}"}),templateShareable:true},selectedKey:"{sSortProperty}",change:s._handleChangeForSortDataProperty.bind(this)});o.addContent(b);var d=new sap.m.Label({layoutData:new sap.ui.layout.GridData({span:"L2 M2 S2"}),width:"100%",textAlign:"End",text:this.getText("direction"),tooltip:this.getText("direction")});o.addContent(d);var D=new sap.m.Select({width:"100%",layoutData:new sap.ui.layout.GridData({span:"L3 M2 S2"}),items:[{key:this.getText("ascending"),text:this.getText("ascending")},{key:this.getText("descending"),text:this.getText("descending")}],selectedKey:"{sDirection}",change:s._handleChangeForSortDirection.bind(this)});o.addContent(D);var A=new sap.ui.core.Icon({width:"100%",src:"sap-icon://add",tooltip:this.getText("addButton"),visible:true,press:s._handleChangeForAddSortRow.bind(this)}).addStyleClass("addIconRepresentation");var r=new sap.ui.core.Icon({width:"100%",src:"sap-icon://less",tooltip:this.getText("deleteButton"),visible:{path:"/",formatter:function(){var B=this.getBindingContext();var n=parseInt(B.getPath().split("/").pop(),10);return!!n;}},press:s._handleChangeForDeleteSortRow.bind(this)}).addStyleClass("lessIconRepresentation");var i=new sap.m.HBox({layoutData:new sap.ui.layout.GridData({span:"L1 M2 S2"}),items:[A,r]});o.addContent(i);S.bindAggregation("items","/aSortRows",o);},_handleChangeForSortDataProperty:function(){this._setSortFieldsFromCurrentDataset();this.oConfigurationEditor.setIsUnsaved();},_handleChangeForSortDirection:function(s){var S=s.getSource().getBindingContext().getProperty("sSortProperty");if(S!==this.getText("none")){this._setSortFieldsFromCurrentDataset();this.oConfigurationEditor.setIsUnsaved();}},_handleChangeForAddSortRow:function(a){var b=a.getSource().getBindingContext();var c=jQuery.extend(true,{},b.getObject());delete c.sSortProperty;delete c.sDirection;var n=parseInt(b.getPath().split("/").pop(),10);var s=this.mDataset.oSortDataset.aSortRows;s.splice(n+1,0,c);this.mModel.oSortModel.updateBindings();this._setSortFieldsFromCurrentDataset();this.oConfigurationEditor.setIsUnsaved();},_handleChangeForDeleteSortRow:function(d){var b=d.getSource().getBindingContext();var n=parseInt(b.getPath().split("/").pop(),10);var s=this.mDataset.oSortDataset.aSortRows;s.splice(n,1);this.mModel.oSortModel.updateBindings();this._setSortFieldsFromCurrentDataset();this.oConfigurationEditor.setIsUnsaved();},_setPropertiesForTable:function(){var s=this;var d=this.oRepresentation.getDimensions();var m=this.oRepresentation.getMeasures();d.forEach(function(p){s.oRepresentation.addProperty(p);s.oRepresentation.setPropertyTextLabelKey(p,s.oRepresentation.getDimensionTextLabelKey(p));s.oRepresentation.setPropertyKind(p,sap.apf.core.constants.representationMetadata.kind.COLUMN);});m.forEach(function(p){s.oRepresentation.addProperty(p);s.oRepresentation.setPropertyTextLabelKey(p,s.oRepresentation.getMeasureTextLabelKey(p));s.oRepresentation.setPropertyKind(p,sap.apf.core.constants.representationMetadata.kind.COLUMN);});d.forEach(function(D){s.oRepresentation.removeDimension(D);});m.forEach(function(M){s.oRepresentation.removeMeasure(M);});},_validateRepresentationData:function(){var s=this;var d=this.oRepresentation.getDimensions().map(function(a){return{sType:"Dimension",sName:a};});var m=this.oRepresentation.getMeasures().map(function(a){return{sType:"Measure",sName:a};});var p=this.oRepresentation.getProperties().map(function(a){return{sType:"Property",sName:a};});var r=d.concat(m).length?d.concat(m):p;r.forEach(function(a){var P=false;s.aSelectProperties.forEach(function(b){if(a.sName===b.sName){P=true;}});if(P===false){var R=["remove",a.sType].join("");s.oRepresentation[R](a.sName);s.oConfigurationEditor.setIsUnsaved();}});},_enableDisableItemsInDisplayOptionOrDisplayOptionBox:function(){var i,a,d,I,p;if(this.byId('idBasicDataLayout').getModel()){p=this.byId("idBasicDataLayout").getModel().getData().aPropertyRows;var b=this.byId("idBasicDataLayout");for(i=0;i<p.length;i++){if(p[i].sAggregationRole==="dimension"){d=b.getItems()[i].getContent()[2];if(p[i].sSelectedProperty===this.getText("none")){b.getItems()[i].getContent()[2].setEnabled(false);continue;}else{b.getItems()[i].getContent()[2].setEnabled(true);}I=this._checkIfTextPropertyOfDimensionIsPresent(p[i].sSelectedProperty);for(a=0;a<d.getItems().length;a++){if(a>0){d.getItems()[a].setEnabled(I);}}}}}},_checkIfTextPropertyOfDimensionIsPresent:function(d){var i=false;var D=this.oEntityMetadata.getPropertyMetadata(d);if(D.text){var s=this.oParentStep.getSelectProperties();i=s.indexOf(D.text)===-1?false:true;}return i;},_setDefaultLabelDisplayOption:function(d){var i=this._checkIfTextPropertyOfDimensionIsPresent(d);if(i){this.oRepresentation.setLabelDisplayOption(d,sap.apf.core.constants.representationMetadata.labelDisplayOptions.KEY_AND_TEXT);}else{this.oRepresentation.setLabelDisplayOption(d,sap.apf.core.constants.representationMetadata.labelDisplayOptions.KEY);}this.oConfigurationEditor.setIsUnsaved();},_setDefaultLabelDisplayOptionToDimensions:function(){var s=this;this.oRepresentation.getDimensions().forEach(function(d){if(s.oRepresentation.getLabelDisplayOption(d)===undefined){s._setDefaultLabelDisplayOption(d);}});},setDetailData:function(){var c=this.mParam.arguments;this.oParentStep=this.oConfigurationEditor.getStep(c.stepId);this.oEntityMetadata=this.getEntityTypeMetadata(this.oParentStep.getService(),this.oParentStep.getEntitySet());this.aSelectProperties=this._getSelectPropertiesFromParentStep();this.oRepresentation=this.oParentStep.getRepresentation(c.representationId);if(!this.oRepresentation){this.oRepresentation=this.oParentStep.createRepresentation();this._setDefaultRepresentationType();this._setDefaultProperties();this.oConfigurationEditor.setIsUnsaved();}if(this.oRepresentation.getRepresentationType()===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){this._setPropertiesForTable();}this._validateRepresentationData();this._setDefaultLabelDisplayOptionToDimensions();var C=this._getChartTypeDataset();var p=this._getPropertyDataset();var s=this._getSortDataset();var o=this._getCornerTextsDataset();var a=this._getChartPictureDataset();this.mDataset={oChartTypeDataset:C,oPropertyDataset:p,oSortDataset:s,oCornerTextsDataset:o,oChartPictureDataset:a};var b=new sap.ui.model.json.JSONModel(this.mDataset.oChartTypeDataset);var P=new sap.ui.model.json.JSONModel(this.mDataset.oPropertyDataset);var S=new sap.ui.model.json.JSONModel(this.mDataset.oSortDataset);var d=new sap.ui.model.json.JSONModel(this.mDataset.oCornerTextsDataset);var e=new sap.ui.model.json.JSONModel(this.mDataset.oChartPictureDataset);this.mModel={oChartTypeModel:b,oPropertyModel:P,oSortModel:S,oCornerTextsModel:d,oChartPictureModel:e};this.byId("idChartType").setModel(this.mModel.oChartTypeModel);var f=this.sCurrentChartType;this._updateAndSetDatasetsByChartType(f);this.byId("idBasicDataLayout").setModel(this.mModel.oPropertyModel);this._bindBasicRepresentationData();this.byId("idSortLayout").setModel(this.mModel.oSortModel);this._bindSortLayoutData();this.byId("idLeftLower").setModel(this.mModel.oCornerTextsModel);this.byId("idRightLower").setModel(this.mModel.oCornerTextsModel);this.byId("idLeftUpper").setModel(this.mModel.oCornerTextsModel);this.byId("idRightUpper").setModel(this.mModel.oCornerTextsModel);this.byId("idChartIcon").setModel(this.mModel.oChartPictureModel);this._addAutoCompleteFeatureOnInputs();var i;if(this.oParentStep.getTopN()){i=false;}else{i=true;}this._changeEditableOfSortProperty(i);},_changeEditableOfSortProperty:function(i){var s=this.byId("idSortLayout").getItems();s.forEach(function(S,n){S.getContent().forEach(function(c){if(c instanceof sap.m.Select){c.setEnabled(i);}if(c instanceof sap.m.HBox){c.getItems().forEach(function(a,b){if(a instanceof sap.ui.core.Icon){a.setVisible(i);if(n===0&&b===1){a.setVisible(false);}}});}});});},_insertPreviewButtonInFooter:function(){var f=this.oViewData.oFooter;f.addContentRight(this._oPreviewButton);},_removePreviewButtonFromFooter:function(){var f=this.oViewData.oFooter;f.removeContentRight(this._oPreviewButton);},_handlePreviewButtonPress:function(){var p=this._getPreviewDetails();var P=new sap.ui.view({type:sap.ui.core.mvc.ViewType.XML,viewName:"sap.apf.modeler.ui.view.previewContent",viewData:p});var o=new sap.m.Dialog({title:this.getText("preview"),content:P,endButton:new sap.m.Button({text:this.getText("close"),press:function(){o.close();}})});o.open();},onExit:function(){this._removePreviewButtonFromFooter();},_getPreviewDetails:function(){var s=this;var c=this.mDataset.oChartTypeDataset.sSelectedChartType;var S=this._getParentStepTitle();var a=this._getParentStepLongTitle()||S;var d=[],m=[],p=[];this.aSelectProperties.forEach(function(o){if(c===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){p.push(o.sName);}else{if(o.sAggregationRole==="dimension"){d.push(o.sName);}else if(o.sAggregationRole==="measure"){m.push(o.sName);}}});var C={dimensions:[],measures:[],properties:[],requiredFilters:[]};this.mDataset.oPropertyDataset.aPropertyRows.forEach(function(P){if(P.sSelectedProperty!==s.getText("none")){var A=(P.sAggregationRole!=="property")?P.sAggregationRole+"s":[P.sAggregationRole.slice(0,-1),"ies"].join("");C[A].push({fieldDesc:P.sLabel,fieldName:P.sSelectedProperty,kind:P.sKind});}});var b=[];this.mDataset.oSortDataset.aSortRows.forEach(function(o){var f=o.sSortProperty||(o.aAllProperties.length&&o.aAllProperties[0].sName);if(f&&f!==s.getText("none")){var A=!o.sDirection||(o.sDirection===s.getText("ascending"));b.push({sSortField:f,bDescending:!A});}});var e={sLeftUpper:this.mDataset.oCornerTextsDataset.LeftUpper,sRightUpper:this.mDataset.oCornerTextsDataset.RightUpper,sLeftLower:this.mDataset.oCornerTextsDataset.LeftLower,sRightLower:this.mDataset.oCornerTextsDataset.RightLower};return{sChartType:c,sStepTitle:S,sStepLongTitle:a,aDimensions:d,aMeasures:m,aProperties:p,oChartParameter:C,aSort:b,aCornerTexts:e};},_getParentStepLongTitle:function(){var s=this.oParentStep.getLongTitleId();s=!this.oTextPool.isInitialTextKey(s)?s:undefined;var S=s&&this.oTextPool.get(s);var a=S&&S.TextElementDescription;return a;},_getParentStepTitle:function(){var s=this.oParentStep.getTitleId();var S=s&&this.oTextPool.get(s);var a=S&&S.TextElementDescription;return a;},_getSelectPropertiesFromParentStep:function(){var a=this.oParentStep.getService();var e=this.oParentStep.getEntitySet();var E=this.getEntityTypeMetadata(a,e);var s=this.oParentStep.getSelectProperties();var r=s.map(function(p){var m=E.getPropertyMetadata(p);return{sName:p,sAggregationRole:m["aggregation-role"],sLabel:m["label"]};});return r;},_getCornerTextsFromConfigObject:function(c){var s=this;var C=["LeftUpper","RightUpper","LeftLower","RightLower"];var d={};C.forEach(function(a){var m=["get",a,"CornerTextKey"].join("");var b=c[m]();var o=b&&s.oTextPool.get(b);var e=o&&o.TextElementDescription;d[a]=e;});return d;},_getChartTypeDataset:function(){var s=this;var k=Object.keys(this._getRepresentationMetadata());var c=k.map(function(K){return{sId:K,sText:s.getText(K)};});var d={aChartTypes:c,sSelectedChartType:this.oRepresentation.getRepresentationType()};this.sCurrentChartType=d.sSelectedChartType;return d;},_getChartPictureDataset:function(){var r=this.getRepresentationTypes();var d={};r.forEach(function(o){var i=o.id;d[i]=o.picture;});d.sSelectedChartPicture=d[this.oRepresentation.getRepresentationType()];return d;},_updatePictureDataset:function(c){var d=this.mModel.oChartPictureModel.getData();d.sSelectedChartPicture=d[c];},_getPropertyDataset:function(){var s=this;var p=[];var a=function(t){var c=s.oRepresentation.getRepresentationType();var g=t!=="Property"?["get",t,"s"].join(""):["get",t.slice(0,-1),"ies"].join("");var P=s.oRepresentation[g]();P.forEach(function(b){var l=["get",t,"TextLabelKey"].join("");var L=s.oRepresentation[l](b);var o=L&&s.oTextPool.get(L);var d=o&&o.TextElementDescription;if(d===undefined||d.length===0){d=s.oEntityMetadata.getPropertyMetadata(b).label||s.oEntityMetadata.getPropertyMetadata(b).name;}var k=["get",t,"Kind"].join("");var K=s.oRepresentation[k](b);var r=s._getRepresentationMetadata()[c];var S=(c===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION)?r[t.slice(0,-1).toLowerCase()+"ies"].supportedKinds:r[t.toLowerCase()+"s"].supportedKinds;var n,e;S.forEach(function(f){if(f.kind===K){n=f.min;e=f.max;}});p.push({sSelectedProperty:b,sAggregationRole:t.toLowerCase(),sLabel:d,sKind:K,nMin:n,nMax:e,sLabelDisplayOptionProperty:t.toLowerCase()==="dimension"?s.oRepresentation.getLabelDisplayOption(b):undefined});});};a("Dimension");a("Measure");a("Property");return{aPropertyRows:p};},_getSortDataset:function(){var s=this;var o=this.oRepresentation.getOrderbySpecifications();var a=this.aSelectProperties.slice();a.unshift({sName:this.getText("none")});if(!o.length){o.push({});}var S=o.map(function(O){var b=O.property;var c=O.ascending!==undefined&&!O.ascending?s.getText("descending"):s.getText("ascending");return{sSortProperty:b,sDirection:c,aAllProperties:a};});return{aSortRows:S};},_getCornerTextsDataset:function(){var r=this._getCornerTextsFromConfigObject(this.oRepresentation);var p=this._getCornerTextsFromConfigObject(this.oParentStep);var d=jQuery.extend({},p,r);return d;},_setDefaultRepresentationType:function(){var d;if(this.getRepresentationTypes()[0].metadata){d=this.getRepresentationTypes()[0].id;}this.oRepresentation.setRepresentationType(d);this.oRepresentation.setAlternateRepresentationType(sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION);var s=this._getChartPictureDataset().sSelectedChartPicture;var S=this.oConfigurationEditor.getCategoriesForStep(this.oParentStep.getId());if(S.length===1){this.oViewData.updateSelectedNode({id:this.oRepresentation.getId(),icon:s});}else{this.oViewData.updateTree();}},_setDefaultProperties:function(){var f,F;this.aSelectProperties.forEach(function(s){if(!f){if(s.sAggregationRole==="dimension"){f=s.sName;}}if(!F){if(s.sAggregationRole==="measure"){F=s.sName;}}});if(f){this.oRepresentation.addDimension(f);this.oRepresentation.setDimensionKind(f,sap.apf.core.constants.representationMetadata.kind.XAXIS);}if(F){this.oRepresentation.addMeasure(F);this.oRepresentation.setMeasureKind(F,sap.apf.core.constants.representationMetadata.kind.YAXIS);}},_updateAndSetDatasetsByChartType:function(c){this._updatePropertyDatasetByChartType(c);this.mModel.oPropertyModel.updateBindings();this._setPropertiesFromCurrentDataset();this._enableDisableItemsInDisplayOptionOrDisplayOptionBox();this._updateSortDatasetByChartType(c);this.mModel.oSortModel.updateBindings();this._setSortFieldsFromCurrentDataset();this._updatePictureDataset(c);this.mModel.oChartPictureModel.updateBindings();},_updatePropertyDatasetByChartType:function(c){var s=this;var d={aPropertyRows:[]};var r=this._getRepresentationMetadata()[c];var a=["dimensions","measures","properties"];a.forEach(function(A){if(r.hasOwnProperty(A)){var S=r[A].supportedKinds;var b;S.forEach(function(o){var e=(A!=="properties")?A.slice(0,-1):[A.slice(0,-3),"y"].join("");var f=(A!=="properties")?s.aSelectProperties.filter(function(P){return(P.sAggregationRole===e);}):s.aSelectProperties;var p={sAggregationRole:e,sKind:o.kind,nMin:o.min,nMax:o.max,aAllProperties:f};if(p.sAggregationRole==="dimension"){p.aLabelDisplayOptionTypes=[{key:"key",value:s.getText("key")},{key:"text",value:s.getText("text")},{key:"keyAndText",value:s.getText("keyAndText")}];}if(!parseInt(o.min,10)){p.aAllProperties.unshift({sName:s.getText("none"),sAggregationRole:e});}p.aAllProperties.forEach(function(g){b=g.sName;if(b){var t=e;var h=[t.charAt(0).toUpperCase(),t.substring(1)].join("");var l=["get",h,"TextLabelKey"].join("");var L=s.oRepresentation[l](b);var i=L&&s.oTextPool.get(L);var j=i&&i.TextElementDescription;if(j){g.sLabel=j;}else{if(b!==s.getText("none")){var P=s.oEntityMetadata.getPropertyMetadata(b);var D=P.label?P.label:P.name;if(D){g.sLabel=D;}}}}});d.aPropertyRows.push(p);});}});var R={aPropertyRows:[]};d.aPropertyRows.forEach(function(D){var e=false;s.mDataset.oPropertyDataset.aPropertyRows.forEach(function(E){var h=E.sAggregationRole===D.sAggregationRole;var H=E.sKind===D.sKind;var b=E.nMin===D.nMin;var f=E.nMax===D.nMax;if(h&&H&&b&&f){e=true;var C=jQuery.extend(E,D);R.aPropertyRows.push(C);}});if(!e){R.aPropertyRows.push(D);}});this.mDataset.oPropertyDataset.aPropertyRows=R.aPropertyRows;},_updateSortDatasetByChartType:function(c){var r=this._getRepresentationMetadata()[c];if(r.sortable!==undefined&&!r.sortable){var a=this.aSelectProperties.slice();a.unshift({sName:this.getText("none")});this.mDataset.oSortDataset.aSortRows=[{aAllProperties:a,sDirection:this.getText("ascending")}];this.byId("idSortLayout").setVisible(false);this.byId("idSorting").setVisible(false);}else{this.byId("idSortLayout").setVisible(true);this.byId("idSorting").setVisible(true);this.mModel.oSortModel.updateBindings();var s=this.byId("idSortLayout");jQuery.sap.delayedCall(10,s,s.rerender);}},_setPropertiesFromCurrentDataset:function(){var s=this;var d=this.oRepresentation.getDimensions();d.forEach(function(D){s.oRepresentation.removeDimension(D);});var m=this.oRepresentation.getMeasures();m.forEach(function(M){s.oRepresentation.removeMeasure(M);});var p=this.oRepresentation.getProperties();p.forEach(function(P){s.oRepresentation.removeProperty(P);});this.mDataset.oPropertyDataset.aPropertyRows.forEach(function(P){var S=P.sSelectedProperty||(P.aAllProperties.length&&P.aAllProperties[0].sName);if(S&&S!==s.getText("none")){var a=P.sAggregationRole;var A=[a.charAt(0).toUpperCase(),a.substring(1)].join("");var o=s.oEntityMetadata.getPropertyMetadata(S);var D=o.label?o.label:o.name;var l=P.sLabel;var L;if(l&&l!==D){var t=sap.apf.modeler.ui.utils.TranslationFormatMap.REPRESENTATION_LABEL;L=s.oTextPool.setText(l,t);}var b=["add",A].join("");var c=["set",A,"Kind"].join("");var e=["set",A,"TextLabelKey"].join("");s.oRepresentation[b](S);s.oRepresentation[c](S,P.sKind);s.oRepresentation[e](S,L);if(a==="dimension"){var f=P.sLabelDisplayOptionProperty;if(!f){s._setDefaultLabelDisplayOption(S);P.sLabelDisplayOptionProperty=s.oRepresentation.getLabelDisplayOption(S);}else{s.oRepresentation.setLabelDisplayOption(S,f);}}P.sSelectedProperty=S;}else{P.sLabel="";P.sSelectedProperty=s.getText("none");P.sLabelDisplayOptionProperty=undefined;}});},_setSortFieldsFromCurrentDataset:function(){var s=this;this.oRepresentation.getOrderbySpecifications().forEach(function(o){s.oRepresentation.removeOrderbySpec(o.property);});this.mDataset.oSortDataset.aSortRows.forEach(function(S){var a=S.sSortProperty||(S.aAllProperties.length&&S.aAllProperties[0].sName);if(a&&a!==s.getText("none")){var A=!S.sDirection||(S.sDirection===s.getText("ascending"));s.oRepresentation.addOrderbySpec(a,A);}});},_getRepresentationMetadata:function(){var r={};this.getRepresentationTypes().forEach(function(a){if(a.metadata){r[a.id]=a.metadata;}});return r;}});
