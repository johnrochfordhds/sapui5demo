/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global',"sap/gantt/GanttChartBase","sap/ui/core/Core","sap/ui/table/TreeTable","sap/ui/table/Row","sap/gantt/misc/Utility",'sap/ui/core/theming/Parameters',"sap/gantt/shape/SelectedShape","sap/gantt/shape/ext/rls/SelectedRelationship","sap/gantt/drawer/ShapeInRow","sap/gantt/drawer/ShapeCrossRow","sap/gantt/drawer/CursorLine","sap/gantt/drawer/NowLine","sap/gantt/drawer/VerticalLine","sap/gantt/drawer/CalendarPattern","sap/gantt/misc/AxisTime","sap/gantt/misc/AxisOrdinal","sap/gantt/misc/Format","sap/gantt/misc/TreeTableHelper","sap/ui/thirdparty/d3"],function(q,G,C,T,R,U,P,S,a,b,c,e,N,V,f,A,h,F,l){"use strict";var n=G.extend("sap.gantt.GanttChart",{metadata:{aggregations:{_treeTable:{type:"sap.ui.table.TreeTable",multiple:false,visibility:"hidden"}}}});n.prototype.init=function(){q.sap.measure.start("GanttChart init","GanttPerf:GanttChart init function");this._oTT=new T({visibleRowCountMode:"Auto",minAutoRowCount:1,selectionBehavior:sap.ui.table.SelectionBehavior.RowOnly,selectionMode:sap.ui.table.SelectionMode.Multi,columnHeaderVisible:false});this._oTT.addColumn(new sap.ui.table.Column());this.setAggregation("_treeTable",this._oTT);this._oTT._oHSb.detachScroll(this._oTT.onhscroll,this._oTT);this._oTT._oHSb.attachScroll(this._onHSbScroll,this);this._oTT._oVSb.detachScroll(this._oTT.onvscroll,this._oTT);this._oTT._oVSb.attachScroll(this._onVSbScroll,this);this._oTT.attachEvent("_rowsUpdated",this._onTTRowUpdate.bind(this));this._oTT.addEventDelegate({onAfterRendering:this._onTTRowUpdate},this);this._oTT.attachEvent("_rowSelectionChange",this._onRowSelectionChange.bind(this));this._oTT.attachRowSelectionChange(this._onRowSelectionChange,this);this._oTT.addEventDelegate({onAfterRendering:this._updateCSSForDummyRow},this);this._oShapeInRowDrawer=new b();this._oShapeCrossRowDrawer=new c();this._oCursorLineDrawer=new e();this._oCalendarPatternDrawer=new f();this._oAxisTime=undefined;this._oAxisOrdinal=undefined;this._aShapeData=undefined;this._aShapeInstance=undefined;this._oShapeInstance=undefined;this._oZoom={base:{}};this._oDataNamePerType={};this._fLeftOffsetRate=0.0;this._oStatusSet=null;this._nLowerRange=0;this._nUpperRange=0;this._aSelectedRelationships=undefined;this._oSelectedShapes={};this._aSelectedShapeUids=[];this._iMouseDown=0;this._bMouseDown=false;this._bDragging=false;this._oDraggingData=undefined;this._lastHoverRowIndex=undefined;this._oChartSchemesConfigMap={};this._oChartSchemesConfigMap[sap.gantt.config.DEFAULT_CHART_SCHEME_KEY]=sap.gantt.config.DEFAULT_CHART_SCHEME;this._oObjectTypesConfigMap={};this._oObjectTypesConfigMap[sap.gantt.config.DEFAULT_OBJECT_TYPE_KEY]=sap.gantt.config.DEFAULT_OBJECT_TYPE;this._fExtendFactor=0.382;this._calZoomFromTimeAxisConfig(sap.gantt.config.DEFAULT_TIME_AXIS);this._createAxisTime(sap.gantt.config.DEFAULT_TIME_AXIS);this._mDrawDelayMS=500;this._mTimeouts={};q.sap.measure.end("GanttChart init");};n.prototype.setTimeAxis=function(t){this.setProperty("timeAxis",t,true);this._calZoomFromTimeAxisConfig(t);this._createAxisTime(t);this._oStatusSet=null;this._draw(true);return this;};n.prototype.setLocale=function(L){this.setProperty("locale",L,true);this._oAxisTime.setLocale(L);this._drawShapes();this._drawSelectedShapes();return this;};n.prototype.setChartSchemes=function(d){this.setProperty("chartSchemes",d,true);this._oChartSchemesConfigMap={};if(d){for(var i=0;i<d.length;i++){this._oChartSchemesConfigMap[d[i].getKey()]=d[i];}}this._drawShapes();this._drawSelectedShapes();return this;};n.prototype.setObjectTypes=function(o){this.setProperty("objectTypes",o,true);this._oObjectTypesConfigMap={};if(o){for(var i=0;i<o.length;i++){this._oObjectTypesConfigMap[o[i].getKey()]=o[i];}}this._drawShapes();this._drawSelectedShapes();return this;};n.prototype.setSelectionMode=function(s){this.setProperty("selectionMode",s);if(this._oTT){if(s==sap.gantt.SelectionMode.MultiWithKeyboard){this._oTT.setSelectionMode(sap.ui.table.SelectionMode.Multi);}else if(s==sap.gantt.SelectionMode.Multiple){this._oTT.setSelectionMode(sap.ui.table.SelectionMode.MultiToggle);}else if(s==sap.gantt.SelectionMode.Single){this._oTT.setSelectionMode(sap.ui.table.SelectionMode.Single);}else{this._oTT.setSelectionMode(sap.ui.table.SelectionMode.None);}}return this;};n.prototype._calZoomFromTimeAxisConfig=function(t){if(!t){return;}this._oZoom.base.sGranularity=t.getGranularity();var g=t.getZoomStrategy()[this._oZoom.base.sGranularity];this._oZoom.determinedByConfig={fRate:1};var o=t.getZoomStrategy()[t.getFinestGranularity()];var d=t.getZoomStrategy()[t.getCoarsestGranularity()];var s=d3.time.format("%Y%m%d%H%M%S").parse("20000101000000");var B=q.sap.getObject(g.innerInterval.unit).offset(s,g.innerInterval.span);this._oZoom.base.fScale=this._calZoomScale(s,B,g.innerInterval.range);var m=q.sap.getObject(o.innerInterval.unit).offset(s,o.innerInterval.span);var M=this._calZoomScale(s,m,o.innerInterval.range*4);var i=q.sap.getObject(d.innerInterval.unit).offset(s,d.innerInterval.span);var j=this._calZoomScale(s,i,d.innerInterval.range);this._oZoom.determinedByConfig.fMaxRate=this._oZoom.base.fScale/M;this._oZoom.determinedByConfig.fMinRate=this._oZoom.base.fScale/j;};n.prototype._calZoomScale=function(s,E,L){return(E.valueOf()-s.valueOf())/L;};n.prototype._createAxisTime=function(o){var s=o.getZoomStrategy();var H=d3.time.format("%Y%m%d%H%M%S").parse(o.getPlanHorizon().getStartTime());var d=d3.time.format("%Y%m%d%H%M%S").parse(o.getPlanHorizon().getEndTime());var g=d.valueOf()-H.valueOf();var i=s[o.getGranularity()];var j=q.sap.getObject(i.innerInterval.unit).offset(H,i.innerInterval.span).valueOf()-H.valueOf();this._oAxisTime=new A([H,d],[0,Math.ceil(g*i.innerInterval.range/j)],o.getRate(),null,null,this.getLocale(),C.getConfiguration().getRTL(),o.getZoomStrategy());this._nLowerRange=this._oAxisTime.getViewRange()[0];this._nUpperRange=Math.ceil(this._oAxisTime.getViewRange()[1]);};n.prototype.setShapes=function(s){this.setProperty("shapes",s,true);if(s&&s.length>0){this._oShapesConfigMap={};for(var i=0;i<s.length;i++){this._oShapesConfigMap[s[i].getKey()]=s[i];}this._parseAndSortShape(this._oShapesConfigMap);this._drawShapes();this._drawSelectedShapes();}return this;};n.prototype._parseAndSortShape=function(s,t){var r=[];var d,o,g,m,p,u;for(var i in s){d=t?t:i;o={};if(s[i].getShapeClassName()){o=this._instantiateCustomerClass(s[i].getShapeClassName(),i,s[i],d);var v=o.getCategory(null,this._oAxisTime,this._oAxisOrdinal);if(!t){u=s[i].getSelectedClassName();if(!u){if(v==sap.gantt.shape.ShapeCategory.Relationship){u="sap.gantt.shape.ext.rls.SelectedRelationship";g=new a();}else{u="sap.gantt.shape.SelectedShape";}}g=this._instantiateCustomerClass(u,"selected"+i,s[i],d);o.setAggregation("selectedShape",g);}if(s[i].getGroupAggregation()&&s[i].getGroupAggregation()instanceof Array){m=this._parseAndSortShape(s[i].getGroupAggregation(),d);for(var k=0;k<m.length;k++){o.addShape(m[k]);}}else if(s[i].getClippathAggregation()&&s[i].getClippathAggregation()instanceof Array){p=this._parseAndSortShape(s[i].getClippathAggregation(),d);for(var j=0;j<p.length;j++){o.addPath(p[j]);}}}r.push(o);}if(t){return r;}else{r.sort(function(x,y){var z=q.isNumeric(x.mShapeConfig.getLevel())?x.mShapeConfig.getLevel():99;var B=q.isNumeric(y.mShapeConfig.getLevel())?y.mShapeConfig.getLevel():99;return B-z;});this._aShapeInstance=r;var w={};q.each(this._aShapeInstance,function(K,x){w[x.mShapeConfig.getKey()]=x;});this._oShapeInstance=w;}};n.prototype._instantiateCustomerClass=function(s,d,o,t){var g=q.sap.getObject(s);if(!g){q.sap.require(s);g=q.sap.getObject(s);}var i=new g();var j=t;if(j===undefined){j=d;}this._storeCustomerClassId(d,i.getId(),t);i.mLocaleConfig=this.getLocale();i.mShapeConfig=o;i.mChartInstance=this;return i;};n.prototype._storeCustomerClassId=function(s,i,t){if(!this._customerClassIds){this._customerClassIds={};}if(this._oShapesConfigMap[s]){this._customerClassIds[s]={"classId":i,"topShapeId":t};}else{var d=t+"_"+s;this._customerClassIds[d]={"classId":i,"topShapeId":t};}};n.prototype._getIdByShapeId=function(s){if(this._customerClassIds&&this._customerClassIds[s]){return this._customerClassIds[s].classId;}return null;};n.prototype._getShapeIdById=function(s){if(this._customerClassIds){for(var d in this._customerClassIds){var o=this._customerClassIds[d];if(o.classId===s){return{"shapeId":d,"topShapeId":o.topShapeId};}}}return null;};n.prototype._genShapeConfig=function(s,p){var o={},d;if(s!==null&&s!==undefined){o.shapeId=s;}if(p.data){o.data=p.data;}if(p.level){o.level=p.level;}if(p.draw){d=p.draw;}else{d=p;}for(var i in d){if(i!=="class"){o[i]=d[i];}}return o;};n.prototype.calculateZoomInfoFromChartWidth=function(i){var t=this.getTimeAxis();var p=t.getPlanHorizon();var I=t.getInitHorizon();this._oZoom.determinedByChartWidth={};if(p){var m=this._calZoomScale(F.abapTimestampToDate(p.getStartTime()),F.abapTimestampToDate(p.getEndTime()),i);this._oZoom.determinedByChartWidth.fMinRate=this._oZoom.base.fScale/m;}if(I&&I.getStartTime()&&I.getEndTime()){var s=this._calZoomScale(F.abapTimestampToDate(I.getStartTime()),F.abapTimestampToDate(I.getEndTime()),i);this._oZoom.determinedByChartWidth.fSuitableRate=this._oZoom.base.fScale/s;}this._oZoom.iChartWidth=i;return this._oZoom;};n.prototype.setTimeZoomRate=function(t){this.setProperty("timeZoomRate",t,true);this._oAxisTime.setZoomRate(t);this._oAxisTime.setViewOffset(0);this._oStatusSet=null;this._nLowerRange=this._oAxisTime.getViewRange()[0];this._nUpperRange=Math.ceil(this._oAxisTime.getViewRange()[1]);this._draw(true);return this;};n.prototype.getBaseRowHeight=function(){if(this._oTT.getRows()[0]&&this._oTT.getRows()[0].getDomRef()){return this._oTT.getRows()[0].getDomRef().scrollHeight;}};n.prototype.updateRelationships=function(r){var B=this.getBinding("relationships");if(B){var d=B.getContexts(0,0);if(d&&d.length>0){this._aRelationshipsContexts=d;}}};n.prototype.addRelationship=function(r){q.sap.log.error("The control manages the relationships aggregation. The method \"addRelationship\" cannot be used programmatically!");};n.prototype.insertRelationship=function(i,r){q.sap.log.error("The control manages the relationships aggregation. The method \"insertRelationship\" cannot be used programmatically!");};n.prototype.removeRelationship=function(r){q.sap.log.error("The control manages the relationships aggregation. The method \"removeRelationship\" cannot be used programmatically!");};n.prototype.getRelationships=function(){q.sap.log.error("The control manages the relationships aggregation. The method \"getRelationships\" cannot be used programmatically!");};n.prototype.destroyRelationships=function(){q.sap.log.error("The control manages the relationships aggregation. The method \"destroyRelationships\" cannot be used programmatically!");};n.prototype.indexOfRelationship=function(r){q.sap.log.error("The control manages the relationships aggregation. The method \"indexOfRelationship\" cannot be used programmatically!");};n.prototype.removeAllRelationships=function(){q.sap.log.error("The control manages the relationships aggregation. The method \"removeAllRelationships\" cannot be used programmatically!");};n.prototype._bindAggregation=function(s,B){if(s=="rows"&&B){var m=this.getModel(B.model);var o=this.getBindingContext(B.model);if(o&&m){B.path=m.resolve(B.path,o);}this._oTT.bindRows(B);}else{return sap.ui.core.Control.prototype._bindAggregation.apply(this,arguments);}};n.prototype.onBeforeRendering=function(){this._detachEvents();this._updateModelForMultiMainRow();};n.prototype._updateModelForMultiMainRow=function(){var B=this._oTT.getBinding("rows");if(!B||B.getLength()===0){return;}var r=B.getContexts(0,B.getLength());var o={},d=1,m,t=r[0].getProperty("type");if(t&&this._oObjectTypesConfigMap[t]){m=this._oObjectTypesConfigMap[t].getProperty("mainChartSchemeKey");if(m&&this._oChartSchemesConfigMap[m]){d=this._oChartSchemesConfigMap[m].getProperty("rowSpan");}}if(d==1||d==undefined){return;}for(var i=0;i<r.length;i++){var g=r[i].getProperty();if(l.isDummyRow(this._oTT,i)){continue;}if(i<r.length-1){if(l.isDummyRow(this._oTT,i+1)){continue;}}g.previousNodeNum=0;g.afterNodeNum=d-1;var D={"chartScheme":m,"mainRowId":g.id};var k=[];for(var j=1;j<d;j++){var p=q.extend(true,{},D);p.previousNodeNum=j;p.afterNodeNum=d-j-1;k.push(p);}o[i]=k;}if(!$.isEmptyObject(o)){l.addDummyData(this._oTT,o,false);}};n.prototype._detachEvents=function(){q("#"+this.getId()+"-svg-ctn").unbind("mousemove",this._onSvgCtnMouseMove);q("#"+this.getId()+"-svg-ctn").unbind("mouseleave",this._onSvgCtnMouseLeave);q("#"+this.getId()+"-svg-ctn").unbind("mousedown",this._onSvgCtnMouseDown);q("#"+this.getId()+"-svg-ctn").unbind("mouseenter",this._onSvgCtnMouseEnter);q("#"+this.getId()+"-svg-ctn").unbind("mouseup",this._onSvgCtnMouseUp);};n.prototype.onAfterRendering=function(){this._attachEvents();};n.prototype._attachEvents=function(){var d=q("#"+this.getId()+"-svg-ctn");d.bind("mousemove",this._onSvgCtnMouseMove.bind(this));d.bind("mouseleave",this._onSvgCtnMouseLeave.bind(this));d.bind("mousedown",this._onSvgCtnMouseDown.bind(this));d.bind("mouseenter",this._onSvgCtnMouseEnter.bind(this));d.bind("mouseup",this._onSvgCtnMouseUp.bind(this));};n.prototype.expandChartChange=function(d,E,g){if(E.length<0){return;}q.sap.measure.start("GanttChart expandChartChange","GanttPerf:GanttChart expandChartChange function");var s=(g&&g.length>0)?g:this._oTT.getSelectedIndices();var k;if(d){for(k=0;k<E.length;k++){var j=E[k];var m;if(this._oChartSchemesConfigMap[j]&&this._oChartSchemesConfigMap[j].getModeKey()){m=this._oChartSchemesConfigMap[j].getModeKey();}else{m=this.getMode();}var o={};for(var i=0;i<s.length;i++){if(l.isDummyRow(this._oTT,s[i])){continue;}var p=l.getContextObject(this._oTT,s[i]);var D={"__group":E[k],"parentData":p,"parentRefId":p.id};if(this._oObjectTypesConfigMap[p.type]&&this._oObjectTypesConfigMap[p.type].getExpandedChartSchemeKeys().length>0){var v=this._oObjectTypesConfigMap[p.type].getExpandedChartSchemeKeys();if($.inArray(j,v)>-1){var r,t=1;var u=this._collectDataNameForValidChartScheme(j,m);if(u){r=u.drawData;t=u.rowSpan;var w=this._insertExpandedRowsToTT(s[i],r,D,t);if(w&&w.length>0){o[s[i]]=w;}}}}}if(!$.isEmptyObject(o)){l.addDummyData(this._oTT,o,true);}}}else{for(k=0;k<E.length;k++){l.removeDummyDataFromSelectedIndices(this._oTT,s,E[k]);}}q.sap.measure.end("GanttChart expandChartChange");};n.prototype._collectDataNameForValidChartScheme=function(s,m){if(this._oChartSchemesConfigMap[s]){var d=[],r;var g=this._oChartSchemesConfigMap[s].getShapeKeys();r=this._oChartSchemesConfigMap[s].getRowSpan();var t=this;q.each(g,function(k,v){if(t._oShapesConfigMap[v]){var M=t._oShapesConfigMap[v].getModeKeys();if((M&&M.length>0&&$.inArray(m,M)>-1)||M.length==0||m==sap.gantt.config.DEFAULT_MODE_KEY){d.push(t._oShapesConfigMap[v].getShapeDataName());}}});if(d.length>0&&r>=1){return{"drawData":d,"rowSpan":r};}}};n.prototype._insertExpandedRowsToTT=function(s,d,D,r){var o=l.getContextObject(this._oTT,s);if(d&&d.length>0){var g=1,H=false;$.each(d,function(m,p){if(o[p]&&o[p].length>0){H=true;for(var i=0;i<o[p].length;i++){if(o[p][i].rowIndex!==undefined&&o[p][i].rowIndex>g){g=o[p][i].rowIndex;}}}});if(!H){return[];}var j=[],k,t;if(g>1&&r==1){for(k=0;k<g;k++){t=q.extend(true,{},D);t.index=k+1;j.push(t);}}else{D.index=1;for(k=0;k<r;k++){t=q.extend(true,{},D);j.push(t);}}return j;}return[];};n.prototype._composeParameterForClickPosition=function(d){var s=q("#"+this.getId()+"-svg");var o=this._getSvgCoodinateByDiv(s[0],d.pageX,d.pageY);var x=d.pageX-s.offset().left||d.offsetX;var y=d.pageY-s.offset().top||d.offsetY;if(!this._oAxisOrdinal){return;}var r,i=this._oAxisOrdinal.viewToRowIndex(y,this._oTT.getVisibleRowCount())+this._oTT.getFirstVisibleRow();var L,g=i;if(l.isMultipleSpanMainRow(this._oTT,i)){var m=l.getMultipleSpanMainRowGroupIndices(this._oTT,i);g=m[0];}if(g!==i){L=l.getContextObject(this._oTT,g);}var j=this._oAxisTime.viewToTime(x);r=l.getContextObject(this._oTT,i);var p={"startTime":j,"svgPoint":o,"leadingRowNum":g,"leadingRowInfo":L,"rowIndex":i,"rowInfo":r};return p;};n.prototype.getAllSelections=function(){var s=this.getSelectedRows();var d=this.getSelectedShapes();var g=this.getSelectedRelationships();var i={"rows":s,"shapes":d,"relationships":g};return i;};n.prototype.getSelectedRows=function(){var s=[];var d=this._oTT.getFirstVisibleRow();var g=this._oTT.getSelectedIndices();for(var i=0;i<g.length;i++){var r=g[i]-d;if(r>-1&&this._aShapeData[r]!==undefined){s.push(this._aShapeData[r]);}}return s;};n.prototype.getSelectedShapes=function(){var s=this._oSelectedShapes;return s;};n.prototype.getSelectedRelationships=function(){return this._aSelectedRelationships;};n.prototype.selectShapes=function(I,d){var i,j,s,o;var g=false;if(this._aSelectedShapeUids===undefined){this._aSelectedShapeUids=[];}if(I===undefined||I.length<1){if(d&&this._aSelectedShapeUids.length>0){this._oSelectedShapes={};this._aSelectedShapeUids=[];g=true;}}else if(d){this._oSelectedShapes={};this._aSelectedShapeUids=[];for(i=0;i<I.length;i++){s=this._getShapeDataById(I[i],false);for(j=0;j<s.length;j++){o=s[j];if(this._judgeEnableSelection(o)){var u=this._selectShape(o);if(u){g=true;}}}}}else{for(i=0;i<I.length;i++){s=this._getShapeDataById(I[i],false);for(j=0;j<s.length;j++){o=s[j];if(q.inArray(o.uid,this._aSelectedShapeUids)>-1){continue;}else if(this._judgeEnableSelection(o)&&this._selectShape(o)){g=true;}}}}if(g){this._drawSelectedShapes();}return g;};n.prototype.deselectShapes=function(I){var s=false;for(var i=0;i<I.length;i++){var d=this._getShapeDataById(I[i]);var u;for(var j=0;j<d.length;j++){u=this._deselectShape(d[j]);if(u){s=true;}}}if(s){this._drawSelectedShapes();}return s;};n.prototype.selectRowsAndShapes=function(I,d){var s=false;var r=this.selectRows(I,d);if(d){this._oSelectedShapes={};this._aSelectedShapeUids=[];}if(this._aSelectedShapeUids===undefined){this._aSelectedShapeUids=[];}for(var g in I){var j=I[g];var o=this._getRowById(j);if(o!==undefined){for(var k in o.data){if(o.data[k]instanceof Array){for(var i=0;i<o.data[k].length;i++){var m=o.data[k][i];if(q.inArray(m.uid,this._aSelectedShapeUids)<0){this._selectShape(m);s=true;}}}}}}if(s){this._drawSelectedShapes();}else if(r){s=true;}return s;};n.prototype.selectRelationships=function(I,d){var i,r;var s=false;if(this._aSelectedRelationships===undefined){this._aSelectedRelationships=[];}if(I===undefined||I.length<1){if(d&&this._aSelectedRelationships.length>0){this._aSelectedRelationships=[];s=true;}}else if(d){if(I.length==this._aSelectedRelationships.length){for(i=0;i<I.length;i++){r=this._getShapeDataById(I[i],true)[0];if(r!==undefined&&q.inArray(r,this._aSelectedRelationships)>=0){continue;}else{s=true;break;}}}this._aSelectedRelationships=[];for(i=0;i<I.length;i++){r=this._getShapeDataById(I[i],true)[0];if(r!==undefined&&r!==null&&this._judgeEnableSelection(r)){this._aSelectedRelationships.push(r);s=true;}}}else{for(i=0;i<I.length;i++){r=this._getShapeDataById(I[i],true)[0];if(r===undefined||q.inArray(r,this._aSelectedRelationships)>=0){continue;}else if(this._judgeEnableSelection(r)){this._aSelectedRelationships.push(r);s=true;}}}if(s){this._drawSelectedShapes();}return s;};n.prototype.deselectRelationships=function(I){var s=false;var u=[];if(I!==undefined){for(var i=0;i<I.length;i++){var d=this._getUidById(I[i],true)[0];if(d!==undefined){u.push(d);}}}for(var j in this._aSelectedRelationships){var o=this._aSelectedRelationships[j];if(q.inArray(o.uid,u)>-1){var g=this._aSelectedRelationships.indexOf(o);this._aSelectedRelationships.splice(g,1);s=true;}}if(s){this._drawSelectedShapes();}return s;};n.prototype.selectRows=function(I,d){var s=false;var v=this._oTT.getRows();var g=this._oTT.getSelectedIndices();if(d&&g.length>0){this._oTT.clearSelection();s=true;}for(var i in v){var r=d3.select("#"+v[i].getId());var j=parseInt(r.attr("data-sap-ui-rowindex"),10);var o=this._aShapeData[j];if(o!==undefined&&q.inArray(o.data.id,I)>-1){if(q.inArray(j,g)<0){var k=this._oTT.getSelectionMode();if(k===sap.ui.table.SelectionMode.Multi){this._oTT.addSelectionInterval(j,j);}else{this._oTT.setSelectedIndex(j);}s=true;}}}return s;};n.prototype.deselectRows=function(I){var s=false;var d=this._oTT.getSelectedIndices();var v=this._oTT.getRows();for(var i in d){var g=d[i];var r=d3.select("#"+v[g].getId());var j=parseInt(r.attr("data-sap-ui-rowindex"),10);var o=this._aShapeData[j];if(q.inArray(o.data.id,I)){d.splice(g,1);this._oTT.removeSelectionInterval(g,1);s=true;}}return s;};n.prototype._isRelationship=function(s){if(this._getShapeDataNameByUid(s)===sap.gantt.shape.ShapeCategory.Relationship){return true;}return false;};n.prototype._onRowSelectionChange=function(E){var d=E.getParameter("rowIndices"),g=this._oTT.getSelectedIndices(),s=[],D=[];for(var i=0;i<d.length;i++){if(g.indexOf(d[i])===-1){D.push(d[i]);}else{s.push(d[i]);}}var t=this._oTT;var u=function(r,k){for(var j=0;j<r.length;j++){if(l.isMultipleSpanMainRow(t,r[j],true)){var M=l.getMultipleSpanMainRowGroupIndices(t,r[j],true);var o=M[0],L=M[M.length-1];for(var m=0;m<M.length;m++){if(k&&g.indexOf(M[m])===-1){t.addSelectionInterval(o,L);}else if(!k&&g.indexOf(M[m])!==-1){t.removeSelectionInterval(o,L);}}}}};u(s,true);u(D,false);this.fireRowSelectionChange({originEvent:E});};n.prototype._selectionChange=function(s,d,g,o){if(this._aSelectedRelationships==undefined){this._aSelectedRelationships=[];}if(this._aSelectedShapeUids==undefined){this._aSelectedShapeUids=[];}var i=false;var r=false;var t=s.uid;var j=this._isRelationship(t);if((d&&this.getSelectionMode()===sap.gantt.SelectionMode.MultiWithKeyboard)||this.getSelectionMode()===sap.gantt.SelectionMode.Multiple){if(!j){if(this._aSelectedShapeUids!==undefined&&q.inArray(t,this._aSelectedShapeUids)>-1){if(!this._bDragging){i=this._deselectShape(s);}}else{i=this._selectShape(s);}}else{if(q.inArray(s,this._aSelectedRelationships)<0){this._aSelectedRelationships.push(s);}else{var k=this._aSelectedRelationships.indexOf(s);this._aSelectedRelationships.splice(k,1);}r=true;}}else if(!j){if((q.inArray(t,this._aSelectedShapeUids)<0||this._aSelectedShapeUids.length>1)&&!this._bDragging){this._oSelectedShapes={};this._aSelectedShapeUids=[];i=true;}if(q.inArray(t,this._aSelectedShapeUids)<0){var u=this._selectShape(s);if(!i&&u){i=true;}}if(this._aSelectedRelationships.length>0){this._aSelectedRelationships=[];r=true;}}else{if((q.inArray(s,this._aSelectedRelationships)<0)||this._aSelectedRelationships.length>1){this._aSelectedRelationships=[];this._aSelectedRelationships.push(s);r=true;}if(this._aSelectedShapeUids!==undefined&&this._aSelectedShapeUids.length>0){this._oSelectedShapes={};this._aSelectedShapeUids=[];i=true;}}if(i||r){this._drawSelectedShapes();}return{shapeSelectionChange:i,relationshipSelectionChange:r};};n.prototype._setSelectedStatusToData=function(){for(var r in this._aShapeData){var o=this._aShapeData[r];for(var s in o.data){var d=o.data[s];if(d instanceof Array){for(var I=0;I<d.length;I++){var g=d[I];if(q.inArray(g.uid,this._aSelectedShapeUids)>-1){g.selected=true;}else{g.selected=false;}}}}}for(var i in this._aRelationships){this._aRelationships[i].selected=false;if(this._aSelectedRelationships!==undefined&&this._aSelectedRelationships.length>0){for(var j in this._aSelectedRelationships){if(this._aRelationships[i].uid===this._aSelectedRelationships[j].uid){this._aRelationships[i].selected=true;}}}}};n.prototype._setSelectedStatusFromData=function(s){this._oSelectedShapes={};this._aSelectedShapeUids=[];for(var r in this._aShapeData){var o=this._aShapeData[r];for(var d in o.data){var g=o.data[d];if(g instanceof Array&&q.inArray(d,s)>-1){for(var i=0;i<g.length;i++){var k=g[i];if(k.selected){if(this._oSelectedShapes[d]===undefined){this._oSelectedShapes[d]=[];}this._oSelectedShapes[d].push({"shapeUid":k.uid,"shapeData":k,"objectInfoRef":o});this._aSelectedShapeUids.push(k.uid);}}}}}this._aSelectedRelationships=[];for(var j in this._aRelationships){if(this._aRelationships[j].selected){this._aSelectedRelationships.push(this._aRelationships[j]);}}};n.prototype._syncTTSelection=function(d){q.sap.measure.start("GanttChart syncTTSelection","GanttPerf:GanttChart syncTTSelection function");var x=d.clientX;var y=d.clientY;var s=d.shiftKey;var g=d.ctrlKey;var i=q("#"+this.getId()+"-svg")[0];var o=this._getSvgCoodinateByDiv(i,x,y);var r=parseInt(this._oAxisOrdinal.viewToBandIndex(o.y),10);if(r<0){return false;}var v=this._oTT.getRows();var I,j=d3.select("#"+v[r].getId());if(r<v.length&&j&&j.attr("data-sap-ui-rowindex")){I=this._oTT.getFirstVisibleRow()+parseInt(j.attr("data-sap-ui-rowindex"),10);}if(l.isDummyRow(this._oTT,I)&&l.getContextObject(this._oTT,I).__group!==undefined){return false;}var k=this._oTT.getSelectionMode();if(I>=0&&k!==sap.ui.table.SelectionMode.None){if(k===sap.ui.table.SelectionMode.Single){if(!this._oTT.isIndexSelected(I)){this._oTT.setSelectedIndex(I);}else{this._oTT.clearSelection();}}else{if(k===sap.ui.table.SelectionMode.Multi&&this.getSelectionMode===sap.gantt.SelectionMode.Multiple){g=true;}if(s){var m=this._oTT.getSelectedIndex();if(m>=0){if(m<I){this._oTT.addSelectionInterval(m,I);}else{this._oTT.addSelectionInterval(I,m);}}else{this._oTT.setSelectedIndex(I);}}else if(!this._oTT.isIndexSelected(I)){if(g){this._oTT.addSelectionInterval(I,I);}else{this._oTT.clearSelection();this._oTT.setSelectedIndex(I);}}else if(g){this._oTT.removeSelectionInterval(I,I);}else if(this._oTT.getSelectedIndices().length>1){this._oTT.clearSelection();this._oTT.setSelectedIndex(I);}}}q.sap.measure.end("GanttChart syncTTSelection");};n.prototype._setEventStatus=function(E){switch(E){case"dragEnter":this._bDragging=true;break;case"mouseDown":this._bMouseDown=true;this._bDragging=false;break;case"shapeDragging":this._bDragging=true;break;case"mouseUp":this._bMouseDown=false;break;case"shapeDragEnd":this._bDragging=false;this._oDraggingData=undefined;break;case"dragLeave":this._iMouseDown=0;this._bMouseDown=false;this._bDragging=false;break;default:break;}};n.prototype._onShapeDragStart=function(E){var s=q("#"+this.getId()+"-svg");var o=d3.select(E.target).data()[0];var d=E.target.getAttribute("class").split(" ")[0];if(o!==undefined&&q.inArray(o.uid,this._aSelectedShapeUids)>-1&&this._judgeEnableDnD(o,d)){var r=this._getRowByShapeUid(o.uid);var x=E.pageX-s.offset().left||E.offsetX;var y=E.pageY-s.offset().top||E.offsetY;var g,j;if(E.target.getAttribute("x")&&E.target.getAttribute("width")){g=parseInt(E.target.getAttribute("x"),10);j=parseInt(E.target.getAttribute("width"),10);}else if(o.startTime){var k=this._oAxisTime.timeToView(F.abapTimestampToDate(o.startTime));var m=this._oAxisTime.timeToView(F.abapTimestampToDate(o.endTime));if(C.getConfiguration().getRTL()){g=m;j=(k-m)>0?(k-m):1;}else{g=k;j=(m-k)>0?(m-k):1;}}else{g=x;j=1;}var D={"x":x,"y":y,"shapeX":g,"shapeWidth":j};var p=[];p.push({"shapeData":o,"objectInfo":r});for(var t in this._oSelectedShapes){var u=this._oSelectedShapes[t];if(u!==undefined){for(var i in u){if(u[i].shapeUid!==o.uid&&this._judgeEnableDnD(u[i].shapeData)){p.push({"shapeData":u[i].shapeData,"objectInfo":u[i].objectInfoRef});}}}}this._oDraggingData={"sourceShapeData":p,"dragStartPoint":D,"sourceSvgId":this.getId(),"targetSvgId":this.getId(),"domObject":d3.select(E.target)[0][0]};this._oDraggingData.fDragHandler=this._onShapeDrag.bind(this);q(document.body).bind("mousemove",this._oDraggingData.fDragHandler);this._oDraggingData.fDragEndHandler=this._onShapeDragEnd.bind(this);q(document.body).bind("mouseup",this._oDraggingData.fDragEndHandler);}};n.prototype._onShapeDrag=function(E){if(E.button!==0||E.buttons===0||E.ctrlKey){return false;}var d=d3.select("#activtityDragDrop");var i=d[0];if(this._oDraggingData===undefined){if(!d.empty()){d.remove();}}else{var j=this._oDraggingData.sourceShapeData.length;var s=this._oDraggingData.dragStartPoint.shapeX;var k=this._oDraggingData.dragStartPoint.x;if(d.empty()||i===null){i=d3.select("body").append("div").attr("id","activtityDragDrop").style("position","absolute").style("z-index","999");var m=this._oDraggingData.domObject.cloneNode();var w=d3.select(m).attr("width");var o=d3.select(m).attr("height");var p=12;var g=i.append("svg").attr("id","activtityDragDropSvg").attr("width",w).attr("height",o).append("g").attr("id","activtityDragDropSvgGroup");var r=d3.select(this._oDraggingData.domObject.cloneNode()).classed("shadow",true).attr("fill-opacity","0.5").attr("x",0).attr("y",0);g.node().appendChild(r.node());g.append("text").attr("x",w/2-p/2).attr("y",o-p/2+4).attr("fill","blue").attr("font-size",12).text(function(){return j;});}var t=s+(E.pageX-k);var u=E.pageY;d3.select("#activtityDragDrop").style("left",t+4+"px");d3.select("#activtityDragDrop").style("top",u+4+"px");q(document.body).addClass("sapGanttDraggingCursor");this._setEventStatus("shapeDragging");this._iMouseDown=0;}};n.prototype._onShapeDragEnd=function(E){var d=d3.select("#activtityDragDrop");if(!d.empty()){d.remove();}if(this._bDragging&&this._oDraggingData!==undefined){var t=this.getId()+"-svg";this._collectDraggingShapeData(this._oDraggingData,E);this.fireShapeDragEnd({originEvent:E,sourceSvgId:this._oDraggingData.sourceSvgId,targetSvgId:t,sourceShapeData:this._oDraggingData.sourceShapeData,targetData:this._oDraggingData.targetData});}if(this._oDraggingData!==undefined){q(document.body).unbind("mousemove",this._oDraggingData.fDragHandler);q(document.body).unbind("mouseup",this._oDraggingData.fDragEndHandler);}q(document.body).removeClass("sapGanttDraggingCursor");this._setEventStatus("shapeDragEnd");};n.prototype._collectDraggingShapeData=function(d,E){var s=q("#"+this.getId()+"-svg");var x=E.pageX-s.offset().left||E.offsetX;var g=d.dragStartPoint.x;var D=parseInt(x,10)-parseInt(g,10);var i=parseInt(d.dragStartPoint.shapeX,10)+D;var j=i+parseInt(d.dragStartPoint.shapeWidth,10);var k,m;if(C.getConfiguration().getRTL()===true){k=F.dateToAbapTimestamp(this._oAxisTime.viewToTime(j));m=F.dateToAbapTimestamp(this._oAxisTime.viewToTime(i));}else{k=F.dateToAbapTimestamp(this._oAxisTime.viewToTime(i));m=F.dateToAbapTimestamp(this._oAxisTime.viewToTime(j));}var p=this._composeParameterForClickPosition(E);var r=p.rowInfo;d.targetData={"mouseTimestamp":{startTime:k,endTime:m},"mode":this.getMode(),"objectInfo":r};};n.prototype.setDraggingData=function(d){this._oDraggingData=d;if(this._oDraggingData!==undefined){this._oDraggingData.targetSvgId=this.getId();q(document.body).unbind("mousemove",this._oDraggingData.fDragHandler);q(document.body).unbind("mouseup",this._oDraggingData.fDragEndHandler);this._oDraggingData.fDragHandler=this._onShapeDrag.bind(this);this._oDraggingData.fDragEndHandler=this._onShapeDragEnd.bind(this);q(document.body).bind("mousemove",this._oDraggingData.fDragHandler);q(document.body).bind("mouseup",this._oDraggingData.fDragEndHandler);this._setEventStatus("dragEnter");}};n.prototype._onSvgCtnMouseEnter=function(E){if(E.currentTarget.id===(this.getId()+'-svg-ctn')&&E.button===0&&E.buttons!==0){this.fireChartDragEnter({originEvent:E});}};n.prototype._onSvgCtnMouseMove=function(E){var s=q("#"+this.getId()+"-svg");var o=this._getSvgCoodinateByDiv(s[0],E.pageX,E.pageY);if(this.getEnableCursorLine()){this._oCursorLineDrawer.drawSvg(d3.selectAll(".sapGanttChartSvg"),d3.selectAll(".sapGanttChartHeaderSvg"),this.getLocale(),o);}var p=this._composeParameterForClickPosition(E);var r=p?p.rowIndex:-1;var d=d3.select(E.target).data()[0];if(r>-1&&((d!==undefined&&d.uid!==this._lastHoverShapeUid)||(d===undefined&&this._lastHoverShapeUid!==undefined)||r!==this._lastHoverRowIndex)){this.fireChartMouseOver({objectInfo:p.rowInfo,leadingRowInfo:p.leadingRowInfo,timestamp:p.startTime.getTime(),svgId:this.getId()+"-svg",svgCoordinate:p.svgPoint,effectingMode:this.getMode(),originEvent:E});if(d!==undefined){this._lastHoverShapeUid=d.uid;}else{this._lastHoverShapeUid=undefined;}}if(r>-1&&r!==this._lastHoverRowIndex){var t=this._oTT;var g=q(t.getDomRef());var H=g.find(".sapUiTableRowHvr");var j=g.find(".sapUiTableTr")[r];if(this._oTT.getRows()[r]){var k=this._oTT.getRows()[r].getIndex();var m=l.getContextObject(this._oTT,k);if(H.length>0){for(var i=0;i<H.length;i++){if(q.inArray("sapUiTableTr",H[i].classList)>-1){q(H[i]).mouseleave();}}}if(!l.isDummyRow(this._oTT,k)||m.__group===undefined||m.__group===null){q(j).mouseenter();this._lastHoverRowIndex=r;}}}};n.prototype._onSvgCtnMouseLeave=function(E){if(E.currentTarget.id===(this.getId()+'-svg-ctn')&&this._bDragging&&this._oDraggingData!==undefined){this._oDraggingData.targetSvgId=undefined;this.fireChartDragLeave({originEvent:E,draggingSource:this._oDraggingData});this._setEventStatus("dragLeave");}if(this.getEnableCursorLine()){this._oCursorLineDrawer.destroySvg(d3.selectAll(".sapGanttChartSvg"),d3.selectAll(".sapGanttChartHeaderSvg"));}var t=this._oTT;var d=q(t.getDomRef());var H=d.find(".sapUiTableRowHvr");if(H.length>0){for(var i=0;i<H.length;i++){if(q.inArray("sapUiTableTr",H[i].classList)>-1){q(H[i]).mouseleave();}}}this._lastHoverShapeUid=undefined;this._lastHoverRowIndex=-1;};n.prototype._onSvgCtnMouseDown=function(E){if(E.button==0){var s=d3.select(E.target).data()[0];var d;if(E.target.getAttribute("class")){d=E.target.getAttribute("class").split(" ")[0];}if(d&&s&&this._judgeEnableSelection(s,d)){this._oLastSelectedShape=s;this._onShapeDragStart(E);E.preventDefault();}this._iMouseDown++;this._setEventStatus("mouseDown");}};n.prototype._onSvgCtnMouseUp=function(d){if(d.button==2){var p=this._composeParameterForClickPosition(d);this.fireChartRightClick({objectInfo:p.rowInfo,leadingRowInfo:p.leadingRowInfo,timestamp:p.startTime.getTime(),svgId:this.getId()+"-svg",svgCoordinate:p.svgPoint,effectingMode:this.getMode(),originEvent:d});}else if(d.button==0&&!this._bDragging&&this._bMouseDown){this._onSvgCtnClick(d);}};n.prototype._onSvgCtnClick=function(E){var s=d3.select(E.target).data()[0];var d;if(E.target.getAttribute("class")){d=E.target.getAttribute("class").split(" ")[0];}var g={};if(s!==undefined&&this._judgeEnableSelection(s,d)&&this._oLastSelectedShape!==undefined&&this._oLastSelectedShape.uid===s.uid){g=this._selectionChange(s,E.ctrlKey,E.shiftKey,E);}else if(this.getSelectionMode()===sap.gantt.SelectionMode.MultiWithKeyboard){this._syncTTSelection(E);this._oLastSelectedShape=undefined;}else{if(this._aSelectedShapeUids!==undefined&&this._aSelectedShapeUids.length>0){this._oSelectedShapes={};this._aSelectedShapeUids=[];g.shapeSelectionChange=true;}if(this._aSelectedRelationships.length>0){this._aSelectedRelationships=[];g.relationshipSelectionChange=true;}if(g.shapeSelectionChange||g.relationshipSelectionChange){this._drawSelectedShapes();}}if(!E.ctrlKey&&!E.shiftKey){var t=this;setTimeout(function(){if(t._iMouseDown>1){var p=t._composeParameterForClickPosition(E);t.fireChartDoubleClick({objectInfo:p.rowInfo,leadingRowInfo:p.leadingRowInfo,timestamp:p.startTime.getTime(),svgId:t.getId()+"-svg",svgCoordinate:p.svgPoint,effectingMode:t.getMode(),originEvent:E});}t._iMouseDown=0;t._setEventStatus("mouseUp");this._oLastSelectedShape=undefined;},300);}else{this._iMouseDown=0;this._setEventStatus("mouseUp");this._oLastSelectedShape=undefined;}if(g.shapeSelectionChange){this.fireShapeSelectionChange({originEvent:E});}if(g.relationshipSelectionChange){this.fireRelationshipSelectionChange({originEvent:E});}};n.prototype._onHSbScroll=function(E){var d=this._oTT._oHSb.getScrollPosition();this.updateLeftOffsetRate(d);this._draw(false);this.fireHorizontalScroll({scrollSteps:d,leftOffsetRate:this._fLeftOffsetRate});};n.prototype._onVSbScroll=function(E){this.fireVerticalScroll({scrollSteps:this._oTT._oVSb.getScrollPosition()});this._oTT.setFirstVisibleRow(this._oTT._oVSb.getScrollPosition()||0,true);};n.prototype._hSbScrollLeft=function(d){var g=q("#"+this.getId()+"-svg-ctn");var i=q("#"+this.getId()+"-header");var j;if(C.getConfiguration().getRTL()===true){j=this._oStatusSet.aViewBoundary[1]-i.width()-d;if(j<0){j=0;}}else{j=d;}if(C.getConfiguration().getRTL()===true&&sap.ui.Device.browser.name==="ff"){g.scrollLeftRTL(j);i.scrollLeftRTL(j);}else{g.scrollLeft(j);i.scrollLeft(j);}};n.prototype.updateLeftOffsetRate=function(d,g){var i=g?g:parseInt(this._oTT._oHSb.getContentSize(),0);var j=q("#"+this.getId()+"-svg-ctn").width();if(i-j!==0){if(C.getConfiguration().getRTL()===true){this._fLeftOffsetRate=(i-d-j)/(i-j);}else{this._fLeftOffsetRate=d/(i-j);}this._fLeftOffsetRate=this._fLeftOffsetRate<0?0:this._fLeftOffsetRate;this._fLeftOffsetRate=this._fLeftOffsetRate>1?1:this._fLeftOffsetRate;}return this._fLeftOffsetRate;};n.prototype.jumpToPosition=function(v){if(!isNaN(v)&&!(v instanceof Date)){this._fLeftOffsetRate=v;this._draw(false);return;}var d,g;var i=q("#"+this.getId()+"-svg-ctn").width();if(!i||i<=0){return;}if(v instanceof Date){d=v;}else{var t=this.getTimeAxis();var I=t.getInitHorizon();if(!I||!I.getStartTime()||!I.getEndTime()){return;}d=F.abapTimestampToDate(I.getStartTime());var s=this._calZoomScale(F.abapTimestampToDate(I.getStartTime()),F.abapTimestampToDate(I.getEndTime()),i);var j=this._oZoom.base.fScale/s;this.setTimeZoomRate(j);}var k=this._nUpperRange-this._nLowerRange;if(!k||k<=0){return;}if(C.getConfiguration().getRTL()===true){g=k-this._oAxisTime.timeToView(d)-this._oAxisTime.getViewOffset();g=g<0?0:g;}else{g=this._oAxisTime.timeToView(d)+this._oAxisTime.getViewOffset();}this.updateLeftOffsetRate(g,k);this._draw(false);};n.prototype._onTTRowUpdate=function(){this._syncSvgHeightWithTT();this._syncSvgDataWithTT();this._prepareRelationshipDataFromModel();this._draw(true);};n.prototype._updateDataString=function(){var s=JSON.stringify(this._aShapeData,function(k,v){if(k==="bindingObj"||k==="contextObj"){return undefined;}return v;});if(this._sShapeData&&s===this._sShapeData){this._sShapeData=s;return false;}else{this._sShapeData=s;return true;}};n.prototype._syncSvgHeightWithTT=function(){var d=this.$().find(".sapGanttChartSvgCtn");d.height(this.$().find(".sapUiTableCCnt").height());};n.prototype._syncSvgDataWithTT=function(){var B=this._oTT.getBinding("rows");var j=B.getMetadata().getName()==="sap.ui.model.json.JSONTreeBinding";var i=this._oTT.getFirstVisibleRow();var v=this._oTT.getVisibleRowCount();this._aShapeData=[];this._aNonVisibleShapeData=[];var _=[];var d=[];var g=[i,i+v-1];if(j){g=this._prepareVerticalDrawingRange();B.getContexts(0,0);if(i>0){_=this._getDrawingData([0,i-1]);}d=this._getDrawingData([i+v,B.getLength()-1]);B.getContexts(g[0],g[1]);this._aShapeData=this._getDrawingData(g);}else{if(this._aRelationshipsContexts&&this._aRelationshipsContexts.length>0){if(i>0){_=this._createShapeDataFromRowContexts(B.getContexts(0,i));}d=this._createShapeDataFromRowContexts(B.getContexts(i+v,B.getLength()));}var r=B.getContexts(i,v);this._aShapeData=this._createShapeDataFromRowContexts(r);}this._aNonVisibleShapeData=_.concat(d);var s=this.getShapeDataNames();if(s&&s.length>0){U.generateRowUid(this._aShapeData,this._oObjectTypesConfigMap,s);U.generateRowUid(this._aNonVisibleShapeData,this._oObjectTypesConfigMap,s);this._setSelectedStatusFromData(s);}else{q.sap.log.error("Missing configuration for shapeDataNames.");}var k=this.getBaseRowHeight();this._oAxisOrdinal=this._createAxisOrdinal(this._aShapeData,k,(g[0]-i)*k);this._cacheObjectPosition(this._aShapeData,this._oAxisOrdinal);this._cacheObjectPosition(_,this._oAxisOrdinal,true);this._cacheObjectPosition(d,this._oAxisOrdinal,false);if(!this._aVisibleRange||this._aVisibleRange[0]!==g[0]||this._aVisibleRange[1]!==g[1]){this._aVisibleRange=g;return true;}return false;};n.prototype._createShapeDataFromRowContexts=function(r){var s=this.getShapeDataNames();var B=this._oTT.getBinding("rows");var m=B.getModel();var d=[];for(var i=0;i<r.length;i++){if(r[i]!=undefined){for(var j=0;j<s.length;j++){var g=s[j];var o=r[i].getProperty(g);var p;if(o){for(var k=0;k<o.length;k++){var t=o[k];p=m.getData("/"+t);d.push({"bindingObj":B,"contextObj":r[i],"data":r[i].getObject(),"shapeData":[p],"id":p.id,"shapeName":g,"rowIndex":i});}}}}}return d;};n.prototype._cacheObjectPosition=function(o,d,g){if(o&&o.length>0){if(g===true){for(var i=0;i<o.length;i++){o[i].y=-100;o[i].rowHeight=d.getViewBandWidth();}}else if(g===false){for(var j=0;j<o.length;j++){o[j].y=d.getViewRange()[1]+100;o[j].rowHeight=d.getViewBandWidth();}}else{for(var k=0;k<o.length;k++){o[k].y=d.elementToView(o[k].uid);if(k>0){o[k-1].rowHeight=o[k].y-o[k-1].y;}}o[o.length-1].rowHeight=d.getViewRange()[1]-o[o.length-1].y;}}};n.prototype._prepareRelationshipDataFromModel=function(){this._aRelationships=[];if(this._aRelationshipsContexts){for(var i=0;i<this._aRelationshipsContexts.length;i++){var r=this._aRelationshipsContexts[i].getObject();if(r!==undefined){this._aRelationships.push(r);}}}U.generateUidByShapeDataName(this._aRelationships,"relationship");};n.prototype._createAxisOrdinal=function(s,B,d){var r=s.map(function(o){return o.uid;});var g=s.map(function(o){if(o.rowSpan){return o.rowSpan;}else{return 1;}});return new h(r,g,B,d);};n.prototype.getShapeData=function(r){return this._aShapeData;};n.prototype._getDrawingData=function(r){var i,j,k,o;var B=this._oTT.getBinding("rows");var d=[];for(i=r[0];i<=r[1];i++){o=l.getContextObject(this._oTT,i);if(!o){continue;}if(l.isDummyRow(this._oTT,i)&&((d.length>0&&d[d.length-1].chartScheme&&d[d.length-1].chartScheme===o.__group&&d[d.length-1].index===o.index)||o.chartScheme)){continue;}if(o.__group){var m;if(this._oChartSchemesConfigMap[o.__group]&&this._oChartSchemesConfigMap[o.__group].getModeKey()&&this._oChartSchemesConfigMap[o.__group].getModeKey()!==sap.gantt.config.DEFAULT_MODE_KEY){m=this._oChartSchemesConfigMap[o.__group].getModeKey();}else{m=this.getMode();}var s=this._collectDataNameForValidChartScheme(o.__group,m);var p=o.parentData?o.parentData:null;if(o.index&&p&&s&&s.drawData){for(j=0;j<s.drawData.length;j++){if(!p[s.drawData[j]]){continue;}o[s.drawData[j]]=[];for(k=0;k<p[s.drawData[j]].length;k++){if(!p[s.drawData[j]][k].rowIndex||o.index===p[s.drawData[j]][k].rowIndex){o[s.drawData[j]].push(p[s.drawData[j]][k]);}}}}d.push({"bindingObj":B,"data":o,"id":p.id,"rowSpan":s.rowSpan,"chartScheme":o.__group,"rowIndex":i,"index":o.index,"icon":this._oChartSchemesConfigMap[o.__group].getIcon(),"closeIcon":"./image/closeChart.png","name":this._oChartSchemesConfigMap[o.__group].getName()});}else{var g=1;var t=this._oObjectTypesConfigMap[o.type]?this._oObjectTypesConfigMap[o.type].getMainChartSchemeKey():sap.gantt.config.DEFAULT_CHART_SCHEME_KEY;if(o.type){var u=this._oChartSchemesConfigMap[t];if(u){g=u.getRowSpan();}}d.push({"bindingObj":B,"contextObj":this._oTT.getContextByIndex(i),"data":o,"id":o.id,"rowSpan":g,"chartScheme":t,"rowIndex":i,"index":0});}}return d;};n.prototype._prepareVerticalDrawingRange=function(){var d=this._oTT.getBinding("rows").getLength()-1;if(d<0){return[0,-1];}var g=this._oTT.getFirstVisibleRow();var j=g+this._oTT.getVisibleRowCount()-1;var k=g;var m=j<d?j:d;var i,o,p,r;for(i=g;i>=0;i--){if(!l.isDummyRow(this._oTT,i)){break;}r=l.getContextObject(this._oTT,i);if(r&&r.previousNodeNum){k=i-r.previousNodeNum;continue;}if(!r||!r.index||r.index<0){break;}if(!p){o=r.__group;p=r.index;}else if(o===r.__group&&p===r.index){k=i;}else{break;}}p=undefined;for(i=j;i<=d;i++){r=l.getContextObject(this._oTT,i);if(r&&r.afterNodeNum){m=i+r.afterNodeNum;continue;}if(!l.isDummyRow(this._oTT,i)){break;}if(!r||!r.index||r.index<0){break;}if(!p){o=r.__group;p=r.index;}else if(o===r.__group&&p===r.index){m=i;}else{break;}}return[k,m];};n.prototype._prepareHorizontalDrawingRange=function(){var d=this._nUpperRange-this._nLowerRange;var g=q("#"+this.getId()+"-svg-ctn").width();if(!this._oStatusSet){this._updateScrollWidth();}var i=Math.ceil((this._fLeftOffsetRate?this._fLeftOffsetRate:0)*(d-g));if(this._oStatusSet){if((g>=d||(this._oStatusSet.aViewBoundary[0]<=i-this._oStatusSet.nOffset&&this._oStatusSet.aViewBoundary[1]>=i+g-this._oStatusSet.nOffset))){if(!this._mTimeouts._drawSvg){this._scrollSvg();}return false;}}var j=g*(1+this._fExtendFactor*2);var k=i-g*this._fExtendFactor;if(k<this._nLowerRange){j+=k;k=0;}if(k+j>this._nUpperRange){j=this._nUpperRange-k;}this._oAxisTime.setViewOffset(k);this._oStatusSet={nWidth:j,nOffset:k,nScrollLeft:i,aViewBoundary:[0,j],aTimeBoundary:[this._oAxisTime.viewToTime(0),this._oAxisTime.viewToTime(j)],bRTL:C.getConfiguration().getRTL()};return true;};n.prototype._draw=function(d){if(!this._prepareHorizontalDrawingRange()&&!d){return;}var t=this;this._mTimeouts._drawSvg=this._mTimeouts._drawSvg||window.setTimeout(function(){t._drawSvg();t._mDrawDelayMS=0;},this._mDrawDelayMS);};n.prototype._updateScrollWidth=function(){var d=100000;var g=this._nUpperRange-this._nLowerRange;var i=g>d?d:g;if(i+"px"!==this._oTT._oHSb.getContentSize()){this._oTT._oHSb.setContentSize(i+"px").bind(this._oTT.getDomRef());}};n.prototype._updateScrollLeft=function(){var d=parseInt(this._oTT._oHSb.getContentSize(),0);var g=q("#"+this.getId()+"-svg-ctn").width();var i=Math.ceil((this._fLeftOffsetRate?this._fLeftOffsetRate:0)*(d-g));if(C.getConfiguration().getRTL()===true){i=d-i-g;}if(Math.abs(this._oTT._oHSb.getScrollPosition()-i)>1){this._oTT._oHSb.setScrollPosition(i);}};n.prototype._scrollSvg=function(){var d=q("#"+this.getId()+"-svg");var g=q("#"+this.getId()+"-header-svg");if(this._oStatusSet.nWidth!==d.width()){d.width(this._oStatusSet.nWidth);}if(this._oStatusSet.nWidth!==g.width()){g.width(this._oStatusSet.nWidth);}var i=this._nUpperRange-this._nLowerRange;var j=q("#"+this.getId()+"-svg-ctn").width();var k=Math.ceil((this._fLeftOffsetRate?this._fLeftOffsetRate:0)*(i-j));this._hSbScrollLeft(k-this._oStatusSet.nOffset);};n.prototype._drawSvg=function(){q.sap.measure.start("GanttChart _drawSvg","GanttPerf:GanttChart _drawSvg function");this._updateScrollLeft();this._scrollSvg();this._sUiSizeMode=U.findSapUiSizeClass(this);this._drawCalendarPattern();this._drawHeader();this._drawNowLine();this._drawVerticalLine();this._drawShapes();this._drawSelectedShapes();this.fireEvent("_shapesUpdated",{aSvg:q("#"+this.getId()+"-svg")});this._updateCSSForDummyRow();delete this._mTimeouts._drawSvg;q.sap.measure.end("GanttChart _drawSvg");};n.prototype._drawHeader=function(){var g=q(this.getDomRef()).find(".sapGanttChartHeader");var j=g.height();var H=d3.select(q(this.getDomRef()).find(".sapGanttChartHeaderSvg").get(0));H.attr("height",j);var k=j/5*2;var m=j/5*4;var o=j/5*4;var L=this.getAxisTime().getTickTimeIntervalLabel(this.getAxisTime().getCurrentTickTimeIntervalKey(),null,[0,this._oStatusSet.nWidth]);H.selectAll("g").remove();var p=H.append("g");p.selectAll("label0").data(L[0]).enter().append("text").classed("sapGanttTimeHeaderSvgText0",true).text(function(d){return d.label;}).attr("x",function(d){return d.value;}).attr("y",function(d){return k;});p.selectAll("label1").data(L[1]).enter().append("text").classed("sapGanttTimeHeaderSvgText1",true).text(function(d){return d.label;}).attr("x",function(d){return d.value+(C.getConfiguration().getRTL()?-5:5);}).attr("y",function(d){return o;});var s="";for(var i=0;i<L[1].length;i++){var r=L[1][i];if(r){s+=" M"+" "+(r.value-1/2)+" "+m+" L"+" "+(r.value-1/2)+" "+j;}}p.append("path").classed("sapGanttTimeHeaderSvgPath",true).attr("d",s);};n.prototype._drawCalendarPattern=function(){var g=d3.select("#"+this.getId()+"-svg");this._oCalendarPatternDrawer.drawSvg(g,this.getId(),this.getCalendarDef(),this._oStatusSet,this.getBaseRowHeight());};n.prototype._drawNowLine=function(){this._oNowlineDrawer=new N(this._oAxisTime);var g=d3.select("#"+this.getId()+"-header-svg"),d=d3.select("#"+this.getId()+"-svg");if(this.getEnableNowLine()){this._oNowlineDrawer.drawSvg(d,g);}else{this._oNowlineDrawer.destroySvg(d,g);}};n.prototype._drawVerticalLine=function(){this._oVerticalLineDrawer=new V(this.getAxisTime());var g=d3.select("#"+this.getId()+"-svg");if(this.getEnableVerticalLine()){this._oVerticalLineDrawer.drawSvg(g);}else{this._oVerticalLineDrawer.destroySvg(g);}};n.prototype._drawShapes=function(){var s=d3.select("#"+this.getId()+"-svg");if(!this._oTT||!this._oTT.getRows()||this._oTT.getRows().length<=0){return;}if(this._aShapeData&&this._aShapeInstance&&this._aShapeInstance.length>0){this._collectDataPerShapeId();var r=[];for(var i=0;i<this._aShapeInstance.length;i++){switch(this._aShapeInstance[i].getCategory(null,this._oAxisTime,this._oAxisOrdinal)){case sap.gantt.shape.ShapeCategory.InRowShape:this._oShapeInRowDrawer.drawSvg(s,this._aShapeInstance[i],this._oAxisTime,this._oAxisOrdinal,this._oStatusSet);break;case sap.gantt.shape.ShapeCategory.Relationship:if(this._judgeDisplayableOfRLS(this._aShapeInstance[i])){r=this._oShapeCrossRowDrawer.generateRelationshipDataSet(s,this._oShapeInstance,this._aNonVisibleShapeData,this.getShapeDataNames(),this._aRelationships,this._oAxisTime,this._oAxisOrdinal);}this._aShapeInstance[i].dataSet=r;this._oShapeCrossRowDrawer.drawSvg(s,this._aShapeInstance[i],this._oAxisTime,this._oAxisOrdinal);break;default:break;}}}};n.prototype._drawSelectedShapes=function(){if(!this._oTT||!this._oTT.getRows()||this._oTT.getRows().length<=0){return;}var s=d3.select("#"+this.getId()+"-svg");this._setSelectedStatusToData();this._collectSelectedDataPerShapeId();for(var d in this._oShapeInstance){var o=this._oShapeInstance[d].getAggregation("selectedShape");var g=o.getCategory(null,this._oAxisTime,this._oAxisOrdinal);switch(g){case sap.gantt.shape.ShapeCategory.InRowShape:this._oShapeInRowDrawer.drawSvg(s,o,this._oAxisTime,this._oAxisrdinal,this._oStatusSet);break;case sap.gantt.shape.ShapeCategory.Relationship:var r=this._oShapeCrossRowDrawer.generateRelationshipDataSet(s,this._oShapeInstance,this._aNonVisibleShapeData,this.getShapeDataNames(),this._aSelectedRelationships,this._oAxisTime,this._oAxisOrdinal);o.dataSet=r;this._oShapeCrossRowDrawer.drawSvg(s,o,this._oAxisTime,this._oAxisOrdinal);break;default:break;}}};n.prototype._collectDataPerShapeId=function(){var j=(this._oTT.getBinding("rows").getMetadata().getName()==="sap.ui.model.json.JSONTreeBinding");var r,s;for(var d in this._oShapeInstance){var g=this._oShapeInstance[d].mShapeConfig.getShapeDataName();this._oShapeInstance[d].dataSet=[];for(var i=0;i<this._aShapeData.length;i++){r=this._aShapeData[i];if(r.isBlank){continue;}if(!g){this._oShapeInstance[d].dataSet.push({"objectInfoRef":r,"shapeData":r.data});continue;}if(!this._judgeDisplayableByShapeId(r,d)){continue;}if(j){s=r.data[g];}else if(g==r.shapeName){s=[r.data];}else{continue;}if(s){this._oShapeInstance[d].dataSet.push({"objectInfoRef":r,"shapeData":s});}}}};n.prototype._collectSelectedDataPerShapeId=function(){for(var s in this._oShapeInstance){var d=this._oShapeInstance[s].mShapeConfig.getShapeDataName();var o=this._oShapeInstance[s].getAggregation("selectedShape");var g=o.getCategory(null,this._oAxisTime,this._oAxisOrdinal);o.dataSet=[];if(g==sap.gantt.shape.ShapeCategory.Relationship){var k=[];for(var j in this._aSelectedRelationships){var r=this._aSelectedRelationships[j];if(this._getShapeDataById(r.id,true)!==undefined){k.push(r);}}o.dataSet.push({"shapeData":k});}else if(this._oSelectedShapes[d]!==undefined){for(var i in this._oSelectedShapes[d]){var m=this._oSelectedShapes[d][i];var p=this._getRowByShapeUid(m.shapeUid);if(p!==undefined&&p!==null&&this._judgeDisplayableByShapeId(p,s)){m.objectInfoRef=p;o.dataSet.push({"objectInfoRef":m.objectInfoRef,"shapeData":[m.shapeData]});}}}}};n.prototype._judgeDisplayableByShapeId=function(r,s){var d,o,g,m;if(r.data.__group){d=r.data.__group;}else{d=this._oObjectTypesConfigMap[r.data.type]?this._oObjectTypesConfigMap[r.data.type].getMainChartSchemeKey():sap.gantt.config.DEFAULT_CHART_SCHEME_KEY;}o=this._oChartSchemesConfigMap[d];if(o==undefined){return false;}g=o.getShapeKeys();m=o.getModeKey()!==sap.gantt.config.DEFAULT_MODE_KEY?o.getModeKey():this.getMode();if(d!==sap.gantt.config.DEFAULT_CHART_SCHEME_KEY&&g.indexOf(s)<0||m!==sap.gantt.config.DEFAULT_MODE_KEY&&this._oShapesConfigMap[s].getModeKeys()&&this._oShapesConfigMap[s].getModeKeys().length>0&&this._oShapesConfigMap[s].getModeKeys().indexOf(m)<0||!r.data){return false;}return true;};n.prototype._judgeDisplayableOfRLS=function(s){var d=this._oShapesConfigMap[s.mShapeConfig.getKey()]?this._oShapesConfigMap[s.mShapeConfig.getKey()].getModeKeys():[];if(q.inArray(this.getMode(),d)<0&&this.getMode()!==sap.gantt.config.DEFAULT_MODE_KEY){return false;}return true;};n.prototype._getShapeDataNameByUid=function(s){var d;if(s!==undefined){var g="|DATA:";if(s.split(g)[1]){d=s.split(g)[1].split("[")[0];}else{d=sap.gantt.shape.ShapeCategory.Relationship;}}return d;};n.prototype._getUidById=function(I,r){var u=[];if(r){for(var i in this._aRelationships){var o=this._aRelationships[i];if(o.id==I){u.push(o.uid);break;}}}else{q.each(this._aShapeData,function(k,v){var d=v;for(var s in d.data){if(d.data[s]instanceof Array){for(var i in d.data[s]){if(d.data[s][i].id==I){u.push(d.data[s][i].uid);}}}}});}return u;};n.prototype._getShapeDataByUid=function(u,r){if(r){for(var i in this._aRelationships){var o=this._aRelationships[i];if(o.uid===u){return o;}}}else{var d=this._getRowByShapeUid(u);var s=this._getShapeDataNameByUid(u);if(d!==undefined&&d.data[s]!==undefined){for(var j=0;j<d.data[s].length;j++){var g=d.data[s][j];if(g.uid==u){return g;}}}}return undefined;};n.prototype._getShapeDataById=function(I,r){var s=[];var u=this._getUidById(I,r);for(var i in u){var o=this._getShapeDataByUid(u[i],r);if(o!==undefined){s.push(o);}}return s;};n.prototype._getRowByShapeUid=function(s){var r;var d=this._getShapeDataNameByUid(s);var j=(this._oTT.getBinding("rows").getMetadata().getName()==="sap.ui.model.json.JSONTreeBinding");q.each(this._aShapeData,function(k,v){var g=v;if(j&&g.data[d]){for(var i=0;i<g.data[d].length;i++){if(g.data[d][i].uid==s){r=g;return false;}}}else if(g.data.uid===s){r=g;return false;}});return r;};n.prototype._getRowById=function(r){var d;q.each(this._aShapeData,function(k,v){var g=v;if(g.data.id==r){d=g;return false;}});return d;};n.prototype._getSvgCoodinateByDiv=function(o,x,y){var d=o.createSVGPoint();d.x=x;d.y=y;d=d.matrixTransform(o.getScreenCTM().inverse());d.svgHeight=o.height.baseVal.value;d.svgId=this.getId()+"-svg";return d;};n.prototype._getTopShapeInstance=function(s,d){if(d!==undefined){var o=this._getShapeIdById(d);if(o!==undefined&&o!==null){if(o.topShapeId!==undefined){return this._oShapeInstance[o.topShapeId];}else{return this._oShapeInstance[o.shapeId];}}}else{var g=this._getShapeDataNameByUid(s.uid);for(var i in this._oShapeInstance){var j=this._oShapeInstance[i].mShapeConfig.getShapeDataName();if(g===j){var t=this._customerClassIds[i].topShapeId;if(t!==undefined){return this._oShapeInstance[t];}else{return this._oShapeInstance[i];}}}}return undefined;};n.prototype._judgeEnableSelection=function(s,d){if(s===undefined){return false;}var t=this._getTopShapeInstance(s,d);if(t!==undefined){return t.getEnableSelection(s);}return false;};n.prototype._judgeEnableDnDByUid=function(s){if(s===undefined||s==null){return false;}var o;if(this._isRelationship(s)){o=this._getShapeDataByUid(s,true);}else{o=this._getShapeDataByUid(s,false);}return this._judgeEnableDnD(o);};n.prototype._judgeEnableDnD=function(s,d){if(s===undefined){return false;}var t=this._getTopShapeInstance(s,d);if(t!==undefined){return t.getEnableDnD(s);}return false;};n.prototype._selectShape=function(s){var r=this._getRowByShapeUid(s.uid);if(r==undefined){return false;}if(this._aSelectedShapeUids===undefined){this._aSelectedShapeUids=[];}var d=this._getShapeDataNameByUid(s.uid);if(this._oSelectedShapes[d]!==undefined&&this._oSelectedShapes[d]!==null){var g=this._oSelectedShapes[d];if(q.inArray(s.uid,this._aSelectedShapeUids)>-1){return false;}else{this._aSelectedShapeUids.push(s.uid);g.push({"shapeUid":s.uid,"shapeData":s,"objectInfoRef":r});return true;}}else{this._aSelectedShapeUids.push(s.uid);this._oSelectedShapes[d]=[];this._oSelectedShapes[d].push({"shapeUid":s.uid,"shapeData":s,"objectInfoRef":r});return true;}};n.prototype._deselectShape=function(s){var d=this._getShapeDataNameByUid(s.uid);if(q.inArray(s.uid,this._aSelectedShapeUids)>-1){var I=this._aSelectedShapeUids.indexOf(s.uid);this._aSelectedShapeUids.splice(I,1);var g=this._oSelectedShapes[d];for(var i in g){if(g[i].shapeUid===s.uid){g.splice(i,1);break;}}return true;}return false;};n.prototype._updateCSSForDummyRow=function(){var r=this._oTT.getRows();var d=this._oTT.$().find(".sapUiTableRowHdrScr").children();for(var i=0;i<r.length;i++){var o=r[i];var g=o.getIndex();if(g!==-1&&l.isMultipleSpanMainRow(this._oTT,i)){var j=l.getContextObject(this._oTT,g);if(j.afterNodeNum>0){r[i].$().addClass("sapGanttTrNoBorder");$(d[i]).addClass("sapGanttTHeaderNoBorder");}else{r[i].$().removeClass("sapGanttTrNoBorder");$(d[i]).removeClass("sapGanttTHeaderNoBorder");}}else{r[i].$().removeClass("sapGanttTrNoBorder");$(d[i]).removeClass("sapGanttTHeaderNoBorder");}}};n.prototype.getAxisOrdinal=function(){return this._oAxisOrdinal;};n.prototype.getAxisTime=function(){return this._oAxisTime;};n.prototype.ondblclick=function(E){return null;};n.prototype.onclick=function(E){return null;};n.prototype.getSapUiSizeClass=function(){return this._sUiSizeMode;};n.prototype.exit=function(){this._detachEvents();};return n;},true);
