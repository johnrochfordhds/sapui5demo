(function(){"use strict";jQuery.sap.declare("sap.ovp.cards.charts.Utils");sap.ovp.cards.charts.Utils=sap.ovp.cards.charts.Utils||{};sap.ovp.cards.charts.Utils.constants={CHART_QUALIFIER_KEY:"chartAnnotationPath",SELVAR_QUALIFIER_KEY:"selectionAnnotationPath",PREVAR_QUALIFIER_KEY:"presentationAnnotationPath",CHART_DATA_SIZE:"4",ERROR_NO_CHART:"Analytic cards require valid \"chartAnnotationPath\" "+"configured in manifest.json"};sap.ovp.cards.charts.Utils.getQualifier=function(c,a){if(!a){return"";}var s=c.getSetting('ovpCardProperties');if(!s){return"";}var S=s.oData;if(!S){return"";}var f=S&&S[a]?S[a]:"";return f===""?"":f.split("#")[1];};sap.ovp.cards.charts.Utils.wrapInBraces=function(w){return"{"+w+"}";};sap.ovp.cards.charts.Utils.getSapLabel=function(p){var e=this.getModel('ovpCardProperties').getProperty("/entityType");var l=sap.ovp.cards.charts.Utils.getAllColumnLabels(e)[p];return l?l:p;};sap.ovp.cards.charts.Utils.formDimensionPath=function(d){var r="{"+d+"}";var e=this.getModel('ovpCardProperties').getProperty("/entityType");if(!e){return r;}var a=sap.ovp.cards.charts.Utils.getEdmTypeOfAll(e);if(!a||!a[d]){return r;}var t=a[d];if(t=="Edm.DateTime"){return"{path:'"+d+"', formatter: 'sap.ovp.cards.charts.Utils.returnDateFormat'}";}var c=sap.ovp.cards.charts.Utils.getAllColumnTexts(e);if(!c){return r;}r="{"+(c[d]||d)+"}";return r;};sap.ovp.cards.charts.Utils.returnDateFormat=function(d){if(d){jQuery.sap.require("sap.ui.core.format.DateFormat");var D=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"dd-MMM"});return D.format(new Date(d));}return"";};sap.ovp.cards.charts.Utils.formatItems=function(c,e,s,p,D,M){var r="";var a=[];var b=[];var f=[];var F=s&&s.SelectOptions;var P=s&&s.Parameters;var S=p&&p.SortOrder;var g=p&&p.MaxItems,h=null;var j;var t;var C;if(P){var k=c.getSetting("dataModel");var l=sap.ovp.cards.AnnotationHelper.resolveParameterizedEntitySet(k,e,s);r+="{path: '"+l+"'";}else{r+="{path: '/"+e.name+"'";}var n=[];var o=null;var q=null;if(!c||!c.getSetting('ovpCardProperties')){jQuery.sap.log.error("Analytic card configuration error");r+="}";return r;}o=c.getSetting('ovpCardProperties').getProperty("/entityType");q=sap.ovp.cards.charts.Utils.getEdmTypeOfAll(o);j=sap.ovp.cards.charts.Utils.getAllColumnTexts(o);C=c.getSetting('ovpCardProperties').getProperty("/filters");if(F){jQuery.each(s.SelectOptions,function(){var d=this.PropertyName.PropertyPath;jQuery.each(this.Ranges,function(){if(this.Sign.EnumMember==="com.sap.vocabularies.UI.v1.SelectionRangeSignType/I"){var m=this.Low.String;if(q&&(q[d].substring(0,7)==="Edm.Int"||q[d].substring(0,11)==='Edm.Decimal')){m=Number(m);}var A={path:d,operator:this.Option.EnumMember.split("/")[1],value1:m};if(this.High){A.value2=this.High.String;}n.push(A);}});});}if(C&&C.length>0){n=n.concat(C);}if(n.length>0){r+=", filters: "+JSON.stringify(n);}if(S){var u=p.SortOrder;if(u.length<1){jQuery.sap.log.warning("OVP-AC: Analytic card: Warning: SortOrder is present in PresentationVariant, "+"but it is empty or not well formed.");}else{var v="";var w;var x;var y;for(var i=0;i<u.length;i++){w=u[i];y=w.Property.PropertyPath;f.push(y);if(typeof w.Descending=="undefined"){x='true';}else{var z=w.Descending.Bool||w.Descending.Boolean;if(!z){jQuery.sap.log.warning("OVP-AC: Analytic card: Warning: Boolean value is not present in PresentationVariant ");x='true';}else{x=z.toLowerCase()=='true'?'true':'false';}}v=v+"{path: '"+y+"',descending: "+x+"},";}r+=", sorter: ["+v.substring(0,v.length-1)+"]";}}if(g){h=g.Int32?g.Int32:g.Int;}jQuery.each(M,function(i,m){t=m.Measure.PropertyPath;b.push(t);if(j&&t!=j[t]){b.push(j[t]?j[t]:t);}});jQuery.each(D,function(i,d){t=d.Dimension.PropertyPath;a.push(t);if(j&&t!=j[t]){a.push(j[t]?j[t]:t);}});r+=", parameters: {select:'"+[].concat(a,b).join(",");if(f.length>0){r+=","+f.join(",");}r+="'}";if(h){if(/^\d+$/.test(h)){r+=", length: "+h;}else{jQuery.sap.log.error("OVP-AC: Analytic card Error: maxItems is Invalid. "+"Please enter an Integer.");}}r+="}";return r;};sap.ovp.cards.charts.Utils.formatItems.requiresIContext=true;sap.ovp.cards.charts.Utils.getAllColumnProperties=function(p,e){var f={};var a=e.property;for(var i=0,l=a.length;i<l;i++){if(a[i].hasOwnProperty(p)&&p=="com.sap.vocabularies.Common.v1.Label"){f[a[i].name]=a[i][p].String;}else if(a[i].hasOwnProperty(p)){f[a[i].name]=a[i][p];}else{f[a[i].name]=a[i].name;}}return f;};sap.ovp.cards.charts.Utils.getAllColumnLabels=function(e){return sap.ovp.cards.charts.Utils.getAllColumnProperties("com.sap.vocabularies.Common.v1.Label",e);};sap.ovp.cards.charts.Utils.getAllColumnTexts=function(e){return sap.ovp.cards.charts.Utils.getAllColumnProperties("sap:text",e);};sap.ovp.cards.charts.Utils.getEdmTypeOfAll=function(e){return sap.ovp.cards.charts.Utils.getAllColumnProperties("type",e);};sap.ovp.cards.charts.Utils.formatChartYaxis=function(){jQuery.sap.require("sap.ui.core.format.NumberFormat");var c={locale:function(){},format:function(v,p){if(p=="yValueAxisFormatter"){var n=sap.ui.core.format.NumberFormat.getFloatInstance({style:'short',minFractionDigits:2,maxFractionDigits:2});return n.format(Number(v));}}};jQuery.sap.require("sap.viz.ui5.api.env.Format");sap.viz.ui5.api.env.Format.numericFormatter(c);};sap.ovp.cards.charts.Utils.hideDateTimeAxis=function(v,f){var e=v.getModel('ovpCardProperties').getProperty("/entityType");var a=sap.ovp.cards.charts.Utils.getEdmTypeOfAll(e);var b=v.getFeeds();for(var i=0;i<b.length;i++){if(b[i].getUid()==f){var c=b[i].getValues();if(!c){return;}for(var j=0;j<c.length;j++){if(a[c[j]]!="Edm.DateTime"){return;}}v.setVizProperties({categoryAxis:{title:{visible:false}}});return;}}};sap.ovp.cards.charts.Utils.LineChart=sap.ovp.cards.charts.Utils.LineChart||{};sap.ovp.cards.charts.Utils.LineChart.categoryAxisFeedList={};sap.ovp.cards.charts.Utils.LineChart.getVizProperties=function(c,a,b){var r=sap.ovp.cards.charts.Utils.LineChart.getValueAxisFeed(c,b).split(",");var e=sap.ovp.cards.charts.Utils.LineChart.getCategoryAxisFeed(c,a).split(",");var v=[];jQuery.each(r,function(i,m){v.push(m);});var f=[];jQuery.each(e,function(i,d){f.push(d);});return"{ valueAxis:{  title:{   visible:true,   text: '"+v.join(",")+"'  },  label:{   formatString:'yValueAxisFormatter'  } }, categoryAxis:{  title:{   visible:true,   text: '"+f.join(",")+"'  },  label:{   formatString:'yValueAxisFormatter'  } }, legend: {  isScrollable: false }, title: {  visible: false }, interaction:{  noninteractiveMode: true,  selectability: {   legendSelection: false,   axisLabelSelection: false,   mode: 'NONE',   plotLassoSelection: false,   plotStdSelection: false  } } }";};sap.ovp.cards.charts.Utils.LineChart.getVizProperties.requiresIContext=true;sap.ovp.cards.charts.Utils.LineChart.getValueAxisFeed=function(c,a){var e=c.getSetting('ovpCardProperties').getProperty("/entityType");if(!e){return"";}var b=sap.ovp.cards.charts.Utils.getAllColumnLabels(e);var r=[];jQuery.each(a,function(i,m){r.push(b[m.Measure.PropertyPath]||m.Measure.PropertyPath);});return r.join(",");};sap.ovp.cards.charts.Utils.LineChart.getValueAxisFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.LineChart.getCategoryAxisFeed=function(c,a){var e=c.getSetting('ovpCardProperties').getProperty("/entityType");if(!e){return"";}var b=sap.ovp.cards.charts.Utils.getAllColumnLabels(e);var r=[];var q;var f;jQuery.each(a,function(i,d){if(d.Role.EnumMember.split("/")[1]==="Category"){f=b[d.Dimension.PropertyPath];r.push(f?f:d.Dimension.PropertyPath);}});if(r.length<1){f=b[a[0].Dimension.PropertyPath];r.push(f?f:a[0].Dimension.PropertyPath);}q=sap.ovp.cards.charts.Utils.getQualifier(c,sap.ovp.cards.charts.Utils.constants.CHART_QUALIFIER_KEY);sap.ovp.cards.charts.Utils.LineChart.categoryAxisFeedList[q]=r;return r.join(",");};sap.ovp.cards.charts.Utils.LineChart.getCategoryAxisFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.LineChart.getColorFeed=function(c,a){var r=[];var q;var e=c.getSetting('ovpCardProperties').getProperty("/entityType");if(!e){return"";}var b=sap.ovp.cards.charts.Utils.getAllColumnLabels(e);var f;jQuery.each(a,function(i,d){if(d.Role.EnumMember.split("/")[1]==="Series"){f=b[d.Dimension.PropertyPath];r.push(f?f:d.Dimension.PropertyPath);}});q=sap.ovp.cards.charts.Utils.getQualifier(c,sap.ovp.cards.charts.Utils.constants.CHART_QUALIFIER_KEY);r=jQuery.grep(r,function(v){if(!sap.ovp.cards.charts.Utils.LineChart.categoryAxisFeedList[q]){return true;}return v!=sap.ovp.cards.charts.Utils.LineChart.categoryAxisFeedList[q][0];});return r.join(",");};sap.ovp.cards.charts.Utils.LineChart.getColorFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.LineChart.testColorFeed=function(c,d){return sap.ovp.cards.charts.Utils.LineChart.getColorFeed(c,d)!=="";};sap.ovp.cards.charts.Utils.LineChart.testColorFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.BubbleChart=sap.ovp.cards.charts.Utils.BubbleChart||{};sap.ovp.cards.charts.Utils.BubbleChart.getVizProperties=function(c,d,a){var r=sap.ovp.cards.charts.Utils.BubbleChart.getValueAxisFeed(c,a).split(",");var b=sap.ovp.cards.charts.Utils.BubbleChart.getValueAxis2Feed(c,a).split(",");var v=[];jQuery.each(r,function(i,m){v.push(m);});var e=[];jQuery.each(b,function(i,m){e.push(m);});return"{ valueAxis:{  title:{ visible:true, text: '"+v.join(",")+"'  },  label:{ formatString:'yValueAxisFormatter'  } }, valueAxis2:{  title:{ visible:true, text: '"+e.join(",")+"'  },  label:{ formatString:'yValueAxisFormatter'  } }, categoryAxis:{  title:{ visible:true  },  label:{ formatString:'yValueAxisFormatter'  } }, legend: {  isScrollable: false }, title: {  visible: false }, interaction:{  noninteractiveMode: true,  selectability: { legendSelection: false, axisLabelSelection: false, mode: 'NONE', plotLassoSelection: false, plotStdSelection: false  } } }";};sap.ovp.cards.charts.Utils.BubbleChart.getVizProperties.requiresIContext=true;sap.ovp.cards.charts.Utils.BubbleChart.getMeasurePriorityList=function(c,a){var o;if(!c||!c.getSetting||!(o=c.getSetting('ovpCardProperties'))){return[""];}var e=o.getProperty("/entityType");if(!e){return[""];}var b=sap.ovp.cards.charts.Utils.getAllColumnLabels(e);var r=[null,null,null];jQuery.each(a,function(i,m){if(m.Role.EnumMember.split("/")[1]==="Axis1"){if(r[0]===null){r[0]=b[m.Measure.PropertyPath]||m.Measure.PropertyPath;}else if(r[1]===null){r[1]=b[m.Measure.PropertyPath]||m.Measure.PropertyPath;}else if(r[2]==null){r[2]=b[m.Measure.PropertyPath]||m.Measure.PropertyPath;}}});jQuery.each(a,function(i,m){if(m.Role.EnumMember.split("/")[1]==="Axis2"){if(r[0]===null){r[0]=b[m.Measure.PropertyPath]||m.Measure.PropertyPath;}else if(r[1]===null){r[1]=b[m.Measure.PropertyPath]||m.Measure.PropertyPath;}else if(r[2]==null){r[2]=b[m.Measure.PropertyPath]||m.Measure.PropertyPath;}}});jQuery.each(a,function(i,m){if(m.Role.EnumMember.split("/")[1]==="Axis3"){if(r[0]===null){r[0]=b[m.Measure.PropertyPath]||m.Measure.PropertyPath;}else if(r[1]===null){r[1]=b[m.Measure.PropertyPath]||m.Measure.PropertyPath;}else if(r[2]==null){r[2]=b[m.Measure.PropertyPath]||m.Measure.PropertyPath;}}});return r;};sap.ovp.cards.charts.Utils.BubbleChart.getMeasurePriorityList.requiresIContext=true;sap.ovp.cards.charts.Utils.BubbleChart.getValueAxisFeed=function(c,m){return sap.ovp.cards.charts.Utils.BubbleChart.getMeasurePriorityList(c,m)[0];};sap.ovp.cards.charts.Utils.BubbleChart.getValueAxisFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.BubbleChart.getValueAxis2Feed=function(c,m){return sap.ovp.cards.charts.Utils.BubbleChart.getMeasurePriorityList(c,m)[1];};sap.ovp.cards.charts.Utils.BubbleChart.getValueAxis2Feed.requiresIContext=true;sap.ovp.cards.charts.Utils.BubbleChart.getBubbleWidthFeed=function(c,m){return sap.ovp.cards.charts.Utils.BubbleChart.getMeasurePriorityList(c,m)[2];};sap.ovp.cards.charts.Utils.BubbleChart.getBubbleWidthFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.BubbleChart.getColorFeed=function(c,a){var e=c.getSetting('ovpCardProperties').getProperty("/entityType");if(!e){return"";}var b=sap.ovp.cards.charts.Utils.getAllColumnLabels(e);var r=[];var f;jQuery.each(a,function(i,d){if(d.Role.EnumMember.split("/")[1]==="Series"){f=b[d.Dimension.PropertyPath];r.push(f?f:d.Dimension.PropertyPath);}});return r.join(",");};sap.ovp.cards.charts.Utils.BubbleChart.getColorFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.BubbleChart.getShapeFeed=function(c,a){var e=c.getSetting('ovpCardProperties').getProperty("/entityType");if(!e){return"";}var b=sap.ovp.cards.charts.Utils.getAllColumnLabels(e);var r=[];var f;jQuery.each(a,function(i,d){if(d.Role.EnumMember.split("/")[1]==="Category"){f=b[d.Dimension.PropertyPath];r.push(f?f:d.Dimension.PropertyPath);}});return r.join(",");};sap.ovp.cards.charts.Utils.BubbleChart.getShapeFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.BubbleChart.testColorFeed=function(c,d){return sap.ovp.cards.charts.Utils.BubbleChart.getColorFeed(c,d)!=="";};sap.ovp.cards.charts.Utils.BubbleChart.testColorFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.BubbleChart.testShapeFeed=function(c,d){return sap.ovp.cards.charts.Utils.BubbleChart.getShapeFeed(c,d)!=="";};sap.ovp.cards.charts.Utils.BubbleChart.testShapeFeed.requiresIContext=true;sap.ovp.cards.charts.Utils.validateMeasuresDimensions=function(v,t){var m=null;var d=null;if(!v.getDataset()){jQuery.sap.log.error("OVP-AC: "+t+" Card Error: No Dataset defined for chart.");return false;}m=v.getDataset().getMeasures();d=v.getDataset().getDimensions();switch(t){case"Bubble":if(m.length!==3||d.length<1||!m[0].getName()||!m[1].getName()||!m[2].getName()||!d[0].getName()){jQuery.sap.log.error("OVP-AC: Bubble Card Error: Enter exactly 3 measures and at least 1 dimension.");return false;}break;case"Donut":if(m.length!==1||d.length!==1||!m[0].getName()||!d[0].getName()){jQuery.sap.log.error("OVP-AC: Donut Card Error: Enter exactly 1 measure and 1 dimension.");return false;}break;case"Line":if(m.length<1||d.length<1||!m[0].getName()||!d[0].getName()){jQuery.sap.log.error("OVP-AC: Line Card Error: Configure at least 1 dimensions and 1 measure.");return false;}break;}return true;};sap.ovp.cards.charts.Utils.checkExists=function(t,a,b,m,l){m=typeof m==="undefined"?false:m;var r=false;var c;if(!t&&m){jQuery.sap.log.error(l+"OVP-AC: Analytic card: Error: "+b+" is mandatory.");return r;}if(!t){jQuery.sap.log.warning(l+"OVP-AC: Analytic card: Warning: "+b+" is missing.");r=true;return r;}c=a[t];if(!c||typeof c!=="object"){var d=m?jQuery.sap.log.error:jQuery.sap.log.warning;d(l+"OVP-AC: Analytic card: Error in "+b+". ("+t+" is not found or not well formed)");return r;}r=true;return r;};sap.ovp.cards.charts.Utils.validateCardConfiguration=function(c){var r=false;if(!c){return r;}var s;var a;var p;var i;var P;var e;var l="";var C;var v=c.getView();if(v){l="["+v.getId()+"] ";}if(!(C=c.getCardPropertiesModel())){jQuery.sap.log.error(l+"OVP-AC: Analytic card: Error in card configuration."+"Could not obtain Cards model.");return r;}e=C.getProperty("/entityType");if(!e||jQuery.isEmptyObject(e)){jQuery.sap.log.error(l+"OVP-AC: Analytic card: Error in card annotation.");return r;}s=C.getProperty("/selectionAnnotationPath");a=C.getProperty("/chartAnnotationPath");p=C.getProperty("/presentationAnnotationPath");i=C.getProperty("/identificationAnnotationPath");P=C.getProperty("/dataPointAnnotationPath");r=this.checkExists(s,e,"Selection Variant",false,l);r=this.checkExists(a,e,"Chart Annotation",true,l)&&r;r=this.checkExists(p,e,"Presentation Variant",false,l)&&r;r=this.checkExists(i,e,"Identification Annotation",true,l)&&r;r=this.checkExists(P,e,"Data Point",false,l)&&r;return r;};sap.ovp.cards.charts.Utils.checkNoData=function(e,c,v){var d,n;if(!c){jQuery.sap.log.error("OVP-AC: Analytic card Error: Could not obtain card container. "+"("+v.getId()+")");return;}d=e.getParameter("data");if(!d||jQuery.isEmptyObject(d)||!d.results||!d.results.length){jQuery.sap.log.error("OVP-AC: Analytic card Error: No data available. "+"("+v.getId()+")");n=sap.ui.xmlfragment("sap.ovp.cards.charts.generic.noData");c.removeAllItems();c.addItem(n);}};}());
