(function(){"use strict";jQuery.sap.require("sap.ovp.ui.ObjectStream");jQuery.sap.require("sap.ovp.cards.AnnotationHelper");sap.ui.controller("sap.ovp.cards.stack.Stack",{onInit:function(){var v=this.getView().byId("stackContent");v.addEventDelegate({onclick:this.openStack.bind(this),onkeydown:function(e){if(!e.shiftKey&&(e.keyCode==13||e.keyCode==32)){e.preventDefault();this.openStack();}}.bind(this)});},onExit:function(){if(this.oObjectStream){this.oObjectStream.destroy();}},onAfterRendering:function(){var v=this.getView();var m=v.getModel();var c=v.getModel("ovpCardProperties");var e=c.getProperty("/entitySet");var o=c.getProperty("/objectStreamCardsSettings");var M=m.getMetaModel();var E=M.getODataEntitySet(e);var a=M.getODataEntityType(E.entityType);var A=c.getProperty("/annotationPath");var b=(A)?A.split(","):[];function g(k){if(k==="ovpCardProperties"){return c;}else if(k==="dataModel"){return m;}else if(k==="_ovpCache"){return{};}}var f=[{getSetting:g},E].concat(b);var B=sap.ovp.cards.AnnotationHelper.formatItems.apply(this,f);var d=sap.ui.base.BindingParser.complexParser(B);var O=c.getProperty("/objectStreamCardsNavigationProperty");var s=O?true:false;var S;var h=c.getProperty("/objectStreamCardsTemplate");if(s){if(h==="sap.ovp.cards.quickview"){jQuery.sap.log.error("objectStreamCardsTemplate cannot be 'sap.ovp.cards.quickview' when objectStreamCardsNavigationProperty is provided");this.setErrorState();return;}S=this._determineFilterPropertyId(m,E,a,O);o.entitySet=m.getMetaModel().getODataAssociationSetEnd(a,O).entitySet;}else{if(h!=="sap.ovp.cards.quickview"){jQuery.sap.log.error("objectStreamCardsTemplate must be 'sap.ovp.cards.quickview' when objectStreamCardsNavigationProperty is not provided");this.setErrorState();return;}if(!o.category){if(a["com.sap.vocabularies.UI.v1.HeaderInfo"]&&a["com.sap.vocabularies.UI.v1.HeaderInfo"].TypeName&&a["com.sap.vocabularies.UI.v1.HeaderInfo"].TypeName.String){o.category=a["com.sap.vocabularies.UI.v1.HeaderInfo"].TypeName.String;}else{o.category=a.name;}}o.entitySet=e;}d.factory=function(I,C){var j=o,F;if(s){F={filters:[{path:S.foreignKey,operator:"EQ",value1:C.getProperty(S.key)}]};j=jQuery.extend(F,o);}var k=sap.ui.component({name:c.getProperty("/objectStreamCardsTemplate"),componentData:{model:m,settings:j}});var q=new sap.ui.core.ComponentContainer({component:k});q.setBindingContext=function(C){k.setBindingContext(C);};return q;};this.oObjectStream=new sap.ovp.ui.ObjectStream({title:c.getObject("/category"),content:d});this.oObjectStream.setModel(m);if(!s){var n=this.getEntityNavigationEntries();if(n.length>0){var i=n[0].label;var p=this._createPlaceHolder(i);var t=this;p.addEventDelegate({onclick:function(){t.doNavigation(null);}});this.oObjectStream.setPlaceHolder(p);}}var l=this.oObjectStream.getBinding("content");l.attachDataReceived(function(){var j=l.getCurrentContexts().length;v.byId("stackSize").setText(j);var k=this.getView().byId("stackContent").getDomRef();jQuery(k).attr("aria-label",sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("stackCardContent",[j]));var q=this.getView().byId("stackSize").getDomRef();jQuery(q).attr("aria-label",sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("stackCard",[j]));},this);},_determineFilterPropertyId:function(m,e,E,n){var N,a=E.namespace,r,A;for(var i=0;i<E.navigationProperty.length;i++){if(E.navigationProperty[i].name===n){N=E.navigationProperty[i];break;}}r=N.relationship;A=sap.ovp.cards.AnnotationHelper.getAssociationObject(m,r,a);var R=A.referentialConstraint,f={};if(R){f.foreignKey=R.dependent.propertyRef[0].name;f.key=R.principal.propertyRef[0].name;return f;}},_createPlaceHolder:function(a){var i=new sap.ui.core.Icon({src:"sap-icon://offsite-work",useIconTooltip:false,layoutData:new sap.m.FlexItemData({growFactor:1,alignSelf:sap.m.FlexAlignSelf.Center})});i.addStyleClass("sapOvpStackPlaceHolderIcon");var l=new sap.m.Label({text:a});var s=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("ForMoreContentAppName",[a]);var t=new sap.m.Text({text:s});t.addCustomData(new sap.ovp.ui.CustomData({key:"role",value:"heading",writeToDom:true}));t.addCustomData(new sap.ovp.ui.CustomData({key:"aria-label",value:s,writeToDom:true}));l.addStyleClass("sapOvpStackPlaceHolderAppName");t.addStyleClass("sapOvpStackPlaceHolderTextLine");var d=new sap.m.VBox({items:[l,t]});d.addStyleClass("sapOvpStackPlaceHolderLabelsContainer");d.addCustomData(new sap.ovp.ui.CustomData({key:"tabindex",value:"0",writeToDom:true}));d.addCustomData(new sap.ovp.ui.CustomData({key:"role",value:"button",writeToDom:true}));var v=new sap.m.VBox({items:[i,d]});v.addStyleClass("sapOvpStackPlaceHolder");v.addEventDelegate({onkeydown:function(e){if(!e.shiftKey&&(e.keyCode==13||e.keyCode==32)){e.preventDefault();e.srcControl.$().click();}}});return v;},openStack:function(){if(this.oObjectStream){var l=this.oObjectStream.getBinding("content");if(l.getCurrentContexts().length>0){var c=this.getView().$().width();this.oObjectStream.open(c);}}}});})();
