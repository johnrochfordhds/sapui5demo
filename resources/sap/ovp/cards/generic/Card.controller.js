(function(){"use strict";jQuery.sap.require("sap.ovp.cards.ActionUtils");jQuery.sap.require("sap.ui.generic.app.navigation.service.NavigationHandler");jQuery.sap.require("sap.ovp.cards.CommonUtils");var A=sap.ovp.cards.ActionUtils;sap.ui.controller("sap.ovp.cards.generic.Card",{onInit:function(){var h=this.getView().byId("ovpCardHeader");h.attachBrowserEvent("click",this.onHeaderClick.bind(this));h.addEventDelegate({onkeydown:function(e){if(!e.shiftKey&&(e.keyCode==13||e.keyCode==32)){e.preventDefault();this.onHeaderClick();}}.bind(this)});var n=this.getView().byId("kpiNumberValue");if(n){n.addEventDelegate({onAfterRendering:function(){var $=n.$();var a=$.find(".sapMNCValueScr");var b=$.find(".sapMNCScale");a.attr("aria-label",a.text());b.attr("aria-label",b.text());}});}},onAfterRendering:function(){var f=this.getCardPropertiesModel().getProperty("/footerFragment");if(f){this._handleActionFooter();this._handleCountFooter();}},onHeaderClick:function(){this.doNavigation(this.getView().getBindingContext());},_handleActionFooter:function(f){var a=this.getView().byId("ovpActionFooter");if(a){var b=a.getContent();b=b.splice(1,b.length);var l=b[0].getLayoutData();l.setMoveToOverflow(false);l.setStayInOverflow(false);if(b.length===2){l=b[1].getLayoutData();l.setMoveToOverflow(false);l.setStayInOverflow(false);}}},_handleCountFooter:function(){var c=this.getView().byId("ovpCountFooter");if(c){var i=this.getCardItemsBinding();if(i){i.attachDataReceived(function(){var t=i.getLength();var C=i.getCurrentContexts().length;var a=sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("Count_Footer",[C,t]);c.setText(a);});}}},getCardItemsBinding:function(){},onActionPress:function(e){var s=e.getSource(),c=this._getActionObject(s),a=s.getBindingContext();if(c.type.indexOf("DataFieldForAction")!==-1){this.doAction(a,c);}else{this.doNavigation(a,c);}},_getActionObject:function(s){var c=s.getCustomData();var C={};for(var i=0;i<c.length;i++){C[c[i].getKey()]=c[i].getValue();}return C;},doNavigation:function(c,n){if(!n){n=this.getEntityNavigationEntries(c)[0];}if(n){switch(n.type){case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":this.doNavigationWithUrl(c,n);break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":this.doIntentBasedNavigation(c,n);break;}}},doNavigationWithUrl:function(c,n){var p=sap.ushell.Container.getService("URLParsing");if(!(p.isIntentUrl(n.url))){window.open(n.url);}else{var P=p.parseShellHash(n.url);this.doIntentBasedNavigation(c,P);}},doIntentBasedNavigation:function(c,i){var p,n,e=c?c.getObject():null;var N=sap.ovp.cards.CommonUtils.getNavigationHandler();if(N){if(i){p=this._getEntityNavigationParameters(e);p.done(function(P,a){n={target:{semanticObject:i.semanticObject,action:i.action},appSpecificRoute:i.appSpecificRoute,params:P};var o={};if(a){o=a;}function h(E){if(E instanceof Error){E.showMessageBox();}}N.navigate(n.target.semanticObject,n.target.action,n.params,o,h);});}}},doAction:function(c,a){this.actionData=A.getActionInfo(c,a,this.getEntityType());if(this.actionData.allParameters.length>0){this._loadParametersForm();}else{this._callFunction();}},getEntityNavigationEntries:function(c,a){var n=[];var e=this.getEntityType();if(!a){var C=this.getCardPropertiesModel();var I=C.getProperty("/identificationAnnotationPath");a=I;}var r=e[a];if(Array.isArray(r)){r=sap.ovp.cards.AnnotationHelper.sortCollectionByImportance(r);for(var i=0;i<r.length;i++){if(r[i].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){n.push({type:r[i].RecordType,semanticObject:r[i].SemanticObject.String,action:r[i].Action.String,label:r[i].Label.String});}if(r[i].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"&&!r[i].Url.UrlRef){var m=this.getView().getModel();var M=m.oMetaModel;var E=M.createBindingContext(e.$path);var b=sap.ui.model.odata.AnnotationHelper.format(E,r[i].Url);var o=new sap.ui.core.CustomData({key:"url",value:b});o.setModel(m);o.setBindingContext(c);var u=o.getValue();n.push({type:r[i].RecordType,url:u,value:r[i].Value.String,label:r[i].Label.String});}}}return n;},getModel:function(){return this.getView().getModel();},getMetaModel:function(){return this.getModel().getMetaModel();},getCardPropertiesModel:function(){return this.getView().getModel("ovpCardProperties");},getEntitySet:function(){if(!this.entitySet){var e=this.getCardPropertiesModel().getProperty("/entitySet");this.entitySet=this.getMetaModel().getODataEntitySet(e);}return this.entitySet;},getEntityType:function(){if(!this.entityType){this.entityType=this.getMetaModel().getODataEntityType(this.getEntitySet().entityType);}return this.entityType;},getCardContentContainer:function(){if(!this.cardContentContainer){this.cardContentContainer=this.getView().byId("ovpCardContentContainer");}return this.cardContentContainer;},_saveAppState:function(f){var d=jQuery.Deferred();var a=sap.ushell.Container.getService("CrossApplicationNavigation").createEmptyAppState(this.getOwnerComponent());var s=a.getKey();var o={selectionVariant:f};a.setData(o);var S=a.save();S.done(function(){d.resolve(s,o);});return d.promise();},_getEntityNavigationParameters:function(e){var d=jQuery.Deferred();var u={};var E;var c=this.getOwnerComponent().getComponentData();var g=c?c.globalFilter:undefined;var s;var C=sap.ovp.cards.AnnotationHelper.getCardFilters(this.getCardPropertiesModel());var S;if(e){E=this.getEntityType();var k;for(var i=0;E.property&&i<E.property.length;i++){k=E.property[i].name;if(e.hasOwnProperty(k)){if(window.Array.isArray(e[k])&&e[k].length===1){u[k]=e[k][0].toString();}else if(e[k]){u[k]=e[k].toString();}}}}S=this._buildSelectionVariant(g,C,u);var a=S.getSelectOptionsPropertyNames();for(var i=0;i<a.length;i++){var b=a[i];var v=S.getSelectOption(b);if((v)[0]&&(v)[0].Option==="EQ"){var f=(v)[0].Low;if(f){u[b]=f;}}}if(!S.isEmpty()){s=this._saveAppState(S.toJSONString());s.done(function(h,o){u["sap-xapp-state"]=h;d.resolve(u,o);});s.fail(function(){jQuery.sap.log.error("appStateKey is not saved for OVP Application");d.resolve(u);});}else{d.resolve(u);}return d.promise();},_buildSelectionVariant:function(g,c,u){var G=g?g.getFilterDataAsString():"{}";var s=new sap.ui.generic.app.navigation.service.SelectionVariant(G);for(var i=0;i<c.length;i++){var e=c[i];if(e.path&&e.operator&&typeof e.value1!=="undefined"){var v=(typeof e.value2==="number")?e.value2.toString():undefined;s.addSelectOption(e.path,"I",e.operator,e.value1.toString(),v);}}if(u){var a;for(var k in u){a=u[k];if(!s.getSelectOption(k)){s.addParameter(k,a);}}}return s;},_loadParametersForm:function(){var p=new sap.ui.model.json.JSONModel();p.setData(this.actionData.parameterData);var t=this;var P=new sap.m.Dialog('ovpCardActionDialog',{title:this.actionData.sFunctionLabel,afterClose:function(){P.destroy();}}).addStyleClass("sapUiNoContentPadding");var a=new sap.m.Button({text:this.actionData.sFunctionLabel,press:function(e){var m=A.getParameters(e.getSource().getModel(),t.actionData.oFunctionImport);P.close();t._callFunction(m);}});var c=new sap.m.Button({text:"Cancel",press:function(){P.close();}});P.setBeginButton(a);P.setEndButton(c);var o=function(e){var m=A.mandatoryParamsMissing(e.getSource().getModel(),t.actionData.oFunctionImport);a.setEnabled(!m);};var f=A.buildParametersForm(this.actionData,o);P.addContent(f);P.setModel(p);P.open();},_callFunction:function(u){var p={batchGroupId:"Changes",changeSetId:"Changes",urlParameters:u,forceSubmit:true,context:this.actionData.oContext,functionImport:this.actionData.oFunctionImport};var t=this;var P=new Promise(function(r,a){var m=t.actionData.oContext.getModel();var f;f="/"+p.functionImport.name;m.callFunction(f,{method:p.functionImport.httpMethod,urlParameters:p.urlParameters,batchGroupId:p.batchGroupId,changeSetId:p.changeSetId,headers:p.headers,success:function(d,R){r(R);},error:function(R){a(R);}});});P.then(function(r){return sap.m.MessageToast.show(sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("Toast_Action_Success"),{duration:1000});},function(e){return sap.m.MessageToast.show(sap.ui.getCore().getLibraryResourceBundle("sap.ovp").getText("Toast_Action_Error"),{duration:1000});});},setErrorState:function(){var c=this.getOwnerComponent();var C=c.oContainer;var o=this.getCardPropertiesModel();var a={name:"sap.ovp.cards.loading",componentData:{model:this.getView().getModel(),settings:{category:o.getProperty("/category"),title:o.getProperty("/title"),description:o.getProperty("/description"),entitySet:o.getProperty("/entitySet"),state:sap.ovp.cards.loading.State.ERROR}}};var l=sap.ui.component(a);C.setComponent(l);setTimeout(function(){c.destroy();},0);}});})();
