define("tinymce/imagetoolsplugin/Plugin",["global!tinymce.PluginManager","global!tinymce.Env","global!tinymce.util.Promise","global!tinymce.util.URI","global!tinymce.util.Tools","global!tinymce.util.Delay","ephox/imagetools/api/ImageTransformations","ephox/imagetools/api/BlobConversions","tinymce/imagetoolsplugin/Dialog"],function(P,E,a,U,T,D,I,B,b){var p=function(c){var d=0,i,l;if(!E.fileApi){return;}function g(e){var H,J;function K(L){return L.indexOf('px')==L.length-2;}H=e.style.width;J=e.style.height;if(H||J){if(K(H)&&K(J)){return{w:parseInt(H,10),h:parseInt(J,10)};}return null;}H=c.$(e).attr('width');J=c.$(e).attr('height');if(H&&J){return{w:parseInt(H,10),h:parseInt(J,10)};}return null;}function s(e,H){var J,K;if(H){J=e.style.width;K=e.style.height;if(J||K){c.$(e).css({width:H.w,height:H.h}).removeAttr('data-mce-style');}J=e.width;K=e.height;if(J||K){c.$(e).attr({width:H.w,height:H.h});}}}function f(e){return{w:e.naturalWidth,h:e.naturalHeight};}function h(){return c.selection.getNode();}function j(){return'imagetools'+d++;}function k(e){var H=e.src;return H.indexOf('data:')===0||H.indexOf('blob:')===0||new U(H).host===c.documentBaseURI.host;}function m(e){return T.inArray(c.settings.imagetools_cors_hosts,new U(e.src).host)!==-1;}function n(){return c.settings.api_key||c.settings.imagetools_api_key;}function r(e){return new a(function(H){var J,K;J=new XMLHttpRequest();J.onload=function(){H(this.response);};J.open('GET',e,true);K=n();if(K){J.setRequestHeader("Content-Type","application/json;charset=UTF-8");J.setRequestHeader('tiny-api-key',K);}J.responseType='blob';J.send();});}function o(e){var H=e.src;if(m(e)){return r(e.src);}if(!k(e)){H=c.settings.imagetools_proxy;H+=(H.indexOf('?')===-1?'?':'&')+'url='+encodeURIComponent(e.src);if(n()){return r(H);}e=new Image();e.src=H;}return B.imageToBlob(e);}function q(){var e;e=c.editorUpload.blobCache.getByUri(h().src);if(e){return e;}return o(h()).then(function(H){return B.blobToBase64(H).then(function(J){var K=c.editorUpload.blobCache;var e=K.create(j(),H,J);K.add(e);return e;});});}function t(){i=D.setEditorTimeout(c,function(){c.editorUpload.uploadImagesAuto();},30000);}function u(){clearTimeout(i);}function v(e,H){return B.blobToDataUri(e).then(function(J){var K,L,M,N,O;O=h();K=j();M=c.editorUpload.blobCache;L=U.parseDataUri(J).data;N=M.create(K,e,L);M.add(N);c.undoManager.transact(function(){function Q(){c.$(O).off('load',Q);c.nodeChanged();if(H){c.editorUpload.uploadImagesAuto();}else{u();t();}}c.$(O).on('load',Q);c.$(O).attr({src:N.blobUri()}).removeAttr('data-mce-src');});return N;});}function w(e){return function(){return c._scanForImages().then(q).then(e).then(v);};}function x(e){return function(){return w(function(H){var J=g(h());if(J){s(h(),{w:J.h,h:J.w});}return I.rotate(H.blob(),e);})();};}function y(e){return function(){return w(function(H){return I.flip(H.blob(),e);})();};}function z(){var e=h(),H=f(e);if(e){o(e).then(b.edit).then(function(J){return new a(function(K){B.blobToImage(J).then(function(L){var M=f(L);if(H.w!=M.w||H.h!=M.h){if(g(e)){s(e,M);}}URL.revokeObjectURL(L.src);K(J);});});}).then(function(J){v(J,true);},function(){});}}function A(){c.addButton('rotateleft',{title:'Rotate counterclockwise',onclick:x(-90)});c.addButton('rotateright',{title:'Rotate clockwise',onclick:x(90)});c.addButton('flipv',{title:'Flip vertically',onclick:y('v')});c.addButton('fliph',{title:'Flip horizontally',onclick:y('h')});c.addButton('editimage',{title:'Edit image',onclick:z});c.addButton('imageoptions',{title:'Image options',icon:'options',cmd:'mceImage'});}function C(){c.on('NodeChange',function(e){if(l&&l.src!=e.element.src){u();c.editorUpload.uploadImagesAuto();l=undefined;}if(F(e.element)){l=e.element;}});}function F(e){var H=c.dom.is(e,'img:not([data-mce-object],[data-mce-placeholder])');return H&&(k(e)||m(e)||c.settings.imagetools_proxy);}function G(){var e=c.settings.imagetools_toolbar;if(!e){e='rotateleft rotateright | flipv fliph | crop editimage imageoptions';}c.addContextToolbar(F,e);}A();G();C();c.addCommand('mceEditImage',z);};P.add('imagetools',p);return function(){};});
