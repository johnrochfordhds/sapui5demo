define("tinymce/pasteplugin/Clipboard",["tinymce/Env","tinymce/dom/RangeUtils","tinymce/util/VK","tinymce/pasteplugin/Utils","tinymce/util/Delay"],function(E,R,V,U,D){return function(a){var s=this,p,l,k=0,d=false;var b='%MCEPASTEBIN%',c;var m='data:text/mce-internal,';function f(e){var i,A=a.dom;i=a.fire('BeforePastePreProcess',{content:e});i=a.fire('PastePreProcess',i);e=i.content;if(!i.isDefaultPrevented()){if(a.hasEventListeners('PastePostProcess')&&!i.isDefaultPrevented()){var B=A.add(a.getBody(),'div',{style:'display:none'},e);i=a.fire('PastePostProcess',{node:B});A.remove(B);e=i.node.innerHTML;}if(!i.isDefaultPrevented()){a.insertContent(e,{merge:a.settings.paste_merge_formats!==false,data:{paste:true}});}}}function g(e){e=a.dom.encode(e).replace(/\r\n/g,'\n');var i=a.dom.getParent(a.selection.getStart(),a.dom.isBlock);var A=a.settings.forced_root_block;var B;if(A){B=a.dom.createHTML(A,a.settings.forced_root_block_attrs);B=B.substr(0,B.length-3)+'>';}if((i&&/^(PRE|DIV)$/.test(i.nodeName))||!A){e=U.filter(e,[[/\n/g,"<br>"]]);}else{e=U.filter(e,[[/\n\n/g,"</p>"+B],[/^(.*<\/p>)(<p>)$/,B+'$1'],[/\n/g,"<br />"]]);if(e.indexOf('<p>')!=-1){e=B+e;}}f(e);}function h(){var i=a.dom,A=a.getBody();var B=a.dom.getViewPort(a.getWin()),C=B.y,F=20;var G;l=a.selection.getRng();if(a.inline){G=a.selection.getScrollContainer();if(G&&G.scrollTop>0){C=G.scrollTop;}}function H(e){var K,L,M,J=e.startContainer;K=e.getClientRects();if(K.length){return K[0];}if(!e.collapsed||J.nodeType!=1){return;}M=J.childNodes[l.startOffset];while(M&&M.nodeType==3&&!M.data.length){M=M.nextSibling;}if(!M){return;}if(M.tagName=='BR'){L=i.doc.createTextNode('\uFEFF');M.parentNode.insertBefore(L,M);e=i.createRng();e.setStartBefore(L);e.setEndAfter(L);K=e.getClientRects();i.remove(L);}if(K.length){return K[0];}}if(l.getClientRects){var I=H(l);if(I){F=C+(I.top-i.getPos(A).y);}else{F=C;var J=l.startContainer;if(J){if(J.nodeType==3&&J.parentNode!=A){J=J.parentNode;}if(J.nodeType==1){F=i.getPos(J,G||A).y;}}}}p=i.add(a.getBody(),'div',{id:"mcepastebin",contentEditable:true,"data-mce-bogus":"all",style:'position: absolute; top: '+F+'px;'+'width: 10px; height: 10px; overflow: hidden; opacity: 0'},b);if(E.ie||E.gecko){i.setStyle(p,'left',i.getStyle(A,'direction',true)=='rtl'?0xFFFF:-0xFFFF);}i.bind(p,'beforedeactivate focusin focusout',function(e){e.stopPropagation();});p.focus();a.selection.select(p,true);}function r(){if(p){var e;while((e=a.dom.get('mcepastebin'))){a.dom.remove(e);a.dom.unbind(e);}if(l){a.selection.setRng(l);}}p=l=null;}function j(){var e='',A,i,B,C;A=a.dom.select('div[id=mcepastebin]');for(i=0;i<A.length;i++){B=A[i];if(B.firstChild&&B.firstChild.id=='mcepastebin'){B=B.firstChild;}C=B.innerHTML;if(e!=b){e+=C;}}return e;}function n(e){var i,A,B,C;B=[25942,29554,28521,14958];for(i=0;i<B.length;i++){if(e.charCodeAt(i)!=B[i]){return e;}}A='';for(i=0;i<e.length;i++){C=e.charCodeAt(i);A+=String.fromCharCode((C&0x00FF));A+=String.fromCharCode((C&0xFF00)>>8);}return decodeURIComponent(escape(A));}function o(e){var i,A,B;A='<!--StartFragment-->';i=e.indexOf(A);if(i!==-1){e=e.substr(i+A.length);}B='<!--EndFragment-->';i=e.indexOf(B);if(i!==-1){e=e.substr(0,i);}return e;}function q(e){var A={};if(e){if(e.getData){var B=e.getData('Text');if(B&&B.length>0){if(B.indexOf(m)==-1){A['text/plain']=B;}}}if(e.types){for(var i=0;i<e.types.length;i++){var C=e.types[i],F=e.getData(C);if(C=='text/html'){F=o(n(F));}A[C]=F;}}}return A;}function t(e){return q(e.clipboardData||a.getDoc().dataTransfer);}function u(e,A){var B=e.clipboardData||e.dataTransfer;function C(F){var i,G,H,I=false;function J(H){if(A){a.selection.setRng(A);A=null;}f('<img src="'+H.result+'">');}if(F){for(i=0;i<F.length;i++){G=F[i];if(/^image\/(jpeg|png|gif|bmp)$/.test(G.type)){H=new FileReader();H.onload=J.bind(null,H);H.readAsDataURL(G.getAsFile?G.getAsFile():G);e.preventDefault();I=true;}}}return I;}if(a.settings.paste_data_images&&B){return C(B.items)||C(B.files);}}function v(e){var i=e.clipboardData;return navigator.userAgent.indexOf('Android')!=-1&&i&&i.items&&i.items.length===0;}function w(e){return R.getCaretRangeFromPoint(e.clientX,e.clientY,a.getDoc());}function x(e,i){return i in e&&e[i].length>0;}function y(e){return(V.metaKeyPressed(e)&&e.keyCode==86)||(e.shiftKey&&e.keyCode==45);}function z(){a.on('keydown',function(e){function A(e){if(y(e)&&!e.isDefaultPrevented()){r();}}if(y(e)&&!e.isDefaultPrevented()){c=e.shiftKey&&e.keyCode==86;if(c&&E.webkit&&navigator.userAgent.indexOf('Version/')!=-1){return;}e.stopImmediatePropagation();k=new Date().getTime();if(E.ie&&c){e.preventDefault();a.fire('paste',{ieFake:true});return;}r();h();a.once('keyup',A);a.once('paste',function(){a.off('keyup',A);});}});function i(e,A,B){var C;if(x(e,'text/html')){C=e['text/html'];}else{C=j();if(C==b){B=true;}}C=U.trimHtml(C);if(p&&p.firstChild&&p.firstChild.id==='mcepastebin'){B=true;}r();if(!C.length){B=true;}if(B){if(x(e,'text/plain')&&C.indexOf('</p>')==-1){C=e['text/plain'];}else{C=U.innerText(C);}}if(C==b){if(!A){a.windowManager.alert('Please use Ctrl+V/Cmd+V keyboard shortcuts to paste contents.');}return;}if(B){g(C);}else{f(C);}}a.on('paste',function(e){var A=new Date().getTime();var B=t(e);var C=new Date().getTime()-A;var F=(new Date().getTime()-k-C)<1000;var G=s.pasteFormat=="text"||c;c=false;if(e.isDefaultPrevented()||v(e)){r();return;}if(u(e)){r();return;}if(!F){e.preventDefault();}if(E.ie&&(!F||e.ieFake)){h();a.dom.bind(p,'paste',function(e){e.stopPropagation();});a.getDoc().execCommand('Paste',false,null);B["text/html"]=j();}if(x(B,'text/html')){e.preventDefault();i(B,F,G);}else{D.setEditorTimeout(a,function(){i(B,F,G);},0);}});a.on('dragstart dragend',function(e){d=e.type=='dragstart';});a.on('drop',function(e){var A=w(e);if(e.isDefaultPrevented()||d){return;}if(u(e,A)){return;}if(A&&a.settings.paste_filter_drop!==false){var B=q(e.dataTransfer);var C=B['mce-internal']||B['text/html']||B['text/plain'];if(C){e.preventDefault();a.undoManager.transact(function(){if(B['mce-internal']){a.execCommand('Delete');}a.selection.setRng(A);C=U.trimHtml(C);if(!B['text/html']){g(C);}else{f(C);}});}}});a.on('dragover dragend',function(e){if(a.settings.paste_data_images){e.preventDefault();}});}s.pasteHtml=f;s.pasteText=g;a.on('preInit',function(){z();a.parser.addNodeFilter('img',function(e,A,B){function C(B){return B.data&&B.data.paste===true;}function F(J){if(!J.attr('data-mce-object')&&I!==E.transparentSrc){J.remove();}}function G(I){return I.indexOf("webkit-fake-url")===0;}function H(I){return I.indexOf("data:")===0;}if(!a.settings.paste_data_images&&C(B)){var i=e.length;while(i--){var I=e[i].attributes.map.src;if(!I){continue;}if(G(I)){F(e[i]);}else if(!a.settings.allow_html_data_urls&&H(I)){F(e[i]);}}}});});};});
