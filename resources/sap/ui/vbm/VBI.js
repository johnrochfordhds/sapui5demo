/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(['jquery.sap.global','./library','sap/ui/core/Control','sap/ui/core/IconPool','sap/ui/thirdparty/jqueryui/jquery-ui-widget','sap/ui/thirdparty/jqueryui/jquery-ui-core','sap/ui/thirdparty/jqueryui/jquery-ui-mouse','sap/ui/thirdparty/jqueryui/jquery-ui-draggable','./lib/sapvbi'],function(q,l,C,I,j,a,b,c,s){"use strict";var V=C.extend("sap.ui.vbm.VBI",{metadata:{library:"sap.ui.vbm",properties:{width:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:'800px'},height:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:'600px'},config:{type:"object",group:"Misc",defaultValue:null},plugin:{type:"boolean",group:"Misc",defaultValue:false}},events:{submit:{parameters:{data:{type:"string"}}},thumbnailClick:{parameters:{pos:{type:"string"},zoomLevel:{type:"int"}}},render:{parameters:{canvas:{type:"object"}}},changeTrackingMode:{parameters:{mode:{type:"int"},bSet:{type:"boolean"}}},zoom:{parameters:{canvas:{type:"object"}}},move:{parameters:{canvas:{type:"object"}}},openWindow:{parameters:{contentarea:{type:"object"},id:{type:"string"}}},closeWindow:{parameters:{contentarea:{type:"object"},id:{type:"string"}}}}}});V.RttMap={};V.prototype.exit=function(){if(this.getPlugin()){var p=this.getPlugInControl();if(p){p.OnSubmit=null;}}else if(this.mVBIContext){this.mVBIContext.clear();}if(this.resizeID!=""){sap.ui.core.ResizeHandler.deregister(this.resizeID);this.resizeID="";}};V.prototype.resize=function(e){var d=(this.oControl!=undefined)?this.oControl:this;var f=d.mVBIContext;if(f){var g=f.GetMainScene();if(g){g.resizeCanvas(e);}if(f.m_Windows){f.m_Windows.NotifyResize();}}};V.prototype.init=function(){this.m_aLoadQueue=null;if(!this.getPlugin()){this.mVBIContext=new VBI.VBIContext(this);}this.resizeID="";};V.prototype.loadNative=function(d){var f=this.getId();var g=document.getElementById('VBI'+f);if(!g){return;}var h=function(i){try{var D;if((D=JSON.parse(i))){var v=D.SAPVB;var t=JSON.stringify(v,null,'  ');this.fireSubmit({data:t});}}catch(e){if(VBI.m_bTrace){VBI.Trace("Error submitting plugin event");}}};if(q.type(d)=='object'){var t=JSON.stringify(d,null,'  ');try{g.Load(t);g.OnSubmit=h.bind(this);}catch(e){}}else if(q.type(d)=='string'){try{g.Load(d);g.OnSubmit=h.bind(this);}catch(e){}}};V.prototype.loadHtml=function(d){var e=this.getId();var f=null;if(typeof d=='string'){f=JSON.parse(d.indexOf('{')?d.substr(d.indexOf('{')):d);}else if(typeof d=='object'){f=d;}if(!f){return;}if(!f["SAPVB"]){var m;if(this.mVBIContext&&(m=(new VBI.Adaptor(this.mVBIContext)).CreateLoadData(f))){this.loadHtml(m);return;}else{return;}}var M=false;var g=false;var h=false;var i=false;if(q.type(f)=='object'){if(f.SAPVB){if(f.SAPVB.Config){this.mVBIContext.GetConfig().load(f.SAPVB.Config,this.mVBIContext);}if(f.SAPVB.Resources){this.mVBIContext.GetResources().load(f.SAPVB.Resources,this.mVBIContext);}if(f.SAPVB.DataTypes){if(!this.mVBIContext.m_DataTypeProvider){this.mVBIContext.m_DataTypeProvider=new VBI.DataTypeProvider();}this.mVBIContext.m_DataTypeProvider.load(f.SAPVB.DataTypes,this.mVBIContext);}if(f.SAPVB.Data){if(!this.mVBIContext.m_DataProvider){this.mVBIContext.m_DataProvider=new VBI.DataProvider();}this.mVBIContext.m_DataProvider.load(f.SAPVB.Data,this.mVBIContext);M=true;}if(f.SAPVB.MapProviders){if(!this.mVBIContext.m_MapProviders){this.mVBIContext.m_MapProviders=new VBI.MapProviders();}this.mVBIContext.m_MapProviders.load(f.SAPVB.MapProviders,this.mVBIContext);}if(f.SAPVB.MapLayerStacks){if(!this.mVBIContext.m_MapLayerStackManager){this.mVBIContext.m_MapLayerStackManager=new VBI.MapLayerStackManager(this.mVBIContext);}this.mVBIContext.m_MapLayerStackManager.load(f.SAPVB.MapLayerStacks,this.mVBIContext);}if(f.SAPVB.Windows){if(!this.mVBIContext.m_Windows){this.mVBIContext.m_Windows=new VBI.Windows();}this.mVBIContext.m_Windows.load(f.SAPVB.Windows,this.mVBIContext);h=true;}if(f.SAPVB.Actions){if(!this.mVBIContext.m_Actions){this.mVBIContext.m_Actions=new VBI.Actions();}this.mVBIContext.m_Actions.load(f.SAPVB.Actions,this.mVBIContext);}if(f.SAPVB.Automation){if(!this.mVBIContext.m_Automations){this.mVBIContext.m_Automations=new VBI.Automations();}this.mVBIContext.m_Automations.load(f.SAPVB.Automation,this.mVBIContext);}if(f.SAPVB.Menus){if(!this.mVBIContext.m_Menus){this.mVBIContext.m_Menus=new VBI.Menus();}this.mVBIContext.m_Menus.load(f.SAPVB.Menus,this.mVBIContext);}if(f.SAPVB.Clustering){if(!this.mVBIContext.m_Clustering){this.mVBIContext.m_Clustering=new VBI.Clustering();}this.mVBIContext.m_Clustering.load(f.SAPVB.Clustering,this.mVBIContext);i=true;}if(f.SAPVB.Scenes){if(!this.mVBIContext.m_SceneManager){this.mVBIContext.m_SceneManager=new VBI.SceneManager();}this.mVBIContext.m_SceneManager.load(f.SAPVB.Scenes,this.mVBIContext);g=true;}}if(M){if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.NotifyDataChange();}}if(g||h){if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.Awake(e);}}if(g||M||i){if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.RenderAsync();}}}};V.prototype.load=function(d){if(!this.isRendered()){if(!this.m_aLoadQueue){this.m_aLoadQueue=[];}this.m_aLoadQueue.push(d);return;}if(this.getPlugin()){this.loadNative(d);}else{this.loadHtml(d);}if(this.resizeID==""&&this.mVBIContext.GetMainScene()){this.resize();this.resizeID=sap.ui.core.ResizeHandler.register(this,this.resize);}};
/**
	 * Returns a Screenshot of the Overlay. Please note that the map cannot be included due to browser restrictions. Function returns the visible part
	 * of the Canvas excluding map, copyright info, navigation control, scaler, legend, detail windows, container elements. Analytic Maps are returned
	 * as they are not treated as "maps" internally. Modes 2 & 3 are experimental, trying to load the map (this may work on inhouse servers with
	 * adapted settings, standard configurations should fail)
	 * 
	 * @param {int} [iMode] 0: Overlay only; 1 (default) and 3: include Labels; 2 and 3: try to include maps (will return "" if not possible)
	 * @returns {string} Base64 encoded picture (PNG format) on success, "" otherwise
	 * @public
	 * @ui5-metamodel This method also will be described in the UI5 (legacy) designtime metamodel
	 */
V.prototype.getPicOfOverlay=function(m){var d=this.mVBIContext.GetMainScene();if(!(d&&d.GetOverlayPicture)){return"";}return d.GetOverlayPicture(m);};V.prototype.minimize=function(n,N,f,F,d,e,g,t){var v=this.mVBIContext;if(!v.moThumbnail){v.moThumbnail={bThumbnailed:false};}var h=v.moThumbnail;h.nThumbWidth=n;h.nThumbHeight=N;h.strFont=d;h.strCol=e;h.nFontPos=g;h.strText=t;if(f){h.nFullWidth=f;}if(F){h.nFullHeight=F;}var i=v.GetMainScene();if(i){v.DoMinimize(i);}};V.prototype.maximize=function(f,F){var d=this.mVBIContext.GetMainScene();if(d&&this.mVBIContext.moThumbnail){var n,e;if(f){n=String(f)+"px";}else{n=this.mVBIContext.moThumbnail.strOrgWidth?this.mVBIContext.moThumbnail.strOrgWidth:this.getWidth();}if(F){e=String(F)+"px";}else{e=this.mVBIContext.moThumbnail.strOrgHeight?this.mVBIContext.moThumbnail.strOrgHeight:this.getHeight();}this.mVBIContext.m_bThumbnail=false;this.setWidth(n);this.setHeight(e);d.m_Ctx.moThumbnail=undefined;d.resizeCanvas(0);}};V.prototype.zoomToGeoPosition=function(L,f,i){var d=null;if((d=this.mVBIContext.GetMainScene())){if(q.type(L)=='array'&&q.type(f)=='array'){if(L.length>1&&f.length>1){d.ZoomToMultiplePositions(L,f);}else{d.ZoomToGeoPosition(VBI.MathLib.DegToRad([parseFloat(L[0]),parseFloat(f[0])]),parseFloat(i));}}else{d.ZoomToGeoPosition(VBI.MathLib.DegToRad([parseFloat(L),parseFloat(f)]),parseFloat(i));}}};V.prototype.zoomToAreas=function(A,d){var e=null;if((e=this.mVBIContext.GetMainScene())){e.ZoomToAreas(A,d);}};V.prototype.getInfoForCluster=function(i,t){var d=null;if((d=this.mVBIContext.GetMainScene())){return d.getInfoForCluster(i,t);}return null;};V.prototype.onAfterRendering=function(){if(this.$oldContent.length>0){this.$().append(this.$oldContent);}if(this.m_aLoadQueue){var n;for(n=0;n<this.m_aLoadQueue.length;++n){this.load(this.m_aLoadQueue[n]);}this.m_aLoadQueue=null;}if(this.resizeID==""&&this.mVBIContext.GetMainScene()){this.resize();this.resizeID=sap.ui.core.ResizeHandler.register(this,this.resize);}var d=this.getId();if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.Awake(d);}};V.prototype.onBeforeRendering=function(){this.$oldContent=sap.ui.core.RenderManager.findPreservedContent(this.getId());};V.prototype.isRendered=function(){return this.getDomRef()?true:false;};V.prototype.getPlugInControl=function(){var d=this.getId();var e=document.getElementById('VBI'+d);return e?e:null;};V.prototype.setConfig=function(d){return this.load(d);};V.prototype.setWidth=function(v){if(typeof v==='number'){this.setProperty("width",parseInt(v,10).toString()+"px");}else{this.setProperty("width",v);}};V.prototype.setHeight=function(v){if(typeof v==='number'){this.setProperty("height",parseInt(v,10).toString()+"px");}else{this.setProperty("height",v);}};return V;});
