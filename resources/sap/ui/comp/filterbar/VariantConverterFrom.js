/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/smartfilterbar/ControlConfiguration','sap/ui/comp/valuehelpdialog/ValueHelpDialog','sap/m/MultiComboBox','sap/m/MultiInput','sap/m/DatePicker','sap/m/DateRangeSelection'],function(q,C,V,M,a,D,b){"use strict";var c=function(){};c.prototype.convert=function(s,f){var o=null,r=null;var S;if(s){S=JSON.parse(s);if(f&&f.getFilterBarViewMetadata&&S&&(S.Parameters||S.SelectOptions)){o={};if(S.Parameters){this._addParameters(S.Parameters,f,o);}if(S.SelectOptions){this._addSelectOptions(S.SelectOptions,f,o);}r={payload:null,variantId:null};r.payload=JSON.stringify(o);if(S.SelectionVariantID){r.variantId=S.SelectionVariantID;}}}return r;};c.prototype.retrieveVariantId=function(s){var v=null;var S;if(s){S=JSON.parse(s);if(S&&S.SelectionVariantID){v=S.SelectionVariantID;}}return v;};c.prototype._getParameterMetaData=function(n,f){var i,j;var g;var F=f.getFilterBarViewMetadata();if(F){for(i=0;i<F.length;i++){g=F[i];for(j=0;j<g.fields.length;j++){if(n===g.fields[j].fieldName){return g.fields[j];}}}}return null;};c.prototype._addParameters=function(s,f,o){var i;var n,v;var F;for(i=0;i<s.length;i++){v=s[i].PropertyValue;n=s[i].PropertyName;F=this._getParameterMetaData(n,f);if(F){this._addAccordingMetaData(o,F,v);}else{q.sap.log.error("neither metadata nor custom information for filter '"+n+"'");}}};c.prototype._addSelectOptions=function(s,f,o){var i;var n,r;var F,d;for(i=0;i<s.length;i++){n=s[i].PropertyName;r=s[i].Ranges;F=this._getParameterMetaData(n,f);if(F){d=F.control;this._addRangesAccordingMetaData(o,F,r,d);}else{q.sap.log.error("neither metadata nor custom information for filter '"+name+"'");}}};c.prototype._addRangesAccordingMetaData=function(o,f,r,d,n){var i,O;var e=function(s,v){var I=s;if(s==="CP"){I=sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.Contains;if(v){var h=v.indexOf('*');var j=v.lastIndexOf('*');if((h===0)&&(j!==(v.length-1))){I=sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.EndsWith;v=v.substring(1,v.length);}else if((h!==0)&&(j===(v.length-1))){I=sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.StartsWith;v=v.substring(0,v.length-1);}else{v=v.substring(1,v.length-1);}}}return{op:I,v:v};};var g=function(F,r){var i,I,O;if(!o[F]){o[F]={ranges:[],items:[],value:null};}for(i=0;i<r.length;i++){O=e(r[i].Option,r[i].Low);I={"exclude":(r[i].Sign==="E"),"operation":O.op,"keyField":F,"value1":O.v,"value2":r[i].High};o[F].ranges.push(I);}};if(r&&r.length>0){if(f.isCustomFilterField){if(!o._CUSTOM){o._CUSTOM={};}o._CUSTOM[f.fieldName]=r[0].Low;return;}if(f.conditionType){g(f.fieldName,r);return;}if(f.filterRestriction===C.FILTERTYPE.single){if(!r[0].Low&&d&&(d instanceof D)){o[f.fieldName]=null;}else{o[f.fieldName]=r[0].Low;}}else if(f.filterRestriction===C.FILTERTYPE.interval){if(d&&(d instanceof b)){if(r[0].Low&&r[0].High){o[f.fieldName]={low:r[0].Low,high:r[0].High};}else if(r[0].Low&&!r[0].High){o[f.fieldName]={low:r[0].Low,high:r[0].Low};}else if(!r[0].Low&&r[0].High){o[f.fieldName]={low:r[0].High,high:r[0].High};}else{o[f.fieldName]={low:null,high:null};}}else{o[f.fieldName]={low:r[0].Low===undefined?null:r[0].Low,high:r[0].High===undefined?null:r[0].High};}}else if(f.filterRestriction===C.FILTERTYPE.multiple){o[f.fieldName]={ranges:[],items:[],value:null};if(d&&((d instanceof M)||(d instanceof a))){for(i=0;i<r.length;i++){O=e(r[i].Option,r[i].Low);if(O.op===sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.EQ){if(f.type==="Edm.DateTime"){o[f.fieldName].ranges.push({value1:O.v});}else{o[f.fieldName].items.push({key:O.v});}}}}else{g(f.fieldName,r);}}else{g(f.fieldName,r);}q.sap.log.warning("potential reduced information for filter '"+f.fieldName+"'");}else{q.sap.log.warning("no Ranges-section found for filter '"+f.fieldName+"'");}};c.prototype._addAccordingMetaData=function(o,f,v){var h=f.type==="Edm.DateTime"?"":v;var r=[{Sign:"I",Low:v,High:h,Option:"EQ"}];this._addRangesAccordingMetaData(o,f,r);};return c;},true);
