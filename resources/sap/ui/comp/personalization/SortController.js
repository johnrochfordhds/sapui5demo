/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','./BaseController','sap/m/library','./Util'],function(q,B,l,U){"use strict";var S=B.extend("sap.ui.comp.personalization.SortController",{constructor:function(i,s){B.apply(this,arguments);this.setType(sap.m.P13nPanelType.sort);},metadata:{events:{afterSortModelDataChange:{}}}});S.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);if(t instanceof sap.ui.table.Table){t.detachSort(this._onSort,this);t.attachSort(this._onSort,this);}};S.prototype.getTitleText=function(){return sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("PERSODIALOG_TAB_SORT");};S.prototype._getTable2Json=function(){var j=this.createPersistentStructure();var t=this.getTable();U.createSort2Json(t,j.sort.sortItems,this.getIgnoreColumnKeys());return j;};S.prototype.syncTable2TransientModel=function(){var t=this.getTable();var i=[];if(t){if(t instanceof sap.ui.table.Table){t.getColumns().forEach(function(c){if(U.isColumnIgnored(c,this.getIgnoreColumnKeys())){return;}if(U.isSortable(c)){i.push({columnKey:U.getColumnKey(c),text:c.getLabel().getText(),tooltip:(c.getTooltip()instanceof sap.ui.core.TooltipBase)?c.getTooltip().getTooltip_Text():c.getTooltip_Text()});}},this);}else if(t instanceof sap.m.Table){t.getColumns().forEach(function(c){if(U.isColumnIgnored(c,this.getIgnoreColumnKeys())){return;}if(U.isSortable(c)){i.push({columnKey:U.getColumnKey(c),text:c.getHeader().getText(),tooltip:(c.getHeader().getTooltip()instanceof sap.ui.core.TooltipBase)?c.getHeader().getTooltip().getTooltip_Text():c.getHeader().getTooltip_Text()});}},this);}else if(t instanceof sap.ui.comp.personalization.ChartWrapper){t.getColumns().forEach(function(c){if(U.isColumnIgnored(c,this.getIgnoreColumnKeys())){return;}i.push({columnKey:U.getColumnKey(c),text:c.getLabel(),tooltip:(c.getTooltip()instanceof sap.ui.core.TooltipBase)?c.getTooltip().getTooltip_Text():c.getTooltip_Text()});},this);}}U.sortItemsByText(i);i.splice(0,0,{key:null,text:sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("P13NDIALOG_SELECTION_NONE")});var I=this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.sort.items;if(q(i).not(I).length!==0||q(I).not(i).length!==0){this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.sort.items=i;}};S.prototype._onSort=function(e){e.preventDefault();var a=e.mParameters.columnAdded;var t=this.getTable();if(typeof t==="string"){t=sap.ui.getCore().byId(t);}this.fireBeforePotentialTableChange();if(!a){t.getColumns().forEach(function(c,b){if(c.setSorted){c.setSorted(false);}},this);}var c=e.mParameters.column;if(c&&c.setSorted){c.setSorted(true);c.setSortOrder(e.mParameters.sortOrder);}var s=this.getModel("$sapuicomppersonalizationBaseController").getData().persistentData.sort;if(!a){s.sortItems=[];}var i=U.getIndexByKey(s.sortItems,U.getColumnKey(c));if(i>-1){s.sortItems.splice(i,1);}s.sortItems.push({columnKey:U.getColumnKey(c),operation:e.mParameters.sortOrder});this.fireAfterPotentialTableChange();this.fireAfterSortModelDataChange();};S.prototype._hasTableSortableColumns=function(){var t=this.getTable();if(!t){return false;}var h=false;t.getColumns().some(function(c){if(U.isSortable(c)){h=true;return true;}});return h;};S.prototype.getPanel=function(){sap.ui.getCore().loadLibrary("sap.m");q.sap.require("sap/m/P13nSortPanel");q.sap.require("sap/m/P13nItem");q.sap.require("sap/m/P13nSortItem");if(!this._hasTableSortableColumns()){return null;}var t=this;var p=new sap.m.P13nSortPanel({title:this.getTitleText(),containerQuery:true,items:{path:"$sapmP13nPanel>/transientData/sort/items",template:new sap.m.P13nItem({columnKey:"{$sapmP13nPanel>columnKey}",text:"{$sapmP13nPanel>text}",tooltip:"{$sapmP13nPanel>tooltip}",maxLength:"{$sapmP13nPanel>maxlength}",type:"{$sapmP13nPanel>type}"})},sortItems:{path:"$sapmP13nPanel>/persistentData/sort/sortItems",template:new sap.m.P13nSortItem({columnKey:"{$sapmP13nPanel>columnKey}",operation:"{$sapmP13nPanel>operation}"})},beforeNavigationTo:t.setModelFunction()});p.attachAddSortItem(function(e){var d=this.getModel("$sapuicomppersonalizationBaseController").getData();var a=e.getParameters();var s={columnKey:a.sortItemData.getColumnKey(),operation:a.sortItemData.getOperation()};if(a.index>-1){d.persistentData.sort.sortItems.splice(a.index,0,s);}else{d.persistentData.sort.sortItems.push(s);}this.getModel("$sapuicomppersonalizationBaseController").setData(d,true);},this);p.attachRemoveSortItem(function(e){var a=e.getParameters();var d=this.getModel("$sapuicomppersonalizationBaseController").getData();if(a.index>-1){d.persistentData.sort.sortItems.splice(a.index,1);this.getModel("$sapuicomppersonalizationBaseController").setData(d,true);}},this);return p;};S.prototype.syncJsonModel2Table=function(j){var t=this.getTable();var c=t.getColumns();var C=q.extend(true,[],c);this.fireBeforePotentialTableChange();if(t instanceof sap.ui.table.Table){j.sort.sortItems.forEach(function(s){var o=U.getColumn(s.columnKey,c);if(!o){return;}if(!o.getSorted()){o.setSorted(true);}if(o.getSortOrder()!==s.operation){o.setSortOrder(s.operation);}C.splice(C.indexOf(o),1);});C.forEach(function(o){if(o&&o.getSorted()){o.setSorted(false);}});}this.fireAfterPotentialTableChange();};S.prototype.getChangeType=function(p,P){if(!P||!P.sort||!P.sort.sortItems){return sap.ui.comp.personalization.ChangeType.Unchanged;}var i=JSON.stringify(p.sort.sortItems)!==JSON.stringify(P.sort.sortItems);return i?sap.ui.comp.personalization.ChangeType.ModelChanged:sap.ui.comp.personalization.ChangeType.Unchanged;};S.prototype.getChangeData=function(p,P){if(!p||!p.sort||!p.sort.sortItems){return{sort:{sortItems:[]}};}if(!P||!P.sort||!P.sort.sortItems){return{sort:U.copy(p.sort)};}if(JSON.stringify(p.sort.sortItems)!==JSON.stringify(P.sort.sortItems)){return{sort:U.copy(p.sort)};}return null;};S.prototype.getUnionData=function(p,P){if(!P||!P.sort||!P.sort.sortItems){return{sort:U.copy(p.sort)};}return{sort:U.copy(P.sort)};};S.prototype.exit=function(){B.prototype.exit.apply(this,arguments);var t=this.getTable();if(t&&t instanceof sap.ui.table.Table){t.detachSort(this._onSort,this);}};return S;},true);
