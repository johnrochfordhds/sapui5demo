/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/m/CheckBox','sap/m/ComboBox','sap/m/DatePicker','sap/m/TimePicker','sap/m/HBox','sap/m/Input','sap/m/Text','sap/ui/comp/navpopover/SmartLink','sap/ui/comp/odata/MetadataAnalyser','sap/ui/comp/smartfield/ODataHelper','sap/ui/comp/smartfield/SmartField','sap/ui/comp/odata/ODataType','sap/ui/comp/util/FormatUtil'],function(q,C,a,D,T,H,I,b,S,M,O,c,d,F){"use strict";var e=function(p){if(p){this._oParentODataModel=p.model;this._oMetadataAnalyser=p.metadataAnalyser;this._aODataFieldMetadata=p.fieldsMetadata;this._oDateFormatSettings=p.dateFormatSettings;this._bEnableDescriptions=p.enableDescriptions;this._oCurrencyFormatSettings=p.currencyFormatSettings;this._oDefaultDropDownDisplayBehaviour=p.defaultDropDownDisplayBehaviour||"descriptionAndId";this.useSmartField=p.useSmartField==="true";this._sEntitySet=p.entitySet;}if(!this._oMetadataAnalyser&&this._oParentODataModel){this._oMetadataAnalyser=new M(this._oParentODataModel);this._intialiseMetadata();}this._mSmartField={};this._oHelper=new O(this._oMetadataAnalyser.oModel);this._aValueListProvider=[];this._aValueHelpProvider=[];};e.prototype._intialiseMetadata=function(){if(!this._aODataFieldMetadata){this._aODataFieldMetadata=this._oMetadataAnalyser.getFieldsByEntitySetName(this.sEntity);}};e.prototype.getFieldViewMetadata=function(f,i){var o=this._createFieldMetadata(f);this._createFieldTemplate(o,i);return o;};e.prototype._createFieldTemplate=function(v,i){if(this.useSmartField){v.template=new c({value:{path:v.name},entitySet:this._sEntitySet,contextEditable:{path:"sm4rtM0d3l>/editable",mode:"OneWay"},controlContext:"table",wrapping:false});if(d.isNumeric(v.type)||d.isDateOrTime(v.type)){v.template.setTextAlign("End");v.template.setWidth("100%");}this._completeSmartField(v);v.template._setPendingEditState(i);}else{v.template=i?this._createEditableTemplate(v):this._createDisplayOnlyTemplate(v);}};e.prototype._completeSmartField=function(v){var o={annotations:{},path:v.name};if(!this._mSmartField.entitySetObject){this._mSmartField.entitySetObject=this._oHelper.oMeta.getODataEntitySet(this._sEntitySet);this._mSmartField.entityType=this._oHelper.oMeta.getODataEntityType(this._mSmartField.entitySetObject.entityType);}o.modelObject=this._oParentODataModel;o.entitySetObject=this._mSmartField.entitySetObject;o.entitySet=this._mSmartField.entitySetObject;o.entityType=this._mSmartField.entityType;this._oHelper.getProperty(o);o.annotations.uom=this._oHelper.getUnitOfMeasure2(o);o.annotations.text=this._oHelper.getTextProperty2(o);o.annotations.lineitem=this._oMetadataAnalyser.getLineItemAnnotation(o.entitySetObject.entityType);o.annotations.semantic=this._oMetadataAnalyser.getSemanticObjectAnnotationFromProperty(o.property.property);this._oHelper.getUOMTextAnnotation(o);if(o.property.property["sap:value-list"]||o.property.property["com.sap.vocabularies.Common.v1.ValueList"]){o.annotations.valuelist=this._oHelper.getValueListAnnotationPath(o);if(o.property.property["sap:value-list"]){o.annotations.valuelistType=o.property.property["sap:value-list"];}else{o.annotations.valuelistType=this._oMetadataAnalyser.getValueListSemantics(o.property.property["com.sap.vocabularies.Common.v1.ValueList"]);}}this._oHelper.getUOMValueListAnnotationPath(o);delete o.entitySet;v.template.data("configdata",{"configdata":o});v.template.data("dateFormatSettings",this._oDateFormatSettings);v.template.data("currencyFormatSettings",this._oCurrencyFormatSettings);v.template.data("defaultDropDownDisplayBehaviour",this._oDefaultDropDownDisplayBehaviour);if(o.annotations.uom||d.isNumeric(v.type)||d.isDateOrTime(v.type)){var A=v.template.getTextAlign();if(A==="Initial"){A="End";}v.align=A;v.textDirection="LTR";}};e.prototype._createEditableTemplate=function(v,B){var t=null,f,o,g;if(v.type==="Edm.DateTime"||v.type==="Edm.DateTimeOffset"){if(v.displayFormat==="Date"){f=this._oDateFormatSettings;o={displayFormat:"Date"};t=new D({dateValue:{path:v.name}});}}else if(v.type==="Edm.Boolean"){t=new C({selected:{path:v.name}});}else if(v.type==="Edm.Decimal"){o={precision:v.precision,scale:v.scale};}g=d.getType(v.type,f,o);if(v.semanticObject&&(!B)){t=this._createSmartLinkFieldTemplate(v,g,function(){var i=this._createEditableTemplate(v,true);if(i.setWrapping&&v.template&&v.template.getWrapping){i.setWrapping(v.template.getWrapping());}return i;}.bind(this));}if(!t){if(v.type==="Edm.Time"){t=new T({value:{path:v.name,type:g}});}else{t=new I({value:{path:v.name,type:g}});if(v.isMeasureField){t.bindProperty("description",{path:v.unit});t.setTextAlign("End");t.setTextDirection("LTR");t.setFieldWidth("80%");}else if(this._bEnableDescriptions&&v.description){t.bindProperty("description",{path:v.description});}else if(d.isNumeric(v.type)||d.isDateOrTime(v.type)){t.setTextAlign("End");t.setTextDirection("LTR");}if(v.hasValueListAnnotation){this._associateValueHelpAndSuggest(t,v);}}}return t;};e.prototype._associateValueHelpAndSuggest=function(o,f){o.setShowValueHelp(true);this._aValueHelpProvider.push(new sap.ui.comp.providers.ValueHelpProvider({loadAnnotation:true,fullyQualifiedFieldName:f.fullName,metadataAnalyser:this._oMetadataAnalyser,control:o,model:this._oParentODataModel,preventInitialDataFetchInValueHelpDialog:true,dateFormatSettings:this._oDateFormatSettings,takeOverInputValue:false,fieldName:f.fieldName,type:f.type,maxLength:f.maxLength,displayFormat:f.displayFormat,displayBehaviour:f.displayBehaviour,title:f.label}));o.setShowSuggestion(true);o.setFilterSuggests(false);this._aValueListProvider.push(new sap.ui.comp.providers.ValueListProvider({loadAnnotation:true,fullyQualifiedFieldName:f.fullName,metadataAnalyser:this._oMetadataAnalyser,control:o,model:this._oParentODataModel,dateFormatSettings:this._oDateFormatSettings,typeAheadEnabled:true,aggregation:"suggestionRows",displayFormat:f.displayFormat,displayBehaviour:f.displayBehaviour}));};e.prototype._createDisplayOnlyTemplate=function(v,B){var t=null,o=null,f,g,A,s,h;if(v.displayFormat==="Date"){f=this._oDateFormatSettings;g={displayFormat:"Date"};}else if(v.type==="Edm.Decimal"){g={precision:v.precision,scale:v.scale};}o=d.getType(v.type,f,g);if(d.isNumeric(v.type)||d.isDateOrTime(v.type)){A="End";}if(v.isMeasureField){v.textDirection="LTR";t=this._createMeasureFieldTemplate(v,o);}else if(v.semanticObject&&(!B)){t=this._createSmartLinkFieldTemplate(v,o,function(){var i=this._createDisplayOnlyTemplate(v,true);if(i.setWrapping&&v.template&&v.template.getWrapping){i.setWrapping(v.template.getWrapping());}return i;}.bind(this));}else{h={path:v.name,type:o};if(this._bEnableDescriptions&&v.description){s=v.displayBehaviour;h={parts:[{path:v.name,type:o},{path:v.description}],formatter:function(i,j){return F.getFormattedExpressionFromDisplayBehaviour(s,i,j);}};}t=new b({wrapping:false,textAlign:A,textDirection:A==="End"?"LTR":undefined,text:h});}v.align=A;return t;};e.prototype._createSmartLinkFieldTemplate=function(v,t,f){var B={path:v.name,type:t};if(this._bEnableDescriptions&&v.description){B={parts:[{path:v.name,type:t},{path:v.description}],formatter:function(i,s){return F.getFormattedExpressionFromDisplayBehaviour(v.displayBehaviour,i,s);}};}var o=new S({semanticObject:v.semanticObject,semanticObjectLabel:v.label,fieldName:v.name,text:B});o.setCreateControlCallback(f);return o;};e.prototype._createMeasureFieldTemplate=function(v,t){var o,V,u,E=false;E=!!(v.isCurrencyField&&this._oCurrencyFormatSettings&&this._oCurrencyFormatSettings.showCurrencySymbol);V=new b({wrapping:false,textAlign:"End",text:{parts:[{path:v.name,type:t},{path:v.unit}],formatter:v.isCurrencyField?F.getAmountCurrencyFormatter():F.getMeasureUnitFormatter(),useRawValues:v.isCurrencyField}});u=new b({wrapping:false,textAlign:"Begin",width:"2.5em",text:{path:v.unit,formatter:E?F.getCurrencySymbolFormatter():undefined}});o=new H({justifyContent:"End",items:[V,u]});o.addStyleClass("sapUiCompUOMInTableLTR");return o;};e.prototype._createFieldMetadata=function(f){var o=q.extend({},f);o.label=f.fieldLabel||f.name;o.quickInfo=f.quickInfo||o.label;o.displayBehaviour=o.displayBehaviour||this._oDefaultDropDownDisplayBehaviour;o.filterType=this._getFilterType(f);this._updateValueListMetadata(o,f);this._setAnnotationMetadata(o);return o;};e.prototype._updateValueListMetadata=function(f,o){f.hasValueListAnnotation=o["sap:value-list"]!==undefined;if(f.hasValueListAnnotation){f.hasFixedValues=o["sap:value-list"]==="fixed-values";}else if(o["com.sap.vocabularies.Common.v1.ValueList"]){f.hasValueListAnnotation=true;f.hasFixedValues=this._oMetadataAnalyser.getValueListSemantics(o["com.sap.vocabularies.Common.v1.ValueList"])==="fixed-values";}};e.prototype._setAnnotationMetadata=function(f){var A=null;if(!this.useSmartField&&f&&f.fullName){A=this._oMetadataAnalyser.getSemanticObjectAnnotation(f.fullName);if(A){f.semanticObject=A.semanticObject;}}};e.prototype._getFilterType=function(f){if(d.isNumeric(f.type)){return"numeric";}else if(f.type==="Edm.DateTime"&&f.displayFormat==="Date"){return"date";}else if(f.type==="Edm.String"){return"string";}else if(f.type==="Edm.Boolean"){return"boolean";}else if(f.type==="Edm.Time"){return"time";}return undefined;};e.prototype.destroy=function(){var i;if(this._oMetadataAnalyser&&this._oMetadataAnalyser.destroy){this._oMetadataAnalyser.destroy();}this._oMetadataAnalyser=null;if(this._aValueHelpProvider){i=this._aValueHelpProvider.length;while(i--){this._aValueHelpProvider[i].destroy();}}this._aValueHelpProvider=null;if(this._aValueListProvider){i=this._aValueListProvider.length;while(i--){this._aValueListProvider[i].destroy();}}if(this._oHelper){this._oHelper.destroy();}this._oHelper=null;this._mSmartField=null;this._aValueListProvider=null;this._aODataFieldMetadata=null;this._oCurrencyFormatter=null;this.bIsDestroyed=true;};return e;},true);
