/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/EventProvider','sap/ui/comp/smartfilterbar/ControlConfiguration','sap/ui/model/type/Date','sap/ui/comp/odata/MetadataAnalyser','sap/ui/comp/util/FormatUtil'],function(q,E,C,D,M,F){"use strict";var B=E.extend("sap.ui.comp.providers.BaseValueListProvider",{constructor:function(p){E.call(this);this.sFieldName=p.fieldName;this.oControl=p.control;this.sValueListEntitySetName=null;this.sValueListEntityName=null;this.oODataModel=p.model;this.oFilterModel=p.filterModel;this.oFilterProvider=p.filterProvider;this.sDisplayFormat=p.displayFormat;this._oDateFormatSettings=p.dateFormatSettings;this.bResolveInOutParams=(p.resolveInOutParams===false)?false:true;this.sDisplayBehaviour=p.displayBehaviour;this.sDDLBDisplayBehaviour=this.sDisplayBehaviour;if(!this.sDDLBDisplayBehaviour||this.sDDLBDisplayBehaviour===C.DISPLAYBEHAVIOUR.auto){this.sDDLBDisplayBehaviour=this.oFilterProvider?this.oFilterProvider.sDefaultDropDownDisplayBehaviour:C.DISPLAYBEHAVIOUR.descriptionOnly;}this.sPropertyTypePath="";if(this.bResolveInOutParams&&!this.oFilterModel&&!this.oFilterProvider){this._resolvePropertyPath();}if(p.loadAnnotation&&p.fullyQualifiedFieldName){this._oMetadataAnalyser=p.metadataAnalyser;if(!this._oMetadataAnalyser){this._oMetadataAnalyser=new M(this.oODataModel);this._bCleanupMetadataAnalyser=true;}this._oMetadataAnalyser.getValueListAnnotationLazy(p.fullyQualifiedFieldName).then(this._onAnnotationLoad.bind(this),function(e){this._oError=e;this.bInitialised=true;q.sap.log.debug(e);}.bind(this));}else{this._onAnnotationLoad({primaryValueListAnnotation:p.annotation,additionalAnnotations:p.additionalAnnotations});}if(!sap.ui.comp.smartfilterbar||!sap.ui.comp.smartfilterbar.FilterProvider){q.sap.require("sap.ui.comp.smartfilterbar.FilterProvider");}}});B.prototype.attachValueListChanged=function(f,l){this.attachEvent("valueListChanged",f,l);};B.prototype.detachValueListChanged=function(f,l){this.detachEvent("valueListChanged",f,l);};B.prototype._onAnnotationLoad=function(v){this.oPrimaryValueListAnnotation=v.primaryValueListAnnotation;this.additionalAnnotations=v.additionalAnnotations;this._resolveAnnotationData(this.oPrimaryValueListAnnotation);this.bInitialised=true;if(this.sAggregationName&&!this.bTypeAheadEnabled){this.oControl.rerender();}};B.prototype._resolvePropertyPath=function(){var b=this.oControl.getBindingInfo("value"),p,P,a;if(b&&b.parts){p=b.parts[0]?b.parts[0].path:"";}if(p){a=p.split("/");if(a.length>1){P=a[a.length-1];this.sPropertyTypePath=p.replace("/"+P,"");}}};B.prototype._resolveAnnotationData=function(a){var l=0,i=0,c,f,t,T;if(this.oODataModel&&a){this.bSupportBasicSearch=a.isSearchSupported;this.sValueListTitle=a.valueListTitle||a.qualifier;this.sKey=a.keyField;this._aKeys=a.keys;this.sValueListEntitySetName=a.valueListEntitySetName;this.sValueListEntityName=a.valueListEntityName;this.mInParams=a.inParams;this.mOutParams=a.outParams;this.sTokenDisplayBehaviour=this.sDisplayBehaviour;if(!this.sTokenDisplayBehaviour||this.sTokenDisplayBehaviour===C.DISPLAYBEHAVIOUR.auto){this.sTokenDisplayBehaviour=this.oFilterProvider?this.oFilterProvider.sDefaultTokenDisplayBehaviour:C.DISPLAYBEHAVIOUR.descriptionAndId;}if(!a.descriptionField){this.sTokenDisplayBehaviour=C.DISPLAYBEHAVIOUR.idOnly;}this.sDescription=a.descriptionField||this.sKey;if(this.sValueListEntitySetName&&this.sKey){this._aCols=[];this.aSelect=[];c=a.valueListFields;l=c.length;for(i=0;i<l;i++){f=c[i];t=null;T=null;if(f.type==="Edm.Boolean"){t="boolean";}else if(f.type==="Edm.DateTime"&&f.displayFormat==="Date"){t="date";T=new D();}else if(f.type==="Edm.Decimal"){t="decimal";T=new sap.ui.model.type.Float();}else if(f.type==="Edm.String"){t="string";}this._aCols.push({label:f.fieldLabel,type:t,oType:T,width:F.getWidth(f,15),template:f.name});this.aSelect.push(f.name);}if(a.descriptionField){this.aSelect.push(a.descriptionField);}}}};B.prototype._calculateFilterInputData=function(){var l,v,d=null;delete this.mFilterInputData;if(this.oFilterProvider&&this.oFilterProvider._oSmartFilter){d=this.oFilterProvider._oSmartFilter.getFilterData();}else if(this.oFilterModel){d=this.oFilterModel.getData();}else if(this.oODataModel&&this.bResolveInOutParams){d=this.oODataModel.getData(this.sPropertyTypePath,this.oControl.getBindingContext());}if(this.mInParams&&d){this.mFilterInputData={};this.aFilterField=[];for(l in this.mInParams){if(l){v=this.mInParams[l];if(v!==this.sKey){if(d[l]){this.mFilterInputData[v]=d[l];this.aFilterField.push(v);}}}}}};B.prototype._calculateAndSetFilterOutputData=function(d){var l,v,f=null,o,e,n,i,a;if(this.mOutParams&&d&&(this.oFilterProvider||this.oFilterModel)){f={};a=function(b){return b.key===n.key;};for(l in this.mOutParams){if(l){v=this.mOutParams[l];if(v!==this.sKey){i=d.length;while(i--){o=d[i];if(o[v]){n={key:o[v]};if(!f[l]){if(!e&&this.oFilterModel){e=this.oFilterModel.getData();}if(e&&e[l]&&e[l].items){f[l]=e[l];}else{f[l]={items:[]};}}if(f[l].items.filter(a).length<=0){f[l].items.push(n);}}}}}}if(f){if(this.oFilterProvider){this.oFilterProvider.setFilterData(f);}else if(this.oFilterModel){this.oFilterModel.setData(f,true);}}}else if(this.oODataModel&&this.bResolveInOutParams){this._calculateAndSetODataModelOutputData(d[0]);}};B.prototype._calculateAndSetODataModelOutputData=function(d){var b,l,v,p,V,c={};if(d&&this.mOutParams){b=this.oControl.getBindingContext();for(l in this.mOutParams){if(l){v=this.mOutParams[l];if(v!==this.sKey){V=d[v];c[l]=V;p=this.sPropertyTypePath?this.sPropertyTypePath+"/"+l:l;this.oODataModel.setProperty(p,V,b,true);}}}if(c&&!q.isEmptyObject(c)){this.fireEvent("valueListChanged",{"changes":c});}}};B.prototype.destroy=function(){sap.ui.base.EventProvider.prototype.destroy.apply(this,arguments);if(this._bCleanupMetadataAnalyser&&this._oMetadataAnalyser){this._oMetadataAnalyser.destroy();}this._oMetadataAnalyser=null;this.oControl=null;this.sFieldName=null;this.mFilterInputData=null;this.aFilterField=null;this.sValueListEntitySetName=null;this.sValueListEntityName=null;this.oODataModel=null;this.oFilterModel=null;this.oFilterProvider=null;this.oPrimaryValueListAnnotation=null;this.additionalAnnotations=null;this.sDisplayFormat=null;this.bSupportBasicSearch=null;this.bInitialised=null;this._oError=null;this.sValueListTitle=null;this.sKey=null;this._aKeys=null;this.mInParams=null;this.mOutParams=null;this.sDescription=null;this.aSelect=null;this._aCols=null;this.sDDLBDisplayBehaviour=null;this.sTokenDisplayBehaviour=null;this._oDateFormatSettings=null;this.bIsDestroyed=true;};return B;},true);
