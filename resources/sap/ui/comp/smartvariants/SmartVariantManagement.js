/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/library','./PersonalizableInfo','sap/ui/comp/variants/VariantItem','sap/ui/comp/variants/VariantManagement','sap/ui/fl/Change','sap/ui/fl/Persistence','sap/ui/fl/registry/Settings','sap/ui/fl/Utils'],function(q,l,P,V,a,C,b,S,F){"use strict";var c=a.extend("sap.ui.comp.smartvariants.SmartVariantManagement",{metadata:{library:"sap.ui.comp",aggregations:{personalizableControls:{type:"sap.ui.comp.smartvariants.PersonalizableInfo",multiple:true,singularName:"personalizableControl"}},events:{initialise:{},afterSave:{}}},renderer:function(r,o){a.getMetadata().getRenderer().render(r,o);}});c.prototype.init=function(){a.prototype.init.apply(this);this._mStandardVariants={};this._mControlPersistence={};this._mControlComponent={};this._mControlPromise={};this._mCurrentVariantId={};this._aPersonalizableControls=null;this._bIsInitialized=false;if(this.setLifecycleSupport){this.setLifecycleSupport(true);}this._setBackwardCompatibility(false);};c.prototype.addPersonalizableControl=function(o){var d=null;var s=o.getControl();this.addAggregation("personalizableControls",o,true);if(s){d=sap.ui.getCore().byId(s);this._mControlPersistence[d]=new b(d,o.getKeyName());this._mControlComponent[d]=sap.ui.fl.Utils.getComponentClassName(d);}this._handleGetChanges(d);};c.prototype._handleGetChanges=function(o){var t=this;if(o&&this._mControlPersistence&&this._mControlPersistence[o]){this._mControlPromise[o]={};this._mControlPromise[o].promise=new Promise(function(r,d){t._mControlPersistence[o].getChanges().then(function(v){var s=t._mControlPersistence[o].getComponentName();var p={appDescriptor:F.getAppDescriptor(o),siteId:F.getSiteId(o)};sap.ui.fl.registry.Settings.getInstance(s,p).then(function(e){var R={variants:v,settings:e};r(R);});},function(e){d(e);});});}};c.prototype._createControlWrapper=function(o){var d=null;var e=sap.ui.getCore().byId(o.getControl());if(e){d={control:e,type:o.getType(),dataSource:o.getDataSource(),persistence:this._mControlPersistence[e],keyName:o.getKeyName()};if(this._mControlPromise[e]&&this._mControlPromise[e].promise){d.promise=this._mControlPromise[e].promise;}}return d;};c.prototype.getVariantContent=function(o,k){var d=null;if(k===this.STANDARDVARIANTKEY){d=this.getStandardVariant(o);}else{d=this._getVariantContent(o,k);}return d;};c.prototype._getVariant=function(o,i){var d=null;if(o){var p=this._mControlPersistence[o];if(p){d=p.getChange(i);}}return d;};c.prototype._getVariantContent=function(o,k){var d=null;var v=this._getVariant(o,k);if(v){d=v.getContent();}return d;};c.prototype._getAllPersonalizableControls=function(){var i;var o=null;if(!this._aPersonalizableControls){this._aPersonalizableControls=[];var p=this.getPersonalizableControls();if(p){for(i=0;i<p.length;i++){o=this._createControlWrapper(p[i]);if(o){this._aPersonalizableControls.push(o);}}}}return this._aPersonalizableControls;};c.prototype._createVariantEntries=function(v,o){var n=null;var s,d=null;var e,f;var g=[];this.removeAllItems();if(v){for(n in v){if(n){e=v[n];if(e.isVariant()){f=new V({key:e.getId(),text:e.getText("variantName"),global:!e.isUserDependent(),executeOnSelection:this._getExecuteOnSelection(e),lifecycleTransportId:e.getRequest(),lifecyclePackage:e.getPackage(),namespace:e.getNamespace(),readOnly:e.isReadOnly(),labelReadOnly:e.isLabelReadOnly()});if(this._hasStoredStandardVariant(e)){d=e.getId();}this.addVariantItem(f);g.push(e.getId());}}}}if(o){s=this._getDefaultVariantKey(o);if(s){this.setInitialSelectionKey(s);}var h=this._isApplicationVariant(o.control);if(h){this.setIndustrySolutionMode(h);h=F.isVendorLayer();this._setVendorLayer(h);}if(this.getIndustrySolutionMode()){if(o.standardvariantkey!==undefined){delete o.standardvariantkey;}if(d){o.standardvariantkey=d;this.setStandardVariantKey(d);}}}if(this._isVariantDownport(o)){this._enableManualVariantKey(true);}return g;};c.prototype.getVariantsInfo=function(f){if(!f){q.sap.log.error("'getVariantsInfo' failed . Expecting callBack not passed.");return;}var n=null;var v;var d=[];var e;var t=this;try{e=this._getAllPersonalizableControls();if(e&&(e.length===1)&&e[0].persistence&&e[0].control){e[0].persistence.getChanges().then(function(m){if(m){for(n in m){if(n){v=m[n];if(v.isVariant()){d.push({key:v.getId(),text:v.getText("variantName")});}}}}f(d);},function(h){var E="'getChanges' failed:";if(h&&h[0]&&h[0].messages&&h[0].messages[0]){E+=(' '+h[0].messages[0]);}t._setErrorValueState(t.oResourceBundle.getText("VARIANT_MANAGEMENT_READ_FAILED"),E,e[0].control);f(d);});}}catch(g){this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_READ_FAILED"),"'getChanges' throws an exception",null);}};c.prototype.getCurrentVariantId=function(){var k="";var i=this._getSelectedItem();if(i){k=i.getKey();if(k===this.STANDARDVARIANTKEY){k="";}}return k;};a.prototype.setCurrentVariantId=function(v,d){var o;var i=this._determineVariantId(v);var e=this._getAllPersonalizableControls();if(e&&(e.length===1)&&e[0].persistence&&e[0].control){if(!this._bIsInitialized){this._mCurrentVariantId[e[0].control]=v;}else{o=this.getVariantContent(e[0].control,i);if(o){this._setSelectionByKey(i);if(d!==true){this._applyVariant(e[0].control,o);}}}}};c.prototype._determineVariantId=function(v){var i=v;if(!i){i=this.getStandardVariantKey();}else{if(!this.getItemByKey(i)){i=this.getStandardVariantKey();}}return i;};c.prototype.initialise=function(){var t=this;var d;var o=null,e=null,v;var p={variantKeys:[]};var k;try{d=this._getAllPersonalizableControls();if(d&&(d.length===1)&&d[0].persistence&&d[0].control&&d[0].promise){d[0].promise.then(function(r){var m=r.variants;p.variantKeys=t._createVariantEntries(m,d[0]);var D=t._getDefaultVariantKey(d[0]);if(D){v=t._getVariant(d[0].control,D);if(v){t.setDefaultVariantKey(D);t.setInitialSelectionKey(D);}}var s=null;if(d[0].standardvariantkey){s=t._getVariantContent(d[0].control,d[0].standardvariantkey);}if(d[0].standardvariantkey&&((d[0].type==="table")||(d[0].type==="chart"))){e=s;t._applyVariant(d[0].control,e,"STANDARD",true);}t.fireEvent("initialise",p);t._bIsInitialized=true;if(!d[0].standardvariantkey){t._setStandardVariant(d[0]);}var g=t._mCurrentVariantId[d[0].control];if(g){k=t._determineVariantId(g);t.setInitialSelectionKey(k);t._mCurrentVariantId[d[0].control]=undefined;}k=t.getSelectionKey();if(k&&(k!==t.getStandardVariantKey())){o=t._getVariantContent(d[0].control,k);}else{if(d[0].standardvariantkey&&(!e)){o=s;}}if(d[0].standardvariantkey){t._updateStandardVariant(d[0].control,s);}if(o){t._applyVariant(d[0].control,o,null,true);}else{if((k===t.STANDARDVARIANTKEY)&&t.bExecuteOnSelectForStandard){if(d[0].control.search){t.setInitialSelectionKey(k);d[0].control.search();}}}},function(g){var E="'getChanges' failed:";if(g&&g[0]&&g[0].messages&&g[0].messages[0]){E+=(' '+g[0].messages[0]);}t._setErrorValueState(t.oResourceBundle.getText("VARIANT_MANAGEMENT_READ_FAILED"),E,d[0].control);t.fireEvent("initialise",p);t._setStandardVariant(d[0].control);});}else{this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_READ_FAILED"),"'initialise' no personalizable component available",null);this.fireEvent("initialise",p);if(d&&(d.length===1)&&d[0].control){this._setStandardVariant(d[0].control);}}}catch(f){this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_READ_FAILED"),"'getChanges' throws an exception",null);this.fireEvent("initialise",p);if(d&&(d.length===1)&&d[0].control){this._setStandardVariant(d[0].control);}}};c.prototype._updateVariant=function(v,o){if(this._isIndustrySolutionModeAndVendorLayer()||(v.key!==this.getStandardVariantKey())){if(v&&o&&o.control&&o.control.fetchVariant){var d=this._getVariant(o.control,v.key);if(d){try{if((v.lifecycleTransportId!==null)&&(v.lifecycleTransportId!==undefined)){d.setRequest(v.lifecycleTransportId);}var e=o.control.fetchVariant();if(e){var i=this.getItemByKey(v.key);if(i){e.executeOnSelection=i.getExecuteOnSelection();}if(e.standardvariant!==undefined){delete e.standardvariant;}if(this._isIndustrySolutionModeAndVendorLayer()&&(v.key===this.getStandardVariantKey())){e.standardvariant=true;}d.setContent(e);}}catch(f){q.sap.log.error("'_updateVariant' throws an exception");}}}}};c.prototype._newVariant=function(v,o){var i;if(v&&o&&o.control&&o.control.fetchVariant&&o.persistence){var t=o.type;var d=o.dataSource;var u=!v.global;var p="";if((v.lifecyclePackage!==null)&&(v.lifecyclePackage!==undefined)){p=v.lifecyclePackage;}var T="";if((v.lifecycleTransportId!==null)&&(v.lifecycleTransportId!==undefined)){T=v.lifecycleTransportId;}var e=o.control.fetchVariant();if(e){var s=JSON.stringify(e);e=JSON.parse(s);if(v.exe){e.executeOnSelection=v.exe;}if(v.tile){e.tile=v.tile;}if(e.standardvariant!==undefined){delete e.standardvariant;}if(this._isIndustrySolutionModeAndVendorLayer()&&v.key===this.STANDARDVARIANTKEY){e.standardvariant=true;}}i=this._isVariantDownport(o)?v.key:null;var m={type:t,ODataService:d,texts:{variantName:v.name},content:e,isVariant:true,packageName:p,isUserDependent:u,id:i};i=o.persistence.addChange(m);this.replaceKey(v.key,i);this.setInitialSelectionKey(i);if(this.getIndustrySolutionMode()&&v.key===this.STANDARDVARIANTKEY){this.setStandardVariantKey(i);}var f=this._getVariant(o.control,i);if(f){f.setRequest(T);var I=this.getItemByKey(i);if(I){I.setNamespace(f.getNamespace());}}if(v.def===true){this._setDefaultVariantKey(o,i);}}};c.prototype._appendLifecycleInformation=function(v,i){var t;var I=this.getItemByKey(i);if(I){t=I.getLifecycleTransportId();if(t===null||t===undefined){t="";}if(v){v.setRequest(t);}}};c.prototype._renameVariant=function(v,o){if(v.key!==this.getStandardVariantKey()){if(v&&o&&o.control){var d=this._getVariant(o.control,v.key);if(d){d.setText("variantName",v.name);this._appendLifecycleInformation(d,v.key);}}}};c.prototype._deleteVariants=function(v,o){var i;if(v&&v.length&&o&&o.control){var s=this._getDefaultVariantKey(o);for(i=0;i<v.length;i++){if(v[i]===this.getStandardVariantKey()){continue;}var d=this._getVariant(o.control,v[i]);if(d){d.markForDeletion();if(s&&s===v[i]){this._setDefaultVariantKey(o,"");}this._appendLifecycleInformation(d,v[i]);}}}};c.prototype._getDefaultVariantKey=function(o){var d="";if(o&&o.persistence){d=o.persistence.getDefaultVariantIdSync();}return d;};c.prototype._setDefaultVariantKey=function(o,v){if(o&&o.persistence){o.persistence.setDefaultVariantIdSync(v);}};c.prototype._isVariantDownport=function(o){var d=false;if(o&&o.persistence){d=o.persistence.isVariantDownport();}return d;};c.prototype._getExecuteOnSelection=function(v){var o;if(v){o=v.getContent();if(o&&(o.executeOnSelection!==undefined)){return o.executeOnSelection;}}return false;};c.prototype._hasStoredStandardVariant=function(v){var o;if(v){o=v.getContent();if(o&&o.standardvariant){return o.standardvariant;}}return false;};c.prototype._isComponentTemplate=function(o){var i=false;var d=F.getComponentForControl(o);if(d&&d.getAppComponent){d=d.getAppComponent();if(d){i=true;}}return i;};c.prototype._isApplicationVariant=function(o){if(F.isApplicationVariant(o)){return true;}if(this._isComponentTemplate(o)){return true;}return false;};c.prototype._setExecuteOnSelections=function(v,o){var i;if(v&&v.length&&o&&o.control){for(i=0;i<v.length;i++){var d=this._getVariant(o.control,v[i].key);if(d){var j=d.getContent();if(j){j.executeOnSelection=v[i].exe;d.setContent(j);}this._appendLifecycleInformation(d,v[i].key);}}}};c.prototype._save=function(o){var t=this;if(o&&o.persistence){try{o.persistence.saveAll().then(function(){t.fireEvent("afterSave");},function(d){var E="'_save' failed:";if(d&&d[0]&&d[0].messages&&d[0].messages[0]){E+=(' '+d[0].messages[0]);}t._setErrorValueState(t.oResourceBundle.getText("VARIANT_MANAGEMENT_SAVE_FAILED"),E,o.control);});}catch(e){this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_SAVE_FAILED"),"'_save' throws an exception",o.control);}}};c.prototype.fireSave=function(v){var s=false;var d=this._getAllPersonalizableControls();if(d&&(d.length===1)){if(v){if(v.overwrite){if(this._isIndustrySolutionModeAndVendorLayer()||(v.key!==this.getStandardVariantKey())){this.fireEvent("save");if(v.key===this.STANDARDVARIANTKEY){this._newVariant(v,d[0]);}else{this._updateVariant(v,d[0]);}s=true;}}else{this.fireEvent("save");this._newVariant(v,d[0]);s=true;}if(s){this._save(d[0]);}}}};c.prototype.fireManage=function(v){var i;var d=this._getAllPersonalizableControls();if(d&&(d.length===1)){if(v){if(v.renamed){for(i=0;i<v.renamed.length;i++){this._renameVariant(v.renamed[i],d[0]);}}if(v.deleted){this._deleteVariants(v.deleted,d[0]);}if(v.exe){this._setExecuteOnSelections(v.exe,d[0]);}if(v.def){var D=this._getDefaultVariantKey(d[0]);if(D!==v.def){this._setDefaultVariantKey(d[0],v.def);}}if((v.deleted&&v.deleted.length>0)||(v.renamed&&v.renamed.length>0)||(v.exe&&v.exe.length>0)||v.def){this._save(d[0]);}}}};c.prototype.fireSelect=function(v){var o=null;var d=this._getAllPersonalizableControls();if(d&&(d.length===1)){if(v&&v.key){o=this.getVariantContent(d[0].control,v.key);if(o){var s=JSON.stringify(o);o=JSON.parse(s);if((v.key===this.STANDARDVARIANTKEY)&&this.bExecuteOnSelectForStandard){o.executeOnSelection=this.bExecuteOnSelectForStandard;}this._applyVariant(d[0].control,o);}}}};c.prototype._setStandardVariant=function(o){var d=o.control;if(d){if(d.fireBeforeVariantSave){d.fireBeforeVariantSave(a.STANDARD_NAME);}this._assignStandardVariant(d);}};c.prototype._updateStandardVariant=function(o,d){this._assignStandardVariantForCotrol(o,d);};c.prototype._assignStandardVariant=function(o){var s=null;if(o){if(o.fetchVariant){s=o.fetchVariant();}this._assignStandardVariantForCotrol(o,s);}};c.prototype._assignStandardVariantForCotrol=function(o,s){if(o){this._mStandardVariants[o]=s;}};c.prototype.getStandardVariant=function(o){var d=null;if(this._mStandardVariants&&o&&this._mStandardVariants[o]){d=this._mStandardVariants[o];}return d;};c.prototype._applyVariant=function(o,d,s,i){if(o&&o.applyVariant){o.applyVariant(d,s,i);}};c.prototype._setErrorValueState=function(t,L,o){this.setEnabled(false);if(L){q.sap.log.error(L);}};c.prototype.exit=function(){a.prototype.exit.apply(this,arguments);this._mStandardVariants=null;this._mControlPersistence=null;this._aPersonalizableControls=null;var n;for(n in this._mControlPromise){if(n&&this._mControlPromise[n].promise){this._mControlPromise[n].promise=null;delete this._mControlPromise[n].promise;}}this._mControlPromise=null;this._mControlComponent=null;this._mCurrentVariantId=null;};return c;},true);
