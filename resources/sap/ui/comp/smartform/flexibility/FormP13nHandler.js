/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/m/Dialog","sap/m/FlexBox","sap/m/FlexItemData","sap/m/Text","sap/m/Button","sap/m/DialogType","sap/ui/core/mvc/XMLView","sap/ui/comp/smartform/SmartForm","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/odata/FieldSelector","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/fl/FlexControllerFactory","sap/m/MessageBox","sap/ui/comp/transport/TransportSelection","sap/ui/fl/Transports","sap/ui/fl/registry/Settings"],function(q,D,F,a,T,B,b,X,S,d,e,f,g,J,h,M,l,m,n){"use strict";var o=function(){this._oOriginalDataModelForDialog=null;};o.prototype.init=function(s){var p;this._oSmartForm=s;this._oDialogContent=null;this._textResources=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");this._oDialog=this._createDialog();var t=this;this._mergeErrorOccured=false;var c=this._getFlexController();if(this._oSmartForm){p={appDescriptor:g.getAppDescriptor(this._oSmartForm),siteId:g.getSiteId(this._oSmartForm)};}return n.getInstance(c.getComponentName(),p).then(function(i){if(!i.hasMergeErrorOccured()){t._oDialog.setContentHeight("60%");t._oDialog.setTitle(t._textResources.getText("FORM_PERS_DIALOG_TITLE"));t._oDialogContent=t._createDialogContent();t._oDialog.addContent(t._oDialogContent);}else{t._mergeErrorOccured=true;t._oDialog.setType(b.Message);t._oDialog.setTitle(t._textResources.getText("FORM_PERS_DIALOG_ERR_TITLE"));t._showMergeErrorMessageInDialog();}t._createButtons(i);});};o.prototype._createDialog=function(){var c;c=new D("smartFormPersDialog",{contentWidth:"60%",verticalScrolling:false,horizontalScrolling:false,afterClose:[this._destroyDialog,this]});return c;};o.prototype._createButtons=function(s){var O=new B(this._oDialog.getId()+'-OkButton');O.setText(this._textResources.getText("FORM_PERS_DIALOG_OK"));O.attachPress(this._dialogOkClicked.bind(this));this._oDialog.addButton(O);var c=new B(this._oDialog.getId()+'-CancelButton');c.setText(this._textResources.getText("FORM_PERS_DIALOG_CANCEL"));c.attachPress({sAction:"cancel"},this._closeDialog,this);this._oDialog.addButton(c);var i=new B(this._oDialog.getId()+'-RestoreButton');i.setText(this._textResources.getText("FORM_PERS_DIALOG_RESET"));i.attachPress({sAction:"discard"},this._confirmDiscardAllChanges,this);this._oDialog.addButton(i);if(!s.isProductiveSystem()&&!s.hasMergeErrorOccured()){var t=new B(this._oDialog.getId()+'-TransportButton');t.setText(this._textResources.getText("FORM_PERS_DIALOG_TRANSPORT"));t.attachPress({sAction:"transport"},this._confirmTransportAllChanges,this);if(this._oDialog){this._oDialog.addButton(t);}}};o.prototype._showTransportErrorMessage=function(E){return this._showMessage(M.Icon.ERROR,"FORM_PERS_TRANSPORT_ERROR_TITLE","FORM_PERS_TRANSPORT_ERROR_MESSAGE",E);};o.prototype._openTransportSelection=function(c,s){var t=this;return new Promise(function(r,i){var O=function(R){if(R&&R.getParameters){var p=R.getParameters().selectedTransport;var P=R.getParameters().selectedPackage;var u=R.getParameters().dialog;var v={transport:p,packageName:P,fromDialog:u};r(v);}else{r({});}};var E=function(p){if(s&&(p.sId===''||p.sId==='cancel')){r();}t._showTransportErrorMessage(p).then(function(){i(p);});};var j={};if(c){j["package"]=c.getPackage();j.namespace=c.getNamespace();j.name=c.getId();j.type=c.getDefinition().fileType;}var k=new sap.ui.comp.transport.TransportSelection();k.selectTransport(j,O,E,false,t._oSmartForm);});};o.prototype._dialogOkClicked=function(){var c=[];if(!this._mergeErrorOccured){c=this._getChangeDataFromDialog();}if(c.length===0){this._closeDialog();return new Promise(function(r,i){r({});});}var t=this;return t._createAndApplyChanges(c).then(function(){t._closeDialog();});};o.prototype._createAndApplyChanges=function(c){var t=this;return Promise.resolve().then(function(){var i;i=t._getFlexController();function v(C){return C&&C.selector&&C.selector.id;}c.filter(v).forEach(function(C){var j=t._getControlById(C.selector.id);i.createAndApplyChange(C,j);});})['catch'](function(E){g.log.error("Create and apply error: "+E);return E;}).then(function(E){return t._getFlexController().saveAll().then(function(){if(E){throw E;}});})['catch'](function(E){g.log.error("Create and apply and/or save error: "+E);return t._showApplySaveChangesErrorMessage(E);});};o.prototype._getControlById=function(c){return sap.ui.getCore().byId(c);};o.prototype._getFlexController=function(){return h.createForControl(this._oSmartForm);};o.prototype._createDialogContent=function(){var c,j,C;if(!this._oSmartForm){return undefined;}j=this._createModelFromSmartForm(this._oSmartForm);j.isMoveDownButtonEnabled=false;j.isMoveUpButtonEnabled=false;j.isMoveBottomButtonEnabled=false;j.isMoveTopButtonEnabled=false;this._oOriginalDataModelForDialog=JSON.parse(JSON.stringify(j));this._oModel=new J();this._oModel.setData(j);c=new sap.ui.comp.smartform.flexibility.DialogContent(this._oDialog.getId()+'-Content');c.setModel(this._oModel);var v=g.getViewForControl(this._oSmartForm);c.setViewId(v.createId(""));var i=this._getIgnoredFields(this._oSmartForm);C=g.getComponentClassName(this._oSmartForm);var p={appDescriptor:g.getAppDescriptor(this._oSmartForm),siteId:g.getSiteId(this._oSmartForm)};c.initialiseODataFieldSelector(this._oSmartForm.getModel(),this._oSmartForm.getEntityType(),C,i,this._mBindingPathToFieldListElement,this._mIdToFieldListElement,p);return c;};o.prototype._getIgnoredFields=function(s){if(s){var c=s.getIgnoredFields();if(c){var i=c.split(",");return i;}}return[];};o.prototype._createChangeSpecificDataFromDialogModel=function(j,c){var C=[],k;var p={};this._createNodeMap(j,p);var r={};this._createNodeMap(c,r);var i,I,N,s,t;var u=Object.keys(p);for(i=0;i<u.length;i++){I=u[i];if(r[I]&&r[I].node){N=p[I].node;s=r[I].node;if(N.label&&s.label&&N.label!==s.label){k=this._createLabelChange(I,s.label,s.type);if(k&&k.selector&&k.selector.id){C.push(k);}}if((N.isVisible&&!s.isVisible)||(!N.isVisible&&s.isVisible)){if(s.isVisible){t=true;}else{t=false;}C.push(this._createVisibilityChange(I,t));}}}var P={};for(i=0;i<c.length;i++){this._check4AddChanges(c[i],p,C,P);}for(i=0;i<c.length;i++){this._check4InterMoveChanges(c[i],r,p,C,P);this._check4IntraMoveChanges(c[i],r,p,C,P);}return C;};o.prototype._check4AddChanges=function(p,c,C,P){if(p&&p.id&&p.children){var i,s=0,I,j,k;j=p.id;if(c[j]&&c[j].node){var r=c[j].node;if(!P){P={};}P[j]={};P[j].index={};for(i=0;i<r.children.length;i++){k=r.children[i];I=k.id;P[j].index[I]=i;}}for(i=0;i<p.children.length;i++){k=p.children[i];if(k.id){I=k.id;if(!c[I]){var t=this._createAddChange(j,k,i);if(t&&t.selector&&t.selector.id){C.push(t);s++;if(!k.isVisible){C.push(this._createVisibilityChange(I,false));}}}else if(s>0&&P[j]&&P[j].index[I]!==undefined){P[j].index[I]=P[j].index[I]+s;}this._check4AddChanges(k,c,C,P);}}}};o.prototype._check4InterMoveChanges=function(p,c,r,C,P){if(p&&p.id&&p.children){var i,I,s,t,u=[],v={},w,x={};s=p.id;var L=p.children.length;for(i=0;i<L;i++){w=p.children[i];if(w.id){I=w.id;if(r[I]&&r[I].index!==undefined){if(!r[I].index[s]&&r[I].index[s]!==0){var j,y=[];y=Object.keys(r[I].index);for(j=0;j<y.length;j++){t=y[j];if(!v[t]){v[t]=[];}v[t].push({"id":I,"index":c[I].index[s]});var z,A=[],E,k;if(P[t]&&P[t].index[I]!==undefined){E=P[t].index[I];delete P[t].index[I];A=Object.keys(P[t].index);for(k=0;k<A.length;k++){z=A[k];if(P[t].index[z]>E){P[t].index[z]--;}}}if(P[s]){E=c[I].index[s];A=Object.keys(P[s].index);for(k=0;k<A.length;k++){z=A[k];if(P[s].index[z]>=E){P[s].index[z]++;}}P[s].index[I]=E;}}}}this._check4InterMoveChanges(w,c,r,C,P);}}if(v){u=Object.keys(v);for(i=0;i<u.length;i++){t=u[i];x=this._createMoveChange(t,p.type,v[t],p.id);if(x&&x.selector&&x.selector.id){C.push(x);}}}}};o.prototype._check4IntraMoveChanges=function(p,c,j,C,P){if(p&&p.id&&p.children){var i,I,s,k=[],r,t={};s=p.id;var L=p.children.length;for(i=0;i<L;i++){r=p.children[i];if(r.id){I=r.id;if(j[I]&&j[I].index!==undefined){if(j[I].index[s]!==undefined&&j[I].index[s]!==i){if(P[s]&&P[s].index[I]!==undefined&&P[s].index[I]!==i){k.push({"id":I,"index":c[I].index[s]});}}}this._check4IntraMoveChanges(r,c,j,C,P);}}if(k.length>0){t=this._createMoveChange(s,p.type,k,"");if(t&&t.selector&&t.selector.id){C.push(t);}}}};o.prototype._createAddChange=function(i,N,I){var A={};A.selector={};A.selector.id=i;A.index=I;A.newControlId=N.id;switch(N.type){case"form":A={};break;case"group":A.changeType="addGroup";if(!N.label){A.groupLabel="";}else{A.groupLabel=N.label;}break;case"field":A.changeType="addField";if(!N.label){A.fieldLabel="";}else{A.fieldLabel=N.label;}if(!N.fieldValue){A.fieldValue="";}else{A.fieldValue=N.fieldValue;}if(!N.valueProperty){A.valueProperty="";}else{A.valueProperty=N.valueProperty;}if(!N.jsType){A.jsType="";}else{A.jsType=N.jsType;}break;default:A={};break;}return A;};o.prototype._createLabelChange=function(i,L,t){var c={};c.selector={};c.selector.id=i;switch(t){case"form":c={};break;case"group":c.changeType="renameGroup";c.groupLabel=L;break;case"field":c.changeType="renameField";c.fieldLabel=L;break;default:c={};break;}return c;};o.prototype._createMoveChange=function(i,t,I,s){var c={};c.selector={};c.selector.id=i;switch(t){case"form":c.changeType="moveGroups";c.moveGroups=I;break;case"group":c.changeType="moveFields";c.moveFields=I;break;default:c={};break;}if(s){c.targetId=s;}return c;};o.prototype._createVisibilityChange=function(i,I){var v={};v.selector={};v.selector.id=i;if(I===true){v.changeType="unhideControl";}else{v.changeType="hideControl";}return v;};o.prototype._createNodeMap=function(j,N,p){if(!N){throw new Error("Node map instance must be provided");}if(!j||!j.length){return;}var c,I;var i,L=j.length;for(i=0;i<L;i++){c=j[i];if(c&&c.id){I=c.id;if(!N[I]){N[I]={};N[I].node=c;}if(p&&p.id){if(!N[I].index){N[I].index={};}N[I].index[p.id]=i;}if(c.children){this._createNodeMap(c.children,N,c);}}}};o.prototype.show=function(){this._oDialog.open();};o.prototype._showMergeErrorMessageInDialog=function(){var c=new F();c.setDirection("Column");c.setAlignItems("Start");var i=new T();i.setText(this._textResources.getText("FORM_PERS_DIALOG_ERR_DESC"));i.setLayoutData(new a({order:1,growFactor:1}));var j=new T();j.setText(this._textResources.getText("FORM_PERS_DIALOG_ERR_HINT"));j.setLayoutData(new a({order:1,growFactor:1}));c.addItem(i);c.addItem(j);this._oDialog.addContent(c);};o.prototype._closeDialog=function(){if(this._oDialog){this._oDialog.close();}this._destroyDialog();};o.prototype._destroyDialog=function(){if(this._oDialogContent){this._oDialogContent.destroy();this._oDialogContent=null;}if(this._oDialog){this._oDialog.destroy();this._oDialog=null;}};o.prototype._createSmartFormControlMap=function(s){var c=[];var C;if(s){C=s.getId();c[C]=s;var G=s.getGroups();if(G){for(var i=0;i<G.length;i++){var k=G[i];if(k){C=k.getId();c[C]=k;var p=k.getGroupElements();if(p){for(var j=0;j<p.length;j++){var r=p[j];if(r){C=r.getId();c[C]=r;}}}}}}}return c;};o.prototype._showDiscardSuccessMessage=function(){return this._showMessage(M.Icon.SUCCESS,"FORM_PERS_DISCARD_SUCCESS_TITLE","FORM_PERS_DISCARD_SUCCESS_MESSAGE");};o.prototype._showTransportSuccessMessage=function(){return this._showMessage(M.Icon.SUCCESS,"FORM_PERS_TRANSPORT_SUCCESS_TITLE","FORM_PERS_TRANSPORT_SUCCESS_MESSAGE");};o.prototype._showTransportInapplicableMessage=function(){return this._showMessage(M.Icon.INFORMATION,"FORM_PERS_TRANSPORT_INAPPLICABLE_TITLE","FORM_PERS_TRANSPORT_INAPPLICABLE_MESSAGE");};o.prototype._showDiscardErrorMessage=function(E){return this._showMessage(M.Icon.ERROR,"FORM_PERS_DISCARD_ERROR_TITLE","FORM_PERS_DISCARD_ERROR_MESSAGE",E);};o.prototype._showApplySaveChangesErrorMessage=function(E){return this._showMessage(M.Icon.ERROR,"FORM_PERS_APPLYSAVE_ERROR_TITLE","FORM_PERS_APPLYSAVE_ERROR_MESSAGE",E);};o.prototype._showMessage=function(c,t,s,E){return new Promise(function(r){if(E&&(E.sId===''||E.sId==='cancel')){r();}else{var i,j;if(E){j=[E.message||E];i=this._textResources.getText(s,j);}i=this._textResources.getText(s);var k=this._textResources.getText(t);M.show(i,{icon:c,title:k,onClose:r});}}.bind(this));};o.prototype._filterChangesForSmartForm=function(c,s){var r=[];var j=this._createSmartFormControlMap(s);for(var i=0;i<c.length;i++){var C=c[i];var k=C.getSelector().id;if(j[k]){r.push(C);}}return r;};o.prototype._setTransports=function(c,C,t,i){var j=this;if(C>=0){var k=c[C];if(i===true){if(k.getDefinition().packageName!=="$TMP"){k.setRequest(t);}C--;return j._setTransports(c,C,t,i);}else{if(k.getDefinition().packageName!=="$TMP"){return j._openTransportSelection(k).then(function(p){k.setRequest(p.transport);if(p.fromDialog===true){t=p.transport;i=true;}C--;return j._setTransports(c,C,t,i);});}else{C--;return j._setTransports(c,C,t,i);}}}else{return Promise.resolve();}};o.prototype._deleteChanges=function(c,s){var t=this;var i=this._filterChangesForSmartForm(c,s);var j=t._getFlexController();var C=i.length-1;return this._setTransports(i,C).then(function(){return j.discardChanges(i);}).then(function(){return t._showDiscardSuccessMessage();})["catch"](function(E){return t._showDiscardErrorMessage(E);});};o.prototype._confirmDiscardAllChanges=function(){var t=this;var p={appDescriptor:g.getAppDescriptor(t._oSmartForm),siteId:g.getSiteId(t._oSmartForm)};var c=function(A){if(A==="OK"){var j=t._getFlexController();j.getComponentChanges(p).then(function(C){var k=t._convertToChangeArray(C);return t._deleteChanges(k,t._oSmartForm);})["catch"](function(E){return t._showDiscardErrorMessage();}).then(function(){t._closeDialog();});}};var s=this._textResources.getText("FORM_PERS_RESET_MESSAGE");var i=this._textResources.getText("FORM_PERS_RESET_TITLE");M.confirm(s,{title:i,onClose:c});};o.prototype._confirmTransportAllChanges=function(){var t=this;return Promise.resolve().then(c)['catch'](i).then(j).then(k).then(p).then(r)['catch'](s).then(u);function c(){var C=t._getChangeDataFromDialog();if(C.length>0){return t._createAndApplyChanges(C);}}function i(E){g.log.error("SmartForm changes could not be applied or saved: "+E);return t._showApplySaveChangesErrorMessage(E).then(function(){throw new Error('createAndApply failed');});}function j(){return t._getAllLocalChanges();}function k(A){return!!A.length;}function p(v){if(v){return t._openTransportSelection(null,true);}else{return t._showTransportInapplicableMessage();}}function r(v){if(v&&v.transport&&v.packageName!=="$TMP"){return t._transportAllLocalChanges(v);}}function s(E){if(E.message==='createAndApply failed'){return;}g.log.error("transport error"+E);return t._showTransportErrorMessage(E);}function u(){t._closeDialog();}};o.prototype._getChangeDataFromDialog=function(){var c,C;c=this._oModel.getData();C=this._createChangeSpecificDataFromDialogModel([this._oOriginalDataModelForDialog],[c]);return C;};o.prototype._getAllLocalChanges=function(){var t=this;var p={appDescriptor:g.getAppDescriptor(t._oSmartForm),siteId:g.getSiteId(t._oSmartForm)};return t._getFlexController().getComponentChanges(p).then(function(c){var A=t._convertToChangeArray(c);return t._filterChangesForSmartForm(A,t._oSmartForm);});};o.prototype._transportAllLocalChanges=function(t){var c=this;return c._getAllLocalChanges().then(function(A){var i=c._convertToChangeTransportData(A);var j=new m();var k={};k.transportId=t.transport;k.changeIds=i;return j.makeChangesTransportable(k).then(function(){A.forEach(function(C){if(C.getPackage()==='$TMP'){var p=C.getDefinition();p.packageName='';C.setResponse(p);}});}).then(function(){return c._showTransportSuccessMessage();});});};o.prototype._convertToChangeTransportData=function(L){var t=[];var c=L.length;for(var i=0;i<c;i++){var C=L[i];var j={};j.namespace=C.getNamespace();j.fileName=C.getId();j.fileType=C.getDefinition().fileType;t.push(j);}return t;};o.prototype._convertToChangeArray=function(c){var C=c;if(!q.isArray(c)){C=[];var k=Object.keys(c);for(var i=0;i<k.length;i++){C.push(c[k[i]]);}}return C;};o.prototype._createModelFromSmartForm=function(s){var c,j,i,p,r,t,k,u;var v=this;this._mBindingPathToFieldListElement={};this._mIdToFieldListElement={};if(s){c=this._getModelNodeForSmartForm(s);j=s.getGroups();if(j){for(i=0;i<j.length;i++){p=j[i];if(!g.checkControlId(p)){continue;}r=this._getModelNodeForSmartGroup(p);c.children.push(r);if(p){t=p.getGroupElements();if(t){for(k=0;k<t.length;k++){if(!g.checkControlId(t[k])){continue;}var G=t[k];u=this._getModelNodeForSmartGroupElement(G);var w=!!(u.label);if(w){r.children.push(u);q.each(u.bindingPaths,function(x,y){v._mBindingPathToFieldListElement[y.path]=u;});this._mIdToFieldListElement[u.id]=u;}}}}}}}return c;};o.prototype._getModelNodeForSmartForm=function(s){var r={};r.id=s.getId();r.label=s.getTitle();r.isVisible=s.getVisible();r.type="form";r.children=[];return r;};o.prototype._getModelNodeForSmartGroup=function(s){var r={};r.id=s.getId();r.label=s.getLabel();r.isVisible=s.getVisible();r.type="group";r.children=[];return r;};o.prototype._determineRelevantBindingPathsOf=function(C,i){var t=this;if(!i){i=[];}if((!C)||(!C.getMetadata)){return;}var j=C.getMetadata();if(j){var p=j.getAllProperties();q.each(p,function(c,k){var r=c==='text'||c==='value'||c==='selected'||c==='selectedKey';if(r){var s=C.getBinding(c);if(s){var u=s.getPath();if(u){var v=t._getAbsoluteBindingPath(C,u);var I=function(w){return(w.path===v);};if(!i.some(I)){i.push({path:v});}}}}});var A=j.getAllAggregations();q.each(A,function(k,r){var v=C.getAggregation(k);if(!q.isArray(v)){var s=[];s.push(v);v=s;}if(v){for(var c=0;c<v.length;c++){t._determineRelevantBindingPathsOf(v[c],i);}}});}return i;};o.prototype._getAbsoluteBindingPath=function(c,s){var p='';var i=c.getModel();if(i){var j=i.getMetaModel();if(j){var k=c.getBindingContext();if(k){var r=k.getPath();if(r){var t=j.getMetaContext(r);if(t){var u=t.sPath;if(u){var E=j.getObject(u).name;if(E){p=p+E+'/';}}}}}}}return p+s;};o.prototype._getModelNodeForSmartGroupElement=function(G){var r={};r.id=G.getId();r.label=G.getLabelText();r.isVisible=G.getVisible();if(r.isVisible){r.isVisible=G.getVisibleBasedOnElements();}r.type="field";r.bindingPaths=this._determineRelevantBindingPathsOf(G);return r;};return o;},true);
