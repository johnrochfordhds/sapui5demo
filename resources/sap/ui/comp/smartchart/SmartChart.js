/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/library','sap/chart/Chart','sap/chart/library','sap/chart/data/Dimension','sap/chart/data/Measure','sap/m/ToggleButton','sap/m/Button','sap/m/Text','sap/m/ComboBox','sap/m/ComboBoxRenderer','sap/m/FlexItemData','sap/ui/core/Item','sap/m/OverflowToolbar','sap/m/OverflowToolbarButton','sap/m/ToolbarSeparator','sap/m/ToolbarDesign','sap/m/ToolbarSpacer','sap/m/VBox','sap/m/VBoxRenderer','sap/ui/comp/providers/ChartProvider','sap/ui/comp/smartfilterbar/FilterProvider','sap/ui/comp/smartvariants/SmartVariantManagement','sap/ui/model/Filter','sap/ui/model/FilterOperator','sap/ui/comp/personalization/Util','sap/ui/Device','sap/ui/comp/odata/ODataModelUtil'],function(q,l,C,c,D,M,T,B,d,f,g,F,I,O,h,j,k,m,V,o,p,r,S,s,t,P,u,v){"use strict";var w=V.extend("sap.ui.comp.smartchart.SmartChart",{metadata:{library:"sap.ui.comp",properties:{entitySet:{type:"string",group:"Misc",defaultValue:null},smartFilterId:{type:"string",group:"Misc",defaultValue:null},ignoredFields:{type:"string",group:"Misc",defaultValue:null},requestAtLeastFields:{type:"string",group:"Misc",defaultValue:null},ignoreFromPersonalisation:{type:"string",group:"Misc",defaultValue:null},chartType:{type:"string",group:"Misc",defaultValue:null},ignoredChartTypes:{type:"string",group:"Misc",defaultValue:null},useVariantManagement:{type:"boolean",group:"Misc",defaultValue:true},useChartPersonalisation:{type:"boolean",group:"Misc",defaultValue:true},header:{type:"string",group:"Misc",defaultValue:null},persistencyKey:{type:"string",group:"Misc",defaultValue:null},currentVariantId:{type:"string",group:"Misc",defaultValue:null},enableAutoBinding:{type:"boolean",group:"Misc",defaultValue:false},chartBindingPath:{type:"string",group:"Misc",defaultValue:null},showDrillButtons:{type:"boolean",group:"Misc",defaultValue:true},showZoomButtons:{type:"boolean",group:"Misc",defaultValue:true},showSemanticNavigationButton:{type:"boolean",group:"Misc",defaultValue:true},showLegendButton:{type:"boolean",group:"Misc",defaultValue:true},legendVisible:{type:"boolean",group:"Misc",defaultValue:true},selectionMode:{type:"sap.chart.SelectionMode",group:"Misc",defaultValue:sap.chart.SelectionMode.Single},showFullScreenButton:{type:"boolean",group:"Misc",defaultValue:true},useTooltip:{type:"boolean",group:"Misc",defaultValue:true}},aggregations:{toolbar:{type:"sap.m.Toolbar",multiple:false},semanticObjectController:{type:"sap.ui.comp.navpopover.SemanticObjectController",multiple:false}},events:{initialise:{},beforeRebindChart:{},dataReceived:{},afterVariantInitialise:{},afterVariantSave:{},afterVariantApply:{},showOverlay:{}}},renderer:o.render});w.prototype.init=function(){sap.m.FlexBox.prototype.init.call(this);this.addStyleClass("sapUiCompSmartChart");this.setFitContainer(true);this._bUpdateToolbar=true;this._oChartTypeModel=null;this.setHeight("100%");var a=new sap.ui.model.json.JSONModel({items:[]});this.setModel(a,"$smartChartTypes");this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");this.sResizeListenerId=null;if(u.system.desktop){this.sResizeListenerId=sap.ui.core.ResizeHandler.register(this,q.proxy(this._adjustHeight,this));}else{u.orientation.attachHandler(this._adjustHeight,this);u.resize.attachHandler(this._adjustHeight,this);}};w.prototype._createVariantManagementControl=function(){if(this._oVariantManagement||(!this.getUseVariantManagement()&&!this.getUseChartPersonalisation())||!this.getPersistencyKey()){return;}var a=new sap.ui.comp.smartvariants.PersonalizableInfo({type:"chart",keyName:"persistencyKey",dataSource:"TODO"});a.setControl(this);this._oVariantManagement=new S({personalizableControls:a,initialise:function(e){if(!this._oCurrentVariant){this._oCurrentVariant="STANDARD";}this.fireAfterVariantInitialise();}.bind(this),save:function(e){this._variantSaved();}.bind(this),afterSave:function(){this.fireAfterVariantSave({currentVariantId:this.getCurrentVariantId()});}.bind(this),showShare:false});this._oVariantManagement.initialise();};w.prototype._variantSaved=function(){if(this._oPersController){this._oPersController.setPersonalizationData(this._oCurrentVariant);}};w.prototype.setUseChartPersonalisation=function(U){this.setProperty("useChartPersonalisation",U,true);this._bUpdateToolbar=true;};w.prototype._createPopover=function(){if(!this._oPopover&&this._oChart){q.sap.require("sap.viz.ui5.controls.Popover");this._oPopover=new sap.viz.ui5.controls.Popover({});this._oPopover.connect(this._oChart.getVizUid());}};w.prototype._createTooltip=function(){if(this._oChart){this._oChart.setVizProperties({"interaction":{"behaviorType":null},"tooltip":{"visible":true}});}};w.prototype._createTooltipOrPopover=function(){if(this.getUseTooltip()){this._createTooltip();}else{this._createPopover();}};w.prototype._destroyPopover=function(){if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}};w.prototype.setUseVariantManagement=function(U){this.setProperty("useVariantManagement",U,true);if(this._oPersController){this._oPersController.setResetToInitialTableState(!U);}this._bUpdateToolbar=true;};w.prototype.setToolbar=function(a){if(this._oToolbar){this.removeItem(this._oToolbar);}this._oToolbar=a;this._bUpdateToolbar=true;};w.prototype.getToolbar=function(){return this._oToolbar;};w.prototype.setHeader=function(a){this.setProperty("header",a,true);this._refreshHeaderText();};w.prototype._refreshHeaderText=function(){if(!this._headerText){this._bUpdateToolbar=true;return;}var a=this.getHeader();this._headerText.setText(a);};w.prototype._createToolbar=function(){if(!this._oToolbar){this._oToolbar=new O({design:k.Transparent});this._oToolbar.addStyleClass("sapUiCompSmartChartToolbar");}this._oToolbar.setLayoutData(new sap.m.FlexItemData({shrinkFactor:0}));this.insertItem(this._oToolbar,0);};w.prototype._createToolbarContent=function(){this._addVariantManagementToToolbar();this._addSeparatorToToolbar();this._addHeaderToToolbar();this._addSpacerToToolbar();this._addSemanticNavigationButton();this._addChartTypeToToolbar();this._addDrillUpDownButtons();this._addLegendButton();this._addZoomInOutButtons();this._addPersonalisationToToolbar();this._addFullScrrenButton();if(this._oToolbar&&(this._oToolbar.getContent().length===0||(this._oToolbar.getContent().length===1&&this._oToolbar.getContent()[0]instanceof m))){this.removeItem(this._oToolbar);this._oToolbar.destroy();this._oToolbar=null;}};w.prototype._addFullScrrenButton=function(){var a,b=this;if(this.getShowFullScreenButton()){a=new h(this.getId()+"-btnFullScreen",{press:function(){b.setFullScreen(!b.bFullScreen);}});this.oFullScreenButton=a;this.setFullScreen(this.bFullScreen,true);this._oToolbar.addContent(a);}};w.prototype._addZoomInOutButtons=function(){var a=this;this._oZoomInButton=new h(this.getId()+"-btnZoomIn",{tooltip:this._oRb.getText("CHART_ZOOMINBTN_TOOLTIP"),icon:"sap-icon://zoom-in",press:function(){if(a._oChart){a._oChart.zoom({direction:"in"});}},visible:this.getShowZoomButtons()});this._oZoomOutButton=new h(this.getId()+"-btnZoomOut",{tooltip:this._oRb.getText("CHART_ZOOMOUTBTN_TOOLTIP"),icon:"sap-icon://zoom-out",press:function(){if(a._oChart){a._oChart.zoom({direction:"out"});}},visible:this.getShowZoomButtons()});this._oToolbar.addContent(this._oZoomInButton);this._oToolbar.addContent(this._oZoomOutButton);};w.prototype.setShowZoomButtons=function(b){this.setProperty("showZoomButtons",b);if(this._oZoomInButton){this._oZoomInButton.setVisible(b);}if(this._oZoomOutButton){this._oZoomOutButton.setVisible(b);}};w.prototype.setLegendVisible=function(b){this.setProperty("legendVisible",b);this._setLegendVisible(b);};w.prototype._setLegendVisible=function(b){var a=this._getVizFrame();if(a){a.setLegendVisible(b);}};w.prototype._getVizFrame=function(){var a=null;if(this._oChart){a=this._oChart.getAggregation("_vizFrame");}return a;};w.prototype._addLegendButton=function(){var a=this;this._oLegendButton=new h(this.getId()+"-btnLegend",{tooltip:this._oRb.getText("CHART_LEGENDBTN_TOOLTIP"),icon:"sap-icon://legend",press:function(){a.setLegendVisible(!a.getLegendVisible());},visible:this.getShowLegendButton()});this._oToolbar.addContent(this._oLegendButton);};w.prototype.setShowLegendButton=function(b){this.setProperty("showLegendButton",b);if(this._oLegendButton){this._oLegendButton.setVisible(b);}};w.prototype.setShowSemanticNavigationButton=function(b){this.setProperty("showSemanticNavigationButton",b);if(this._oSemanticalNavButton){this._oSemanticalNavButton.setVisible(b);}else{if(b){this._addSemanticNavigationButton();}}};w.prototype._addSemanticNavigationButton=function(){var a=this,b;if(!this._oSemanticalNavButton&&this.getShowSemanticNavigationButton()){this._oSemanticalNavButton=new B(this.getId()+"-btnNavigation",{text:this._oRb.getText("CHART_SEMNAVBTN"),tooltip:this._oRb.getText("CHART_SEMNAVBTN_TOOLTIP"),visible:this.getShowSemanticNavigationButton(),enabled:false});q.sap.require("sap.ui.comp.navpopover.NavigationPopoverHandler");var n=new sap.ui.comp.navpopover.NavigationPopoverHandler({control:this._oSemanticalNavButton});var e=this.getSemanticObjectController();if(e){n.setSemanticObjectController(e);}this._oSemanticalNavButton.attachPress(function(E){if(b&&(b.length>0)){if(b.length===1){n.setSemanticObject(b[0].name);n.setSemanticObjectLabel(b[0].fieldLabel);n._handlePressed(E);}else{a._semanticObjectList(b,n);}}});if(this._oChart){this._oChart.attachDeselectData(function(E){b=a._setSelectionDataPointHandling(n);});this._oChart.attachSelectData(function(E){b=a._setSelectionDataPointHandling(n);});}var i=this._indexOfSpacerOnToolbar();this._oToolbar.insertContent(this._oSemanticalNavButton,i+1);}};w.prototype._setSelectionDataPointHandling=function(n){var a=this._setSelectionDataPoint(n);if(a&&a.length>0){this._oSemanticalNavButton.setEnabled(true);}else{this._oSemanticalNavButton.setEnabled(false);}return a;};w.prototype._setSelectionDataPoint=function(n){var a,b,e=null,y;var z=this._oChart.getSelectedDataPoints();if(!z||!z.dataPoints||(z.dataPoints.length===0)){return e;}if(z.dataPoints.length===1){a=z.dataPoints[0].context;if(a){b=a.getObject();if(b){e=this._determineSemanticObjects(b,a);if(e&&(e.length>0)){n.setBindingContext(a);}}}return e;}y=[];for(var i=0;i<z.dataPoints.length;i++){a=z.dataPoints[i].context;if(a){b=a.getObject();if(b){y.push(b);}}}if(y&&y.length>0){e=this._condensBasedOnSameValue(y);if(e&&e.length>0){n.setBindingContext(z.dataPoints[z.dataPoints.length-1].context);}}return e;};w.prototype._condensBasedOnSameValue=function(a){var b=null,R,e,n;b=this._determineSemanticObjects(a[0]);if(b&&b.length>0){for(var i=0;i<b.length;i++){e=b[i];n=e.name;if(this._bAllValuesAreEqual(a,n)){if(!R){R=[];}R.push(e);}}b=R;}return b;};w.prototype._bAllValuesAreEqual=function(a,b){var e,n;for(var i=0;i<a.length;i++){e=a[i];if(i===0){n=e[b];continue;}if(n!=e[b]){return false;}}return true;};w.prototype._semanticObjectList=function(a,n){q.sap.require("sap.m.List");q.sap.require("sap.m.ListType");q.sap.require("sap.m.PlacementType");q.sap.require("sap.m.StandardListItem");q.sap.require("sap.m.ResponsivePopover");var b,L,e,y;if(this._oChart){L=new sap.m.List({mode:sap.m.ListMode.SingleSelectMaster,selectionChange:function(E){if(E&&E.mParameters&&E.mParameters.listItem){y=E.mParameters.listItem.data("semObj");if(y){n.setSemanticObject(y.name);n.setSemanticObjectLabel(y.fieldLabel);n._handlePressed(E);}}b.close();}});for(var i=0;i<a.length;i++){y=a[i];e=new sap.m.StandardListItem({title:y.fieldLabel,type:sap.m.ListType.Active});e.data("semObj",y);L.addItem(e);}b=new sap.m.ResponsivePopover({title:this._oRb.getText("CHART_SEMNAVBTN"),showHeader:false,contentWidth:"12rem",placement:sap.m.PlacementType.Left});b.addContent(L);b.openBy(this._oSemanticalNavButton);}};w.prototype._determineSemanticObjects=function(e,i){var n,y,z=[];if(e){for(n in e){if(n){y=this._getField(n);if(y&&y.isDimension&&y.isSemanticObject){z.push(y);}}}}if(z){z.sort(function(a,b){return a.fieldLabel.localeCompare(b.fieldLabel);});}return z;};w.prototype._checkSemanticNavigationButton=function(b){if(this._oSemanticalNavButton){this._oSemanticalNavButton.setEnabled(b);}};w.prototype._addDrillUpDownButtons=function(){var a=this;this._oDrillUpButton=new h(this.getId()+"-btnDrillUp",{tooltip:this._oRb.getText("CHART_DRILLUPBTN_TOOLTIP"),icon:"sap-icon://drill-up",press:function(){if(a._oChart){a._oChart.drillUp();}},visible:this.getShowDrillButtons()});this._oDrillDownButton=new h(this.getId()+"-btnDrillDown",{tooltip:this._oRb.getText("CHART_DRILLDOWNBTN_TOOLTIP"),icon:"sap-icon://drill-down",press:function(e){a._drillDown(e);},visible:this.getShowDrillButtons()});this._oToolbar.addContent(this._oDrillUpButton);this._oToolbar.addContent(this._oDrillDownButton);};w.prototype.setShowDrillButtons=function(b){this.setProperty("showDrillButtons",b);if(this._oDrillUpButton){this._oDrillUpButton.setVisible(b);}if(this._oDrillDownButton){this._oDrillDownButton.setVisible(b);}};w.prototype._triggerSearchInPopover=function(e,L){var a,i,b,n,y,z;if(!e||!L){return;}a=e.getParameters();if(!a){return;}y=a.newValue?a.newValue.toLowerCase():"";if(this._oChart){z=L.getItems();for(i=0;i<z.length;i++){n=z[i].getTooltip();b=z[i].getTitle();if((b&&(b.toLowerCase().indexOf(y)>-1))||(n&&(n.toLowerCase().indexOf(y)>-1))){z[i].setVisible(true);}else{z[i].setVisible(false);}}}};w.prototype._drillDown=function(e){q.sap.require("sap.m.Bar");q.sap.require("sap.m.List");q.sap.require("sap.m.ListType");q.sap.require("sap.m.SearchField");q.sap.require("sap.m.PlacementType");q.sap.require("sap.m.StandardListItem");q.sap.require("sap.m.ResponsivePopover");var a=this,b,n,y,z,L,A,E,G,i,H;if(this._oChart){A=new sap.m.List({mode:sap.m.ListMode.SingleSelectMaster,selectionChange:function(e){if(e&&e.mParameters&&e.mParameters.listItem){if(e.mParameters.listItem.getType()===sap.m.ListType.Inactive){return;}var z=e.mParameters.listItem.data("dim");if(z){a._oChart.drillDown(z);}}b.close();}});E=new sap.m.Bar();G=new sap.m.SearchField({placeholder:this._oRb.getText("CHART_DRILLDOWN_SEARCH")});G.attachLiveChange(function(e){a._triggerSearchInPopover(e,A);});E.addContentRight(G);b=new sap.m.ResponsivePopover({title:this._oRb.getText("CHART_DRILLDOWN_TITLE"),contentWidth:"25rem",contentHeight:"20rem",placement:sap.m.PlacementType.Bottom,subHeader:E});b.addContent(A);n=this._oChart.getVisibleDimensions();y=this._getSortedDimensions();if(y.length<7){E.setVisible(false);}for(i=0;i<y.length;i++){if(n.indexOf(y[i].getName())>-1){continue;}z=y[i];L=new sap.m.StandardListItem({title:z.getLabel(),type:sap.m.ListType.Active});L.data("dim",z);H=this._getFieldTooltip(z.name);if(H){L.setTooltip(H);}if(n.indexOf(y[i].getName())>-1){L.setType(sap.m.ListType.Inactive);}A.addItem(L);}b.openBy(e.getSource());}};w.prototype._addHeaderToToolbar=function(){if(this.getHeader()){if(!this._headerText){this._headerText=new d();this._headerText.addStyleClass("sapMH4Style");this._headerText.addStyleClass("sapUiCompSmartChartHeader");}this._refreshHeaderText();this._oToolbar.insertContent(this._headerText,0);}else if(this._headerText){this._oToolbar.removeContent(this._headerText);}};w.prototype._addSeparatorToToolbar=function(){if(this.getHeader()&&this.getUseVariantManagement()){this._oSeparator=new j();this._oToolbar.insertContent(this._oSeparator,0);if(!this._oToolbar.getHeight()){this._oToolbar.setHeight("3rem");}}else if(this._oSeparator){this._oToolbar.removeContent(this._oSeparator);}};w.prototype._addVariantManagementToToolbar=function(){if(this.getUseVariantManagement()){this._oToolbar.insertContent(this._oVariantManagement,0);}else if(this._oVariantManagement){this._oToolbar.removeContent(this._oVariantManagement);}};w.prototype._addSpacerToToolbar=function(){if(this._indexOfSpacerOnToolbar()===-1){this._oToolbar.addContent(new m());}};w.prototype._indexOfSpacerOnToolbar=function(){var a=this._oToolbar.getContent(),i,L;if(a){L=a.length;i=0;for(i;i<L;i++){if(a[i]instanceof m){return i;}}}return-1;};w.prototype._addPersonalisationToToolbar=function(){if(this.getUseChartPersonalisation()){if(!this._oChartPersonalisationButton){this._oChartPersonalisationButton=new h(this.getId()+"-btnPersonalisation",{icon:"sap-icon://action-settings",tooltip:this._oRb.getText("CHART_PERSOBTN_TOOLTIP"),press:q.proxy(function(e){this._oPersController.openDialog({dimeasure:{visible:true,payload:{availableChartTypes:this._getAllChartTypes()}},sort:{visible:true},filter:{visible:true}});},this)});}this._oToolbar.addContent(this._oChartPersonalisationButton);}else if(this._oChartPersonalisationButton){this._oToolbar.removeContent(this._oChartPersonalisationButton);}};w.prototype._addChartTypeToToolbar=function(){this._oChartTypeButton=this._createChartTypeButton();this._oToolbar.addContent(this._oChartTypeButton);};w.prototype._createChartTypeComboBox=function(){var a=this;var i=new I({key:"{$smartChartTypes>key}",text:"{$smartChartTypes>text}"});var b=new f({enabled:false,items:{path:"$smartChartTypes>/items",template:i}});b.attachSelectionChange(null,function(){a._setChartType(b.getSelectedItem().getKey());});return b;};w.prototype._createChartTypeButton=function(){var a=this;var b=new T({enabled:false,press:function(e){this.setPressed(true);a._displayChartTypes(e);}});this._enreachButton(this._oChart.getChartType());return b;};w.prototype._displayChartTypes=function(e){q.sap.require("sap.m.Bar");q.sap.require("sap.m.List");q.sap.require("sap.m.ListType");q.sap.require("sap.ui.core.ListItem");q.sap.require("sap.m.SearchField");q.sap.require("sap.m.PlacementType");q.sap.require("sap.m.StandardListItem");q.sap.require("sap.m.ResponsivePopover");var a=this,b,L,i,n;if(this._oChart&&e){var y=e.getSource();var z=new sap.m.StandardListItem({title:"{$smartChartTypes>text}",icon:"{$smartChartTypes>icon}",selected:"{$smartChartTypes>selected}"});L=new sap.m.List({mode:sap.m.ListMode.SingleSelectMaster,items:{path:"$smartChartTypes>/items",template:z},selectionChange:function(e){if(e&&e.mParameters&&e.mParameters.listItem){var A=e.mParameters.listItem.getBinding("title");if(A){var E=A.getContext();if(E){var G=E.getObject();if(G&&G.key){a._setChartType(G.key);a._enreachButton(G.key,G.text);}}}}y.setPressed(false);b.close();}});i=new sap.m.Bar();n=new sap.m.SearchField({placeholder:this._oRb.getText("CHART_TYPE_SEARCH")});n.attachLiveChange(function(e){a._triggerSearchInPopover(e,L);});i.addContentRight(n);b=new sap.m.ResponsivePopover({title:this._oRb.getText("CHART_TYPE_TITLE"),contentWidth:"25rem",contentHeight:"20rem",placement:sap.m.PlacementType.Bottom,subHeader:i});b.setModel(this.getModel("$smartChartTypes"),"$smartChartTypes");b.addContent(L);if(L.getItems().length<7){i.setVisible(false);}b.openBy(y);}};w.prototype._selectCurrentChartType=function(L){var a=this._oChart.getChartType();var b,e=L.getItems();for(var i=0;i<e.length;i++){b=e[i];if(b){var n=b.getBinding("title");if(n){var y=n.getContext();if(y){var z=y.getObject();if(z&&z.key&&(z.key===a)){L.setSelectedItem(b);return;}}}}}};var x={"bar":"sap-icon://horizontal-bar-chart","bullet":"sap-icon://horizontal-bullet-chart","bubble":"sap-icon://bubble-chart","column":"sap-icon://vertical-bar-chart","combination":"sap-icon://business-objects-experience","dual_bar":"sap-icon://horizontal-bar-chart","dual_column":"sap-icon://vertical-bar-chart","dual_combination":"sap-icon://business-objects-experience","dual_line":"sap-icon://line-chart","dual_stacked_bar":"sap-icon://full-stacked-chart","dual_stacked_column":"sap-icon://vertical-stacked-chart","dual_stacked_combination":"sap-icon://business-objects-experience","donut":"sap-icon://donut-chart","heatmap":"sap-icon://heatmap-chart","horizontal_stacked_combination":"sap-icon://business-objects-experience","line":"sap-icon://line-chart","pie":"sap-icon://pie-chart","scatter":"sap-icon://scatter-chart","stacked_bar":"sap-icon://full-stacked-chart","stacked_column":"sap-icon://vertical-stacked-chart","stacked_combination":"sap-icon://business-objects-experience","treemap":"sap-icon://Chart-Tree-Map","vertical_bullet":"sap-icon://vertical-bullet-chart","100_dual_stacked_bar":"sap-icon://full-stacked-chart","100_dual_stacked_column":"sap-icon://vertical-stacked-chart","100_stacked_bar":"sap-icon://full-stacked-chart","100_stacked_column":"sap-icon://full-stacked-column-chart"};w.prototype._getMatchingIcon=function(a){var i=x[a];if(!i){i="";}return i;};w.prototype._enreachButton=function(K,a){if(!this._oChartTypeButton){return;}if(a===undefined){a=K;var b=this._retrieveChartTypeDescription(K);if(b&&b.text){a=b.text;}}var e=this._getMatchingIcon(K);this._oChartTypeButton.setIcon(e?e:"sap-icon://vertical-bar-chart");this._oChartTypeButton.setTooltip(this._oRb.getText("CHART_TYPE_TOOLTIP",[a]));};w.prototype._updateAvailableChartType=function(){var a=this,b,e,i=[];b=this.getModel("$smartChartTypes");if(!b){return;}e={items:i};var n=this._oChart.getChartType();var y="";this._getAvailableChartTypes().forEach(function(z){var A={key:z.key,text:z.text,icon:a._getMatchingIcon(z.key),selected:n===z.key};i.push(A);if(A.selected){y=A.text;}});b.setData(e);if(this._oChartTypeButton){if(!this._oChartTypeButton.getEnabled()){this._oChartTypeButton.setEnabled(true);}this._enreachButton(n,y);}};w.prototype._createPersonalizationController=function(){if(this._oPersController||!this.getUseChartPersonalisation()){return;}var a=this.data("p13nDialogSettings");if(typeof a==="string"){try{a=JSON.parse(a);}catch(e){a=null;}}a=this._setIgnoreFromPersonalisationToSettings(a);a=a||{};q.sap.require("sap.ui.comp.personalization.Controller");var b=P.createChartWrapper(this._oChart,this._oChart.data("p13nData"));if(this.$()&&this.$().closest(".sapUiSizeCompact").length>0){this._oChart.addStyleClass("sapUiSizeCompact");}this._oPersController=new sap.ui.comp.personalization.Controller({table:b,setting:a,resetToInitialTableState:!this.getUseVariantManagement(),afterP13nModelDataChange:q.proxy(this._personalisationModelDataChange,this)});};w.prototype._setIgnoreFromPersonalisationToSettings=function(a){var i=P.createArrayFromString(this.getIgnoreFromPersonalisation());if(i.length){if(!a){a={};}var b=function(e){if(!a[e]){a[e]={};}a[e].ignoreColumnKeys=i;};b("dimeasure");b("filter");b("sort");}return a;};w.prototype._personalisationModelDataChange=function(e){this._oCurrentVariant=e.getParameter("persistentData");if(this._bApplyingVariant){return;}var a=e.getParameter("changeType");var b=this._getChangeStatus(a);if(b===sap.ui.comp.personalization.ChangeType.Unchanged){return;}if(!this.getUseVariantManagement()){this._persistPersonalisation();}else if(this._oVariantManagement){this._oVariantManagement.currentVariantSetModified(true);}if(b===sap.ui.comp.personalization.ChangeType.TableChanged){if(this._oCurrentVariant.dimeasure&&this._oCurrentVariant.dimeasure.chartTypeKey){this._updateAvailableChartType();}if(this._oSemanticalNavButton){this._oSemanticalNavButton.setEnabled(false);}}else if(b===sap.ui.comp.personalization.ChangeType.ModelChanged){if(this._bIsChartBound||!this._oSmartFilter){this._reBindChart();}else{this._showOverlay(true);}}};w.prototype._getChangeStatus=function(a){if(!a){return sap.ui.comp.personalization.ChangeType.ModelChanged;}if(a.sort===sap.ui.comp.personalization.ChangeType.ModelChanged||a.filter===sap.ui.comp.personalization.ChangeType.ModelChanged||a.dimeasure===sap.ui.comp.personalization.ChangeType.ModelChanged||a.group===sap.ui.comp.personalization.ChangeType.ModelChanged){return sap.ui.comp.personalization.ChangeType.ModelChanged;}if(a.sort===sap.ui.comp.personalization.ChangeType.TableChanged||a.filter===sap.ui.comp.personalization.ChangeType.TableChanged||a.dimeasure===sap.ui.comp.personalization.ChangeType.TableChanged||a.group===sap.ui.comp.personalization.ChangeType.TableChanged){return sap.ui.comp.personalization.ChangeType.TableChanged;}return sap.ui.comp.personalization.ChangeType.Unchanged;};w.prototype.setEntitySet=function(e){this.setProperty("entitySet",e);this._initialiseMetadata();};w.prototype.propagateProperties=function(){V.prototype.propagateProperties.apply(this,arguments);this._initialiseMetadata();};w.prototype._initialiseMetadata=function(){if(!this.bIsInitialised){v.handleModelInit(this,this._onMetadataInitialised);}};w.prototype._onMetadataInitialised=function(){this._bMetaModelLoadAttached=false;if(!this.bIsInitialised){this._createChartProvider();if(this._oChartProvider){this._oChartViewMetadata=this._oChartProvider.getChartViewMetadata();if(this._oChartViewMetadata){this.bIsInitialised=true;this._listenToSmartFilter();this._createVariantManagementControl();this._assignData();this._createContent();this._createToolbarContent();this._createPersonalizationController();this.fireInitialise();if(this.getEnableAutoBinding()){if(this._oSmartFilter&&this._oSmartFilter.isPending()){this._oSmartFilter.search();}else{this._reBindChart();}}}}}};w.prototype._createChartProvider=function(){var a,e;e=this.getEntitySet();a=this.getModel();if(a&&!this._bChartCreated){this._aAlwaysSelect=[];this._createToolbar();this._createChart();this._bChartCreated=true;}if(a&&e){this._oChartProvider=new p({entitySet:e,ignoredFields:this.getIgnoredFields(),dateFormatSettings:this.data("dateFormatSettings"),currencyFormatSettings:this.data("currencyFormatSettings"),defaultDropDownDisplayBehaviour:this.data("defaultDimensionDisplayBehaviour"),useSmartField:this.data("useSmartField"),enableInResultForLineItem:this.data("enableInResultForLineItem"),model:a});}};w.prototype._listenToSmartFilter=function(){var a=null;a=this.getSmartFilterId();this._oSmartFilter=this._findControl(a);if(this._oSmartFilter){this._oSmartFilter.attachSearch(this._reBindChart,this);this._oSmartFilter.attachFilterChange(this._showOverlay,this,true);this._oSmartFilter.attachCancel(this._showOverlay,this,false);}};w.prototype._renderOverlay=function(b){if(this._oChart){var $=this._oChart.$(),a=$.find(".sapUiCompSmartChartOverlay");if(b&&a.length===0){a=q("<div>").addClass("sapUiOverlay sapUiCompSmartChartOverlay").css("z-index","1");$.append(a);}else if(!b){a.remove();}}};w.prototype._showOverlay=function(b){if(b){var a={show:true};this.fireShowOverlay({overlay:a});b=a.show;}this._renderOverlay(b);};w.prototype._findControl=function(i){var R,a;if(i){R=sap.ui.getCore().byId(i);if(!R){a=this._getView();if(a){R=a.byId(i);}}}return R;};w.prototype._getView=function(){if(!this._oView){var a=this.getParent();while(a){if(a instanceof sap.ui.core.mvc.View){this._oView=a;break;}a=a.getParent();}}return this._oView;};w.prototype.rebindChart=function(){this._reBindChart();};w.prototype._reBindChart=function(){var R,a,b,e,n,y=[],z,E,A,G={},H={preventChartBind:false};e=this._getChartPersonalisationData()||{};z=e.filters;E=e.excludeFilters;A=e.sorters;if(this._oSmartFilter){n=this._oSmartFilter.getFilters();G=this._oSmartFilter.getParameters()||{};}if(n&&n.length){if(E){y=[new sap.ui.model.Filter([n[0],E],true)];}else{y=n;}}else if(E){y=[E];}if(z){z=y.concat(z);}else{z=y;}R=this.getRequestAtLeastFields();if(R){a=R.split(",");}else{a=[];}a.concat(this._aAlwaysSelect);if(!b||!b.length){b=a;}else{for(var i=0;i<a.length;i++){if(b.indexOf(a[i])<0){b.push(a[i]);}}}if(b&&b.length){G["select"]=b.toString();}G["entitySet"]=this.getEntitySet();if(!A){A=[];}H.filters=z;H.sorter=A;H.parameters=G;this.fireBeforeRebindChart({bindingParams:H});if(!H.preventChartBind){A=H.sorter;z=H.filters;this._oChart.setBusy(true);this._bDataLoadPending=true;this._oChart.bindData({path:this.getChartBindingPath()||("/"+this.getEntitySet()),parameters:G,filters:z,sorter:A,events:{dataReceived:function(J){if(J&&J.getParameter&&J.getParameter("__simulateAsyncAnalyticalBinding")){return;}this._onDataLoadComplete(J,true);this.fireDataReceived();}.bind(this),change:this._onDataLoadComplete.bind(this)}});this._showOverlay(false);this._bIsChartBound=true;}};w.prototype._onDataLoadComplete=function(e,b){if(this._oSemanticalNavButton){this._oSemanticalNavButton.setEnabled(false);}if(this._bDataLoadPending||b){this._bDataLoadPending=false;this._updateAvailableChartType();this._oChart.setBusy(false);}};w.prototype._assignData=function(){if(this._oChartViewMetadata&&this._oChart){if(this._oChartViewMetadata.measureFields&&(this._oChartViewMetadata.measureFields.length>0)){this._oChart.setVisibleMeasures(this._oChartViewMetadata.measureFields);}if(this._oChartViewMetadata.dimensionFields&&(this._oChartViewMetadata.dimensionFields.length>0)){this._oChart.setVisibleDimensions(this._oChartViewMetadata.dimensionFields);}if(!this.getChartType()&&this._oChartViewMetadata.chartType){this._setChartType(this._oChartViewMetadata.chartType);}if(this._oChartViewMetadata.semantics==="aggregate"){this._oChart.setIsAnalytical(true);}}};w.prototype._createP13nObject=function(a){return{columnKey:a.name,leadingProperty:a.name,additionalProperty:a.additionalProperty,sortProperty:a.sortable?a.name:undefined,filterProperty:a.filterable?a.name:undefined,type:a.filterType,maxLength:a.maxLength,precision:a.precision,scale:a.scale,isMeasure:a.isMeasure,isDimension:a.isDimension,aggregationRole:a.aggregationRole,label:a.fieldLabel,tooltip:a.quickInfo};};w.prototype._createContent=function(){q.sap.require("sap.ui.comp.util.FormatUtil");var i,L=0,a,b,e,n=[],y,z=this;L=this._oChartViewMetadata.fields.length;for(i=0;i<L;i++){b=null;a=this._oChartViewMetadata.fields[i];y=this._createP13nObject(a);e={name:a.name,label:a.fieldLabel};if(a.inResult){this._aAlwaysSelect.push(a.name);}if(a.isDimension){b=new D(e);this._oChart.addDimension(b);if(a.description){b.setTextProperty(a.description);b.setTextFormatter(function(K,A){var N=this.getIdentity();var E=z._getDisplayBehaviour(N);return sap.ui.comp.util.FormatUtil.getFormattedExpressionFromDisplayBehaviour(E,K,A);});}}else if(a.isMeasure){b=new M(e);this._oChart.addMeasure(b);if(a.unit){b.setUnitBinding(a.unit);}}else if(a.sortable||a.filterable){n.push(y);}if(b){if(a.role){b.setRole(a.role);}b.data("p13nData",y);}}if(this._oChart){this._oChart.data("p13nData",n);}};w.prototype._getDisplayBehaviour=function(n){var a=this._getField(n);if(a){return a.displayBehaviour;}return"";};w.prototype._getField=function(n){var a,i,L;if(n&&this._oChartViewMetadata&&this._oChartViewMetadata.fields){L=this._oChartViewMetadata.fields.length;for(i=0;i<L;i++){a=this._oChartViewMetadata.fields[i];if(a.name===n){return a;}}}return null;};w.prototype._createChart=function(){var a=this.getItems(),L=a?a.length:0,b;while(L--){b=a[L];if(b instanceof C){break;}b=null;}if(b){this._oChart=b;}else{this._oChart=new C({uiConfig:{applicationSet:'fiori'},vizProperties:{title:{text:''}},selectionMode:this.getSelectionMode(),width:"100%"});this.insertItem(this._oChart,2);}if(!this._oChart.getLayoutData()){this._oChart.setLayoutData(new sap.m.FlexItemData({growFactor:1,baseSize:"0%"}));}this._setChartType(this.getChartType());this._createTooltipOrPopover();};w.prototype.getChart=function(){return this._oChart;};w.prototype._getChartTypes=function(){var a;try{a=sap.chart.api.getChartTypes();}catch(e){a={};q.sap.log.error("sap.chart.api..getChartTypes throws an exception.\n"+e.toString());}return a;};w.prototype._getAvailableChartTypes=function(){var i,K,a=[],b,e={},n;if(this._oChart){n=P.createArrayFromString(this.getIgnoredChartTypes());e=this._getChartTypes();b=this._oChart.getAvailableChartTypes().available;if(b){for(i=0;i<b.length;i++){K=b[i].chart;if(n.indexOf(K)<0){a.push({key:K,text:e[K]});}}}}return a;};w.prototype._getAllChartTypes=function(){var K,a=[],b,i;i=P.createArrayFromString(this.getIgnoredChartTypes());b=this._getChartTypes();for(K in b){if(K){if(i.indexOf(K)<0){a.push({key:K,text:b[K]});}}}return a;};w.prototype._retrieveChartTypeDescription=function(a){var b=this._getChartTypes();return({key:a,text:b[a]});};w.prototype._setChartType=function(a){if(this._oChart){this._oChart.setChartType(a);}};w.prototype._getDimensions=function(){var a=[];if(this._oChart){a=this._oChart.getDimensions();}return a;};w.prototype._getVisibleDimensions=function(){var a=[];if(this._oChart){a=this._oChart.getVisibleDimensions();}return a;};w.prototype._getMeasures=function(){var a=[];if(this._oChart){a=this._oChart.getMeasures();}return a;};w.prototype._getVisibleMeasures=function(){var a=[];if(this._oChart){a=this._oChart.getVisibleMeasures();}return a;};w.prototype._getSortedDimensions=function(){var e=[];if(this._oChart){e=this._oChart.getDimensions();if(e){e.sort(function(a,b){return a.getLabel().localeCompare(b.getLabel());});}}return e;};w.prototype.fetchVariant=function(){if(this._oCurrentVariant==="STANDARD"||this._oCurrentVariant===null){return{};}return this._oCurrentVariant;};w.prototype.applyVariant=function(a,b){this._oCurrentVariant=a;if(this._oCurrentVariant==="STANDARD"){this._oCurrentVariant=null;}if(b==="STANDARD"){this._oApplicationDefaultVariant=this._oCurrentVariant;}if(this._oApplicationDefaultVariant&&!b){this._oCurrentVariant=q.extend(true,{},this._oApplicationDefaultVariant,a);}this._bApplyingVariant=true;if(this._oPersController){if(this._oCurrentVariant===null||q.isEmptyObject(this._oCurrentVariant)){this._oPersController.resetPersonalization(sap.ui.comp.personalization.ResetType.ResetFull);}else{this._oPersController.setPersonalizationData(this._oCurrentVariant);}}if(this._bIsChartBound||!this._oSmartFilter){this._reBindChart();}else{this._showOverlay(true);}this._bApplyingVariant=false;this.fireAfterVariantApply({currentVariantId:this.getCurrentVariantId()});};w.prototype._getFieldTooltip=function(K){var a=this._getFieldByKey(K);if(a){return a.quickInfo;}return"";};w.prototype._getFieldByKey=function(K){var i,a=null;if(this._oChartViewMetadata&&this._oChartViewMetadata.fields){for(i=0;i<this._oChartViewMetadata.fields.length;i++){a=this._oChartViewMetadata.fields[i];if(K===a.name){return a;}}return null;}};w.prototype._getByKey=function(a,K){var i,L,b,e;if(a){L=a.length;for(i=0;i<L;i++){b=a[i];e=b.data("p13nData");if(e&&e.columnKey===K){return b;}}}return null;};w.prototype._getDimensionByKey=function(K){if(this._oChart){return this._getByKey(this._oChart.getDimensions(),K);}return null;};w.prototype._getMeasureByKey=function(K){if(this._oChart){return this._getByKey(this._oChart.getMeasures(),K);}return null;};w.prototype._getChartObjByKey=function(K){var a=this._getDimensionByKey(K);if(!a){a=this._getMeasureByKey(K);}return a;};w.prototype._getPathFromColumnKeyAndProperty=function(a,b){var e=null,i,n;i=this._getChartObjByKey(a);if(i){n=i.data("p13nData");if(n){e=n[b];}}return e;};w.prototype._getChartPersonalisationData=function(){if(!this._oCurrentVariant){return null;}var a=[],b=[],e=[],E,i,n;if(this._oCurrentVariant.sort){i=this._oCurrentVariant.sort.sortItems;}else{i=this._aInitialSorters;}if(i){i.forEach(function(y){var z=y.operation==="Descending";n=y.columnKey;a.push(new sap.ui.model.Sorter(n,z));},this);}if(this._oCurrentVariant.filter){this._oCurrentVariant.filter.filterItems.forEach(function(y){var z=y.value1,A=y.value2;n=y.columnKey;if(z instanceof Date&&this._oChartProvider&&this._oChartProvider.getIsUTCDateHandlingEnabled()){z=r.getDateInUTCOffset(z);A=A?r.getDateInUTCOffset(A):A;}if(y.exclude){e.push(new s(n,t.NE,z));}else{b.push(new s(n,y.operation,z,A));}},this);if(e.length){E=new s(e,true);}}return{filters:b,excludeFilters:E,sorters:a};};w.prototype._persistPersonalisation=function(){var a=this;if(this._oVariantManagement){this._oVariantManagement.getVariantsInfo(function(b){var e=null;if(b&&b.length>0){e=b[0].key;}var i=e!==null;var n={name:"Personalisation",global:false,overwrite:i,key:e,def:true};a._oVariantManagement.fireSave(n);});}};w.prototype.getCurrentVariantId=function(){var K="";if(this._oVariantManagement){K=this._oVariantManagement.getCurrentVariantId();}return K;};w.prototype.setCurrentVariantId=function(a){if(this._oVariantManagement){this._oVariantManagement.setCurrentVariantId(a);}else{q.sap.log.error("sap.ui.comp.smartchart.SmartChart.prototype.setCurrentVariantId: VariantManagement does not exist");}};w.prototype._adjustHeight=function(){if(this._oChart){var i=0,H=this.getDomRef().offsetHeight;if(H===0){return;}if(this._oToolbar&&this._oToolbar.getDomRef()){i=this._oToolbar.getDomRef().offsetHeight;}var a=0;this._oChart.setHeight((H-i-a)+"px");}};w.prototype.setFullScreen=function(b,a){if(!this.oFullScreenButton||(b===this.bFullScreen&&!a)){return;}this.bFullScreen=b;if(this.bFullScreen){this.oFullScreenButton.setTooltip(this._oRb.getText("CHART_MINIMIZEBTN_TOOLTIP"));this.oFullScreenButton.setIcon("sap-icon://exit-full-screen");this._enterFullScreen();}else{this.oFullScreenButton.setTooltip(this._oRb.getText("CHART_MAXIMIZEBTN_TOOLTIP"));this.oFullScreenButton.setIcon("sap-icon://full-screen");this._exitFullScreen();}};w.prototype._enterFullScreen=function(){q.sap.require("sap.ui.core.delegate.ScrollEnablement");this._oScrollEnablement=new sap.ui.core.delegate.ScrollEnablement(this,this.getId()+'-wrapper',{horizontal:true,vertical:true});if(!this._oPopup){this._oPopup=new sap.ui.core.Popup({modal:true,shadow:false,autoClose:false});}this.$content=this.$();if(this.$content){this.$tempNode=q('<div></div>');this.$content.before(this.$tempNode);this._$overlay=q("<div id='"+q.sap.uid()+"'></div>");this._$overlay.css("top","0px");this._$overlay.css("left","0px");this._$overlay.css("width","100%");this._$overlay.css("height","100%");this._$overlay.append(this.$content);this._oPopup.setContent(this._$overlay);}else{q.sap.log.warn('Overlay: content does not exist or contains more than one child');}this._oToolbar.setDesign(k.Solid);this._oPopup.open(200,null,q('body'));};w.prototype._exitFullScreen=function(){if(!this.$tempNode){return;}if(this._oScrollEnablement){this._oScrollEnablement.destroy();this._oScrollEnablement=null;}this.$tempNode.replaceWith(this.$content);this._oToolbar.setDesign(k.Auto);this._oPopup.close();this._$overlay.remove();};w.prototype.exit=function(){this._oRb=null;if(this._oSmartFilter){this._oSmartFilter.detachSearch(this._reBindChart,this);this._oSmartFilter.detachFilterChange(this._showOverlay,this);this._oSmartFilter.detachCancel(this._showOverlay,this);}if(this._oChartProvider&&this._oChartProvider.destroy){this._oChartProvider.destroy();}this._oChartProvider=null;if(this._oPersController&&this._oPersController.destroy){this._oPersController.destroy();}this._oPersController=null;if(this._oVariantManagement&&this._oVariantManagement.destroy){this._oVariantManagement.destroy();}this._oVariantManagement=null;this._destroyPopover();if(this._oPopup){this._oPopup.destroy();this._oPopup=null;}if(u.system.desktop&&this.sResizeListenerId){sap.ui.core.ResizeHandler.deregister(this.sResizeListenerId);this.sResizeListenerId=null;}else{u.orientation.detachHandler(this._adjustHeight,this);u.resize.detachHandler(this._adjustHeight,this);}this._oCurrentVariant=null;this._oApplicationDefaultVariant=null;this._oChartViewMetadata=null;this._aAlwaysSelect=null;this._oSmartFilter=null;this._oToolbar=null;this._oChartPersonalisationButton=null;this._oView=null;this._oChart=null;};return w;},true);
