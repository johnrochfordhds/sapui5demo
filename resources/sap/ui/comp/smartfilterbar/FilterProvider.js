/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/m/ComboBox','sap/m/DatePicker','sap/m/DateRangeSelection','sap/m/TimePicker','sap/m/Input','sap/m/MultiComboBox','sap/m/MultiInput','sap/m/SearchField','sap/m/Token','sap/ui/comp/odata/MetadataAnalyser','sap/ui/comp/providers/ValueHelpProvider','sap/ui/comp/providers/ValueListProvider','sap/ui/model/Filter','sap/ui/model/json/JSONModel','sap/ui/comp/odata/ODataType','sap/ui/comp/util/FormatUtil'],function(q,C,D,a,T,I,M,b,S,c,d,V,e,F,J,O,f){"use strict";var g=function(p){this._bInitialized=false;this._bPending=true;if(p){this._oParentODataModel=p.model;this._sServiceURL=p.serviceUrl;this._sBasicSearchFieldName=p.basicSearchFieldName;this._isBasicSearchEnabled=p.enableBasicSearch;this._bUseContainsAsDefault=p.useContainsAsDefaultFilter==="true";this.sEntityType=p.entityType;this._isRunningInValueHelpDialog=p.isRunningInValueHelpDialog;this._oAdditionalConfiguration=p.additionalConfiguration;this.sDefaultDropDownDisplayBehaviour=p.defaultDropDownDisplayBehaviour;this.sDefaultTokenDisplayBehaviour=p.defaultTokenDisplayBehaviour;if(typeof p.dateFormatSettings==="string"){try{this._oDateFormatSettings=p.dateFormatSettings?JSON.parse(p.dateFormatSettings):undefined;}catch(h){}}else{this._oDateFormatSettings=p.dateFormatSettings;}this._oSmartFilter=p.smartFilter;}this.sFilterModelName=g.FILTER_MODEL_NAME;this._sBasicFilterAreaID=g.BASIC_FILTER_AREA_ID;this._aFilterBarViewMetadata=[];this._aFilterBarMultiValueFieldMetadata=[];this._aFilterBarDateFieldNames=[];this._aFilterBarTimeFieldNames=[];this._aFilterBarTimeIntervalFieldNames=[];this._aFilterBarDateTimeMultiValueFieldNames=[];this._aFilterBarStringFieldNames=[];this._aFieldGroupAnnotation=[];this._oMetadataAnalyser=new d(this._oParentODataModel||this._sServiceURL);this.oModel=new J();this._aValueListProvider=[];this._aValueHelpDialogProvider=[];this._mConditionTypeFields={};this._intialiseMetadata();this._bInitialized=true;};g.FILTER_MODEL_NAME="fi1t3rM0d31";g.BASIC_FILTER_AREA_ID="_BASIC";g.BASIC_SEARCH_FIELD_ID="_BASIC_SEARCH_FIELD";g.CUSTOM_FIELDS_MODEL_PROPERTY="_CUSTOM";g.FIELD_NAME_REGEX=/\./g;g.prototype._intialiseMetadata=function(){var G,h,o,k,i,j,l,m,n,p,r;this._aFilterBarViewMetadata.push({groupName:this._sBasicFilterAreaID,index:0,fields:[]});this.sEntityTypeName=this._oMetadataAnalyser.removeNamespace(this.sEntityType);k=this._oMetadataAnalyser.getAllFilterableFieldsByEntityTypeName(this.sEntityType);if(k){this._updateDisplayBehaviour();this._aFieldGroupAnnotation=this._oMetadataAnalyser.getFieldGroupAnnotation(this.sEntityType);if(this._aFieldGroupAnnotation){G=this._aFieldGroupAnnotation.length;for(i=0;i<G;i++){o=this._aFieldGroupAnnotation[i];n=this._createGroupMetadata(o);n.index=this._aFilterBarViewMetadata.length;this._aFilterBarViewMetadata.push(n);}}G=k.length;for(i=0;i<G;i++){o=k[i];h=o.fields.length;n=this._createGroupMetadata(o);this._aFilterBarViewMetadata.push(n);for(j=0;j<h;j++){l=o.fields[j];if(l.type.indexOf("Edm.")===0){m=this._createFieldMetadata(l);n.fields.push(m);}}}}r=this._getAdditionalConfigurationForCustomGroups(k);G=r.length;for(j=0;j<G;j++){n=this._createGroupMetadataForCustomGroup(r[j]);if(n){this._aFilterBarViewMetadata.push(n);}}p=this._getAdditionalConfigurationForCustomFilterFields();h=p.length;for(j=0;j<h;j++){m=this._createFieldMetadataForCustomFilterFields(p[j]);if(m){this._aFilterBarViewMetadata[0].fields.push(m);}}if(this._hasBasicSearch()){m=this._createBasicSearchFieldMetadata();this._aFilterBarViewMetadata[0].fields.push(m);}this._applyGroupId();this._applyIndexes();this._createInitialModel(true);this._initializeConditionTypeFields();this.setPending(this.isPending());};g.prototype.attachPendingChange=function(h){this._fPendingChange=h;};g.prototype.detachPendingChange=function(){this._fPendingChange=null;};g.prototype.setPending=function(v){var h=this._bPending!==v;this._bPending=v;if(h&&this._fPendingChange){this._fPendingChange(v);}};g.prototype.isPending=function(){if(!this._bInitialized){return true;}for(var n in this._mConditionTypeFields){if(this._mConditionTypeFields[n].conditionType.isPending()){return true;}}return false;};g.prototype._updateDisplayBehaviour=function(){this._sTextArrangementDisplayBehaviour=this._oMetadataAnalyser.getTextArrangementValue(this.sEntityType);if(!this.sDefaultDropDownDisplayBehaviour){if(this._sTextArrangementDisplayBehaviour){this.sDefaultDropDownDisplayBehaviour=this._sTextArrangementDisplayBehaviour;}else{this.sDefaultDropDownDisplayBehaviour=sap.ui.comp.smartfilterbar.ControlConfiguration.DISPLAYBEHAVIOUR.descriptionOnly;}}if(!this.sDefaultTokenDisplayBehaviour){if(this._sTextArrangementDisplayBehaviour){this.sDefaultTokenDisplayBehaviour=this._sTextArrangementDisplayBehaviour;}else{this.sDefaultTokenDisplayBehaviour=sap.ui.comp.smartfilterbar.ControlConfiguration.DISPLAYBEHAVIOUR.descriptionAndId;}}};g.prototype._hasBasicSearch=function(){return this._isBasicSearchEnabled;};g.prototype._getAdditionalConfigurationForCustomFilterFields=function(){var h,l,n,i,r,j,k,o;if(!this._oAdditionalConfiguration){return[];}h=this._oAdditionalConfiguration.getControlConfiguration();o=this._oMetadataAnalyser.getAllFilterableFieldNamesByEntityTypeName(this.sEntityType);if(!o||!o.length){return h;}r=[];n=o.length;l=h.length;for(i=0;i<l;i++){k=false;for(j=0;j<n;j++){if(o[j]===h[i].key){k=true;break;}}if(!k){r.push(h[i]);}}return r;};g.prototype._getAdditionalConfigurationForCustomGroups=function(o){var G,l,n,i,r,j,h,s;if(!this._oAdditionalConfiguration){return[];}G=this._oAdditionalConfiguration.getGroupConfiguration();if(!o||!o.length){return G;}r=[];n=o.length;l=G.length;for(i=0;i<l;i++){h=false;for(j=0;j<n;j++){s=o[j].groupName||o[j].groupEntityName;if(s===G[i].key){h=true;break;}}if(!h){r.push(G[i]);}}return r;};g.prototype._createInitialModelForField=function(j,o,u){var h,i,H=false,k=false,l=null,s=null,L,m=null,n=[],r=[];if(!o||o.isCustomFilterField){return;}if(o.filterRestriction!==sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.multiple){k=true;}if(u){h=o.defaultFilterValues;H=h&&h.length;}if(o.filterRestriction===sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.single){if(H){i=h[0];l=i.low;}j[o.fieldName]=l;}else if(o.filterRestriction===sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.interval&&o.type!=="Edm.Time"){if(H){i=h[0];l=i.low;s=i.high;}j[o.fieldName]={low:l,high:s};}else{if(H){L=h.length;while(L--){i=h[L];if(k){m={"exclude":i.sign==="E","operation":i.operator,"keyField":o.fieldName,"value1":i.low,"value2":i.high};}else{m={key:i.low,text:i.low};}n.push(m);}}this._aFilterBarMultiValueFieldMetadata.push(o);j[o.fieldName]={value:null};if(k){r=n.slice(0);n=[];j[o.fieldName].ranges=r;}j[o.fieldName].items=n;this._updateMultiValueControl(o.control,n,r);}};g.prototype._createInitialModel=function(u){var o,G,h,k,j,i;o={};this._bCreatingInitialModel=true;this._aFilterBarMultiValueFieldMetadata=[];if(this._aFilterBarViewMetadata){G=this._aFilterBarViewMetadata.length;for(i=0;i<G;i++){k=this._aFilterBarViewMetadata[i];h=k.fields.length;for(j=0;j<h;j++){this._createInitialModelForField(o,k.fields[j],u);}}}this.oModel.setData(o);this._updateConditionTypeFields([]);this._bCreatingInitialModel=false;};g.prototype._updateMultiValueControl=function(o,h,r){var i=0,t=null,j=null,R=null,s=null,k=null;if(o&&h){i=h.length;if(o instanceof b){t=[];while(i--){s=h[i].text||h[i].key;t.push(new c({key:h[i].key,text:s,tooltip:s}));}if(r){i=r.length;while(i--){R=r[i];if(R.tokenText){s=R.tokenText;}else{s=f.getFormattedRangeText(R.operation,R.value1,R.value2,R.exclude);}j=new c({text:s,tooltip:s});j.data("range",R);t.push(j);}}o.setTokens(t);}if(o instanceof M){k=[];while(i--){k.push(h[i].key);}o.setSelectedKeys(k);}}};g.prototype._applyIndexes=function(){var h,i;if(!this._aFilterBarViewMetadata){return;}this._aFilterBarViewMetadata=this._sortByIndex(this._aFilterBarViewMetadata);h=this._aFilterBarViewMetadata.length;for(i=0;i<h;i++){if(this._aFilterBarViewMetadata[i].fields){this._aFilterBarViewMetadata[i].fields=this._sortByIndex(this._aFilterBarViewMetadata[i].fields);}}};g.prototype._sortByIndex=function(A){var h,i,l,j,k,r;if(!A||!A.length){return A;}r=[];h=[];l=A.length;for(i=0;i<l;i++){if(parseInt(A[i].index,10)||A[i].index===0){if(h.length===0){h.push(A[i]);}else{k=h.length;for(j=0;j<k;j++){if(h[j].index>A[i].index){h.splice(j,0,A[i]);break;}else if(j+1===h.length){h.push(A[i]);break;}}}}else{r.push(A[i]);}}l=h.length;for(i=0;i<l;i++){if(h[i].index>r.length){r.push(h[i]);}else{r.splice(h[i].index,0,h[i]);}}return r;};g.prototype._applyGroupId=function(){var h,i,l,j,o,n,k;h=this._aFilterBarViewMetadata.length;for(i=0;i<h;i++){if(!this._aFilterBarViewMetadata[i].fields){continue;}l=this._aFilterBarViewMetadata[i].fields.length;for(j=0;j<l;j++){o=this._aFilterBarViewMetadata[i].fields[j];if(o&&o.groupId&&o.groupId!==this._aFilterBarViewMetadata[i].groupName){n=undefined;for(k=0;k<h;k++){if(this._aFilterBarViewMetadata[k].groupName===o.groupId){n=this._aFilterBarViewMetadata[k];break;}}if(n){this._aFilterBarViewMetadata[i].fields.splice(j,1);j--;l--;n.fields=n.fields||[];n.fields.push(o);}}}}};g.prototype._createGroupMetadata=function(o){var G,h,s;s=o.groupName||o.groupEntityName;h=this._oAdditionalConfiguration.getGroupConfigurationByKey(s);G={};G.groupName=s;G.groupLabel=this._getGroupLabel(o,h);G.fields=[];G.index=this._getGroupIndex(h);return G;};g.prototype._createGroupMetadataForCustomGroup=function(G){var o;o={};o.groupName=G.key;o.groupLabel=G.label;o.fields=[];o.index=this._getGroupIndex(G);return o;};g.prototype._createControl=function(o){var h,t,i=false,j,k={},m,l;if(o.customControl){return o.customControl;}if(o.precision||o.scale){k.precision=o.precision;k.scale=o.scale;}if(o.maxLength){k.maxLength=o.maxLength;}if(o.displayFormat){k.displayFormat=o.displayFormat;}if(o.fControlConstructor===a||o.fControlConstructor===D){j=this._oDateFormatSettings;}t=O.getType(o.type,j,k);h=new o.fControlConstructor();if(o.fControlConstructor===a){h.bindProperty('dateValue',this.sFilterModelName+">/"+o.fieldName+"/low");h.bindProperty('secondDateValue',this.sFilterModelName+">/"+o.fieldName+"/high");}else if(o.fControlConstructor===C){if(h.setForceSelection){h.setForceSelection(true);}this._associateValueList(h,"items",o);h.attachSelectionChange(function(){if(this._bUpdatingFilterData||this._bCreatingInitialModel){return;}h.fireChange({filterChangeReason:o.fieldName,value:""});}.bind(this));h.bindProperty('selectedKey',this.sFilterModelName+">/"+o.fieldName);}else if(o.fControlConstructor===M){this._associateValueList(h,"items",o);h.attachSelectionChange(function(E){if(this._bUpdatingFilterData||this._bCreatingInitialModel){return;}var n=E.getSource(),s=null,K=[],L;s=n.getSelectedItems();if(s){L=s.length;while(L--){K.push({key:s[L].getKey(),text:s[L].getText()});}}if(this.oModel){this.oModel.setProperty("/"+o.fieldName+"/items",K);}n.fireChange({filterChangeReason:o.fieldName,value:""});}.bind(this));h.bindProperty('value',this.sFilterModelName+">/"+o.fieldName+"/value");}else if(o.fControlConstructor===b){if(o.controlType===sap.ui.comp.smartfilterbar.ControlConfiguration.CONTROLTYPE.date||o.type==="Edm.Time"){h.setValueHelpOnly(true);if(o.filterRestriction===sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.interval){this._associateValueHelpDialog(h,o,false,false);}else{this._associateValueHelpDialog(h,o,true,true);}}else{if(o.hasValueHelpDialog){this._associateValueHelpDialog(h,o,o.filterRestriction!==sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.multiple,true);}else{h.setShowValueHelp(false);}h.bindProperty('value',{path:this.sFilterModelName+">/"+o.fieldName+"/value",type:t});}this._handleMultiInput(h,o);}else if(o.fControlConstructor===I){if(o.filterRestriction===sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.interval){i=true;h.bindProperty('value',this.sFilterModelName+">/"+o.fieldName+"/low");if(!this.oResourceBundle){this.oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");}if(!this.sIntervalPlaceholder){this.sIntervalPlaceholder=this.oResourceBundle.getText("INTERVAL_PLACEHOLDER_TEXT");}h.setPlaceholder(this.sIntervalPlaceholder);}else{h.bindProperty('value',{path:this.sFilterModelName+">/"+o.fieldName,type:t});}if(o.hasValueHelpDialog){h.setShowValueHelp(true);this._associateValueHelpDialog(h,o,false,false);}}else if(o.fControlConstructor===D||o.fControlConstructor===T){h.bindProperty('dateValue',this.sFilterModelName+">/"+o.fieldName);}if(h instanceof D){if(this._oDateFormatSettings&&this._oDateFormatSettings.style){h.setDisplayFormat(this._oDateFormatSettings.style);}h.attachChange(function(E){var v=E.getParameter("valid");h.data("__mandatoryEmpty",null);if(v){h.setValueState(sap.ui.core.ValueState.None);h.setValueStateText();}else{h.setValueState(sap.ui.core.ValueState.Error);if(t){try{t.parseValue("foo","string");}catch(n){h.setValueStateText(n.message);}}}});}if(o.hasTypeAhead){h.setShowSuggestion(true);h.setFilterSuggests(false);this._associateValueList(h,"suggestionRows",o,true);}if(o.displayFormat==="UpperCase"&&h.attachChange&&h.setValue){h.attachChange(function(){var v=h.getValue();if(v){h.setValue(v.toUpperCase());}});}if(h instanceof I){if(!o.hasValueListAnnotation&&!i&&o.maxLength){m=parseInt(o.maxLength,10);if(!isNaN(m)){h.setMaxLength(m);}}}l=function(E){var n=E.getParameter("exception");if(h){if(n){if(h.setValueStateText){h.setValueStateText(n.message);}}if(h.setValueState){h.setValueState(sap.ui.core.ValueState.Error);}h.data("__mandatoryEmpty",null);}};h.attachParseError(l);h.attachFormatError(l);h.attachValidationError(l);h.attachValidationSuccess(function(E){if(h){if(h.setValueState){h.setValueState(sap.ui.core.ValueState.None);}if(h.setValueStateText){h.setValueStateText();}h.data("__mandatoryEmpty",null);delete h.__sValidationText;}});return h;};g.prototype._getControlConstructor=function(o){var h=I,i,j;if(o.isCustomFilterField){h=undefined;}else{i=(o.filterRestriction===sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.single);j=(o.filterRestriction===sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.interval);if(o.controlType===sap.ui.comp.smartfilterbar.ControlConfiguration.CONTROLTYPE.date){o.displayFormat="Date";if(i){h=D;}else{h=j?a:b;}this._aFilterBarDateFieldNames.push(o.fieldName);if(o.filterRestriction===sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.multiple){this._aFilterBarDateTimeMultiValueFieldNames.push(o.fieldName);}}else if(o.controlType===sap.ui.comp.smartfilterbar.ControlConfiguration.CONTROLTYPE.dropDownList){h=(i)?C:M;if(!i){o.filterRestriction=sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.multiple;}}else if(o.type==="Edm.Time"){if(i){h=T;}else{h=b;}this._aFilterBarTimeFieldNames.push(o.fieldName);if(j){this._aFilterBarTimeIntervalFieldNames.push(o.fieldName);}else if(o.filterRestriction===sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.multiple){this._aFilterBarDateTimeMultiValueFieldNames.push(o.fieldName);}}else if(!i&&!j){h=b;}}return h;};g.prototype._handleMultiInput=function(o,h){o.setEnableMultiLineMode(true);o.attachTokenChange(function(E){if(this._bUpdatingFilterData||this._bCreatingInitialModel||E.getParameter("type")!=="tokensChanged"){return;}var t=E.getSource().getTokens(),i=[],l,j=null,r=null,R=[];if(t){l=t.length;while(l--){j=t[l];r=j.data("range");if(r){r.tokenText=j.getText();R.push(r);}else{i.push({key:j.getKey(),text:j.getText()});}}}if(this.oModel){this.oModel.setProperty("/"+h.fieldName+"/items",i);this.oModel.setProperty("/"+h.fieldName+"/ranges",R);}o.fireChange({filterChangeReason:h.fieldName,value:""});}.bind(this));if(h.hasValueListAnnotation||h.type==="Edm.String"){o.attachEvent("_validateOnPaste",function(E){var t=E.getParameter("texts"),p,l,s,r;l=t?t.length:0;if(l>1){E.preventDefault();p=this.oModel.getProperty("/"+h.fieldName);r=p.ranges||[];o.setValue("");while(l--){s=t[l];if(s){r.push({"exclude":false,"operation":"EQ","keyField":h.fieldName,"value1":s,"value2":null});}}this.oModel.setProperty("/"+h.fieldName+"/ranges",r);this._updateMultiValueControl(o,p.items,r);}}.bind(this));}};g.prototype._associateValueHelpDialog=function(o,h,s,i){this._aValueHelpDialogProvider.push(new V({loadAnnotation:h.hasValueListAnnotation,fullyQualifiedFieldName:h.fullName,metadataAnalyser:this._oMetadataAnalyser,control:o,filterModel:this.oModel,filterProvider:this,model:this._oParentODataModel,preventInitialDataFetchInValueHelpDialog:h.preventInitialDataFetchInValueHelpDialog,dateFormatSettings:this._oDateFormatSettings,supportMultiSelect:i,supportRanges:s,isUnrestrictedFilter:h.filterRestriction!==sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.multiple,isSingleIntervalRange:h.filterRestriction===sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.interval,fieldName:h.fieldName,type:h.filterType,scale:h.scale,precision:h.precision,maxLength:h.maxLength,displayFormat:h.displayFormat,displayBehaviour:h.displayBehaviour,title:h.label}));};g.prototype._associateValueList=function(o,A,h,H){if(h.hasValueListAnnotation){this._aValueListProvider.push(new e({control:o,fieldName:h.fieldName,typeAheadEnabled:H,aggregation:A,displayFormat:h.displayFormat,displayBehaviour:h.displayBehaviour,dateFormatSettings:this._oDateFormatSettings,loadAnnotation:true,fullyQualifiedFieldName:h.fullName,metadataAnalyser:this._oMetadataAnalyser,filterModel:this.oModel,filterProvider:this,model:this._oParentODataModel}));}};g.prototype._createFieldMetadata=function(o){var h,i;o.fieldName=this._getFieldName(o);o.fieldNameOData=o.fieldName.replace(g.FIELD_NAME_REGEX,"/");i=this._oAdditionalConfiguration.getControlConfigurationByKey(o.fieldName);h=q.extend({},o);h.filterRestriction=this._getFilterRestriction(o,i);this._updateValueListMetadata(h,o);h.hasValueHelpDialog=this._hasValueHelpDialog(h,i);h.preventInitialDataFetchInValueHelpDialog=i?i.preventInitialDataFetchInValueHelpDialog:true;h.controlType=this._getControlType(h,i);if(i&&i.displayBehaviour){h.displayBehaviour=i.displayBehaviour;}h.isCustomFilterField=!!(i&&i.customControl);h.visibleInAdvancedArea=!!(i&&i.visibleInAdvancedArea);h.label=this._getLabel(o,i);h.isMandatory=this._isMandatory(o,i);h.width=this._getWidth(i);h.isVisible=this._isVisible(i);h.groupId=this._getGroupID(o,i);h.index=this._getIndex(o,i);h.fControlConstructor=this._getControlConstructor(h);h.filterType=this._getFilterType(h);h.hasTypeAhead=this._hasTypeAhead(h,o,i);h.customControl=i?i.customControl:undefined;h.control=this._createControl(h);this._applyWidth(h);h.defaultFilterValues=i?i.defaultFilterValues:undefined;if(h.type==="Edm.String"){this._aFilterBarStringFieldNames.push(h.fieldName);}h.conditionType=null;var j=i?i.conditionType:null;if(j){var s="";if(typeof j==="object"){s=j.module;delete j.module;}else{s=j;j=null;}try{q.sap.require(s);var k=q.sap.getObject(s);if(k){h.conditionType=new k(h.fieldName,this,h);this._mConditionTypeFields[h.fieldName]=h;}if(j){h.conditionType.applySettings(j);}}catch(l){q.sap.log.error("Module "+s+" could not be loaded");}}return h;};g.prototype._getFilterType=function(o){if(O.isNumeric(o.type)){return"numeric";}else if(o.type==="Edm.DateTime"&&o.displayFormat==="Date"){return"date";}else if(o.type==="Edm.String"){return"string";}else if(o.type==="Edm.Boolean"){return"boolean";}else if(o.type==="Edm.Time"){return"time";}return undefined;};g.prototype._updateValueListMetadata=function(o,h){o.hasValueListAnnotation=h["sap:value-list"]!==undefined;if(o.hasValueListAnnotation){o.hasFixedValues=h["sap:value-list"]==="fixed-values";}else if(h["com.sap.vocabularies.Common.v1.ValueList"]){o.hasValueListAnnotation=true;o.hasFixedValues=this._oMetadataAnalyser.getValueListSemantics(h["com.sap.vocabularies.Common.v1.ValueList"])==="fixed-values";}};g.prototype._createBasicSearchFieldMetadata=function(){var o;var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");o={};o.filterRestriction=sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.single;o.name=g.BASIC_SEARCH_FIELD_ID;o.fieldName=g.BASIC_SEARCH_FIELD_ID;o.label=undefined;o.isMandatory=false;o.isVisible=true;o.groupId=g.BASIC_FILTER_AREA_ID;o.index=0;o.control=new S({showSearchButton:false});if(!this._isRunningInValueHelpDialog){o.control.setPlaceholder(r.getText("FILTER_BAR_BSEARCH_PLACE_HOLDER"));}o.control.bindProperty('value',this.sFilterModelName+">/"+o.fieldName);return o;};g.prototype._applyWidth=function(o){if(o&&o.width&&o.control&&o.control.setWidth&&(typeof o.control.setWidth==='function')){o.control.setWidth(o.width);}};g.prototype._createFieldMetadataForCustomFilterFields=function(o){var h;if(!o||!o.customControl){return undefined;}h={};h.name=o.key;h.fieldName=o.key;h.label=o.label;h.visibleInAdvancedArea=!!(o&&o.visibleInAdvancedArea);h.isVisible=this._isVisible(o);h.groupId=o.groupId;h.isMandatory=this._isMandatory(undefined,o);h.index=o.index;h.width=this._getWidth(o);h.control=o.customControl;h.isCustomFilterField=true;this._applyWidth(h);return h;};g.prototype._getFieldName=function(o){if(!o.parentPropertyName){return o.name;}else{return o.parentPropertyName+"."+o.name;}};g.prototype._hasValueHelpDialog=function(o,h){var v=true;if(h){if(h.controlType===sap.ui.comp.smartfilterbar.ControlConfiguration.CONTROLTYPE.dropDownList){v=false;}else if(h.hasValueHelpDialog!==true){v=false;}}if(o&&!o.hasValueListAnnotation){if(o.filterRestriction===sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.single||o.filterRestriction===sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.multiple){v=false;}}return v;};g.prototype._isVisible=function(o){if(o&&o.isVisible===false){return false;}return true;};g.prototype._getWidth=function(o){if(o&&o.width){return o.width;}return undefined;};g.prototype._isMandatory=function(o,h){if(h&&h.mandatory!==sap.ui.comp.smartfilterbar.ControlConfiguration.MANDATORY.auto){return h.mandatory===sap.ui.comp.smartfilterbar.ControlConfiguration.MANDATORY.mandatory;}if(o){return o.requiredField;}return false;};g.prototype._getFilterRestriction=function(o,h){var s;if(h&&h.filterType&&h.filterType!==sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.auto){s=h.filterType;}else if(o.filterRestriction==="single-value"){s=sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.single;}else if(o.filterRestriction==="multi-value"){s=sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.multiple;}else if(o.filterRestriction==="interval"){s=sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.interval;}else{s=sap.ui.comp.smartfilterbar.ControlConfiguration.FILTERTYPE.auto;}return s;};g.prototype._getControlType=function(o,h){var s;if(h&&h.controlType&&h.controlType!==sap.ui.comp.smartfilterbar.ControlConfiguration.CONTROLTYPE.auto){s=h.controlType;}else if(o.type==="Edm.DateTime"&&o.displayFormat==="Date"){s=sap.ui.comp.smartfilterbar.ControlConfiguration.CONTROLTYPE.date;}else if(o.hasValueListAnnotation&&o.hasFixedValues){s=sap.ui.comp.smartfilterbar.ControlConfiguration.CONTROLTYPE.dropDownList;}else{s=sap.ui.comp.smartfilterbar.ControlConfiguration.CONTROLTYPE.input;}return s;};g.prototype._getGroupID=function(o,h){if(h&&h.groupId){return h.groupId;}else if(o&&o.requiredField){return this._sBasicFilterAreaID;}return this._getGroupIDFromFieldGroup(o);};g.prototype._getGroupIDFromFieldGroup=function(o){var l=0,h=null,G;if(o&&this._aFieldGroupAnnotation&&this._aFieldGroupAnnotation.length){l=this._aFieldGroupAnnotation.length;while(l--){h=this._aFieldGroupAnnotation[l];if(h&&h.fields&&h.fields.indexOf(o.fieldNameOData)>-1){G=h.groupName;break;}}}return G;};g.prototype._getLabel=function(o,h){if(h&&h.label){return h.label;}return this._getLabelFromFieldGroup(o)||o.fieldLabel||o.fieldName;};g.prototype._getLabelFromFieldGroup=function(o){var l=0,h=null,L;if(o&&this._aFieldGroupAnnotation&&this._aFieldGroupAnnotation.length){l=this._aFieldGroupAnnotation.length;while(l--){h=this._aFieldGroupAnnotation[l];if(h&&h.fields&&h.fields.indexOf(o.fieldNameOData)>-1){L=h.labels[o.fieldNameOData];break;}}}return L;};g.prototype._getIndex=function(o,h){if(h&&(h.index||h.index===0)){return h.index;}return this._getIndexFromFieldGroup(o);};g.prototype._getIndexFromFieldGroup=function(o){var l=0,h=null,i;if(o&&this._aFieldGroupAnnotation&&this._aFieldGroupAnnotation.length){l=this._aFieldGroupAnnotation.length;while(l--){h=this._aFieldGroupAnnotation[l];if(h&&h.fields){i=h.fields.indexOf(o.fieldNameOData);if(i>-1){break;}i=undefined;}}}return i;};g.prototype._getGroupIndex=function(G){if(G&&(G.index||G.index===0)){return G.index;}};g.prototype._getGroupLabel=function(o,G){if(G&&G.label){return G.label;}return o.groupLabel||o.groupName||o.groupEntityName;};g.prototype._hasTypeAhead=function(o,h,i){var H;H=true;if(i){H=i.hasTypeAhead;}else if(h.type!=="Edm.String"){return false;}if(!(o.fControlConstructor===I||o.fControlConstructor===b)){return false;}return H;};g.prototype.getModel=function(){return this.oModel;};g.prototype.getFilterBarViewMetadata=function(){return this._aFilterBarViewMetadata;};g.prototype.getParameters=function(){var p,B=null;if(this.oModel){B=this.oModel.getProperty("/"+g.BASIC_SEARCH_FIELD_ID);}if(this._sBasicSearchFieldName||B){p={custom:{}};if(this._sBasicSearchFieldName){p.custom["search-focus"]=this._sBasicSearchFieldName;}p.custom["search"]=B||"";}return p;};g.prototype.getFilters=function(h){var o=null;if(this.oModel){o=this.oModel.getData();}return g.generateFilters(h,o,{dateSettings:this._oDateFormatSettings,useContainsAsDefault:this._bUseContainsAsDefault,stringFields:this._aFilterBarStringFieldNames,timeFields:this._aFilterBarTimeFieldNames});};g.prototype.getFilterData=function(){return this.oModel?this.oModel.getData():null;};g.prototype.getFilterDataAsString=function(){return this.oModel?this.oModel.getJSON():null;};g.prototype.getFilledFilterData=function(h){var o,i={},j,s,v;o=this.oModel?this.oModel.getData():null;if(o&&h){j=h.length;while(j--){s=h[j];if(s&&s!==g.BASIC_SEARCH_FIELD_ID){v=o[s];if(v&&v.hasOwnProperty("low")){if(v.low){i[s]=v;}}else if(v&&v.hasOwnProperty("items")){if(v.value&&typeof v.value==="string"){v.value=v.value.trim();}if(v.items.length||(v.ranges&&v.ranges.length)||v.value){i[s]=v;}}else if(v){if(typeof v==="string"){v=v.trim();}if(v){i[s]=v;}}}if(j===0){s=g.CUSTOM_FIELDS_MODEL_PROPERTY;v=o[s];if(v){i[s]=v;}}}}return q.extend(true,{},i);};g.prototype.getFilledFilterDataAsString=function(h){return JSON.stringify(this.getFilledFilterData(h));};g.prototype.setFilterData=function(j,r){var o=null,h=null,k=null;if(this.oModel&&j){this._bUpdatingFilterData=true;if(r){this._createInitialModel(false);}o=this._parseFilterData(j,r);if(o){this.oModel.setData(o,true);h=[];var s=arguments[2];if(s){h.push(s);}for(k in o){h.push(k);}this._handleFilterDataUpdate(h);}this._bUpdatingFilterData=false;}};g.prototype.setFilterDataAsString=function(j,r){if(j){this.setFilterData(JSON.parse(j),r);}};g.prototype._parseFilterData=function(j,r){return g.parseFilterData(this.oModel.getData(),j,{dateFields:this._aFilterBarDateFieldNames,timeFields:this._aFilterBarTimeFieldNames,timeIntervalFields:this._aFilterBarTimeIntervalFieldNames,dateTimeMultiValueFields:this._aFilterBarDateTimeMultiValueFieldNames,conditionTypeFields:this._mConditionTypeFields},r);};g.prototype._handleFilterDataUpdate=function(h){var i=0,o,j,k;if(this._aFilterBarMultiValueFieldMetadata){i=this._aFilterBarMultiValueFieldMetadata.length;while(i--){if(!j){j=this.oModel.getData();}if(j){o=this._aFilterBarMultiValueFieldMetadata[i];if(h.indexOf(o.fieldName)>-1){k=j[o.fieldName];if(k){this._updateMultiValueControl(o.control,k.items,k.ranges);}}}}this._updateConditionTypeFields(h);}};g.prototype.clear=function(){this._createInitialModel(false);};g.prototype.reset=function(){this._createInitialModel(true);};g.prototype._initializeConditionTypeFields=function(){function h(E){t.setPending(t.isPending());}for(var n in this._mConditionTypeFields){this._mConditionTypeFields[n].conditionType.initialize(this.oModel.getData()[n]);var t=this;if(this._mConditionTypeFields[n].conditionType.getAsync()){this._mConditionTypeFields[n].conditionType.attachPendingChange(h);}}};g.prototype._updateConditionTypeFields=function(u){if(typeof u==="string"){u=[u];}var U=u||[];if(U.length===0){for(var n in this.oModel.getData()){U.push(n);}}for(var n in this._mConditionTypeFields){this._mConditionTypeFields[n].conditionType.providerDataUpdated(U,this.oModel.getData());}};g.prototype._validateConditionTypeFields=function(){var i=false;for(var n in this._mConditionTypeFields){var v=this._mConditionTypeFields[n].conditionType.validate();if(!v&&!i){i=true;}}return i;};g.generateFilters=function(h,o,s){var i=[],A=null,E=null,j=null,k=null,m=g.FIELD_NAME_REGEX,v=null,l,n,p=null,L=0,r=0;var t,u,w,x,U,y;if(s){t=s.dateSettings;u=s.useContainsAsDefault;w=s.stringFields;x=s.timeFields;}if(h&&o){r=h.length;while(r--){y=false;k=h[r];if(k&&k!==g.BASIC_SEARCH_FIELD_ID){U=false;if(u&&w){if(w.indexOf(k)>-1){U=true;}}else if(x&&x.indexOf(k)>-1){y=true;}v=o[k];k=k.replace(m,"/");if(v&&v.hasOwnProperty("low")){if(v.low&&v.high){l=v.low;n=v.high;if(t&&t.UTC&&l instanceof Date&&n instanceof Date){l=g.getDateInUTCOffset(l);n=g.getDateInUTCOffset(n);}i.push(new F(k,sap.ui.model.FilterOperator.BT,l,n));}else if(v.low){if(v.low instanceof Date){l=v.low;if(t&&t.UTC){l=g.getDateInUTCOffset(l);}i.push(new F(k,sap.ui.model.FilterOperator.EQ,l));}else if(typeof v.low==="string"){p=v.low.split("-");if(p&&p.length===2){i.push(new F(k,sap.ui.model.FilterOperator.BT,p[0],p[1]));}else{i.push(new F(k,U?sap.ui.model.FilterOperator.Contains:sap.ui.model.FilterOperator.EQ,v.low));}}}}else if(v&&v.hasOwnProperty("items")){A=[];j=[];E=null;if(v&&v.hasOwnProperty("ranges")){p=v.ranges;L=p.length;while(L--){l=p[L].value1;n=p[L].value2;if(y){if(l instanceof Date){l=f.getEdmTimeFromDate(l);}if(n instanceof Date){n=f.getEdmTimeFromDate(n);}}else if(t&&t.UTC){if(l instanceof Date){l=g.getDateInUTCOffset(l);}if(n instanceof Date){n=g.getDateInUTCOffset(n);}}if(p[L].exclude){if(p[L].operation===sap.ui.model.FilterOperator.EQ){j.push(new F(k,sap.ui.model.FilterOperator.NE,l));}}else{A.push(new F(k,p[L].operation,l,n));}}if(j.length){E=new F(j,true);}}p=v.items;L=p.length;while(L--){A.push(new F(k,sap.ui.model.FilterOperator.EQ,p[L].key));}if(v.value||v.value===0||v.value===false){if(typeof v.value==="string"){v.value=v.value.trim();}if(v.value||v.value===0||v.value===false){A.push(new F(k,U?sap.ui.model.FilterOperator.Contains:sap.ui.model.FilterOperator.EQ,v.value));}}if(A.length){if(E){i.push(new F([new F(A,false),E],true));}else{i.push(new F(A,false));}}else if(E){i.push(E);}}else if(v||v===0||v===false){if(typeof v==="string"){v=v.trim();}if(v&&v instanceof Date){if(y){v=f.getEdmTimeFromDate(v);}else if(t&&t.UTC){v=g.getDateInUTCOffset(v);}}if(v||v===0||v===false){i.push(new F(k,U?sap.ui.model.FilterOperator.Contains:sap.ui.model.FilterOperator.EQ,v));}}}}}return(i.length>1)?[new F(i,true)]:i;};g.parseFilterData=function(o,h,s,r){var R={},m=null,j=null,v=null,n,k,i,l,p,t,u,w,x,E;if(s){t=s.dateFields;u=s.timeFields;w=s.timeIntervalFields;x=s.dateTimeMultiValueFields;m=s.conditionTypeFields||{};}if(!t){t=[];}if(!u){u=[];}if(!w){w=[];}if(!x){x=[];}if(o&&h){k=q.extend({},h,true);for(j in k){if(o.hasOwnProperty(j)&&j!==g.CUSTOM_FIELDS_MODEL_PROPERTY){v=o[j];n=k[j];if(j in m){if("conditionTypeInfo"in n||(!("conditionTypeInfo"in n)&&n.ranges)){m[j].conditionType.initialize(n);}}else if(v&&v.hasOwnProperty("low")){R[j]=n;if(n){if(n.low&&n.high){if(!(n.low instanceof Date)){R[j].low=new Date(n.low);}if(!(n.high instanceof Date)){R[j].high=new Date(n.high);}}else if((n.low||n.value)&&!n.high){if(!n.low&&n.value){n.low=n.value;}if((t.indexOf(j)>-1||u.indexOf(j)>-1)&&!(n.low instanceof Date)){R[j].low=new Date(n.low);}else{R[j].low=n.low;}R[j].high=null;}}}else if(v&&v.hasOwnProperty("items")){if(n&&(n.items||n.ranges)){if(n.ranges&&n.ranges.length){if(w.indexOf(j)>-1){l=n.ranges.length;for(i=0;i<l;i++){p=n.ranges[i];if(!p.exclude&&(p.operation==="EQ"||p.operation==="BT")){break;}p=null;}if(p){if(p.value1&&typeof p.value1==="string"){p.value1=new Date(p.value1);}if(p.value2&&typeof p.value2==="string"){p.value2=new Date(p.value2);}R[j]={ranges:[p],items:[],value:""};}continue;}else if(x.indexOf(j)>-1){l=n.ranges.length;E=[];for(i=0;i<l;i++){p=n.ranges[i];if(!p.exclude&&p.operation==="EQ"){if(p.value1&&typeof p.value1==="string"){p.value1=new Date(p.value1);}E.push(p);}}R[j]={ranges:E,items:[],value:""};continue;}else if(t.indexOf(j)>-1||u.indexOf(j)>-1){l=n.ranges.length;for(i=0;i<l;i++){p=n.ranges[i];if(p.value1&&typeof p.value1==="string"){p.value1=new Date(p.value1);}if(p.value2&&typeof p.value2==="string"){p.value2=new Date(p.value2);}}}}R[j]=n;}else if(typeof n==="string"||typeof n==="number"||n instanceof Date){if(n&&(t.indexOf(j)>-1||u.indexOf(j)>-1)){if(typeof n==="string"){n=new Date(n);}R[j]={ranges:[{"exclude":false,"operation":"EQ","keyField":j,"value1":n,"value2":null}],items:[],value:""};}else{R[j]={value:n,items:[]};}}}else{R[j]=null;if(typeof n==="string"||typeof n==="boolean"||typeof n==="number"||n instanceof Date){if(typeof n==="string"&&(t.indexOf(j)>-1||u.indexOf(j)>-1)){R[j]=new Date(n);}else{R[j]=n;}}else if(n&&(n.value||n.value===0||n.value===false)){R[j]=n.value;}else if(n&&n.items&&n.items.length){R[j]=n.items[0].key;}else if(n&&n.ranges&&n.ranges.length){l=n.ranges.length;for(i=0;i<l;i++){p=n.ranges[i];if(!p.exclude&&p.operation==="EQ"){break;}p=null;}if(p&&p.value1){if(typeof p.value1==="string"&&(t.indexOf(j)>-1||u.indexOf(j)>-1)){R[j]=new Date(p.value1);}else{R[j]=p.value1;}}}}}else if(r||j===g.CUSTOM_FIELDS_MODEL_PROPERTY){R[j]=k[j];}}}return R;};g.getDateInUTCOffset=function(o){return new Date(o.valueOf()-o.getTimezoneOffset()*60*1000);};g.prototype.destroy=function(){var i=0;this._aFilterBarViewMetadata=null;this._aFilterBarDateFieldNames=null;this._aFilterBarTimeFieldNames=null;this._aFilterBarTimeIntervalFieldNames=null;this._aFilterBarDateTimeMultiValueFieldNames=null;this._aFilterBarStringFieldNames=null;this._aFilterBarMultiValueFieldMetadata=null;this._aFieldGroupAnnotation=null;if(this._oMetadataAnalyser&&this._oMetadataAnalyser.destroy){this._oMetadataAnalyser.destroy();}this._oMetadataAnalyser=null;if(this._aValueHelpDialogProvider){i=this._aValueHelpDialogProvider.length;while(i--){this._aValueHelpDialogProvider[i].destroy();}}this._aValueHelpDialogProvider=null;if(this._aValueListProvider){i=this._aValueListProvider.length;while(i--){this._aValueListProvider[i].destroy();}}this._aValueListProvider=null;this.oResourceBundle=null;this.sIntervalPlaceholder=null;this.sDefaultDropDownDisplayBehaviour=null;this.sDefaultTokenDisplayBehaviour=null;this._oSmartFilter=null;this.bIsDestroyed=true;};return g;},true);
